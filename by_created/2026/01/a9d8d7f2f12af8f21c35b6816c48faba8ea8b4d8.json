{
  "id": "a9d8d7f2f12af8f21c35b6816c48faba8ea8b4d8",
  "url": "https://www.r-bloggers.com/2025/12/censo-2024-de-poblacion-y-viviendas-en-chile-con-codigos-territoriales-corregidos/",
  "created_at_utc": "2026-01-04T05:35:43Z",
  "crawled_at_utc": "2026-01-04T05:35:47Z",
  "html_title": "Censo 2024 de Poblaci√≥n y Viviendas en Chile con C√≥digos Territoriales Corregidos | R-bloggers",
  "meta_description": "He liberado los datos censales en formato DuckDB para proporcionar los datos censales con los c√≥digos",
  "data": {
    "url": "https://www.r-bloggers.com/2025/12/censo-2024-de-poblacion-y-viviendas-en-chile-con-codigos-territoriales-corregidos/",
    "canonical_url": "https://www.r-bloggers.com/2025/12/censo-2024-de-poblacion-y-viviendas-en-chile-con-codigos-territoriales-corregidos/",
    "html_title": "Censo 2024 de Poblaci√≥n y Viviendas en Chile con C√≥digos Territoriales Corregidos | R-bloggers",
    "h1_title": "R-bloggers",
    "meta_description": "He liberado los datos censales en formato DuckDB para proporcionar los datos censales con los c√≥digos",
    "meta_keywords": null,
    "og_title": "Censo 2024 de Poblaci√≥n y Viviendas en Chile con C√≥digos Territoriales Corregidos | R-bloggers",
    "og_description": "He liberado los datos censales en formato DuckDB para proporcionar los datos censales con los c√≥digos",
    "og_image": "https://www.r-bloggers.com/wp-content/uploads/2016/04/R_02_2016-05-01.png",
    "twitter_title": "Censo 2024 de Poblaci√≥n y Viviendas en Chile con C√≥digos Territoriales Corregidos | R-bloggers",
    "twitter_description": "He liberado los datos censales en formato DuckDB para proporcionar los datos censales con los c√≥digos",
    "raw_jsonld_article": null,
    "article_headline": null,
    "article_section": null,
    "article_tags": null,
    "article_author": null,
    "article_published": null,
    "article_modified": null,
    "main_text": "Censo 2024 de Poblaci√≥n y Viviendas en Chile con C√≥digos Territoriales Corregidos\nPosted on\nDecember 4, 2025\nby\nhttps://pacha.dev/blog\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nhttps://pacha.dev/blog\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\npacha.dev/blog\n‚ò∞ Menu\nMauricio ‚ÄúPach√°‚Äù Vargas Sep√∫lveda\nBlog with notes about R, Shiny, SQL, Python, Linux and C++. This blog is listed on\nR-Bloggers\n.\nDark mode on\nA-\nA+\nHOME üè†\nCenso 2024 de Poblaci√≥n y Viviendas en Chile con C√≥digos Territoriales Corregidos\nR\nDuckDB\nHe liberado los datos censales en formato DuckDB para proporcionar los datos censales con los c√≥digos de regi√≥n, provincia y comuna corregidos y adem√°s con llaves for√°neas para ayudar en los cruces de tablas.\nAuthor\nMauricio ‚ÄúPach√°‚Äù Vargas S.\nPublished\nDecember 5, 2025\nSi esta publicaci√≥n te resulta √∫til, te agradecer√≠a que hicieras una peque√±a donaci√≥n en\nBuy Me a Coffee\n. La utilizar√© para continuar con mis iniciativas de c√≥digo abierto.\nPuedes enviarme preguntas para el blog utilizando\neste formulario\ny suscribirse para recibir un correo electr√≥nico cuando haya una nueva publicaci√≥n.\nLuego de analizar los datos censales del d√≠a 4 de diciembre en\neste post\n, el mismo d√≠a que se liberaron los microdatos del censo, decid√≠ utilizar dichos datos para dar un ejemplo de flujos migratorios en el contexto del modelo de gravedad estructural.\nTuve que reemplazar valores en ‚Äúp27_nacionalidad_nac‚Äù (lugar de nacimiento), ‚Äúp27_nacionalidad_esp‚Äù (nacionalidad) y ‚Äúp44_lug_trab_esp‚Äù (lugar de trabajo) por -999 ya que ‚Äú10‚Äù no es un valor en los c√≥digos territoriales espec√≠ficos.La necesidad de utilizar -999 (no aplica) en las llaves for√°neas es para distinguir ‚ÄúNA‚Äù/‚ÄúNULL‚Äù del caso -99 (no responde), pues estas no admiten valores nulos.\nDicho trabajo adicional no deber√≠a ser realizado si quienes publican estos datos revisaran dos veces y publicaran una, pero dado que no es as√≠, he decidido compartir mis correcciones para que otros puedan beneficiarse de ellas y no perder tiempo corrigiendo los mismos errores.\nPaso 1: Instalaci√≥n y carga de paquetes\nUtilic√© los siguientes paquetes de R para manejar la descarga, lectura, limpieza y organizaci√≥n de los datos:\narchive\n: Extraer archivos comprimidos (ZIP, 7z, etc.)\narrow\n: Leer archivos Parquet\nduckdb\n: Leer/escribir de datos SQL portable\nreadxl\n: Leer archivos Excel\ndplyr\n: Manipulaci√≥n de datos (filtrar, agrupar, resumir)\ndbplyr\n: Uso sintaxis de dplyr con SQL\njanitor\n: Limpiar nombres de columnas\nstringr\n: Manipulaci√≥n de texto\npurrr\n: Iteraciones (e.g., copiar una regi√≥n a la vez)\n# 1: packages ----\n\nif (!require(archive)) install.packages(\"archive\", repos = \"http://cran.r-project.org\")\nif (!require(arrow)) install.packages(\"arrow\", repos = \"http://cran.r-project.org\")\nif (!require(duckdb)) install.packages(\"duckdb\", repos = \"http://cran.r-project.org\")\nif (!require(readxl)) install.packages(\"readxl\", repos = \"http://cran.r-project.org\")\nif (!require(dplyr)) install.packages(\"dplyr\", repos = \"http://cran.r-project.org\")\nif (!require(dbplyr)) install.packages(\"dbplyr\", repos = \"http://cran.r-project.org\")\nif (!require(janitor)) install.packages(\"janitor\", repos = \"http://cran.r-project.org\")\nif (!require(stringr)) install.packages(\"stringr\", repos = \"http://cran.r-project.org\")\nif (!require(purrr)) install.packages(\"purrr\", repos = \"http://cran.r-project.org\")\n\nlibrary(archive)\nlibrary(arrow)\nlibrary(duckdb)\nlibrary(readxl)\nlibrary(dplyr)\nlibrary(janitor)\nlibrary(stringr)\nlibrary(purrr)\nPaso 2: Descarga y lectura de datos brutos\nDescargu√© los microdatos del Censo 2024 desde el servidor del INE. El archivo ZIP contiene tres archivos Parquet (personas, hogares, viviendas) y un diccionario en Excel que explica qu√© significa cada variable y c√≥digo.\n# 2: raw data ----\n\nurl <- \"https://storage.googleapis.com/bktdescargascenso2024/viv_hog_per_censo2024.zip\"\nzip <- paste0(\"\", basename(url))\n\nif (!file.exists(zip)) {\n  download.file(url, zip, mode = \"wb\")\n}\n\narchive_extract(zip, dir = dirname(zip))\nCre√© una funci√≥n auxiliar para leer las distintas hojas del diccionario Excel. La funci√≥n\nclean_names()\nconvierte los nombres de las columnas a un formato consistente (min√∫sculas, sin espacios).\nread_dic <- function(file = \"diccionario_variables_censo2024.xlsx\", sheet) {\n  read_excel(file, sheet = sheet) |>\n    clean_names()\n}\n\ncodigos_personas <- read_dic(sheet = \"tabla_personas\")\n\ncodigos_personas |>\n  filter(nombre_variable == \"cine11\")\n\ncodigos_hogares <- read_dic(sheet = \"tabla_hogares\")\n\ncodigos_viviendas <- read_dic(sheet = \"tabla_viviendas\")\n\ncodigos_territoriales <- read_dic(sheet = \"codigos_territoriales\")\n\ncodigos_territoriales_especificos <- read_dic(sheet = \"cod_territoriales_especificos\")\nLe√≠ los archivos y debo reconocer que el INE tom√≥ unabuena decisi√≥n al proporcionar estos archivos adem√°s de CSV. El formato Parquet es muy eficiente para datos grandes porque usa compresi√≥n, utlizando alrededor de 300 MB para el censo completo.\npersonas <- read_parquet(\"personas_censo2024.parquet\")\n\nhogares <- read_parquet(\"hogares_censo2024.parquet\")\n\nviviendas <- read_parquet(\"viviendas_censo2024.parquet\")\nLa siguiente funci√≥n limpia todas las columnas de texto: elimina espacios m√∫ltiples, saltos de l√≠nea y espacios al inicio o final. Esto es importante porque los datos brutos tienen inconsistencias de formato.\n# for all chr-type columns, replace multiple spaces / new lines with single space, trim leading/trailing spaces\nclean_chr_cols <- function(df) {\n  chr_cols <- names(df)[sapply(df, is.character)]\n  df <- df |> mutate(across(all_of(chr_cols), ~ str_squish(str_trim(.))))\n  return(df)\n}\n\ncodigos_personas <- clean_chr_cols(codigos_personas) |>\n  select(-entidad)\n\ncodigos_hogares <- clean_chr_cols(codigos_hogares) |>\n  select(-entidad)\n\ncodigos_viviendas <- clean_chr_cols(codigos_viviendas) |>\n  select(-entidad)\n\npersonas <- clean_chr_cols(personas)\nhogares <- clean_chr_cols(hogares)\nviviendas <- clean_chr_cols(viviendas)\nEl problema con los c√≥digos de regi√≥n\nEste es el problema que detect√© en el post del d√≠a 4 de diciembre. Los c√≥digos de regi√≥n en los datos no son √∫nicos. Esto rompe los cruces directos con la tabla de c√≥digos territoriales.\n# 3: problem with \"region\" ----\n\nglimpse(personas)\n\npersonas_educacion <- personas |>\n  group_by(region, cine11) |>\n  summarise(total = n(), .groups = \"drop\") |>\n  collect() |>\n\n  inner_join(\n    codigos_personas |>\n        filter(nombre_variable == \"cine11\") |>\n        select(cine11 = valor, nivel_educacional = etiqueta_de_categoria) |>\n        mutate(cine11 = as.integer(cine11))\n  ) |>\n\n  inner_join(\n    codigos_territoriales |>\n        select(region = codigo_territorial, nombre_region = territorio) |>\n        mutate(region = as.integer(region))\n  )\n\ncodigos_territoriales |>\n    filter(codigo_territorial %in% 1:16) |>\n    group_by(codigo_territorial) |>\n    filter(n() > 1)\nComo los c√≥digos de comuna son √∫nicos (5 d√≠gitos), podemos usarlos para hacer los cruces y luego derivar la regi√≥n a partir de los primeros 2 d√≠gitos del c√≥digo de comuna.\npersonas_educacion <- personas |>\n  group_by(comuna, cine11) |>\n  summarise(total = n(), .groups = \"drop\") |>\n  collect() |>\n\n  inner_join(\n    codigos_personas |>\n        filter(nombre_variable == \"cine11\") |>\n        select(cine11 = valor, nivel_educacional = etiqueta_de_categoria) |>\n        mutate(cine11 = as.integer(cine11))\n  ) |>\n\n  inner_join(\n    codigos_territoriales |>\n        select(comuna = codigo_territorial, nombre_comuna = territorio) |>\n        mutate(comuna = as.integer(comuna))\n  )\n\npersonas_educacion <- personas_educacion |>\n  mutate(\n    comuna = str_pad(comuna, width = 5, side = \"left\", pad = \"0\"),\n    region = str_sub(comuna, 1, 2),\n    nombre_region = case_when(\n      region == \"15\" ~ \"Regi√≥n de Arica y Parinacota\",\n      region == \"01\" ~ \"Regi√≥n de Tarapac√°\",\n      region == \"02\" ~ \"Regi√≥n de Antofagasta\",\n      region == \"03\" ~ \"Regi√≥n de Atacama\",\n      region == \"04\" ~ \"Regi√≥n de Coquimbo\",\n      region == \"05\" ~ \"Regi√≥n de Valpara√≠so\",\n      region == \"13\" ~ \"Regi√≥n Metropolitana de Santiago\",\n      region == \"06\" ~ \"Regi√≥n del Libertador General Bernardo O'Higgins\",\n      region == \"07\" ~ \"Regi√≥n del Maule\",\n      region == \"16\" ~ \"Regi√≥n de √ëuble\",\n      region == \"08\" ~ \"Regi√≥n del B√≠o B√≠o\",\n      region == \"09\" ~ \"Regi√≥n de La Araucan√≠a\",\n      region == \"14\" ~ \"Regi√≥n de Los R√≠os\",\n      region == \"10\" ~ \"Regi√≥n de Los Lagos\",\n      region == \"11\" ~ \"Regi√≥n de Ays√©n del General Carlos Ib√°√±ez del Campo\",\n      region == \"12\" ~ \"Regi√≥n de Magallanes y de la Ant√°rtica Chilena\",\n      TRUE ~ \"Desconocida\"\n    )\n  )\nCorrecci√≥n definitiva de los c√≥digos\nEsta es la correcci√≥n principal. El problema es que los c√≥digos de comuna de 4 d√≠gitos (como 1101 para Iquique) deben tener un cero adelante para quedar como 5 d√≠gitos (01101). Adem√°s, las columnas de c√≥digos territoriales espec√≠ficos (lugar de residencia hace 5 a√±os, lugar de nacimiento, nacionalidad, lugar de trabajo) tambi√©n necesitan esta correcci√≥n.\nUsamos\n-999\npara marcar valores que no aplican (por ejemplo, lugar de trabajo para menores de edad), distingui√©ndolo de\n-99\nque significa ‚Äúno responde‚Äù.\n# 4: proper fix ----\n\npersonas <- personas |>\n  mutate(\n    comuna = str_pad(comuna, width = 5, side = \"left\", pad = \"0\"),\n    # NOTE: region and provincia removed - derive with substr(comuna, 1, 2) and substr(comuna, 1, 3)\n    # Convert to VARCHAR and pad to 5 digits for FK to codigos_territoriales_especificos\n    # First clean, then only pad codes of length 4 (comunas that need leading zero)\n    # Replace NA with \"-999\" for consistency with census data and FK constraints\n    p24_lug_resid5_esp = case_when(\n      is.na(p24_lug_resid5_esp) ~ \"-999\",\n      TRUE ~ str_squish(str_trim(as.character(p24_lug_resid5_esp)))\n    ),\n\n    p24_lug_resid5_esp = case_when(\n      p24_lug_resid5_esp == \"-999\" ~ \"-999\",\n      str_detect(p24_lug_resid5_esp, \"^[0-9]+$\") & str_length(p24_lug_resid5_esp) == 4 ~ str_pad(p24_lug_resid5_esp, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ p24_lug_resid5_esp\n    ),\n    \n    p25_lug_nacimiento_esp = case_when(\n      is.na(p25_lug_nacimiento_esp) ~ \"-999\",\n      TRUE ~ str_squish(str_trim(as.character(p25_lug_nacimiento_esp)))\n    ),\n    \n    p25_lug_nacimiento_esp = case_when(\n      p25_lug_nacimiento_esp == \"-999\" ~ \"-999\",\n      str_detect(p25_lug_nacimiento_esp, \"^[0-9]+$\") & str_length(p25_lug_nacimiento_esp) == 4 ~ str_pad(p25_lug_nacimiento_esp, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ p25_lug_nacimiento_esp\n    ),\n    \n    p27_nacionalidad_esp = case_when(\n      is.na(p27_nacionalidad_esp) ~ \"-999\",\n      TRUE ~ str_squish(str_trim(as.character(p27_nacionalidad_esp)))\n    ),\n    \n    p27_nacionalidad_esp = case_when(\n      p27_nacionalidad_esp == \"-999\" ~ \"-999\",\n      str_detect(p27_nacionalidad_esp, \"^[0-9]+$\") & str_length(p27_nacionalidad_esp) == 4 ~ str_pad(p27_nacionalidad_esp, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ p27_nacionalidad_esp\n    ),\n    \n    p44_lug_trab_esp = case_when(\n      is.na(p44_lug_trab_esp) ~ \"-999\",\n      TRUE ~ str_squish(str_trim(as.character(p44_lug_trab_esp)))\n    ),\n    \n    p44_lug_trab_esp = case_when(\n      p44_lug_trab_esp == \"-999\" ~ \"-999\",\n      str_detect(p44_lug_trab_esp, \"^[0-9]+$\") & str_length(p44_lug_trab_esp) == 4 ~ str_pad(p44_lug_trab_esp, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ p44_lug_trab_esp\n    )\n  ) |>\n  select(-any_of(c(\"region\", \"provincia\")))\nLos c√≥digos de regi√≥n tambi√©n necesitan estandarizaci√≥n. Por ejemplo, la Regi√≥n de Tarapac√° deber√≠a ser ‚Äú01‚Äù (no ‚Äú1‚Äù), y las comunas deben tener 5 d√≠gitos. Adem√°s, hay que corregir manualmente algunos casos donde el mismo c√≥digo se usaba para entidades diferentes.\ncodigos_territoriales <- codigos_territoriales |>\n  mutate(\n    codigo_territorial = case_when(\n      codigo_territorial <= 16 ~ str_pad(codigo_territorial, width = 2, side = \"left\", pad = \"0\"),\n      codigo_territorial > 16 & codigo_territorial <= 99 ~ str_pad(codigo_territorial, width = 3, side = \"left\", pad = \"0\"),\n      str_length(codigo_territorial) == 4 ~ str_pad(codigo_territorial, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ as.character(codigo_territorial)\n    ),\n    codigo_territorial = case_when(\n      territorio == \"Arica y Parinacota\" & str_length(codigo_territorial) == 2 ~ \"15\",\n      territorio == \"Tarapac√°\" & str_length(codigo_territorial) == 2 ~ \"01\",\n      territorio == \"Iquique\" & str_length(codigo_territorial) == 2 ~ \"011\",\n      territorio == \"Del Tamarugal\" & str_length(codigo_territorial) == 2 ~ \"014\",\n      territorio == \"Antofagasta\" & str_length(codigo_territorial) == 2 ~ \"02\",\n      territorio == \"Atacama\" & str_length(codigo_territorial) == 2 ~ \"03\",\n      territorio == \"Coquimbo\" & str_length(codigo_territorial) == 2 ~ \"04\",\n      territorio == \"Valpara√≠so\" & str_length(codigo_territorial) == 2 ~ \"05\",\n      territorio == \"Metropolitana de Santiago\" & str_length(codigo_territorial) == 2 ~ \"13\",\n      territorio == \"Libertador General Bernardo O'Higgins\" & str_length(codigo_territorial) == 2 ~ \"06\",\n      territorio == \"Maule\" & str_length(codigo_territorial) == 2 ~ \"07\",\n      territorio == \"√ëuble\" & str_length(codigo_territorial) == 2 ~ \"16\",\n      territorio == \"Biob√≠o\" & str_length(codigo_territorial) == 2 ~ \"08\",\n      territorio == \"La Araucan√≠a\" & str_length(codigo_territorial) == 2 ~ \"09\",\n      territorio == \"Los R√≠os\" & str_length(codigo_territorial) == 2 ~ \"14\",\n      territorio == \"Los Lagos\" & str_length(codigo_territorial) == 2 ~ \"10\",\n      territorio == \"Ays√©n del General Carlos Ib√°√±ez del Campo\" & str_length(codigo_territorial) == 2 ~ \"11\",\n      territorio == \"Magallanes y de la Ant√°rtica Chilena\" & str_length(codigo_territorial) == 2 ~ \"12\",\n      TRUE ~ codigo_territorial\n    )\n  )\n\ncodigos_territoriales |>\n  filter(str_length(codigo_territorial) == 2) |>\n  arrange(codigo_territorial) |>\n  print(n = 30)\n\ncodigos_territoriales |>\n  distinct()\nPara los c√≥digos espec√≠ficos (pa√≠ses, comunas para variables de migraci√≥n/trabajo) es similar:\n# similar for codigos_territoriales_especificos\n# len 4 -> add 0, and ensure character type\n\ncodigos_territoriales_especificos <- codigos_territoriales_especificos |>\n  mutate(\n    codigo_especifico = as.character(codigo_especifico),\n    codigo_especifico = case_when(\n      str_length(codigo_especifico) == 4 ~ str_pad(codigo_especifico, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ codigo_especifico\n    )\n  )\nLas columnas de lugar de residencia, nacimiento, nacionalidad y trabajo pueden contener tanto c√≥digos de comuna chilenas como c√≥digos de pa√≠ses. Para que las llaves for√°neas funcionen, necesitamos una tabla unificada que contenga todos los c√≥digos posibles.\n# The p24, p25, p27, p44 columns contain BOTH comuna codes (from codigos_territoriales)\n# AND country/special codes (from codigos_territoriales_especificos)\n# We need to add all comuna codes to codigos_territoriales_especificos for FK to work\n# Also add special codes: -66 (anonimizado), -99 (no respuesta)\ncodigos_territoriales_especificos <- codigos_territoriales_especificos |>\n  bind_rows(\n    codigos_territoriales |>\n      filter(str_length(codigo_territorial) == 5) |>\n      select(codigo_especifico = codigo_territorial, territorio_especifico = territorio)\n  ) |>\n  bind_rows(\n    tibble(\n      codigo_especifico = c(\"-66\", \"-99\", \"-999\"),\n      territorio_especifico = c(\"Anonimizado\", \"No respuesta\", \"No aplica\")\n    )\n  ) |>\n  distinct(codigo_especifico, .keep_all = TRUE)\nOrganizaci√≥n en base de datos SQL (DuckDB)\nExport√© los datos a una base de datos DuckDB. Esto tiene varias ventajas:\nIntegridad referencial\n: Las llaves for√°neas garantizan que no haya c√≥digos inv√°lidos (esto me permiti√≥ detectar errores y actualizar el c√≥digo)\nEficiencia\n: DuckDB est√° optimizado para consultas anal√≠ticas\nPortabilidad\n: Un solo archivo que contiene toda la base de datos\n# 5: organize in SQL ---\n\n# same fix as for personas\n\nhogares <- hogares |>\n  mutate(\n    comuna = str_pad(comuna, width = 5, side = \"left\", pad = \"0\")\n  ) |>\n  select(-any_of(c(\"region\", \"provincia\")))\n\nviviendas <- viviendas |>\n  mutate(\n    comuna = str_pad(comuna, width = 5, side = \"left\", pad = \"0\")\n  ) |>\n  select(-any_of(c(\"region\", \"provincia\")))\n\n# persona: id_hogar -> hogar: id_hogar\n# persona: id_vivienda -> vivienda: id_vivienda\n\nlength(unique(personas$id_hogar)) # -> add comuna to deambiguate\nEscrib√≠ las tablas corregidas en una nueva base de datos DuckDB:\nunlink(\"censo2024_corregido.duckdb\")\nunlink(\"censo2024_corregido.duckdb.wal\")\n\ncon <- dbConnect(duckdb::duckdb(), \"censo2024_corregido.duckdb\", read_only = FALSE)\n\ndbWriteTable(con, \"personas\", personas, overwrite = TRUE)\ndbWriteTable(con, \"hogares\", hogares, overwrite = TRUE)\ndbWriteTable(con, \"viviendas\", viviendas, overwrite = TRUE)\n\ndbWriteTable(con, \"codigos_personas\", codigos_personas, overwrite = TRUE)\ndbWriteTable(con, \"codigos_hogares\", codigos_hogares, overwrite = TRUE)\ndbWriteTable(con, \"codigos_viviendas\", codigos_viviendas, overwrite = TRUE)\n\ndbWriteTable(con, \"codigos_territoriales\", codigos_territoriales, overwrite = TRUE)\ndbWriteTable(con, \"codigos_territoriales_especificos\", codigos_territoriales_especificos, overwrite = TRUE)\n\ngc()\nA diferencia de PostgreSQL, DuckDB no permite agregar restricciones a tablas existentes con\nALTER TABLE\n, as√≠ que deb√≠ recrear las tablas con las restricciones definidas desde el inicio.\n# DuckDB doesn't support ALTER TABLE for adding constraints\n# We need to recreate tables with constraints using CREATE TABLE ... AS\n\n# First, add primary keys by recreating tables\ndbExecute(con, \"\n  CREATE OR REPLACE TABLE codigos_territoriales_new (\n    codigo_territorial VARCHAR PRIMARY KEY,\n    territorio VARCHAR\n  )\n\")\n\n# Note: codigo_territorial uses VARCHAR because it has variable length (2, 3, or 5 chars)\n# comuna columns in main tables will be converted to CHAR(5) for efficiency\ndbExecute(con, \"INSERT INTO codigos_territoriales_new SELECT * FROM codigos_territoriales\")\ndbExecute(con, \"DROP TABLE codigos_territoriales\")\ndbExecute(con, \"ALTER TABLE codigos_territoriales_new RENAME TO codigos_territoriales\")\n\ndbExecute(con, \"\n  CREATE OR REPLACE TABLE codigos_territoriales_especificos_new (\n    codigo_especifico VARCHAR PRIMARY KEY,\n    territorio_especifico VARCHAR\n  )\n\")\ndbExecute(con, \"INSERT INTO codigos_territoriales_especificos_new SELECT * FROM codigos_territoriales_especificos\")\ndbExecute(con, \"DROP TABLE codigos_territoriales_especificos\")\ndbExecute(con, \"ALTER TABLE codigos_territoriales_especificos_new RENAME TO codigos_territoriales_especificos\")\nLuego cre√© las tablas principales (viviendas, hogares, personas) con sus llaves primarias y for√°neas. Esto garantiza la integridad de los datos (e.g.¬†que no existan valores en la tabla de personas u otra tabla que no est√°n no descritos en las tablas de c√≥digos territoriales).\n# Get all column names and types from hogares\nviviendas_schema <- dbGetQuery(con, \"DESCRIBE viviendas\")\nhogares_schema <- dbGetQuery(con, \"DESCRIBE hogares\")\npersonas_schema <- dbGetQuery(con, \"DESCRIBE personas\")\n\n# Build the column definitions dynamically\n# Convert comuna from VARCHAR to CHAR(5) for fixed-width efficiency\nviviendas_cols <- paste(\n  sapply(1:nrow(viviendas_schema), function(i) {\n    col_name <- viviendas_schema$column_name[i]\n    col_type <- viviendas_schema$column_type[i]\n    # Use CHAR(5) for comuna - fixed width is more efficient\n    if (col_name == \"comuna\") col_type <- \"CHAR(5)\"\n    paste(col_name, col_type)\n  }),\n  collapse = \",\\n    \"\n)\n\nhogares_cols <- paste(\n  sapply(1:nrow(hogares_schema), function(i) {\n    col_name <- hogares_schema$column_name[i]\n    col_type <- hogares_schema$column_type[i]\n    if (col_name == \"comuna\") col_type <- \"CHAR(5)\"\n    paste(col_name, col_type)\n  }),\n  collapse = \",\\n    \"\n)\n\npersonas_cols <- paste(\n  sapply(1:nrow(personas_schema), function(i) {\n    col_name <- personas_schema$column_name[i]\n    col_type <- personas_schema$column_type[i]\n    if (col_name == \"comuna\") col_type <- \"CHAR(5)\"\n    paste(col_name, col_type)\n  }),\n  collapse = \",\\n    \"\n)\n\n# Create new table with PK and FK\ndbExecute(con, paste0(\"\n  CREATE OR REPLACE TABLE viviendas_new (\n    \", viviendas_cols, \",\n    FOREIGN KEY (comuna) REFERENCES codigos_territoriales (codigo_territorial),\n    PRIMARY KEY (id_vivienda, comuna)\n  )\n\"))\n\ndbExecute(con, paste0(\"\n  CREATE OR REPLACE TABLE hogares_new (\n    \", hogares_cols, \",\n    FOREIGN KEY (comuna) REFERENCES codigos_territoriales (codigo_territorial),\n    PRIMARY KEY (id_hogar, id_vivienda, comuna)\n  )\n\"))\n\n# NULLs replaced with \"-999\" to maintain FK constraints\ndbExecute(con, paste0(\"\n  CREATE OR REPLACE TABLE personas_new (\n    \", personas_cols, \",\n    FOREIGN KEY (comuna) REFERENCES codigos_territoriales (codigo_territorial),\n    FOREIGN KEY (p24_lug_resid5_esp) REFERENCES codigos_territoriales_especificos (codigo_especifico),\n    FOREIGN KEY (p25_lug_nacimiento_esp) REFERENCES codigos_territoriales_especificos (codigo_especifico),\n    FOREIGN KEY (p27_nacionalidad_esp) REFERENCES codigos_territoriales_especificos (codigo_especifico),\n    FOREIGN KEY (p44_lug_trab_esp) REFERENCES codigos_territoriales_especificos (codigo_especifico),\n    PRIMARY KEY (id_persona, id_hogar, id_vivienda, comuna)\n  )\n\"))\nInsert√© los datos en las tablas con restricciones y elimin√© las tablas originales.\ndbExecute(con, \"INSERT INTO viviendas_new SELECT * FROM viviendas\")\ndbExecute(con, \"DROP TABLE viviendas\")\ndbExecute(con, \"ALTER TABLE viviendas_new RENAME TO viviendas\")\n\ntbl(con, \"codigos_territoriales_especificos\") |>\n  filter(codigo_especifico == \"13104\")\n\ntbl(con, \"codigos_territoriales_especificos\") |>\n  filter(codigo_especifico == \"07101\")\n\ndbExecute(con, \"INSERT INTO hogares_new SELECT * FROM hogares\")\ndbExecute(con, \"DROP TABLE hogares\")\ndbExecute(con, \"ALTER TABLE hogares_new RENAME TO hogares\")\nDurante la migraci√≥n descubrimos que el c√≥digo ‚Äú10‚Äù aparece en algunas columnas pero no es un c√≥digo territorial escpec√≠fico v√°lido. Lo reemplac√© por ‚Äú-999‚Äù (no aplica).\n# Find all unique codes in p24/p25/p27/p44 that are NOT in codigos_territoriales_especificos\nmissing_codes <- dbGetQuery(con, \"\n  SELECT DISTINCT code FROM (\n    SELECT DISTINCT p24_lug_resid5_esp AS code FROM personas\n    UNION\n    SELECT DISTINCT p25_lug_nacimiento_esp FROM personas\n    UNION\n    SELECT DISTINCT p27_nacionalidad_esp FROM personas\n    UNION\n    SELECT DISTINCT p44_lug_trab_esp FROM personas\n  ) t\n  WHERE code NOT IN (SELECT codigo_especifico FROM codigos_territoriales_especificos)\n  ORDER BY code\n\")\n\n# code 10 is not valid, replace with -999 in personas\ndbSendQuery(con, \"\n  UPDATE personas\n  SET p24_lug_resid5_esp = '-999'\n  WHERE p24_lug_resid5_esp = '10'\n\")\ndbSendQuery(con, \"\n  UPDATE personas\n  SET p25_lug_nacimiento_esp = '-999'\n  WHERE p25_lug_nacimiento_esp = '10'\n\")\ndbSendQuery(con, \"\n  UPDATE personas\n  SET p27_nacionalidad_esp = '-999'\n  WHERE p27_nacionalidad_esp = '10'\n\")\ndbSendQuery(con, \"\n  UPDATE personas\n  SET p44_lug_trab_esp = '-999'\n  WHERE p44_lug_trab_esp = '10'\n\")\nPara evitar problemas de memoria y facilitar la depuraci√≥n, insert√© los datos de personas regi√≥n por regi√≥n.\nregiones <- dbGetQuery(con, \"SELECT DISTINCT SUBSTR(comuna, 1, 2) AS region FROM personas ORDER BY region\")$region\n\nwalk(regiones, function(reg) {\n  tryCatch({\n    message(sprintf(\"Processing region %s\", reg))\n    dbExecute(con, sprintf(\"INSERT INTO personas_new SELECT * FROM personas WHERE SUBSTR(comuna, 1, 2) = '%s'\", reg))\n  }, error = function(e) {\n    message(sprintf(\"Error in region %s: %s\", reg, e$message))\n    stop(sprintf(\"Stopping at region %s\", reg))\n  })\n})\n\ndbExecute(con, \"DROP TABLE personas\")\ndbExecute(con, \"ALTER TABLE personas_new RENAME TO personas\")\n\ntbl(con, \"personas\")\ntbl(con, \"hogares\")\ntbl(con, \"viviendas\")\nCompactaci√≥n final de la base de datos\nFinalmente, compact√© la base de datos export√°ndola a Parquet y reimport√°ndola. Esto elimina el espacio asignado a las operaciones de eliminaci√≥n y actualizaci√≥n.\n# Compact the database by exporting and reimporting\ndbDisconnect(con, shutdown = TRUE)\n\n# Export to parquet, then reimport to a fresh database\ncon <- dbConnect(duckdb::duckdb(), \"censo2024_corregido.duckdb\", read_only = FALSE)\n\n# Create export directory\nexport_dir <- \"censo_export_temp\"\nunlink(export_dir, recursive = TRUE)\ndir.create(export_dir)\n\ndbExecute(con, sprintf(\"EXPORT DATABASE '%s' (FORMAT PARQUET, COMPRESSION ZSTD)\", export_dir))\ndbDisconnect(con, shutdown = TRUE)\n\n# Remove old database and create fresh one\nunlink(\"censo2024_corregido.duckdb\")\nunlink(\"censo2024_corregido.duckdb.wal\")\n\ncon <- dbConnect(duckdb::duckdb(), \"censo2024_corregido.duckdb\", read_only = FALSE)\ndbExecute(con, sprintf(\"IMPORT DATABASE '%s'\", export_dir))\ndbDisconnect(con, shutdown = TRUE)\n\n# Clean up export directory\nunlink(export_dir, recursive = TRUE)\n\n# Show final database size\ndb_size <- file.info(\"censo2024_corregido.duckdb\")$size / 1024^2\nmessage(sprintf(\"Database size: %.1f MB\", db_size))\nEjemplo: Porcentaje de personas provenientes de Venezuela y Per√∫ por regi√≥n\nLa base resultante ocupa 3.3 GB en disco pero tiene la ventaja de que el proceso de leer y filtrar el censo completo para generar la siguiente table toma menos de un segundo gracias a las optimizaciones de DuckDB.\n¬øCu√°ntos Venezolanos y Peruanos hay en cada regi√≥n y qu√© porcentaje representan de la poblaci√≥n total?\ncon <- dbConnect(duckdb::duckdb(), \"censo2024_corregido.duckdb\", read_only = TRUE)\n\ncod_venezuela <- tbl(con, \"codigos_territoriales_especificos\") |>\n  filter(territorio_especifico == \"Venezuela (Rep√∫blica Bolivariana de)\") |>\n  select(codigo_especifico) |>\n  collect() |>\n  pull()\n\ncod_peru <- tbl(con, \"codigos_territoriales_especificos\") |>\n  filter(territorio_especifico == \"Per√∫\") |>\n  select(codigo_especifico) |>\n  collect() |>\n  pull()\n\nvenezolanos_region <- tbl(con, \"personas\") |>\n  filter(p27_nacionalidad_esp == cod_venezuela) |>\n  group_by(comuna) |>\n  summarise(n_venezolanos = n(), .groups = \"drop\") |>  \n  inner_join(\n    tbl(con, \"codigos_territoriales\") |>\n      select(comuna = codigo_territorial, nombre_comuna = territorio)\n  ) |>\n  mutate(\n    region = substr(comuna, 1, 2)\n  ) |>\n  group_by(region) |>\n  summarise(n_venezolanos = sum(n_venezolanos), .groups = \"drop\") |>\n\n  inner_join(\n    tbl(con, \"personas\") |>\n      filter(p27_nacionalidad_esp == cod_peru) |>\n      group_by(comuna) |>\n      summarise(n_peruanos = n(), .groups = \"drop\") |>  \n      inner_join(\n        tbl(con, \"codigos_territoriales\") |>\n          select(comuna = codigo_territorial, nombre_comuna = territorio)\n      ) |>\n      mutate(\n        region = substr(comuna, 1, 2)\n      ) |>\n      group_by(region) |>\n      summarise(n_peruanos = sum(n_peruanos), .groups = \"drop\") |>\n      inner_join(\n        tbl(con, \"codigos_territoriales\") |>\n          select(region = codigo_territorial, nombre_region = territorio) |>\n          filter(str_length(region) == 2)\n      )\n  ) |>\n\n  inner_join(\n    tbl(con, \"personas\") |>\n      mutate(region = substr(comuna, 1, 2)) |>\n      group_by(region) |>\n      summarise(total_personas = n(), .groups = \"drop\")\n  ) |>\n\n  inner_join(\n    tbl(con, \"codigos_territoriales\") |>\n      select(region = codigo_territorial, nombre_region = territorio) |>\n      filter(str_length(region) == 2)\n  ) |>\n\n  mutate(\n    pct_venezolanos = n_venezolanos / total_personas * 100,\n    pct_peruanos = n_peruanos / total_personas * 100\n  ) |>\n  \n  select(\n    region,\n    nombre_region,\n    n_venezolanos,\n    pct_venezolanos,\n    n_peruanos,\n    pct_peruanos,\n    total_personas\n  ) |>\n  \n  collect()\n\ndbDisconnect(con, shutdown = TRUE)\nEl resultado es el siguiente:\n# A tibble: 16 √ó 7\n   region nombre_region    n_venezolanos pct_venezolanos n_peruanos pct_peruanos\n   <chr>  <chr>                    <dbl>           <dbl>      <dbl>        <dbl>\n 1 01     Tarapac√°                 11140           3.01       14534       3.93  \n 2 02     Antofagasta              15882           2.50       13341       2.10  \n 3 03     Atacama                   6411           2.14        2112       0.706 \n 4 04     Coquimbo                 19557           2.35        2613       0.314 \n 5 05     Valpara√≠so               47486           2.50        4859       0.256 \n 6 06     Libertador Gene‚Ä¶         23897           2.42        1914       0.194 \n 7 07     Maule                    23505           2.09        1516       0.135 \n 8 08     Biob√≠o                   29074           1.80        1694       0.105 \n 9 09     La Araucan√≠a              7429           0.735        691       0.0684\n10 10     Los Lagos                18914           2.12         934       0.105 \n11 11     Ays√©n del Gener‚Ä¶           921           0.914        107       0.106 \n12 12     Magallanes y de‚Ä¶          3213           1.93         213       0.128 \n13 13     Metropolitana d‚Ä¶        431283           5.83      165278       2.23  \n14 14     Los R√≠os                  2568           0.645        181       0.0455\n15 15     Arica y Parinac‚Ä¶          6544           2.68        9547       3.90  \n16 16     √ëuble                     5643           1.10         437       0.0853\nAcceso a los datos\nEn el siguiente repositorio:\nhttps://github.com/pachadotdev/censo2024-duckdb\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nhttps://pacha.dev/blog\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
    "main_html": "<article class=\"post-397835 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Censo 2024 de Poblaci√≥n y Viviendas en Chile con C√≥digos Territoriales Corregidos</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">December 4, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/https-pacha-dev-blog/\">https://pacha.dev/blog</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \r\n<div style=\"min-height: 30px;\">\r\n[social4i size=\"small\" align=\"align-left\"]\r\n</div>\r\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\r\n[This article was first published on  <strong><a href=\"https://pacha.dev/blog/2025/12/05/censo2024/index.html\"> https://pacha.dev/blog</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47--><!DOCTYPE html>\n\n<meta charset=\"utf-8\"/>\n<meta content=\"IE=edge\" http-equiv=\"X-UA-Compatible\"/>\n<meta content=\"width=device-width, initial-scale=1.0\" name=\"viewport\"/>\n<title>pacha.dev/blog</title>\n\n<!-- MathJax Configuration -->\n\n\n<!-- Smart header: libraries detected based on content -->\n<!-- File: /tmp/tmp.N7dthHNQVI/index.html -->\n\n<link href=\"https://pacha.dev/blog/libs/bootstrap/bootstrap-icons.css\" rel=\"stylesheet\"/>\n<link append-hash=\"true\" data-mode=\"light\" href=\"https://pacha.dev/blog/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css\" id=\"quarto-bootstrap\" rel=\"stylesheet\"/>\n\n\n<!-- DEBUG: Found sourceCode -->\n<!-- Load custom CSS after any library CSS to ensure proper precedence -->\n<link href=\"https://pacha.dev/blog/css/menu.css\" rel=\"stylesheet\"/>\n<link href=\"https://pacha.dev/blog/css/content.css\" rel=\"stylesheet\"/>\n<div class=\"main-container\">\n<button aria-controls=\"menu\" aria-expanded=\"false\" aria-label=\"Toggle menu\" id=\"menu-toggle\">‚ò∞ Menu</button>\n<div id=\"menu\">\n<header class=\"site-top\">\n<div class=\"site-controls-wrapper\">\n<div class=\"site-controls-row bottom-row\">\n<h1 style=\"margin-bottom: 0 !important;\">Mauricio ‚ÄúPach√°‚Äù Vargas Sep√∫lveda</h1>\n<p>Blog with notes about R, Shiny, SQL, Python, Linux and C++. This blog is listed on <b>R-Bloggers</b>.</p>\n</div>\n<div class=\"site-controls-row top-row\">\n<input id=\"search-box\" placeholder=\"Search...\" type=\"text\"/>\n<button aria-label=\"Toggle dark mode\" id=\"theme-toggle\" title=\"Toggle dark mode\">Dark mode on</button>\n<button aria-label=\"Decrease font size\" id=\"font-decrease\" title=\"Decrease font size\">A-</button>\n<button aria-label=\"Increase font size\" id=\"font-increase\" title=\"Increase font size\">A+</button>\n</div>\n</div>\n</header>\n<center><a class=\"home-link\" href=\"https://pacha.dev/blog/\" rel=\"nofollow\" target=\"_blank\">HOME üè†</a></center>\n<!-- categories are printed below this-->\n\n</div>\n<div id=\"page\">\n<div id=\"content\">\n<header class=\"quarto-title-block default\" id=\"title-block-header\">\n<div class=\"quarto-title\">\n<h1 class=\"title\">Censo 2024 de Poblaci√≥n y Viviendas en Chile con C√≥digos Territoriales Corregidos</h1>\n<div class=\"quarto-categories\">\n<div class=\"quarto-category\"><a href=\"https://pacha.dev/blog//R/\" rel=\"nofollow\" target=\"_blank\">R</a></div>\n<div class=\"quarto-category\"><a href=\"https://pacha.dev/blog//DuckDB/\" rel=\"nofollow\" target=\"_blank\">DuckDB</a></div>\n</div>\n</div>\n<div>\n<div class=\"description\">\n    He liberado los datos censales en formato DuckDB para proporcionar los datos censales con los c√≥digos de regi√≥n, provincia y comuna corregidos y adem√°s con llaves for√°neas para ayudar en los cruces de tablas.\n  </div>\n</div>\n<div class=\"quarto-title-meta\">\n<div>\n<div class=\"quarto-title-meta-heading\">Author</div>\n<div class=\"quarto-title-meta-contents\">\n<p>Mauricio ‚ÄúPach√°‚Äù Vargas S. </p>\n</div>\n</div>\n<div>\n<div class=\"quarto-title-meta-heading\">Published</div>\n<div class=\"quarto-title-meta-contents\">\n<p class=\"date\">December 5, 2025</p>\n</div>\n</div>\n</div>\n</header>\n<p><em>Si esta publicaci√≥n te resulta √∫til, te agradecer√≠a que hicieras una peque√±a donaci√≥n en <a href=\"https://buymeacoffee.com/pacha/e/80976\" rel=\"nofollow\" target=\"_blank\">Buy Me a Coffee</a>. La utilizar√© para continuar con mis iniciativas de c√≥digo abierto.</em></p>\n<p><em>Puedes enviarme preguntas para el blog utilizando <a href=\"https://docs.google.com/forms/d/e/1FAIpQLScMpMtKjDe2h53iHUvlYHDdBNMD1_x9WO5wg5wi_EO7ak_DRA/viewform?%20usp=sharing&amp;ouid=115091451666829859711\" rel=\"nofollow\" target=\"_blank\">este formulario</a> y suscribirse para recibir un correo electr√≥nico cuando haya una nueva publicaci√≥n.</em></p>\n<p>Luego de analizar los datos censales del d√≠a 4 de diciembre en <a href=\"https://pacha.dev/blog/2025/12/04/censo2024/index.html\" rel=\"nofollow\" target=\"_blank\">este post</a>, el mismo d√≠a que se liberaron los microdatos del censo, decid√≠ utilizar dichos datos para dar un ejemplo de flujos migratorios en el contexto del modelo de gravedad estructural.</p>\n<p>Tuve que reemplazar valores en ‚Äúp27_nacionalidad_nac‚Äù (lugar de nacimiento), ‚Äúp27_nacionalidad_esp‚Äù (nacionalidad) y ‚Äúp44_lug_trab_esp‚Äù (lugar de trabajo) por -999 ya que ‚Äú10‚Äù no es un valor en los c√≥digos territoriales espec√≠ficos.La necesidad de utilizar -999 (no aplica) en las llaves for√°neas es para distinguir ‚ÄúNA‚Äù/‚ÄúNULL‚Äù del caso -99 (no responde), pues estas no admiten valores nulos.</p>\n<p>Dicho trabajo adicional no deber√≠a ser realizado si quienes publican estos datos revisaran dos veces y publicaran una, pero dado que no es as√≠, he decidido compartir mis correcciones para que otros puedan beneficiarse de ellas y no perder tiempo corrigiendo los mismos errores.</p>\n<section class=\"level2\" id=\"paso-1-instalaci√≥n-y-carga-de-paquetes\">\n<h2 class=\"anchored\" data-anchor-id=\"paso-1-instalaci√≥n-y-carga-de-paquetes\">Paso 1: Instalaci√≥n y carga de paquetes</h2>\n<p>Utilic√© los siguientes paquetes de R para manejar la descarga, lectura, limpieza y organizaci√≥n de los datos:</p>\n<ul>\n<li><strong>archive</strong>: Extraer archivos comprimidos (ZIP, 7z, etc.)</li>\n<li><strong>arrow</strong>: Leer archivos Parquet</li>\n<li><strong>duckdb</strong>: Leer/escribir de datos SQL portable</li>\n<li><strong>readxl</strong>: Leer archivos Excel</li>\n<li><strong>dplyr</strong>: Manipulaci√≥n de datos (filtrar, agrupar, resumir)</li>\n<li><strong>dbplyr</strong>: Uso sintaxis de dplyr con SQL</li>\n<li><strong>janitor</strong>: Limpiar nombres de columnas</li>\n<li><strong>stringr</strong>: Manipulaci√≥n de texto</li>\n<li><strong>purrr</strong>: Iteraciones (e.g., copiar una regi√≥n a la vez)</li>\n</ul>\n<pre># 1: packages ----\n\nif (!require(archive)) install.packages(\"archive\", repos = \"http://cran.r-project.org\")\nif (!require(arrow)) install.packages(\"arrow\", repos = \"http://cran.r-project.org\")\nif (!require(duckdb)) install.packages(\"duckdb\", repos = \"http://cran.r-project.org\")\nif (!require(readxl)) install.packages(\"readxl\", repos = \"http://cran.r-project.org\")\nif (!require(dplyr)) install.packages(\"dplyr\", repos = \"http://cran.r-project.org\")\nif (!require(dbplyr)) install.packages(\"dbplyr\", repos = \"http://cran.r-project.org\")\nif (!require(janitor)) install.packages(\"janitor\", repos = \"http://cran.r-project.org\")\nif (!require(stringr)) install.packages(\"stringr\", repos = \"http://cran.r-project.org\")\nif (!require(purrr)) install.packages(\"purrr\", repos = \"http://cran.r-project.org\")\n\nlibrary(archive)\nlibrary(arrow)\nlibrary(duckdb)\nlibrary(readxl)\nlibrary(dplyr)\nlibrary(janitor)\nlibrary(stringr)\nlibrary(purrr)</pre>\n</section>\n<section class=\"level2\" id=\"paso-2-descarga-y-lectura-de-datos-brutos\">\n<h2 class=\"anchored\" data-anchor-id=\"paso-2-descarga-y-lectura-de-datos-brutos\">Paso 2: Descarga y lectura de datos brutos</h2>\n<p>Descargu√© los microdatos del Censo 2024 desde el servidor del INE. El archivo ZIP contiene tres archivos Parquet (personas, hogares, viviendas) y un diccionario en Excel que explica qu√© significa cada variable y c√≥digo.</p>\n<pre># 2: raw data ----\n\nurl &lt;- \"https://storage.googleapis.com/bktdescargascenso2024/viv_hog_per_censo2024.zip\"\nzip &lt;- paste0(\"\", basename(url))\n\nif (!file.exists(zip)) {\n  download.file(url, zip, mode = \"wb\")\n}\n\narchive_extract(zip, dir = dirname(zip))</pre>\n<p>Cre√© una funci√≥n auxiliar para leer las distintas hojas del diccionario Excel. La funci√≥n <code>clean_names()</code> convierte los nombres de las columnas a un formato consistente (min√∫sculas, sin espacios).</p>\n<pre>read_dic &lt;- function(file = \"diccionario_variables_censo2024.xlsx\", sheet) {\n  read_excel(file, sheet = sheet) |&gt;\n    clean_names()\n}\n\ncodigos_personas &lt;- read_dic(sheet = \"tabla_personas\")\n\ncodigos_personas |&gt;\n  filter(nombre_variable == \"cine11\")\n\ncodigos_hogares &lt;- read_dic(sheet = \"tabla_hogares\")\n\ncodigos_viviendas &lt;- read_dic(sheet = \"tabla_viviendas\")\n\ncodigos_territoriales &lt;- read_dic(sheet = \"codigos_territoriales\")\n\ncodigos_territoriales_especificos &lt;- read_dic(sheet = \"cod_territoriales_especificos\")</pre>\n<p>Le√≠ los archivos y debo reconocer que el INE tom√≥ unabuena decisi√≥n al proporcionar estos archivos adem√°s de CSV. El formato Parquet es muy eficiente para datos grandes porque usa compresi√≥n, utlizando alrededor de 300 MB para el censo completo.</p>\n<pre>personas &lt;- read_parquet(\"personas_censo2024.parquet\")\n\nhogares &lt;- read_parquet(\"hogares_censo2024.parquet\")\n\nviviendas &lt;- read_parquet(\"viviendas_censo2024.parquet\")</pre>\n<p>La siguiente funci√≥n limpia todas las columnas de texto: elimina espacios m√∫ltiples, saltos de l√≠nea y espacios al inicio o final. Esto es importante porque los datos brutos tienen inconsistencias de formato.</p>\n<pre># for all chr-type columns, replace multiple spaces / new lines with single space, trim leading/trailing spaces\nclean_chr_cols &lt;- function(df) {\n  chr_cols &lt;- names(df)[sapply(df, is.character)]\n  df &lt;- df |&gt; mutate(across(all_of(chr_cols), ~ str_squish(str_trim(.))))\n  return(df)\n}\n\ncodigos_personas &lt;- clean_chr_cols(codigos_personas) |&gt;\n  select(-entidad)\n\ncodigos_hogares &lt;- clean_chr_cols(codigos_hogares) |&gt;\n  select(-entidad)\n\ncodigos_viviendas &lt;- clean_chr_cols(codigos_viviendas) |&gt;\n  select(-entidad)\n\npersonas &lt;- clean_chr_cols(personas)\nhogares &lt;- clean_chr_cols(hogares)\nviviendas &lt;- clean_chr_cols(viviendas)</pre>\n</section>\n<section class=\"level2\" id=\"el-problema-con-los-c√≥digos-de-regi√≥n\">\n<h2 class=\"anchored\" data-anchor-id=\"el-problema-con-los-c√≥digos-de-regi√≥n\">El problema con los c√≥digos de regi√≥n</h2>\n<p>Este es el problema que detect√© en el post del d√≠a 4 de diciembre. Los c√≥digos de regi√≥n en los datos no son √∫nicos. Esto rompe los cruces directos con la tabla de c√≥digos territoriales.</p>\n<pre># 3: problem with \"region\" ----\n\nglimpse(personas)\n\npersonas_educacion &lt;- personas |&gt;\n  group_by(region, cine11) |&gt;\n  summarise(total = n(), .groups = \"drop\") |&gt;\n  collect() |&gt;\n\n  inner_join(\n    codigos_personas |&gt;\n        filter(nombre_variable == \"cine11\") |&gt;\n        select(cine11 = valor, nivel_educacional = etiqueta_de_categoria) |&gt;\n        mutate(cine11 = as.integer(cine11))\n  ) |&gt;\n\n  inner_join(\n    codigos_territoriales |&gt;\n        select(region = codigo_territorial, nombre_region = territorio) |&gt;\n        mutate(region = as.integer(region))\n  )\n\ncodigos_territoriales |&gt;\n    filter(codigo_territorial %in% 1:16) |&gt;\n    group_by(codigo_territorial) |&gt;\n    filter(n() &gt; 1)</pre>\n<p>Como los c√≥digos de comuna son √∫nicos (5 d√≠gitos), podemos usarlos para hacer los cruces y luego derivar la regi√≥n a partir de los primeros 2 d√≠gitos del c√≥digo de comuna.</p>\n<pre>personas_educacion &lt;- personas |&gt;\n  group_by(comuna, cine11) |&gt;\n  summarise(total = n(), .groups = \"drop\") |&gt;\n  collect() |&gt;\n\n  inner_join(\n    codigos_personas |&gt;\n        filter(nombre_variable == \"cine11\") |&gt;\n        select(cine11 = valor, nivel_educacional = etiqueta_de_categoria) |&gt;\n        mutate(cine11 = as.integer(cine11))\n  ) |&gt;\n\n  inner_join(\n    codigos_territoriales |&gt;\n        select(comuna = codigo_territorial, nombre_comuna = territorio) |&gt;\n        mutate(comuna = as.integer(comuna))\n  )\n\npersonas_educacion &lt;- personas_educacion |&gt;\n  mutate(\n    comuna = str_pad(comuna, width = 5, side = \"left\", pad = \"0\"),\n    region = str_sub(comuna, 1, 2),\n    nombre_region = case_when(\n      region == \"15\" ~ \"Regi√≥n de Arica y Parinacota\",\n      region == \"01\" ~ \"Regi√≥n de Tarapac√°\",\n      region == \"02\" ~ \"Regi√≥n de Antofagasta\",\n      region == \"03\" ~ \"Regi√≥n de Atacama\",\n      region == \"04\" ~ \"Regi√≥n de Coquimbo\",\n      region == \"05\" ~ \"Regi√≥n de Valpara√≠so\",\n      region == \"13\" ~ \"Regi√≥n Metropolitana de Santiago\",\n      region == \"06\" ~ \"Regi√≥n del Libertador General Bernardo O'Higgins\",\n      region == \"07\" ~ \"Regi√≥n del Maule\",\n      region == \"16\" ~ \"Regi√≥n de √ëuble\",\n      region == \"08\" ~ \"Regi√≥n del B√≠o B√≠o\",\n      region == \"09\" ~ \"Regi√≥n de La Araucan√≠a\",\n      region == \"14\" ~ \"Regi√≥n de Los R√≠os\",\n      region == \"10\" ~ \"Regi√≥n de Los Lagos\",\n      region == \"11\" ~ \"Regi√≥n de Ays√©n del General Carlos Ib√°√±ez del Campo\",\n      region == \"12\" ~ \"Regi√≥n de Magallanes y de la Ant√°rtica Chilena\",\n      TRUE ~ \"Desconocida\"\n    )\n  )</pre>\n</section>\n<section class=\"level2\" id=\"correcci√≥n-definitiva-de-los-c√≥digos\">\n<h2 class=\"anchored\" data-anchor-id=\"correcci√≥n-definitiva-de-los-c√≥digos\">Correcci√≥n definitiva de los c√≥digos</h2>\n<p>Esta es la correcci√≥n principal. El problema es que los c√≥digos de comuna de 4 d√≠gitos (como 1101 para Iquique) deben tener un cero adelante para quedar como 5 d√≠gitos (01101). Adem√°s, las columnas de c√≥digos territoriales espec√≠ficos (lugar de residencia hace 5 a√±os, lugar de nacimiento, nacionalidad, lugar de trabajo) tambi√©n necesitan esta correcci√≥n.</p>\n<p>Usamos <code>-999</code> para marcar valores que no aplican (por ejemplo, lugar de trabajo para menores de edad), distingui√©ndolo de <code>-99</code> que significa ‚Äúno responde‚Äù.</p>\n<pre># 4: proper fix ----\n\npersonas &lt;- personas |&gt;\n  mutate(\n    comuna = str_pad(comuna, width = 5, side = \"left\", pad = \"0\"),\n    # NOTE: region and provincia removed - derive with substr(comuna, 1, 2) and substr(comuna, 1, 3)\n    # Convert to VARCHAR and pad to 5 digits for FK to codigos_territoriales_especificos\n    # First clean, then only pad codes of length 4 (comunas that need leading zero)\n    # Replace NA with \"-999\" for consistency with census data and FK constraints\n    p24_lug_resid5_esp = case_when(\n      is.na(p24_lug_resid5_esp) ~ \"-999\",\n      TRUE ~ str_squish(str_trim(as.character(p24_lug_resid5_esp)))\n    ),\n\n    p24_lug_resid5_esp = case_when(\n      p24_lug_resid5_esp == \"-999\" ~ \"-999\",\n      str_detect(p24_lug_resid5_esp, \"^[0-9]+$\") &amp; str_length(p24_lug_resid5_esp) == 4 ~ str_pad(p24_lug_resid5_esp, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ p24_lug_resid5_esp\n    ),\n    \n    p25_lug_nacimiento_esp = case_when(\n      is.na(p25_lug_nacimiento_esp) ~ \"-999\",\n      TRUE ~ str_squish(str_trim(as.character(p25_lug_nacimiento_esp)))\n    ),\n    \n    p25_lug_nacimiento_esp = case_when(\n      p25_lug_nacimiento_esp == \"-999\" ~ \"-999\",\n      str_detect(p25_lug_nacimiento_esp, \"^[0-9]+$\") &amp; str_length(p25_lug_nacimiento_esp) == 4 ~ str_pad(p25_lug_nacimiento_esp, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ p25_lug_nacimiento_esp\n    ),\n    \n    p27_nacionalidad_esp = case_when(\n      is.na(p27_nacionalidad_esp) ~ \"-999\",\n      TRUE ~ str_squish(str_trim(as.character(p27_nacionalidad_esp)))\n    ),\n    \n    p27_nacionalidad_esp = case_when(\n      p27_nacionalidad_esp == \"-999\" ~ \"-999\",\n      str_detect(p27_nacionalidad_esp, \"^[0-9]+$\") &amp; str_length(p27_nacionalidad_esp) == 4 ~ str_pad(p27_nacionalidad_esp, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ p27_nacionalidad_esp\n    ),\n    \n    p44_lug_trab_esp = case_when(\n      is.na(p44_lug_trab_esp) ~ \"-999\",\n      TRUE ~ str_squish(str_trim(as.character(p44_lug_trab_esp)))\n    ),\n    \n    p44_lug_trab_esp = case_when(\n      p44_lug_trab_esp == \"-999\" ~ \"-999\",\n      str_detect(p44_lug_trab_esp, \"^[0-9]+$\") &amp; str_length(p44_lug_trab_esp) == 4 ~ str_pad(p44_lug_trab_esp, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ p44_lug_trab_esp\n    )\n  ) |&gt;\n  select(-any_of(c(\"region\", \"provincia\")))</pre>\n<p>Los c√≥digos de regi√≥n tambi√©n necesitan estandarizaci√≥n. Por ejemplo, la Regi√≥n de Tarapac√° deber√≠a ser ‚Äú01‚Äù (no ‚Äú1‚Äù), y las comunas deben tener 5 d√≠gitos. Adem√°s, hay que corregir manualmente algunos casos donde el mismo c√≥digo se usaba para entidades diferentes.</p>\n<pre>codigos_territoriales &lt;- codigos_territoriales |&gt;\n  mutate(\n    codigo_territorial = case_when(\n      codigo_territorial &lt;= 16 ~ str_pad(codigo_territorial, width = 2, side = \"left\", pad = \"0\"),\n      codigo_territorial &gt; 16 &amp; codigo_territorial &lt;= 99 ~ str_pad(codigo_territorial, width = 3, side = \"left\", pad = \"0\"),\n      str_length(codigo_territorial) == 4 ~ str_pad(codigo_territorial, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ as.character(codigo_territorial)\n    ),\n    codigo_territorial = case_when(\n      territorio == \"Arica y Parinacota\" &amp; str_length(codigo_territorial) == 2 ~ \"15\",\n      territorio == \"Tarapac√°\" &amp; str_length(codigo_territorial) == 2 ~ \"01\",\n      territorio == \"Iquique\" &amp; str_length(codigo_territorial) == 2 ~ \"011\",\n      territorio == \"Del Tamarugal\" &amp; str_length(codigo_territorial) == 2 ~ \"014\",\n      territorio == \"Antofagasta\" &amp; str_length(codigo_territorial) == 2 ~ \"02\",\n      territorio == \"Atacama\" &amp; str_length(codigo_territorial) == 2 ~ \"03\",\n      territorio == \"Coquimbo\" &amp; str_length(codigo_territorial) == 2 ~ \"04\",\n      territorio == \"Valpara√≠so\" &amp; str_length(codigo_territorial) == 2 ~ \"05\",\n      territorio == \"Metropolitana de Santiago\" &amp; str_length(codigo_territorial) == 2 ~ \"13\",\n      territorio == \"Libertador General Bernardo O'Higgins\" &amp; str_length(codigo_territorial) == 2 ~ \"06\",\n      territorio == \"Maule\" &amp; str_length(codigo_territorial) == 2 ~ \"07\",\n      territorio == \"√ëuble\" &amp; str_length(codigo_territorial) == 2 ~ \"16\",\n      territorio == \"Biob√≠o\" &amp; str_length(codigo_territorial) == 2 ~ \"08\",\n      territorio == \"La Araucan√≠a\" &amp; str_length(codigo_territorial) == 2 ~ \"09\",\n      territorio == \"Los R√≠os\" &amp; str_length(codigo_territorial) == 2 ~ \"14\",\n      territorio == \"Los Lagos\" &amp; str_length(codigo_territorial) == 2 ~ \"10\",\n      territorio == \"Ays√©n del General Carlos Ib√°√±ez del Campo\" &amp; str_length(codigo_territorial) == 2 ~ \"11\",\n      territorio == \"Magallanes y de la Ant√°rtica Chilena\" &amp; str_length(codigo_territorial) == 2 ~ \"12\",\n      TRUE ~ codigo_territorial\n    )\n  )\n\ncodigos_territoriales |&gt;\n  filter(str_length(codigo_territorial) == 2) |&gt;\n  arrange(codigo_territorial) |&gt;\n  print(n = 30)\n\ncodigos_territoriales |&gt;\n  distinct()</pre>\n<p>Para los c√≥digos espec√≠ficos (pa√≠ses, comunas para variables de migraci√≥n/trabajo) es similar:</p>\n<pre># similar for codigos_territoriales_especificos\n# len 4 -&gt; add 0, and ensure character type\n\ncodigos_territoriales_especificos &lt;- codigos_territoriales_especificos |&gt;\n  mutate(\n    codigo_especifico = as.character(codigo_especifico),\n    codigo_especifico = case_when(\n      str_length(codigo_especifico) == 4 ~ str_pad(codigo_especifico, width = 5, side = \"left\", pad = \"0\"),\n      TRUE ~ codigo_especifico\n    )\n  )</pre>\n<p>Las columnas de lugar de residencia, nacimiento, nacionalidad y trabajo pueden contener tanto c√≥digos de comuna chilenas como c√≥digos de pa√≠ses. Para que las llaves for√°neas funcionen, necesitamos una tabla unificada que contenga todos los c√≥digos posibles.</p>\n<pre># The p24, p25, p27, p44 columns contain BOTH comuna codes (from codigos_territoriales)\n# AND country/special codes (from codigos_territoriales_especificos)\n# We need to add all comuna codes to codigos_territoriales_especificos for FK to work\n# Also add special codes: -66 (anonimizado), -99 (no respuesta)\ncodigos_territoriales_especificos &lt;- codigos_territoriales_especificos |&gt;\n  bind_rows(\n    codigos_territoriales |&gt;\n      filter(str_length(codigo_territorial) == 5) |&gt;\n      select(codigo_especifico = codigo_territorial, territorio_especifico = territorio)\n  ) |&gt;\n  bind_rows(\n    tibble(\n      codigo_especifico = c(\"-66\", \"-99\", \"-999\"),\n      territorio_especifico = c(\"Anonimizado\", \"No respuesta\", \"No aplica\")\n    )\n  ) |&gt;\n  distinct(codigo_especifico, .keep_all = TRUE)</pre>\n</section>\n<section class=\"level2\" id=\"organizaci√≥n-en-base-de-datos-sql-duckdb\">\n<h2 class=\"anchored\" data-anchor-id=\"organizaci√≥n-en-base-de-datos-sql-duckdb\">Organizaci√≥n en base de datos SQL (DuckDB)</h2>\n<p>Export√© los datos a una base de datos DuckDB. Esto tiene varias ventajas:</p>\n<ol type=\"1\">\n<li><strong>Integridad referencial</strong>: Las llaves for√°neas garantizan que no haya c√≥digos inv√°lidos (esto me permiti√≥ detectar errores y actualizar el c√≥digo)</li>\n<li><strong>Eficiencia</strong>: DuckDB est√° optimizado para consultas anal√≠ticas</li>\n<li><strong>Portabilidad</strong>: Un solo archivo que contiene toda la base de datos</li>\n</ol>\n<pre># 5: organize in SQL ---\n\n# same fix as for personas\n\nhogares &lt;- hogares |&gt;\n  mutate(\n    comuna = str_pad(comuna, width = 5, side = \"left\", pad = \"0\")\n  ) |&gt;\n  select(-any_of(c(\"region\", \"provincia\")))\n\nviviendas &lt;- viviendas |&gt;\n  mutate(\n    comuna = str_pad(comuna, width = 5, side = \"left\", pad = \"0\")\n  ) |&gt;\n  select(-any_of(c(\"region\", \"provincia\")))\n\n# persona: id_hogar -&gt; hogar: id_hogar\n# persona: id_vivienda -&gt; vivienda: id_vivienda\n\nlength(unique(personas$id_hogar)) # -&gt; add comuna to deambiguate</pre>\n<p>Escrib√≠ las tablas corregidas en una nueva base de datos DuckDB:</p>\n<pre>unlink(\"censo2024_corregido.duckdb\")\nunlink(\"censo2024_corregido.duckdb.wal\")\n\ncon &lt;- dbConnect(duckdb::duckdb(), \"censo2024_corregido.duckdb\", read_only = FALSE)\n\ndbWriteTable(con, \"personas\", personas, overwrite = TRUE)\ndbWriteTable(con, \"hogares\", hogares, overwrite = TRUE)\ndbWriteTable(con, \"viviendas\", viviendas, overwrite = TRUE)\n\ndbWriteTable(con, \"codigos_personas\", codigos_personas, overwrite = TRUE)\ndbWriteTable(con, \"codigos_hogares\", codigos_hogares, overwrite = TRUE)\ndbWriteTable(con, \"codigos_viviendas\", codigos_viviendas, overwrite = TRUE)\n\ndbWriteTable(con, \"codigos_territoriales\", codigos_territoriales, overwrite = TRUE)\ndbWriteTable(con, \"codigos_territoriales_especificos\", codigos_territoriales_especificos, overwrite = TRUE)\n\ngc()</pre>\n<p>A diferencia de PostgreSQL, DuckDB no permite agregar restricciones a tablas existentes con <code>ALTER TABLE</code>, as√≠ que deb√≠ recrear las tablas con las restricciones definidas desde el inicio.</p>\n<pre># DuckDB doesn't support ALTER TABLE for adding constraints\n# We need to recreate tables with constraints using CREATE TABLE ... AS\n\n# First, add primary keys by recreating tables\ndbExecute(con, \"\n  CREATE OR REPLACE TABLE codigos_territoriales_new (\n    codigo_territorial VARCHAR PRIMARY KEY,\n    territorio VARCHAR\n  )\n\")\n\n# Note: codigo_territorial uses VARCHAR because it has variable length (2, 3, or 5 chars)\n# comuna columns in main tables will be converted to CHAR(5) for efficiency\ndbExecute(con, \"INSERT INTO codigos_territoriales_new SELECT * FROM codigos_territoriales\")\ndbExecute(con, \"DROP TABLE codigos_territoriales\")\ndbExecute(con, \"ALTER TABLE codigos_territoriales_new RENAME TO codigos_territoriales\")\n\ndbExecute(con, \"\n  CREATE OR REPLACE TABLE codigos_territoriales_especificos_new (\n    codigo_especifico VARCHAR PRIMARY KEY,\n    territorio_especifico VARCHAR\n  )\n\")\ndbExecute(con, \"INSERT INTO codigos_territoriales_especificos_new SELECT * FROM codigos_territoriales_especificos\")\ndbExecute(con, \"DROP TABLE codigos_territoriales_especificos\")\ndbExecute(con, \"ALTER TABLE codigos_territoriales_especificos_new RENAME TO codigos_territoriales_especificos\")</pre>\n<p>Luego cre√© las tablas principales (viviendas, hogares, personas) con sus llaves primarias y for√°neas. Esto garantiza la integridad de los datos (e.g.¬†que no existan valores en la tabla de personas u otra tabla que no est√°n no descritos en las tablas de c√≥digos territoriales).</p>\n<pre># Get all column names and types from hogares\nviviendas_schema &lt;- dbGetQuery(con, \"DESCRIBE viviendas\")\nhogares_schema &lt;- dbGetQuery(con, \"DESCRIBE hogares\")\npersonas_schema &lt;- dbGetQuery(con, \"DESCRIBE personas\")\n\n# Build the column definitions dynamically\n# Convert comuna from VARCHAR to CHAR(5) for fixed-width efficiency\nviviendas_cols &lt;- paste(\n  sapply(1:nrow(viviendas_schema), function(i) {\n    col_name &lt;- viviendas_schema$column_name[i]\n    col_type &lt;- viviendas_schema$column_type[i]\n    # Use CHAR(5) for comuna - fixed width is more efficient\n    if (col_name == \"comuna\") col_type &lt;- \"CHAR(5)\"\n    paste(col_name, col_type)\n  }),\n  collapse = \",\\n    \"\n)\n\nhogares_cols &lt;- paste(\n  sapply(1:nrow(hogares_schema), function(i) {\n    col_name &lt;- hogares_schema$column_name[i]\n    col_type &lt;- hogares_schema$column_type[i]\n    if (col_name == \"comuna\") col_type &lt;- \"CHAR(5)\"\n    paste(col_name, col_type)\n  }),\n  collapse = \",\\n    \"\n)\n\npersonas_cols &lt;- paste(\n  sapply(1:nrow(personas_schema), function(i) {\n    col_name &lt;- personas_schema$column_name[i]\n    col_type &lt;- personas_schema$column_type[i]\n    if (col_name == \"comuna\") col_type &lt;- \"CHAR(5)\"\n    paste(col_name, col_type)\n  }),\n  collapse = \",\\n    \"\n)\n\n# Create new table with PK and FK\ndbExecute(con, paste0(\"\n  CREATE OR REPLACE TABLE viviendas_new (\n    \", viviendas_cols, \",\n    FOREIGN KEY (comuna) REFERENCES codigos_territoriales (codigo_territorial),\n    PRIMARY KEY (id_vivienda, comuna)\n  )\n\"))\n\ndbExecute(con, paste0(\"\n  CREATE OR REPLACE TABLE hogares_new (\n    \", hogares_cols, \",\n    FOREIGN KEY (comuna) REFERENCES codigos_territoriales (codigo_territorial),\n    PRIMARY KEY (id_hogar, id_vivienda, comuna)\n  )\n\"))\n\n# NULLs replaced with \"-999\" to maintain FK constraints\ndbExecute(con, paste0(\"\n  CREATE OR REPLACE TABLE personas_new (\n    \", personas_cols, \",\n    FOREIGN KEY (comuna) REFERENCES codigos_territoriales (codigo_territorial),\n    FOREIGN KEY (p24_lug_resid5_esp) REFERENCES codigos_territoriales_especificos (codigo_especifico),\n    FOREIGN KEY (p25_lug_nacimiento_esp) REFERENCES codigos_territoriales_especificos (codigo_especifico),\n    FOREIGN KEY (p27_nacionalidad_esp) REFERENCES codigos_territoriales_especificos (codigo_especifico),\n    FOREIGN KEY (p44_lug_trab_esp) REFERENCES codigos_territoriales_especificos (codigo_especifico),\n    PRIMARY KEY (id_persona, id_hogar, id_vivienda, comuna)\n  )\n\"))</pre>\n<p>Insert√© los datos en las tablas con restricciones y elimin√© las tablas originales.</p>\n<pre>dbExecute(con, \"INSERT INTO viviendas_new SELECT * FROM viviendas\")\ndbExecute(con, \"DROP TABLE viviendas\")\ndbExecute(con, \"ALTER TABLE viviendas_new RENAME TO viviendas\")\n\ntbl(con, \"codigos_territoriales_especificos\") |&gt;\n  filter(codigo_especifico == \"13104\")\n\ntbl(con, \"codigos_territoriales_especificos\") |&gt;\n  filter(codigo_especifico == \"07101\")\n\ndbExecute(con, \"INSERT INTO hogares_new SELECT * FROM hogares\")\ndbExecute(con, \"DROP TABLE hogares\")\ndbExecute(con, \"ALTER TABLE hogares_new RENAME TO hogares\")</pre>\n<p>Durante la migraci√≥n descubrimos que el c√≥digo ‚Äú10‚Äù aparece en algunas columnas pero no es un c√≥digo territorial escpec√≠fico v√°lido. Lo reemplac√© por ‚Äú-999‚Äù (no aplica).</p>\n<pre># Find all unique codes in p24/p25/p27/p44 that are NOT in codigos_territoriales_especificos\nmissing_codes &lt;- dbGetQuery(con, \"\n  SELECT DISTINCT code FROM (\n    SELECT DISTINCT p24_lug_resid5_esp AS code FROM personas\n    UNION\n    SELECT DISTINCT p25_lug_nacimiento_esp FROM personas\n    UNION\n    SELECT DISTINCT p27_nacionalidad_esp FROM personas\n    UNION\n    SELECT DISTINCT p44_lug_trab_esp FROM personas\n  ) t\n  WHERE code NOT IN (SELECT codigo_especifico FROM codigos_territoriales_especificos)\n  ORDER BY code\n\")\n\n# code 10 is not valid, replace with -999 in personas\ndbSendQuery(con, \"\n  UPDATE personas\n  SET p24_lug_resid5_esp = '-999'\n  WHERE p24_lug_resid5_esp = '10'\n\")\ndbSendQuery(con, \"\n  UPDATE personas\n  SET p25_lug_nacimiento_esp = '-999'\n  WHERE p25_lug_nacimiento_esp = '10'\n\")\ndbSendQuery(con, \"\n  UPDATE personas\n  SET p27_nacionalidad_esp = '-999'\n  WHERE p27_nacionalidad_esp = '10'\n\")\ndbSendQuery(con, \"\n  UPDATE personas\n  SET p44_lug_trab_esp = '-999'\n  WHERE p44_lug_trab_esp = '10'\n\")</pre>\n<p>Para evitar problemas de memoria y facilitar la depuraci√≥n, insert√© los datos de personas regi√≥n por regi√≥n.</p>\n<pre>regiones &lt;- dbGetQuery(con, \"SELECT DISTINCT SUBSTR(comuna, 1, 2) AS region FROM personas ORDER BY region\")$region\n\nwalk(regiones, function(reg) {\n  tryCatch({\n    message(sprintf(\"Processing region %s\", reg))\n    dbExecute(con, sprintf(\"INSERT INTO personas_new SELECT * FROM personas WHERE SUBSTR(comuna, 1, 2) = '%s'\", reg))\n  }, error = function(e) {\n    message(sprintf(\"Error in region %s: %s\", reg, e$message))\n    stop(sprintf(\"Stopping at region %s\", reg))\n  })\n})\n\ndbExecute(con, \"DROP TABLE personas\")\ndbExecute(con, \"ALTER TABLE personas_new RENAME TO personas\")\n\ntbl(con, \"personas\")\ntbl(con, \"hogares\")\ntbl(con, \"viviendas\")</pre>\n</section>\n<section class=\"level2\" id=\"compactaci√≥n-final-de-la-base-de-datos\">\n<h2 class=\"anchored\" data-anchor-id=\"compactaci√≥n-final-de-la-base-de-datos\">Compactaci√≥n final de la base de datos</h2>\n<p>Finalmente, compact√© la base de datos export√°ndola a Parquet y reimport√°ndola. Esto elimina el espacio asignado a las operaciones de eliminaci√≥n y actualizaci√≥n.</p>\n<pre># Compact the database by exporting and reimporting\ndbDisconnect(con, shutdown = TRUE)\n\n# Export to parquet, then reimport to a fresh database\ncon &lt;- dbConnect(duckdb::duckdb(), \"censo2024_corregido.duckdb\", read_only = FALSE)\n\n# Create export directory\nexport_dir &lt;- \"censo_export_temp\"\nunlink(export_dir, recursive = TRUE)\ndir.create(export_dir)\n\ndbExecute(con, sprintf(\"EXPORT DATABASE '%s' (FORMAT PARQUET, COMPRESSION ZSTD)\", export_dir))\ndbDisconnect(con, shutdown = TRUE)\n\n# Remove old database and create fresh one\nunlink(\"censo2024_corregido.duckdb\")\nunlink(\"censo2024_corregido.duckdb.wal\")\n\ncon &lt;- dbConnect(duckdb::duckdb(), \"censo2024_corregido.duckdb\", read_only = FALSE)\ndbExecute(con, sprintf(\"IMPORT DATABASE '%s'\", export_dir))\ndbDisconnect(con, shutdown = TRUE)\n\n# Clean up export directory\nunlink(export_dir, recursive = TRUE)\n\n# Show final database size\ndb_size &lt;- file.info(\"censo2024_corregido.duckdb\")$size / 1024^2\nmessage(sprintf(\"Database size: %.1f MB\", db_size))</pre>\n</section>\n<section class=\"level2\" id=\"ejemplo-porcentaje-de-personas-provenientes-de-venezuela-y-per√∫-por-regi√≥n\">\n<h2 class=\"anchored\" data-anchor-id=\"ejemplo-porcentaje-de-personas-provenientes-de-venezuela-y-per√∫-por-regi√≥n\">Ejemplo: Porcentaje de personas provenientes de Venezuela y Per√∫ por regi√≥n</h2>\n<p>La base resultante ocupa 3.3 GB en disco pero tiene la ventaja de que el proceso de leer y filtrar el censo completo para generar la siguiente table toma menos de un segundo gracias a las optimizaciones de DuckDB.</p>\n<p>¬øCu√°ntos Venezolanos y Peruanos hay en cada regi√≥n y qu√© porcentaje representan de la poblaci√≥n total?</p>\n<pre>con &lt;- dbConnect(duckdb::duckdb(), \"censo2024_corregido.duckdb\", read_only = TRUE)\n\ncod_venezuela &lt;- tbl(con, \"codigos_territoriales_especificos\") |&gt;\n  filter(territorio_especifico == \"Venezuela (Rep√∫blica Bolivariana de)\") |&gt;\n  select(codigo_especifico) |&gt;\n  collect() |&gt;\n  pull()\n\ncod_peru &lt;- tbl(con, \"codigos_territoriales_especificos\") |&gt;\n  filter(territorio_especifico == \"Per√∫\") |&gt;\n  select(codigo_especifico) |&gt;\n  collect() |&gt;\n  pull()\n\nvenezolanos_region &lt;- tbl(con, \"personas\") |&gt;\n  filter(p27_nacionalidad_esp == cod_venezuela) |&gt;\n  group_by(comuna) |&gt;\n  summarise(n_venezolanos = n(), .groups = \"drop\") |&gt;  \n  inner_join(\n    tbl(con, \"codigos_territoriales\") |&gt;\n      select(comuna = codigo_territorial, nombre_comuna = territorio)\n  ) |&gt;\n  mutate(\n    region = substr(comuna, 1, 2)\n  ) |&gt;\n  group_by(region) |&gt;\n  summarise(n_venezolanos = sum(n_venezolanos), .groups = \"drop\") |&gt;\n\n  inner_join(\n    tbl(con, \"personas\") |&gt;\n      filter(p27_nacionalidad_esp == cod_peru) |&gt;\n      group_by(comuna) |&gt;\n      summarise(n_peruanos = n(), .groups = \"drop\") |&gt;  \n      inner_join(\n        tbl(con, \"codigos_territoriales\") |&gt;\n          select(comuna = codigo_territorial, nombre_comuna = territorio)\n      ) |&gt;\n      mutate(\n        region = substr(comuna, 1, 2)\n      ) |&gt;\n      group_by(region) |&gt;\n      summarise(n_peruanos = sum(n_peruanos), .groups = \"drop\") |&gt;\n      inner_join(\n        tbl(con, \"codigos_territoriales\") |&gt;\n          select(region = codigo_territorial, nombre_region = territorio) |&gt;\n          filter(str_length(region) == 2)\n      )\n  ) |&gt;\n\n  inner_join(\n    tbl(con, \"personas\") |&gt;\n      mutate(region = substr(comuna, 1, 2)) |&gt;\n      group_by(region) |&gt;\n      summarise(total_personas = n(), .groups = \"drop\")\n  ) |&gt;\n\n  inner_join(\n    tbl(con, \"codigos_territoriales\") |&gt;\n      select(region = codigo_territorial, nombre_region = territorio) |&gt;\n      filter(str_length(region) == 2)\n  ) |&gt;\n\n  mutate(\n    pct_venezolanos = n_venezolanos / total_personas * 100,\n    pct_peruanos = n_peruanos / total_personas * 100\n  ) |&gt;\n  \n  select(\n    region,\n    nombre_region,\n    n_venezolanos,\n    pct_venezolanos,\n    n_peruanos,\n    pct_peruanos,\n    total_personas\n  ) |&gt;\n  \n  collect()\n\ndbDisconnect(con, shutdown = TRUE)</pre>\n<p>El resultado es el siguiente:</p>\n<pre># A tibble: 16 √ó 7\n   region nombre_region    n_venezolanos pct_venezolanos n_peruanos pct_peruanos\n   &lt;chr&gt;  &lt;chr&gt;                    &lt;dbl&gt;           &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;\n 1 01     Tarapac√°                 11140           3.01       14534       3.93  \n 2 02     Antofagasta              15882           2.50       13341       2.10  \n 3 03     Atacama                   6411           2.14        2112       0.706 \n 4 04     Coquimbo                 19557           2.35        2613       0.314 \n 5 05     Valpara√≠so               47486           2.50        4859       0.256 \n 6 06     Libertador Gene‚Ä¶         23897           2.42        1914       0.194 \n 7 07     Maule                    23505           2.09        1516       0.135 \n 8 08     Biob√≠o                   29074           1.80        1694       0.105 \n 9 09     La Araucan√≠a              7429           0.735        691       0.0684\n10 10     Los Lagos                18914           2.12         934       0.105 \n11 11     Ays√©n del Gener‚Ä¶           921           0.914        107       0.106 \n12 12     Magallanes y de‚Ä¶          3213           1.93         213       0.128 \n13 13     Metropolitana d‚Ä¶        431283           5.83      165278       2.23  \n14 14     Los R√≠os                  2568           0.645        181       0.0455\n15 15     Arica y Parinac‚Ä¶          6544           2.68        9547       3.90  \n16 16     √ëuble                     5643           1.10         437       0.0853</pre>\n</section>\n<section class=\"level2\" id=\"acceso-a-los-datos\">\n<h2 class=\"anchored\" data-anchor-id=\"acceso-a-los-datos\">Acceso a los datos</h2>\n<p>En el siguiente repositorio: <a href=\"https://github.com/pachadotdev/censo2024-duckdb\" rel=\"nofollow\" target=\"_blank\">https://github.com/pachadotdev/censo2024-duckdb</a></p>\n</section>\n</div>\n</div>\n\n\n\n\n\n</div>\n</div>\n\n<!-- Load shared sidebar -->\n\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://pacha.dev/blog/2025/12/05/censo2024/index.html\"> https://pacha.dev/blog</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\r\n\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</div> </article>",
    "word_count": 3381,
    "reading_time_min": 16.9,
    "internal_links": [
      {
        "href": "https://www.r-bloggers.com/author/https-pacha-dev-blog/",
        "text": "https://pacha.dev/blog"
      },
      {
        "href": "https://www.r-bloggers.com/category/r-bloggers/",
        "text": "R bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/contact-us/",
        "text": "here"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers.com"
      },
      {
        "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
        "text": "learning R"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      }
    ],
    "external_links": [
      {
        "href": "https://pacha.dev/blog/2025/12/05/censo2024/index.html",
        "text": "https://pacha.dev/blog"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      },
      {
        "href": "https://pacha.dev/blog/",
        "text": "HOME üè†"
      },
      {
        "href": "https://pacha.dev/blog//R/",
        "text": "R"
      },
      {
        "href": "https://pacha.dev/blog//DuckDB/",
        "text": "DuckDB"
      },
      {
        "href": "https://buymeacoffee.com/pacha/e/80976",
        "text": "Buy Me a Coffee"
      },
      {
        "href": "https://docs.google.com/forms/d/e/1FAIpQLScMpMtKjDe2h53iHUvlYHDdBNMD1_x9WO5wg5wi_EO7ak_DRA/viewform?%20usp=sharing&ouid=115091451666829859711",
        "text": "este formulario"
      },
      {
        "href": "https://pacha.dev/blog/2025/12/04/censo2024/index.html",
        "text": "este post"
      },
      {
        "href": "https://github.com/pachadotdev/censo2024-duckdb",
        "text": "https://github.com/pachadotdev/censo2024-duckdb"
      },
      {
        "href": "https://pacha.dev/blog/2025/12/05/censo2024/index.html",
        "text": "https://pacha.dev/blog"
      },
      {
        "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
        "text": "daily e-mail updates"
      },
      {
        "href": "https://www.r-project.org/",
        "text": "R"
      },
      {
        "href": "https://www.r-users.com/",
        "text": "Click here if you're looking to post or find an R/data-science job"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      }
    ],
    "images": [],
    "lang": "en-US",
    "crawled_at_utc": "2026-01-04T05:35:47Z"
  }
}