{
  "uuid": "d7488f5e-0c67-473a-bff7-49e2401fa185",
  "created_at": "2025-11-22 19:58:43",
  "raw_json": {
    "article_author": null,
    "article_headline": null,
    "article_modified": null,
    "article_published": null,
    "article_section": null,
    "article_tags": null,
    "canonical_url": "https://www.r-bloggers.com/2025/04/fast-grouped-counts-and-means-in-r/",
    "crawled_at": "2025-11-22T10:49:39.308390",
    "external_links": [
      {
        "href": "https://lorentzen.ch/index.php/2025/04/30/fast-grouped-counts-and-means-in-r/",
        "text": "R – Michael's and Christian's Blog"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      },
      {
        "href": "https://github.com/Rdatatable/data.table",
        "text": "data.table"
      },
      {
        "href": "https://github.com/pola-rs/r-polars",
        "text": "Polars project"
      },
      {
        "href": "https://h2oai.github.io/db-benchmark/",
        "text": "other benchmarks"
      },
      {
        "href": "https://github.com/lorentzenchr/notebooks/blob/master/blogposts/2025-04-30%20grouped_sums_r.R",
        "text": "R scrip"
      },
      {
        "href": "https://lorentzen.ch/index.php/2025/04/30/fast-grouped-counts-and-means-in-r/",
        "text": "R – Michael's and Christian's Blog"
      },
      {
        "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
        "text": "daily e-mail updates"
      },
      {
        "href": "https://www.r-project.org/",
        "text": "R"
      },
      {
        "href": "https://www.r-users.com/",
        "text": "Click here if you're looking to post or find an R/data-science job"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      }
    ],
    "h1_title": "R-bloggers",
    "html_title": "Fast Grouped Counts and Means in R | R-bloggers",
    "images": [
      {
        "alt": null,
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": null,
        "base64": null,
        "src": "https://i1.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-10.png?w=450&ssl=1"
      },
      {
        "alt": null,
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": null,
        "base64": null,
        "src": "https://i2.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-11.png?w=450&ssl=1"
      }
    ],
    "internal_links": [
      {
        "href": "https://www.r-bloggers.com/author/michael-mayer/",
        "text": "Michael Mayer"
      },
      {
        "href": "https://www.r-bloggers.com/category/r-bloggers/",
        "text": "R bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/contact-us/",
        "text": "here"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers.com"
      },
      {
        "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
        "text": "learning R"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      }
    ],
    "lang": "en-US",
    "main_html": "<article class=\"post-392180 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Fast Grouped Counts and Means in R</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">April 30, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/michael-mayer/\">Michael Mayer</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://lorentzen.ch/index.php/2025/04/30/fast-grouped-counts-and-means-in-r/\"> R – Michael's and Christian's Blog</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<p>From time to time, the following questions pop up: </p>\n<ol class=\"wp-block-list\">\n<li>How to calculate grouped counts and (weighted) means?</li>\n<li>What are fast ways to do it in R?</li>\n</ol>\n<p>This blog post presents a couple of approaches and then compares their speed with a naive benchmark.</p>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1889\" data-lazy-sizes=\"(max-width: 836px) 100vw, 836px\" data-lazy-src=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-10.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" fetchpriority=\"high\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-10.png?w=450&amp;ssl=1 836w, https://lorentzen.ch/wp-content/uploads/2025/03/image-10-300x216.png 300w, https://lorentzen.ch/wp-content/uploads/2025/03/image-10-768x552.png 768w\"/><noscript><img alt=\"\" class=\"wp-image-1889\" data-recalc-dims=\"1\" decoding=\"async\" fetchpriority=\"high\" loading=\"lazy\" sizes=\"(max-width: 836px) 100vw, 836px\" src=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-10.png?w=450&amp;ssl=1\" srcset_temp=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-10.png?w=450&amp;ssl=1 836w, https://lorentzen.ch/wp-content/uploads/2025/03/image-10-300x216.png 300w, https://lorentzen.ch/wp-content/uploads/2025/03/image-10-768x552.png 768w\"/></noscript></figure>\n<h2 class=\"wp-block-heading\">Base R</h2>\n<p>There are many ways to calculate grouped counts and means in base R, e.g., <code>aggregate()</code>, <code>tapply()</code>, <code>by()</code>, <code>split()</code> + <code>lapply()</code>. In my experience, the fastest way is a combination of <code>tabulate()</code> and <code>rowsum()</code>.</p>\n<div class=\"wp-block-ub-tabbed-content wp-block-ub-tabbed-content-holder wp-block-ub-tabbed-content-horizontal-holder-mobile wp-block-ub-tabbed-content-horizontal-holder-tablet\" id=\"ub-tabbed-content-80ca954c-f318-4a63-8a07-58855bcf8dbf\" style=\"\">\n<div class=\"wp-block-ub-tabbed-content-tab-holder horizontal-tab-width-mobile horizontal-tab-width-tablet\">\n<div class=\"wp-block-ub-tabbed-content-tabs-title wp-block-ub-tabbed-content-tabs-title-mobile-horizontal-tab wp-block-ub-tabbed-content-tabs-title-tablet-horizontal-tab\" role=\"tablist\" style=\"justify-content: flex-start; \"><div aria-controls=\"ub-tabbed-content-80ca954c-f318-4a63-8a07-58855bcf8dbf-panel-0\" aria-selected=\"true\" class=\"wp-block-ub-tabbed-content-tab-title-wrap active\" id=\"ub-tabbed-content-80ca954c-f318-4a63-8a07-58855bcf8dbf-tab-0\" role=\"tab\" style=\"--ub-tabbed-title-background-color: #6d6d6d; --ub-tabbed-active-title-color: inherit; --ub-tabbed-active-title-background-color: #6d6d6d; text-align: left; \" tabindex=\"-1\">\n<div class=\"wp-block-ub-tabbed-content-tab-title\">R</div>\n</div></div>\n</div>\n<div class=\"wp-block-ub-tabbed-content-tabs-content\" style=\"\"><div aria-labelledby=\"ub-tabbed-content-80ca954c-f318-4a63-8a07-58855bcf8dbf-tab-0\" class=\"wp-block-ub-tabbed-content-tab-content-wrap active\" id=\"ub-tabbed-content-80ca954c-f318-4a63-8a07-58855bcf8dbf-panel-0\" role=\"tabpanel\" tabindex=\"0\">\n<pre># Make data\nset.seed(1)\n\nn &lt;- 1e6\n\ny &lt;- rexp(n)\nw &lt;- runif(n)\ng &lt;- factor(sample(LETTERS[1:3], n, TRUE))\ndf &lt;- data.frame(y = y, g = g, w = w)\n\n# Grouped counts\ntabulate(g)\n# 333469 333569 332962\n\n# Grouped means\nrowsum(y, g) / tabulate(g)\n      [,1]\n# A 1.000869\n# B 1.001043\n# C 1.000445\n\n# Grouped weighted mean\nws &lt;- rowsum(data.frame(y = y * w, w), g)\nws[, 1L] / ws[, 2L]\n# 1.0022749 1.0017816 0.9997058</pre>\n</div></div>\n</div>\n<p>But: <code>tabulate()</code> ignores missing values. To avoid problems, create an explicit missing level via <code>factor(x, exclude = NULL</code>).</p>\n<p>Let’s turn to some other approaches.</p>\n<h2 class=\"wp-block-heading\">dplyr</h2>\n<p>Not optimized for speed or memory, but the de-facto standard in data processing with R. I love its syntax.</p>\n<div class=\"wp-block-ub-tabbed-content wp-block-ub-tabbed-content-holder wp-block-ub-tabbed-content-horizontal-holder-mobile wp-block-ub-tabbed-content-horizontal-holder-tablet\" id=\"ub-tabbed-content-538c0ac5-16dc-4ba1-b578-d0e8bfff7b2f\" style=\"\">\n<div class=\"wp-block-ub-tabbed-content-tab-holder horizontal-tab-width-mobile horizontal-tab-width-tablet\">\n<div class=\"wp-block-ub-tabbed-content-tabs-title wp-block-ub-tabbed-content-tabs-title-mobile-horizontal-tab wp-block-ub-tabbed-content-tabs-title-tablet-horizontal-tab\" role=\"tablist\" style=\"justify-content: flex-start; \"><div aria-controls=\"ub-tabbed-content-538c0ac5-16dc-4ba1-b578-d0e8bfff7b2f-panel-0\" aria-selected=\"true\" class=\"wp-block-ub-tabbed-content-tab-title-wrap active\" id=\"ub-tabbed-content-538c0ac5-16dc-4ba1-b578-d0e8bfff7b2f-tab-0\" role=\"tab\" style=\"--ub-tabbed-title-background-color: #6d6d6d; --ub-tabbed-active-title-color: inherit; --ub-tabbed-active-title-background-color: #6d6d6d; text-align: left; \" tabindex=\"-1\">\n<div class=\"wp-block-ub-tabbed-content-tab-title\">R</div>\n</div></div>\n</div>\n<div class=\"wp-block-ub-tabbed-content-tabs-content\" style=\"\"><div aria-labelledby=\"ub-tabbed-content-538c0ac5-16dc-4ba1-b578-d0e8bfff7b2f-tab-0\" class=\"wp-block-ub-tabbed-content-tab-content-wrap active\" id=\"ub-tabbed-content-538c0ac5-16dc-4ba1-b578-d0e8bfff7b2f-panel-0\" role=\"tabpanel\" tabindex=\"0\">\n<pre>library(tidyverse)\n\ndf &lt;- tibble(df)\n\n# Grouped counts\ndplyr::count(df, g)\n\n# Grouped means\ndf |&gt;\n  group_by(g) |&gt;\n  summarize(mean(y))\n\n# Grouped weighted means\ndf |&gt;\n  group_by(g) |&gt;\n  summarize(sum(w * y) / sum(w))</pre>\n</div></div>\n</div>\n<h2 class=\"wp-block-heading\"><a href=\"https://github.com/Rdatatable/data.table\" rel=\"nofollow\" target=\"_blank\">data.table</a></h2>\n<p>Does not need an introduction. Since 2006 <em>the</em> package for fast data manipulation written in C.</p>\n<div class=\"wp-block-ub-tabbed-content wp-block-ub-tabbed-content-holder wp-block-ub-tabbed-content-horizontal-holder-mobile wp-block-ub-tabbed-content-horizontal-holder-tablet\" id=\"ub-tabbed-content-11ba2964-a54b-440d-b7d7-fdd60a95623f\" style=\"\">\n<div class=\"wp-block-ub-tabbed-content-tab-holder horizontal-tab-width-mobile horizontal-tab-width-tablet\">\n<div class=\"wp-block-ub-tabbed-content-tabs-title wp-block-ub-tabbed-content-tabs-title-mobile-horizontal-tab wp-block-ub-tabbed-content-tabs-title-tablet-horizontal-tab\" role=\"tablist\" style=\"justify-content: flex-start; \"><div aria-controls=\"ub-tabbed-content-11ba2964-a54b-440d-b7d7-fdd60a95623f-panel-0\" aria-selected=\"true\" class=\"wp-block-ub-tabbed-content-tab-title-wrap active\" id=\"ub-tabbed-content-11ba2964-a54b-440d-b7d7-fdd60a95623f-tab-0\" role=\"tab\" style=\"--ub-tabbed-title-background-color: #6d6d6d; --ub-tabbed-active-title-color: inherit; --ub-tabbed-active-title-background-color: #6d6d6d; text-align: left; \" tabindex=\"-1\">\n<div class=\"wp-block-ub-tabbed-content-tab-title\">R</div>\n</div></div>\n</div>\n<div class=\"wp-block-ub-tabbed-content-tabs-content\" style=\"\"><div aria-labelledby=\"ub-tabbed-content-11ba2964-a54b-440d-b7d7-fdd60a95623f-tab-0\" class=\"wp-block-ub-tabbed-content-tab-content-wrap active\" id=\"ub-tabbed-content-11ba2964-a54b-440d-b7d7-fdd60a95623f-panel-0\" role=\"tabpanel\" tabindex=\"0\">\n<pre>library(data.table)\n\ndt &lt;- data.table(df)\n\n# Grouped counts (use keyby for sorted output)\ndt[, .N, by = g]\n#         g      N\n#    &lt;fctr&gt;  &lt;int&gt;\n# 1:      C 332962\n# 2:      B 333569\n# 3:      A 333469\n\n# Grouped means\ndt[, mean(y), by = g]\n\n# Grouped weighted means\ndt[, sum(w * y) / sum(w), by = g]\ndt[, weighted.mean(y, w), by = g]</pre>\n</div></div>\n</div>\n<h2 class=\"wp-block-heading\">DuckDB</h2>\n<p>Extremely powerful query engine / database system written in C++, with initial release in 2019, and R bindings since 2020. Allows larger-than-RAM calculations. </p>\n<div class=\"wp-block-ub-tabbed-content wp-block-ub-tabbed-content-holder wp-block-ub-tabbed-content-horizontal-holder-mobile wp-block-ub-tabbed-content-horizontal-holder-tablet\" id=\"ub-tabbed-content-38f9b1a3-bb24-410c-8a36-1a9b31f44bbf\" style=\"\">\n<div class=\"wp-block-ub-tabbed-content-tab-holder horizontal-tab-width-mobile horizontal-tab-width-tablet\">\n<div class=\"wp-block-ub-tabbed-content-tabs-title wp-block-ub-tabbed-content-tabs-title-mobile-horizontal-tab wp-block-ub-tabbed-content-tabs-title-tablet-horizontal-tab\" role=\"tablist\" style=\"justify-content: flex-start; \"><div aria-controls=\"ub-tabbed-content-38f9b1a3-bb24-410c-8a36-1a9b31f44bbf-panel-0\" aria-selected=\"true\" class=\"wp-block-ub-tabbed-content-tab-title-wrap active\" id=\"ub-tabbed-content-38f9b1a3-bb24-410c-8a36-1a9b31f44bbf-tab-0\" role=\"tab\" style=\"--ub-tabbed-title-background-color: #6d6d6d; --ub-tabbed-active-title-color: inherit; --ub-tabbed-active-title-background-color: #6d6d6d; text-align: left; \" tabindex=\"-1\">\n<div class=\"wp-block-ub-tabbed-content-tab-title\">R</div>\n</div></div>\n</div>\n<div class=\"wp-block-ub-tabbed-content-tabs-content\" style=\"\"><div aria-labelledby=\"ub-tabbed-content-38f9b1a3-bb24-410c-8a36-1a9b31f44bbf-tab-0\" class=\"wp-block-ub-tabbed-content-tab-content-wrap active\" id=\"ub-tabbed-content-38f9b1a3-bb24-410c-8a36-1a9b31f44bbf-panel-0\" role=\"tabpanel\" tabindex=\"0\">\n<pre>library(duckdb)\n\ncon &lt;- dbConnect(duckdb())\n\nduckdb_register(con, name = \"df\", df = df)\n\ndbGetQuery(con, \"SELECT g, COUNT(*) N FROM df GROUP BY g\")\ndbGetQuery(con, \"SELECT g, AVG(y) AS mean FROM df GROUP BY g\")\ncon |&gt; \n  dbGetQuery(\n  \"\n  SELECT g, SUM(y * w) / sum(w) as wmean\n  FROM df\n  GROUP BY g\n  \"\n  )\n#   g     wmean\n# 1 A 1.0022749\n# 2 B 1.0017816\n# 3 C 0.9997058</pre>\n</div></div>\n</div>\n<h2 class=\"wp-block-heading\">collapse</h2>\n<p>C/C++-based package for data transformation and statistical computing. {collapse} was initially released on CRAN in 2020. It can do much more than grouped calculations, check it out!</p>\n<div class=\"wp-block-ub-tabbed-content wp-block-ub-tabbed-content-holder wp-block-ub-tabbed-content-horizontal-holder-mobile wp-block-ub-tabbed-content-horizontal-holder-tablet\" id=\"ub-tabbed-content-748692bd-bd35-4769-a168-f65ddf4f766d\" style=\"\">\n<div class=\"wp-block-ub-tabbed-content-tab-holder horizontal-tab-width-mobile horizontal-tab-width-tablet\">\n<div class=\"wp-block-ub-tabbed-content-tabs-title wp-block-ub-tabbed-content-tabs-title-mobile-horizontal-tab wp-block-ub-tabbed-content-tabs-title-tablet-horizontal-tab\" role=\"tablist\" style=\"justify-content: flex-start; \"><div aria-controls=\"ub-tabbed-content-748692bd-bd35-4769-a168-f65ddf4f766d-panel-0\" aria-selected=\"true\" class=\"wp-block-ub-tabbed-content-tab-title-wrap active\" id=\"ub-tabbed-content-748692bd-bd35-4769-a168-f65ddf4f766d-tab-0\" role=\"tab\" style=\"--ub-tabbed-title-background-color: #6d6d6d; --ub-tabbed-active-title-color: inherit; --ub-tabbed-active-title-background-color: #6d6d6d; text-align: left; \" tabindex=\"-1\">\n<div class=\"wp-block-ub-tabbed-content-tab-title\">R</div>\n</div></div>\n</div>\n<div class=\"wp-block-ub-tabbed-content-tabs-content\" style=\"\"><div aria-labelledby=\"ub-tabbed-content-748692bd-bd35-4769-a168-f65ddf4f766d-tab-0\" class=\"wp-block-ub-tabbed-content-tab-content-wrap active\" id=\"ub-tabbed-content-748692bd-bd35-4769-a168-f65ddf4f766d-panel-0\" role=\"tabpanel\" tabindex=\"0\">\n<pre>library(collapse)\n\nfcount(g)\nfnobs(g, g) # Faster and does not need memory, but ignores missing values\nfmean(y, g = g)\nfmean(y, g = g, w = w)\n#         A         B         C\n# 1.0022749 1.0017816 0.9997058</pre>\n</div></div>\n</div>\n<h2 class=\"wp-block-heading\">Polars</h2>\n<p>R bindings of the fantastic <a href=\"https://github.com/pola-rs/r-polars\" rel=\"nofollow\" target=\"_blank\">Polars project</a> that started in 2020. First R release in 2022. About to be overhauled into the R package {neopandas} .</p>\n<div class=\"wp-block-ub-tabbed-content wp-block-ub-tabbed-content-holder wp-block-ub-tabbed-content-horizontal-holder-mobile wp-block-ub-tabbed-content-horizontal-holder-tablet\" id=\"ub-tabbed-content-0fbe5b18-e9d7-46df-8421-78ac0704030b\" style=\"\">\n<div class=\"wp-block-ub-tabbed-content-tab-holder horizontal-tab-width-mobile horizontal-tab-width-tablet\">\n<div class=\"wp-block-ub-tabbed-content-tabs-title wp-block-ub-tabbed-content-tabs-title-mobile-horizontal-tab wp-block-ub-tabbed-content-tabs-title-tablet-horizontal-tab\" role=\"tablist\" style=\"justify-content: flex-start; \"><div aria-controls=\"ub-tabbed-content-0fbe5b18-e9d7-46df-8421-78ac0704030b-panel-0\" aria-selected=\"true\" class=\"wp-block-ub-tabbed-content-tab-title-wrap active\" id=\"ub-tabbed-content-0fbe5b18-e9d7-46df-8421-78ac0704030b-tab-0\" role=\"tab\" style=\"--ub-tabbed-title-background-color: #6d6d6d; --ub-tabbed-active-title-color: inherit; --ub-tabbed-active-title-background-color: #6d6d6d; text-align: left; \" tabindex=\"-1\">\n<div class=\"wp-block-ub-tabbed-content-tab-title\">R</div>\n</div></div>\n</div>\n<div class=\"wp-block-ub-tabbed-content-tabs-content\" style=\"\"><div aria-labelledby=\"ub-tabbed-content-0fbe5b18-e9d7-46df-8421-78ac0704030b-tab-0\" class=\"wp-block-ub-tabbed-content-tab-content-wrap active\" id=\"ub-tabbed-content-0fbe5b18-e9d7-46df-8421-78ac0704030b-panel-0\" role=\"tabpanel\" tabindex=\"0\">\n<pre># Sys.setenv(NOT_CRAN = \"true\")\n# install.packages(\"polars\", repos = \"https://community.r-multiverse.org\")\nlibrary(polars)\n\ndfp &lt;- as_polars_df(df)\n\n# Grouped counts\ndfp$get_column(\"g\")$value_counts()\n# Faster, but eats more memory\ndfp$select(\"g\")$with_columns(pl$lit(1L))$group_by(\"g\")$sum()\n\n# Grouped means\ndfp$select(c(\"g\", \"y\"))$group_by(\"g\")$mean()\n\n# Grouped weighted means\n(\n  dfp\n  $with_columns(pl$col(\"y\") * pl$col(\"w\"))\n  $group_by(\"g\")\n  $sum()\n  $with_columns(pl$col(\"y\") / pl$col(\"w\"))\n  $drop(\"w\")\n)\n# shape: (3, 2)\n# ┌─────┬──────────┐\n# │ g   ┆ y        │\n# │ --- ┆ ---      │\n# │ cat ┆ f64      │\n# ╞═════╪══════════╡\n# │ A   ┆ 1.002275 │\n# │ B   ┆ 1.001782 │\n# │ C   ┆ 0.999706 │\n# └─────┴──────────┘</pre>\n</div></div>\n</div>\n<h2 class=\"wp-block-heading\">Naive Benchmark</h2>\n<p>Let’s compare the speed of these approaches for sample sizes up to 10^8 using a Windows system with an Intel i7-13700H CPU.</p>\n<div class=\"wp-block-ub-tabbed-content wp-block-ub-tabbed-content-holder wp-block-ub-tabbed-content-horizontal-holder-mobile wp-block-ub-tabbed-content-horizontal-holder-tablet\" id=\"ub-tabbed-content-8092af9e-9584-42a2-973d-8b73875bd137\" style=\"\">\n<div class=\"wp-block-ub-tabbed-content-tab-holder horizontal-tab-width-mobile horizontal-tab-width-tablet\">\n<div class=\"wp-block-ub-tabbed-content-tabs-title wp-block-ub-tabbed-content-tabs-title-mobile-horizontal-tab wp-block-ub-tabbed-content-tabs-title-tablet-horizontal-tab\" role=\"tablist\" style=\"justify-content: flex-start; \"><div aria-controls=\"ub-tabbed-content-8092af9e-9584-42a2-973d-8b73875bd137-panel-0\" aria-selected=\"true\" class=\"wp-block-ub-tabbed-content-tab-title-wrap active\" id=\"ub-tabbed-content-8092af9e-9584-42a2-973d-8b73875bd137-tab-0\" role=\"tab\" style=\"--ub-tabbed-title-background-color: #6d6d6d; --ub-tabbed-active-title-color: inherit; --ub-tabbed-active-title-background-color: #6d6d6d; text-align: left; \" tabindex=\"-1\">\n<div class=\"wp-block-ub-tabbed-content-tab-title\">R</div>\n</div></div>\n</div>\n<div class=\"wp-block-ub-tabbed-content-tabs-content\" style=\"\"><div aria-labelledby=\"ub-tabbed-content-8092af9e-9584-42a2-973d-8b73875bd137-tab-0\" class=\"wp-block-ub-tabbed-content-tab-content-wrap active\" id=\"ub-tabbed-content-8092af9e-9584-42a2-973d-8b73875bd137-panel-0\" role=\"tabpanel\" tabindex=\"0\">\n<pre># We run the code in a fresh session\nlibrary(tidyverse)\nlibrary(duckdb)\nlibrary(data.table)\nlibrary(collapse)\nlibrary(polars)\n\npolars_info() # 8 threads\nsetDTthreads(8)\ncon &lt;- dbConnect(duckdb(config = list(threads = \"8\")))\n\nset.seed(1)\n\nN &lt;- 10^(5:8)\nm_queries &lt;- 3\nresults &lt;- vector(\"list\", length(N) * m_queries)\n\nfor (i in seq_along(N)) {\n  n &lt;- N[i]\n\n  # Create data\n  y &lt;- rexp(n)\n  w &lt;- runif(n)\n  g &lt;- factor(sample(LETTERS, n, TRUE))\n\n  df &lt;- tibble(y = y, g = g, w = w)\n  dt &lt;- data.table(df)\n  dfp &lt;- as_polars_df(df)\n  duckdb_register(con, name = \"df\", df = df, overwrite = TRUE)\n\n  # Grouped counts\n  results[[1 + (i - 1) * m_queries]] &lt;- bench::mark(\n    base = tabulate(g),\n    dplyr = dplyr::count(df, g),\n    data.table = dt[, .N, by = g],\n    polars = dfp$get_column(\"g\")$value_counts(),\n    collapse = fcount(g),\n    duckdb = dbGetQuery(con, \"SELECT g, COUNT(*) N FROM df GROUP BY g\"),\n    check = FALSE,\n    min_iterations = 3,\n  ) |&gt;\n    bind_cols(n = n, query = \"counts\")\n\n  results[[2 + (i - 1) * m_queries]] &lt;- bench::mark(\n    base = rowsum(y, g) / tabulate(g),\n    dplyr = df |&gt; group_by(g) |&gt; summarize(mean(y)),\n    data.table = dt[, mean(y), by = g],\n    polars = dfp$select(c(\"g\", \"y\"))$group_by(\"g\")$mean(),\n    collapse = fmean(y, g = g),\n    duckdb = dbGetQuery(con, \"SELECT g, AVG(y) AS mean FROM df GROUP BY g\"),\n    check = FALSE,\n    min_iterations = 3\n  ) |&gt;\n    bind_cols(n = n, query = \"means\")\n\n  results[[3 + (i - 1) * m_queries]] &lt;- bench::mark(\n    base = {\n      ws &lt;- rowsum(data.frame(y = y * w, w), g)\n      ws[, 1L] / ws[, 2L]\n    },\n    dplyr = df |&gt; group_by(g) |&gt; summarize(sum(w * y) / sum(w)),\n    data.table = dt[, sum(w * y) / sum(w), by = g],\n    polars = (\n      dfp\n      $with_columns(pl$col(\"y\") * pl$col(\"w\"))\n      $group_by(\"g\")\n      $sum()\n      $with_columns(pl$col(\"y\") / pl$col(\"w\"))\n      $drop(\"w\")\n    ),\n    collapse = fmean(y, g = g, w = w),\n    duckdb = dbGetQuery(\n      con,\n      \"SELECT g, SUM(y * w) / sum(w) as wmean FROM df GROUP BY g\"\n    ),\n    check = FALSE,\n    min_iterations = 3\n  ) |&gt;\n    bind_cols(n = n, query = \"weighted means\")\n}\n\nresults_df &lt;- bind_rows(results) |&gt;\n  group_by(n, query) |&gt;\n  mutate(\n    time = median,\n    approach = as.character(expression),\n    relative = as.numeric(time / min(time))\n  ) |&gt;\n  ungroup()\n\nggplot(results_df, aes(y = relative, x = query, group = approach, color = approach)) +\n  geom_point() +\n  geom_line() +\n  facet_wrap(\"n\", scales = \"free_y\") +\n  labs(x = element_blank(), y = \"Relative timings\") +\n  theme_gray(base_size = 14)\n\nggplot(results_df, aes(y = time, x = query, group = approach, color = approach)) +\n  geom_point() +\n  geom_line() +\n  facet_wrap(\"n\", scales = \"free_y\") +\n  labs(x = element_blank(), y = \"Absolute time in seconds\") +\n  theme_gray(base_size = 14)\n</pre>\n</div></div>\n</div>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1891\" data-lazy-sizes=\"(max-width: 836px) 100vw, 836px\" data-lazy-src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-11.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-11.png?w=450&amp;ssl=1 836w, https://lorentzen.ch/wp-content/uploads/2025/03/image-11-300x216.png 300w, https://lorentzen.ch/wp-content/uploads/2025/03/image-11-768x552.png 768w\"/><noscript><img alt=\"\" class=\"wp-image-1891\" data-recalc-dims=\"1\" decoding=\"async\" loading=\"lazy\" sizes=\"(max-width: 836px) 100vw, 836px\" src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-11.png?w=450&amp;ssl=1\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2025/03/image-11.png?w=450&amp;ssl=1 836w, https://lorentzen.ch/wp-content/uploads/2025/03/image-11-300x216.png 300w, https://lorentzen.ch/wp-content/uploads/2025/03/image-11-768x552.png 768w\"/></noscript><figcaption class=\"wp-element-caption\">Absolute time in seconds. For relative time, check the plot at the top.</figcaption></figure>\n<h2 class=\"wp-block-heading\">Memory</h2>\n<p>What about memory? {dplyr}, {data.table}, and <code>rowsum()</code> require a lot of it, as does <code>collapse::fcount()</code>. For the other approaches, almost no memory is required, or profmem can’ t measure it.</p>\n<h2 class=\"wp-block-heading\">Final words</h2>\n<ul class=\"wp-block-list\">\n<li>{collapse} is increadibly fast for all sample sizes and tasks. In <a href=\"https://h2oai.github.io/db-benchmark/\" rel=\"nofollow\" target=\"_blank\">other benchmarks</a>, it is slower because there, the grouping has to be a string rather than a factor.</li>\n<li>{duckdb} is increadibly fast for large data.</li>\n<li>{polars} looks really cool.</li>\n<li><code>rowsum()</code> and <code>tabulate()</code> provide fast solutions with base R.</li>\n<li>Don’t trust my benchmarks!</li>\n</ul>\n<p><a href=\"https://github.com/lorentzenchr/notebooks/blob/master/blogposts/2025-04-30%20grouped_sums_r.R\" rel=\"nofollow\" target=\"_blank\">R scrip</a>t</p>\n<p></p>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://lorentzen.ch/index.php/2025/04/30/fast-grouped-counts-and-means-in-r/\"> R – Michael's and Christian's Blog</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
    "main_text": "Fast Grouped Counts and Means in R\nPosted on\nApril 30, 2025\nby\nMichael Mayer\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nR – Michael's and Christian's Blog\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nFrom time to time, the following questions pop up:\nHow to calculate grouped counts and (weighted) means?\nWhat are fast ways to do it in R?\nThis blog post presents a couple of approaches and then compares their speed with a naive benchmark.\nBase R\nThere are many ways to calculate grouped counts and means in base R, e.g.,\naggregate()\n,\ntapply()\n,\nby()\n,\nsplit()\n+\nlapply()\n. In my experience, the fastest way is a combination of\ntabulate()\nand\nrowsum()\n.\nR\n# Make data\nset.seed(1)\n\nn <- 1e6\n\ny <- rexp(n)\nw <- runif(n)\ng <- factor(sample(LETTERS[1:3], n, TRUE))\ndf <- data.frame(y = y, g = g, w = w)\n\n# Grouped counts\ntabulate(g)\n# 333469 333569 332962\n\n# Grouped means\nrowsum(y, g) / tabulate(g)\n      [,1]\n# A 1.000869\n# B 1.001043\n# C 1.000445\n\n# Grouped weighted mean\nws <- rowsum(data.frame(y = y * w, w), g)\nws[, 1L] / ws[, 2L]\n# 1.0022749 1.0017816 0.9997058\nBut:\ntabulate()\nignores missing values. To avoid problems, create an explicit missing level via\nfactor(x, exclude = NULL\n).\nLet’s turn to some other approaches.\ndplyr\nNot optimized for speed or memory, but the de-facto standard in data processing with R. I love its syntax.\nR\nlibrary(tidyverse)\n\ndf <- tibble(df)\n\n# Grouped counts\ndplyr::count(df, g)\n\n# Grouped means\ndf |>\n  group_by(g) |>\n  summarize(mean(y))\n\n# Grouped weighted means\ndf |>\n  group_by(g) |>\n  summarize(sum(w * y) / sum(w))\ndata.table\nDoes not need an introduction. Since 2006\nthe\npackage for fast data manipulation written in C.\nR\nlibrary(data.table)\n\ndt <- data.table(df)\n\n# Grouped counts (use keyby for sorted output)\ndt[, .N, by = g]\n#         g      N\n#    <fctr>  <int>\n# 1:      C 332962\n# 2:      B 333569\n# 3:      A 333469\n\n# Grouped means\ndt[, mean(y), by = g]\n\n# Grouped weighted means\ndt[, sum(w * y) / sum(w), by = g]\ndt[, weighted.mean(y, w), by = g]\nDuckDB\nExtremely powerful query engine / database system written in C++, with initial release in 2019, and R bindings since 2020. Allows larger-than-RAM calculations.\nR\nlibrary(duckdb)\n\ncon <- dbConnect(duckdb())\n\nduckdb_register(con, name = \"df\", df = df)\n\ndbGetQuery(con, \"SELECT g, COUNT(*) N FROM df GROUP BY g\")\ndbGetQuery(con, \"SELECT g, AVG(y) AS mean FROM df GROUP BY g\")\ncon |> \n  dbGetQuery(\n  \"\n  SELECT g, SUM(y * w) / sum(w) as wmean\n  FROM df\n  GROUP BY g\n  \"\n  )\n#   g     wmean\n# 1 A 1.0022749\n# 2 B 1.0017816\n# 3 C 0.9997058\ncollapse\nC/C++-based package for data transformation and statistical computing. {collapse} was initially released on CRAN in 2020. It can do much more than grouped calculations, check it out!\nR\nlibrary(collapse)\n\nfcount(g)\nfnobs(g, g) # Faster and does not need memory, but ignores missing values\nfmean(y, g = g)\nfmean(y, g = g, w = w)\n#         A         B         C\n# 1.0022749 1.0017816 0.9997058\nPolars\nR bindings of the fantastic\nPolars project\nthat started in 2020. First R release in 2022. About to be overhauled into the R package {neopandas} .\nR\n# Sys.setenv(NOT_CRAN = \"true\")\n# install.packages(\"polars\", repos = \"https://community.r-multiverse.org\")\nlibrary(polars)\n\ndfp <- as_polars_df(df)\n\n# Grouped counts\ndfp$get_column(\"g\")$value_counts()\n# Faster, but eats more memory\ndfp$select(\"g\")$with_columns(pl$lit(1L))$group_by(\"g\")$sum()\n\n# Grouped means\ndfp$select(c(\"g\", \"y\"))$group_by(\"g\")$mean()\n\n# Grouped weighted means\n(\n  dfp\n  $with_columns(pl$col(\"y\") * pl$col(\"w\"))\n  $group_by(\"g\")\n  $sum()\n  $with_columns(pl$col(\"y\") / pl$col(\"w\"))\n  $drop(\"w\")\n)\n# shape: (3, 2)\n# ┌─────┬──────────┐\n# │ g   ┆ y        │\n# │ --- ┆ ---      │\n# │ cat ┆ f64      │\n# ╞═════╪══════════╡\n# │ A   ┆ 1.002275 │\n# │ B   ┆ 1.001782 │\n# │ C   ┆ 0.999706 │\n# └─────┴──────────┘\nNaive Benchmark\nLet’s compare the speed of these approaches for sample sizes up to 10^8 using a Windows system with an Intel i7-13700H CPU.\nR\n# We run the code in a fresh session\nlibrary(tidyverse)\nlibrary(duckdb)\nlibrary(data.table)\nlibrary(collapse)\nlibrary(polars)\n\npolars_info() # 8 threads\nsetDTthreads(8)\ncon <- dbConnect(duckdb(config = list(threads = \"8\")))\n\nset.seed(1)\n\nN <- 10^(5:8)\nm_queries <- 3\nresults <- vector(\"list\", length(N) * m_queries)\n\nfor (i in seq_along(N)) {\n  n <- N[i]\n\n  # Create data\n  y <- rexp(n)\n  w <- runif(n)\n  g <- factor(sample(LETTERS, n, TRUE))\n\n  df <- tibble(y = y, g = g, w = w)\n  dt <- data.table(df)\n  dfp <- as_polars_df(df)\n  duckdb_register(con, name = \"df\", df = df, overwrite = TRUE)\n\n  # Grouped counts\n  results[[1 + (i - 1) * m_queries]] <- bench::mark(\n    base = tabulate(g),\n    dplyr = dplyr::count(df, g),\n    data.table = dt[, .N, by = g],\n    polars = dfp$get_column(\"g\")$value_counts(),\n    collapse = fcount(g),\n    duckdb = dbGetQuery(con, \"SELECT g, COUNT(*) N FROM df GROUP BY g\"),\n    check = FALSE,\n    min_iterations = 3,\n  ) |>\n    bind_cols(n = n, query = \"counts\")\n\n  results[[2 + (i - 1) * m_queries]] <- bench::mark(\n    base = rowsum(y, g) / tabulate(g),\n    dplyr = df |> group_by(g) |> summarize(mean(y)),\n    data.table = dt[, mean(y), by = g],\n    polars = dfp$select(c(\"g\", \"y\"))$group_by(\"g\")$mean(),\n    collapse = fmean(y, g = g),\n    duckdb = dbGetQuery(con, \"SELECT g, AVG(y) AS mean FROM df GROUP BY g\"),\n    check = FALSE,\n    min_iterations = 3\n  ) |>\n    bind_cols(n = n, query = \"means\")\n\n  results[[3 + (i - 1) * m_queries]] <- bench::mark(\n    base = {\n      ws <- rowsum(data.frame(y = y * w, w), g)\n      ws[, 1L] / ws[, 2L]\n    },\n    dplyr = df |> group_by(g) |> summarize(sum(w * y) / sum(w)),\n    data.table = dt[, sum(w * y) / sum(w), by = g],\n    polars = (\n      dfp\n      $with_columns(pl$col(\"y\") * pl$col(\"w\"))\n      $group_by(\"g\")\n      $sum()\n      $with_columns(pl$col(\"y\") / pl$col(\"w\"))\n      $drop(\"w\")\n    ),\n    collapse = fmean(y, g = g, w = w),\n    duckdb = dbGetQuery(\n      con,\n      \"SELECT g, SUM(y * w) / sum(w) as wmean FROM df GROUP BY g\"\n    ),\n    check = FALSE,\n    min_iterations = 3\n  ) |>\n    bind_cols(n = n, query = \"weighted means\")\n}\n\nresults_df <- bind_rows(results) |>\n  group_by(n, query) |>\n  mutate(\n    time = median,\n    approach = as.character(expression),\n    relative = as.numeric(time / min(time))\n  ) |>\n  ungroup()\n\nggplot(results_df, aes(y = relative, x = query, group = approach, color = approach)) +\n  geom_point() +\n  geom_line() +\n  facet_wrap(\"n\", scales = \"free_y\") +\n  labs(x = element_blank(), y = \"Relative timings\") +\n  theme_gray(base_size = 14)\n\nggplot(results_df, aes(y = time, x = query, group = approach, color = approach)) +\n  geom_point() +\n  geom_line() +\n  facet_wrap(\"n\", scales = \"free_y\") +\n  labs(x = element_blank(), y = \"Absolute time in seconds\") +\n  theme_gray(base_size = 14)\nAbsolute time in seconds. For relative time, check the plot at the top.\nMemory\nWhat about memory? {dplyr}, {data.table}, and\nrowsum()\nrequire a lot of it, as does\ncollapse::fcount()\n. For the other approaches, almost no memory is required, or profmem can’ t measure it.\nFinal words\n{collapse} is increadibly fast for all sample sizes and tasks. In\nother benchmarks\n, it is slower because there, the grouping has to be a string rather than a factor.\n{duckdb} is increadibly fast for large data.\n{polars} looks really cool.\nrowsum()\nand\ntabulate()\nprovide fast solutions with base R.\nDon’t trust my benchmarks!\nR scrip\nt\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nR – Michael's and Christian's Blog\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
    "meta_description": "Grouped counts and grouped (weighted) means? How to calculate them? And how to do it as fast as possible?",
    "meta_keywords": null,
    "og_description": "Grouped counts and grouped (weighted) means? How to calculate them? And how to do it as fast as possible?",
    "og_image": "https://lorentzen.ch/wp-content/uploads/2025/03/image-10.png",
    "og_title": "Fast Grouped Counts and Means in R | R-bloggers",
    "raw_jsonld_article": null,
    "reading_time_min": 6.2,
    "sitemap_lastmod": null,
    "twitter_description": "Grouped counts and grouped (weighted) means? How to calculate them? And how to do it as fast as possible?",
    "twitter_title": "Fast Grouped Counts and Means in R | R-bloggers",
    "url": "https://www.r-bloggers.com/2025/04/fast-grouped-counts-and-means-in-r/",
    "word_count": 1242
  }
}