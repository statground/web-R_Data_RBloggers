{
  "id": "fdc15bea9808156da1c371682cd1164c51d39bfa",
  "url": "https://www.r-bloggers.com/2025/03/consuming-yfinance-data-in-excel-part-ii/",
  "created_at_utc": "2025-11-22T19:59:02Z",
  "data": null,
  "raw_original": {
    "uuid": "1ceec823-a596-4843-8a6b-7e1c50deabf8",
    "created_at": "2025-11-22 19:59:02",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2025/03/consuming-yfinance-data-in-excel-part-ii/",
      "crawled_at": "2025-11-22T10:52:22.568291",
      "external_links": [
        {
          "href": "https://adam-gladstone.github.io/python-project/Consuming-yfinance-data-in-Excel-Part-II/",
          "text": "Adam’s Software Lab"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://adam-gladstone.github.io/python-projects/Building-a-Flask-service-to-get-yfinance-data-Part-I/",
          "text": "first part"
        },
        {
          "href": "https://github.com/Adam-Gladstone/YFinanceService",
          "text": "YFinanceService"
        },
        {
          "href": "https://adam-gladstone.github.io/python-projects/2025-03-19-Consuming-yfinance-data-in-Excel-Part-II/",
          "text": "Part II"
        },
        {
          "href": "https://adam-gladstone.github.io/assets/images/Stock%20Valuation.xlsx",
          "text": "Stock Valuation Spreadsheet"
        },
        {
          "href": "https://learn.microsoft.com/en-us/power-query/connectors/web/web",
          "text": "Power Query Web Connector"
        },
        {
          "href": "https://stablebread.com/how-to-calculate-the-intrinsic-value-of-a-company-like-benjamin-graham/",
          "text": "How to Calculate the Intrinsic Value of a Company Like Benjamin Graham"
        },
        {
          "href": "https://adam-gladstone.github.io/python-projects/Building-a-Flask-service-to-get-yfinance-data-Part-I/",
          "text": "Part I"
        },
        {
          "href": "https://github.com/Adam-Gladstone/YFinanceService",
          "text": "YFinanceService"
        },
        {
          "href": "https://adam-gladstone.github.io/python-projects/2025-03-19-Consuming-yfinance-data-in-Excel-Part-II/",
          "text": "Part II"
        },
        {
          "href": "https://adam-gladstone.github.io/python-project/Consuming-yfinance-data-in-Excel-Part-II/",
          "text": "Adam’s Software Lab"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "Consuming yfinance data in Excel – Part II | R-bloggers",
      "images": [
        {
          "alt": "Calculate Intrinsic Value",
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": "Calculate Intrinsic Value",
          "base64": null,
          "src": "https://i0.wp.com/adam-gladstone.github.io/assets/images/Excel-Calculate-Intrinsic-Value.png?w=578&ssl=1"
        },
        {
          "alt": "Ticker Data Request",
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": "Ticker Data Request",
          "base64": null,
          "src": "https://i2.wp.com/adam-gladstone.github.io/assets/images/Ticker-Data-Request.png?w=578&ssl=1"
        },
        {
          "alt": "Building a KeyIndicators Table",
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": "Building a KeyIndicators Table",
          "base64": null,
          "src": "https://i0.wp.com/adam-gladstone.github.io/assets/images/Ticker-Data-Query-M.png?w=578&ssl=1"
        },
        {
          "alt": "CalcIntrinsicValue Query",
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": "CalcIntrinsicValue Query",
          "base64": null,
          "src": "https://i2.wp.com/adam-gladstone.github.io/assets/images/Calc-Intrinsic-Value.png?w=578&ssl=1"
        }
      ],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/adam-gladstone/",
          "text": "Adam Gladstone"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-391340 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Consuming yfinance data in Excel – Part II</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">March 18, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/adam-gladstone/\">Adam Gladstone</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://adam-gladstone.github.io/python-project/Consuming-yfinance-data-in-Excel-Part-II/\"> Adam’s Software Lab</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47--><h3 id=\"introduction\">Introduction</h3>\n<p>The <a href=\"https://adam-gladstone.github.io/python-projects/Building-a-Flask-service-to-get-yfinance-data-Part-I/\" rel=\"nofollow\" target=\"_blank\">first part</a> of this two-part blog described the <a href=\"https://github.com/Adam-Gladstone/YFinanceService\" rel=\"nofollow\" target=\"_blank\">YFinanceService</a>. This is a Flask service that wrapped calls to the Python <strong>yfinance</strong> library and which served up some of the data via the APIs (/IntrinsicValue, /TickerData and so on). <a href=\"https://adam-gladstone.github.io/python-projects/2025-03-19-Consuming-yfinance-data-in-Excel-Part-II/\" rel=\"nofollow\" target=\"_blank\">Part II</a> of the blog describes how to make use of the APIs in an Excel spreadsheet, specifically using the Power Query Web Connector to retrieve the data.</p>\n<h3 id=\"consuming-the-apis-from-excel\">Consuming the APIs from Excel</h3>\n<p>One of the main objectives of this project was to be able to obtain the data from <strong>yfinance</strong> via the <strong>YFinanceService</strong> and use it in Excel. For this, we use the <a href=\"https://adam-gladstone.github.io/assets/images/Stock%20Valuation.xlsx\" rel=\"nofollow\" target=\"_blank\">Stock Valuation Spreadsheet</a>.</p>\n<p><img alt=\"Calculate Intrinsic Value\" data-lazy-src=\"https://i0.wp.com/adam-gladstone.github.io/assets/images/Excel-Calculate-Intrinsic-Value.png?w=578&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img alt=\"Calculate Intrinsic Value\" data-recalc-dims=\"1\" src=\"https://i0.wp.com/adam-gladstone.github.io/assets/images/Excel-Calculate-Intrinsic-Value.png?w=578&amp;ssl=1\"/></noscript></p>\n<p>The spreadsheet uses the <a href=\"https://learn.microsoft.com/en-us/power-query/connectors/web/web\" rel=\"nofollow\" target=\"_blank\">Power Query Web Connector</a>. However, rather than using the Web Connector directly to call our <strong>YFinanceService</strong> APIs, we use Power Query to create blank queries and write the Power Query M language code to obtain the parameters from the worksheets and to process the results into a table.</p>\n<p>The spreadsheet consists of the following worksheets:</p>\n<ul>\n<li>Setup – defines a table (<code>Parameters</code>) with global model parameters (average yield and current yield). This table is passed into the Power Query queries when needed.</li>\n<li>Screener – this sheet obtains the current prices for a number of stocks and calculates the intrinsic value for each, displaying a recommendation alongside the computed safety margin. The margin of safety is discussed in the article <a href=\"https://stablebread.com/how-to-calculate-the-intrinsic-value-of-a-company-like-benjamin-graham/\" rel=\"nofollow\" target=\"_blank\">How to Calculate the Intrinsic Value of a Company Like Benjamin Graham</a>.</li>\n<li>IntrinsicValues – this sheet defines a list of tickers and requests the intrinsic values for all of them. Similar to the above, it displays a recommendation alongside the computed safety margin.</li>\n<li>Ticker Data – this sheet requests a number of key indicators for a list of stock tickers and displays the results.</li>\n</ul>\n<p><img alt=\"Ticker Data Request\" data-lazy-src=\"https://i2.wp.com/adam-gladstone.github.io/assets/images/Ticker-Data-Request.png?w=578&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img alt=\"Ticker Data Request\" data-recalc-dims=\"1\" src=\"https://i2.wp.com/adam-gladstone.github.io/assets/images/Ticker-Data-Request.png?w=578&amp;ssl=1\"/></noscript></p>\n<p>After opening the spreadsheet, select the Setup worksheet and from the Data menu select Queries and Connections. This will list the queries that are used in this sheet. The three main queries are:</p>\n<ul>\n<li><code>KeyIndicators</code> (in the TickerData worksheet)</li>\n<li><code>IntrinsicValues</code> (in the IntrinsicValues worksheet)</li>\n<li><code>CalcIntrinsicValue</code> which depends on the function <code>fnCalcIntrinsicValue</code> (in the Screener worksheet)</li>\n</ul>\n<h4 id=\"keyindicators-query\">KeyIndicators Query</h4>\n<p>The <strong>TickerData</strong> worksheet sets up two tables: <code>TableSymbols</code> and the <code>TableFields</code>. These are used as the inputs to the <code>KeyIndicators</code> query. The Power Query M code builds up the API query string from these inputs and processes the result to produce a table. The query can be refreshed using the refresh symbol on the right-hand side of the <em>Queries &amp; Connections</em> panel.</p>\n<p><img alt=\"Building a KeyIndicators Table\" data-lazy-src=\"https://i0.wp.com/adam-gladstone.github.io/assets/images/Ticker-Data-Query-M.png?w=578&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img alt=\"Building a KeyIndicators Table\" data-recalc-dims=\"1\" src=\"https://i0.wp.com/adam-gladstone.github.io/assets/images/Ticker-Data-Query-M.png?w=578&amp;ssl=1\"/></noscript></p>\n<h4 id=\"intrinsicvalues-query\">IntrinsicValues Query</h4>\n<p>The <strong>IntrinsicValues</strong> worksheet sets up a table called <code>TickerList</code>. Additionally the query obtains the values for the average yield (<code>avg_yield</code>) and the current yield (<code>cur_yield</code>) from the parameters table defined in the <strong>Setup</strong> worksheet. With these values it constructs the API query string and calls the appropriate <strong>YFinanceService</strong>. If the query succeeds, the resulting string is processed into a table with two columns: <em>Ticker</em> and <em>Intrinsic Value</em>.</p>\n<h4 id=\"calcintrinsicvalue-query\">CalcIntrinsicValue Query</h4>\n<p>The <strong>CalcIntrinsicValue</strong> query depends on the <code>fnCalcIntrinsicValue</code> query/function. This in turn depends on a query (<code>IntrinsicValue</code>) which has had a parameter (<code>Ticker</code>) added to it. The parameter is added using the Manage Parameters menu on the Home menu strip. Once the parameter is added we can convert the original query to a function – <code>fnCalcIntrinsicValue</code>. The function can be invoked either by double clicking it or by entering a parameter, the ticker symbol in this case, and pressing “Invoke”. However, we will not use this method of calling the function.</p>\n<p>Instead, we create a further query <code>CalcIntrinsicValue</code>. This creates a new table. The table uses the tickers defined in the <code>TableTickers</code> (input) table and adds a new custom column. The custom column invokes the intrinsic value function for each ticker value.</p>\n<pre>\t// Add custom IntrinsicValue column based on the function fnCalcIntrinsicValue parameterised with each of the Tickers\n    InvokedCustomFunction = Table.AddColumn(TickerSource, \"IntrinsicValue\", each fnCalcIntrinsicValue([Tickers])),\n</pre>\n<p>The function <code>fnCalcIntrinsicValue</code> returns a key-value pair <code>{ value: nnnn }</code>, so we expand the result and use only the second component:</p>\n<pre>    ExpandedIntrinsicValue = Table.ExpandRecordColumn(InvokedCustomFunction, \"IntrinsicValue\", {\"value\"}, {\"IntrinsicValue.value\"}),\n</pre>\n<p>The resulting table is processed to display on the Intrinsic Value column (which is what appears in the worksheet).</p>\n<p><img alt=\"CalcIntrinsicValue Query\" data-lazy-src=\"https://i2.wp.com/adam-gladstone.github.io/assets/images/Calc-Intrinsic-Value.png?w=578&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img alt=\"CalcIntrinsicValue Query\" data-recalc-dims=\"1\" src=\"https://i2.wp.com/adam-gladstone.github.io/assets/images/Calc-Intrinsic-Value.png?w=578&amp;ssl=1\"/></noscript></p>\n<h3 id=\"a-word-about-performance\">A word about performance</h3>\n<p>Overall the performance of the queries is slow. Assuming the <strong>YFinanceService</strong> is already running, and the Excel spreadsheet is open. Then, pressing the refresh button on any of the queries needs to 1) construct a query string, 2) call the API via Web.Contents, and 3) process the results. The call via Web.Contents calls a Flask API which wraps Python code, and in this case calls via <strong>yfinance</strong> and <strong>yahoo_fin</strong>. Both these use web scraping and this is what determines the slow performance.</p>\n<h3 id=\"wrap-up\">Wrap Up</h3>\n<p>In <a href=\"https://adam-gladstone.github.io/python-projects/Building-a-Flask-service-to-get-yfinance-data-Part-I/\" rel=\"nofollow\" target=\"_blank\">Part I</a> we described the <a href=\"https://github.com/Adam-Gladstone/YFinanceService\" rel=\"nofollow\" target=\"_blank\">YFinanceService</a> and the API calls to the Python <strong>yfinance</strong> library. <a href=\"https://adam-gladstone.github.io/python-projects/2025-03-19-Consuming-yfinance-data-in-Excel-Part-II/\" rel=\"nofollow\" target=\"_blank\">Part II</a> described how to make use of the APIs in an Excel spreadsheet, specifically using the Power Query Web Connector to retrieve the data.</p>\n<p>Overall the arrangement that we have is:</p>\n<ul>\n<li>The <strong>YFinanceService</strong> API query (“What is the intrinsic value of this stock using Graham’s formula?”) takes its parameters and inputs from an Excel table and invokes the stock valuation function via the Power Query Web Connector.</li>\n<li>The calculation is done in Python using data from the <strong>yfinance</strong> library.</li>\n<li>The result is served up over Flask endpoints (the API).</li>\n<li>The result data is massaged using the Power Query Web Connector and used in the Excel worksheet for additional calculations.</li>\n</ul>\n<h4 id=\"advantages-and-disadvantages\">Advantages and Disadvantages</h4>\n<p>There are advantages and disadvantages to this approach. The main advantages are:</p>\n<ul>\n<li>it is simple to debug (on the Python side); somewhat less so using the Power Query M language.</li>\n<li>it is relatively simple to extend: you can add more functionality on the Python side, and/or extend the Flask API to support additional endpoints that expose more of the data from <strong>yfinance</strong>.\nThe disadvantages are mainly concerned with the performance.</li>\n<li>the performance is somewhat disappointing. Specifically, in this case we needed some data from another finance package <strong>yahoofinance</strong>. The underlying mechanism requires web-scraping specific yahoo finance pages (and tables and elements etc.) which results in relatively slow performance.</li>\n</ul>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://adam-gladstone.github.io/python-project/Consuming-yfinance-data-in-Excel-Part-II/\"> Adam’s Software Lab</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
      "main_text": "Consuming yfinance data in Excel – Part II\nPosted on\nMarch 18, 2025\nby\nAdam Gladstone\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nAdam’s Software Lab\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nIntroduction\nThe\nfirst part\nof this two-part blog described the\nYFinanceService\n. This is a Flask service that wrapped calls to the Python\nyfinance\nlibrary and which served up some of the data via the APIs (/IntrinsicValue, /TickerData and so on).\nPart II\nof the blog describes how to make use of the APIs in an Excel spreadsheet, specifically using the Power Query Web Connector to retrieve the data.\nConsuming the APIs from Excel\nOne of the main objectives of this project was to be able to obtain the data from\nyfinance\nvia the\nYFinanceService\nand use it in Excel. For this, we use the\nStock Valuation Spreadsheet\n.\nThe spreadsheet uses the\nPower Query Web Connector\n. However, rather than using the Web Connector directly to call our\nYFinanceService\nAPIs, we use Power Query to create blank queries and write the Power Query M language code to obtain the parameters from the worksheets and to process the results into a table.\nThe spreadsheet consists of the following worksheets:\nSetup – defines a table (\nParameters\n) with global model parameters (average yield and current yield). This table is passed into the Power Query queries when needed.\nScreener – this sheet obtains the current prices for a number of stocks and calculates the intrinsic value for each, displaying a recommendation alongside the computed safety margin. The margin of safety is discussed in the article\nHow to Calculate the Intrinsic Value of a Company Like Benjamin Graham\n.\nIntrinsicValues – this sheet defines a list of tickers and requests the intrinsic values for all of them. Similar to the above, it displays a recommendation alongside the computed safety margin.\nTicker Data – this sheet requests a number of key indicators for a list of stock tickers and displays the results.\nAfter opening the spreadsheet, select the Setup worksheet and from the Data menu select Queries and Connections. This will list the queries that are used in this sheet. The three main queries are:\nKeyIndicators\n(in the TickerData worksheet)\nIntrinsicValues\n(in the IntrinsicValues worksheet)\nCalcIntrinsicValue\nwhich depends on the function\nfnCalcIntrinsicValue\n(in the Screener worksheet)\nKeyIndicators Query\nThe\nTickerData\nworksheet sets up two tables:\nTableSymbols\nand the\nTableFields\n. These are used as the inputs to the\nKeyIndicators\nquery. The Power Query M code builds up the API query string from these inputs and processes the result to produce a table. The query can be refreshed using the refresh symbol on the right-hand side of the\nQueries & Connections\npanel.\nIntrinsicValues Query\nThe\nIntrinsicValues\nworksheet sets up a table called\nTickerList\n. Additionally the query obtains the values for the average yield (\navg_yield\n) and the current yield (\ncur_yield\n) from the parameters table defined in the\nSetup\nworksheet. With these values it constructs the API query string and calls the appropriate\nYFinanceService\n. If the query succeeds, the resulting string is processed into a table with two columns:\nTicker\nand\nIntrinsic Value\n.\nCalcIntrinsicValue Query\nThe\nCalcIntrinsicValue\nquery depends on the\nfnCalcIntrinsicValue\nquery/function. This in turn depends on a query (\nIntrinsicValue\n) which has had a parameter (\nTicker\n) added to it. The parameter is added using the Manage Parameters menu on the Home menu strip. Once the parameter is added we can convert the original query to a function –\nfnCalcIntrinsicValue\n. The function can be invoked either by double clicking it or by entering a parameter, the ticker symbol in this case, and pressing “Invoke”. However, we will not use this method of calling the function.\nInstead, we create a further query\nCalcIntrinsicValue\n. This creates a new table. The table uses the tickers defined in the\nTableTickers\n(input) table and adds a new custom column. The custom column invokes the intrinsic value function for each ticker value.\n// Add custom IntrinsicValue column based on the function fnCalcIntrinsicValue parameterised with each of the Tickers\n    InvokedCustomFunction = Table.AddColumn(TickerSource, \"IntrinsicValue\", each fnCalcIntrinsicValue([Tickers])),\nThe function\nfnCalcIntrinsicValue\nreturns a key-value pair\n{ value: nnnn }\n, so we expand the result and use only the second component:\nExpandedIntrinsicValue = Table.ExpandRecordColumn(InvokedCustomFunction, \"IntrinsicValue\", {\"value\"}, {\"IntrinsicValue.value\"}),\nThe resulting table is processed to display on the Intrinsic Value column (which is what appears in the worksheet).\nA word about performance\nOverall the performance of the queries is slow. Assuming the\nYFinanceService\nis already running, and the Excel spreadsheet is open. Then, pressing the refresh button on any of the queries needs to 1) construct a query string, 2) call the API via Web.Contents, and 3) process the results. The call via Web.Contents calls a Flask API which wraps Python code, and in this case calls via\nyfinance\nand\nyahoo_fin\n. Both these use web scraping and this is what determines the slow performance.\nWrap Up\nIn\nPart I\nwe described the\nYFinanceService\nand the API calls to the Python\nyfinance\nlibrary.\nPart II\ndescribed how to make use of the APIs in an Excel spreadsheet, specifically using the Power Query Web Connector to retrieve the data.\nOverall the arrangement that we have is:\nThe\nYFinanceService\nAPI query (“What is the intrinsic value of this stock using Graham’s formula?”) takes its parameters and inputs from an Excel table and invokes the stock valuation function via the Power Query Web Connector.\nThe calculation is done in Python using data from the\nyfinance\nlibrary.\nThe result is served up over Flask endpoints (the API).\nThe result data is massaged using the Power Query Web Connector and used in the Excel worksheet for additional calculations.\nAdvantages and Disadvantages\nThere are advantages and disadvantages to this approach. The main advantages are:\nit is simple to debug (on the Python side); somewhat less so using the Power Query M language.\nit is relatively simple to extend: you can add more functionality on the Python side, and/or extend the Flask API to support additional endpoints that expose more of the data from\nyfinance\n.\nThe disadvantages are mainly concerned with the performance.\nthe performance is somewhat disappointing. Specifically, in this case we needed some data from another finance package\nyahoofinance\n. The underlying mechanism requires web-scraping specific yahoo finance pages (and tables and elements etc.) which results in relatively slow performance.\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nAdam’s Software Lab\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "Have you ever wanted access to __yfinance__ data in an Excel spreadsheet? If so, this two-part blog may be of interest. It describes an approach using a Flask API to access __yfinance__ data and the Power Query queries required to consume the data in Excel.",
      "meta_keywords": null,
      "og_description": "Have you ever wanted access to __yfinance__ data in an Excel spreadsheet? If so, this two-part blog may be of interest. It describes an approach using a Flask API to access __yfinance__ data and the Power Query queries required to consume the data in Excel.",
      "og_image": "https://adam-gladstone.github.io/assets/images/Excel-Calculate-Intrinsic-Value.png",
      "og_title": "Consuming yfinance data in Excel – Part II | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 5.8,
      "sitemap_lastmod": null,
      "twitter_description": "Have you ever wanted access to __yfinance__ data in an Excel spreadsheet? If so, this two-part blog may be of interest. It describes an approach using a Flask API to access __yfinance__ data and the Power Query queries required to consume the data in Excel.",
      "twitter_title": "Consuming yfinance data in Excel – Part II | R-bloggers",
      "url": "https://www.r-bloggers.com/2025/03/consuming-yfinance-data-in-excel-part-ii/",
      "word_count": 1156
    }
  }
}