{
  "uuid": "5b669947-041f-4be3-98f2-4319fcafa4ee",
  "created_at": "2025-11-22 19:58:34",
  "raw_json": {
    "article_author": null,
    "article_headline": null,
    "article_modified": null,
    "article_published": null,
    "article_section": null,
    "article_tags": null,
    "canonical_url": "https://www.r-bloggers.com/2025/05/planning-for-a-3-arm-cluster-randomized-trial-with-a-nested-intervention-and-a-time-to-event-outcome/",
    "crawled_at": "2025-11-22T10:48:43.409743",
    "external_links": [
      {
        "href": "https://www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/",
        "text": "ouR data generation"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      },
      {
        "href": "https://www.rdatagen.net/post/2023-12-19-a-three-arm-trial-using-two-step-randomization/",
        "text": "wrote about"
      },
      {
        "href": "https://onlinelibrary.wiley.com/doi/full/10.1002/sim.8463",
        "text": "gatekeeping"
      },
      {
        "href": "https://www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/",
        "text": "ouR data generation"
      },
      {
        "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
        "text": "daily e-mail updates"
      },
      {
        "href": "https://www.r-project.org/",
        "text": "R"
      },
      {
        "href": "https://www.r-users.com/",
        "text": "Click here if you're looking to post or find an R/data-science job"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      }
    ],
    "h1_title": "R-bloggers",
    "html_title": "Planning for a 3-arm cluster randomized trial with a nested intervention and a time-to-event outcome | R-bloggers",
    "images": [
      {
        "alt": null,
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": null,
        "base64": null,
        "src": "https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_parameters-1.png?w=450&ssl=1"
      },
      {
        "alt": null,
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": null,
        "base64": null,
        "src": "https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_ideal_curves-1.png?w=450&ssl=1"
      },
      {
        "alt": null,
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": null,
        "base64": null,
        "src": "https://i1.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_median-1.png?w=450&ssl=1"
      },
      {
        "alt": null,
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": null,
        "base64": null,
        "src": "https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_provider_km-1.png?w=450&ssl=1"
      }
    ],
    "internal_links": [
      {
        "href": "https://www.r-bloggers.com/author/our-data-generation/",
        "text": "ouR data generation"
      },
      {
        "href": "https://www.r-bloggers.com/category/r-bloggers/",
        "text": "R bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/contact-us/",
        "text": "here"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers.com"
      },
      {
        "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
        "text": "learning R"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      }
    ],
    "lang": "en-US",
    "main_html": "<article class=\"post-392535 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Planning for a 3-arm cluster randomized trial with a nested intervention and a time-to-event outcome</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">May 19, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/our-data-generation/\">ouR data generation</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/\"> ouR data generation</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<p>A researcher recently approached me for advice on a cluster-randomized trial he is developing. He is interested in testing the effectiveness of two interventions and wondered whether a 2×2 factorial design might be the best approach.</p>\n<p>As we discussed the interventions (I’ll call them <span class=\"math inline\">\\(A\\)</span> and <span class=\"math inline\">\\(B\\)</span>), it became clear that <span class=\"math inline\">\\(A\\)</span> was the primary focus. Intervention <span class=\"math inline\">\\(B\\)</span> might enhance the effectiveness of <span class=\"math inline\">\\(A\\)</span>, but on its own, <span class=\"math inline\">\\(B\\)</span> was not expected to have much impact. (It’s also possible that <span class=\"math inline\">\\(A\\)</span> alone doesn’t work, but once <span class=\"math inline\">\\(B\\)</span> is in place, the combination may reap benefits.) Given this, it didn’t seem worthwhile to randomize clinics or providers to receive B alone. We agreed that a three-arm cluster-randomized trial—with (1) control, (2) <span class=\"math inline\">\\(A\\)</span> alone, and (3) <span class=\"math inline\">\\(A + B\\)</span>—would be a more efficient and relevant design.</p>\n<p>A while ago, I <a href=\"https://www.rdatagen.net/post/2023-12-19-a-three-arm-trial-using-two-step-randomization/\" rel=\"nofollow\" target=\"_blank\">wrote about</a> a proposal to conduct a three-arm trial using a two-step randomization scheme. That design assumes that outcomes in the enhanced arm (<span class=\"math inline\">\\(A + B\\)</span>) are uncorrelated with those in the standalone arm <span class=\"math inline\">\\(A\\)</span> within the same cluster. For this project, that assumption didn’t seem plausible, so I recommended sticking with a standard cluster-level randomization.</p>\n<p>The study has three goals:</p>\n<ul>\n<li>Assess the effectiveness of <span class=\"math inline\">\\(A\\)</span> versus control</li>\n<li>Compare <span class=\"math inline\">\\(A + B\\)</span> versus <span class=\"math inline\">\\(A\\)</span> alone</li>\n<li>If <span class=\"math inline\">\\(A\\)</span> alone is ineffective, compare <span class=\"math inline\">\\(A + B\\)</span> versus control</li>\n</ul>\n<p>In other words, we want to make three pairwise comparisons. Initially, we were concerned about needing to adjust our tests for multiple comparisons. However, we decided to use a <a href=\"https://onlinelibrary.wiley.com/doi/full/10.1002/sim.8463\" rel=\"nofollow\" target=\"_blank\">gatekeeping</a> strategy that maintains the overall Type I error rate at 5% while allowing each test to be performed at <span class=\"math inline\">\\(\\alpha = 0.05\\)</span>.</p>\n<p>This post describes how I set up simulations to evaluate sample size requirements for the proposed trial. The primary outcome is a time-to-event measure: the time from an index physician visit to a follow-up visit, which the intervention aims to shorten. I first generated survival data based on estimates from the literature, then simulated the study design under various sample size assumptions. For each scenario, I generated multiple data sets and applied the gatekeeping hypothesis testing framework to estimate statistical power.</p>\n<div class=\"section level3\" id=\"preliminaries\">\n<h3>Preliminaries</h3>\n<p>Before getting started, here are the <code>R</code> packages used in this post. In addition, I’ve set a randomization seed so that if you try to replicate the approach taken here, our results should align.</p>\n<pre>library(simstudy)\nlibrary(data.table)\nlibrary(survival)\nlibrary(coxme)\nlibrary(broom)\n\nset.seed(8271)</pre>\n</div>\n<div class=\"section level3\" id=\"generating-time-to-event-data\">\n<h3>Generating time-to-event data</h3>\n<p>When simulating time-to-event outcomes, one of the first decisions is what the underlying survival curves should look like. I typically start by defining a curve for the control (baseline) condition, and then generate curves for the intervention arms relative to that baseline.</p>\n<div class=\"section level4\" id=\"getting-parameters-that-define-survival-curve\">\n<h4>Getting parameters that define survival curve</h4>\n<p>We identified a comparable study that reported quintiles for the time-to-event outcome. Specifically, 20% of participants had a follow-up within 1.4 months, 40% by 4.7 months, 60% by 8.7 months, and 80% by just over 15 months. We used the <code>survGetParams</code> function from the <code>simstudy</code> package to estimate the Weibull distribution parameters—the intercept in the Weibull formula and the shape—that characterize this baseline survival curve.</p>\n<pre>q20 &lt;- c(1.44, 4.68, 8.69, 15.32)\n\npoints &lt;- list(c(q20[1], 0.80), c(q20[2], 0.60), c(q20[3], 0.40), c(q20[4], 0.20))\ns &lt;- survGetParams(points)\n\ns\n## [1] -1.868399  1.194869</pre>\n<p>We can visualize the idealized survival curve that will be generated using these parameters stored in the vector <code>s</code>:</p>\n<pre>survParamPlot(f = s[1], shape = s[2], points, limits = c(0, 20))</pre>\n<p><img data-lazy-src=\"https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_parameters-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_parameters-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</div>\n</div>\n<div class=\"section level3\" id=\"generating-data-for-a-simpler-two-arm-rct\">\n<h3>Generating data for a simpler two-arm RCT</h3>\n<p>Before getting into the more complicated three-armed cluster randomized trial, I started with a simpler, two-armed randomized controlled trial. The only covariate at the individual level is the binary treatment indicator <span class=\"math inline\">\\(A\\)</span> which takes on values of <span class=\"math inline\">\\(0\\)</span> (control) and <span class=\"math inline\">\\(1\\)</span> (treatment). The time-to-event outcome is a function of the Weibull parameters we just generated based on the quintiles, along with the treatment indicator.</p>\n<pre>def &lt;- defData(varname = \"A\", formula = \"1;1\", dist = \"trtAssign\")\n\ndefS &lt;- \n  defSurv(varname = \"time\", formula = \"..int + A * ..eff\", shape = \"..shape\") |&gt;\n  defSurv(varname = \"censor\", formula = -40, scale = 0.5, shape = 0.10)</pre>\n<p>I generated a large data set to that we can recreate the idealized curve from above. I assumed a hazard ratio of 2 (which is actually parameterized on the log scale):</p>\n<pre>int &lt;- s[1]\nshape &lt;- s[2]\n\neff &lt;- log(2)\n\ndd &lt;- genData(100000, def)\ndd &lt;- genSurv(dd, defS, timeName = \"time\", censorName = \"censor\")</pre>\n<p>Here are the quintiles (and median) from the control arm, which are fairly close to the quintiles from the study:</p>\n<pre>dd[A==0, round(quantile(time, probs = c(0.20, 0.40, 0.50, 0.60, 0.80)), 1)]\n##  20%  40%  50%  60%  80% \n##  1.6  4.2  6.1  8.5 16.4</pre>\n<div class=\"section level4\" id=\"visualizing-the-curve-and-assessing-its-properties\">\n<h4>Visualizing the curve and assessing its properties</h4>\n<p>A plot of the survival curves from the two arms is shown below, with the control arm in yellow and the intervention arm in red:</p>\n<p><img data-lazy-src=\"https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_ideal_curves-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_ideal_curves-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</div>\n<div class=\"section level4\" id=\"fitting-a-model\">\n<h4>Fitting a model</h4>\n<p>I fit a Cox proportional hazards model just to make sure I could recover the hazard ratio I used in generating the data:</p>\n<pre>fit &lt;- coxph(Surv(time, event) ~  factor(A), data = dd)\ntidy(fit, exponentiate = TRUE)\n## # A tibble: 1 × 5\n##   term       estimate std.error statistic p.value\n##   &lt;chr&gt;         &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;\n## 1 factor(A)1     1.99   0.00665      103.       0</pre>\n</div>\n<div class=\"section level4\" id=\"relationship-of-hr-to-median-time-to-event\">\n<h4>Relationship of HR to median time-to-event</h4>\n<p>My collaborator is especially interested in how the interventions might shift the <em>median</em> time-to-event. This essentially raises the question of how the hazard ratio translates to a change in the median. To explore this, I generated a series of data sets using hazard ratios ranging from 1 to 2 and recorded the observed median for each. As expected, when the hazard ratio is 1, the median closely aligns with that of the baseline distribution.</p>\n<pre>getmedian &lt;- function(eff = 0) {\n  \n  dd &lt;- genData(100000, def)\n  dd &lt;- genSurv(dd, defS, timeName = \"time\", censorName = \"censor\")\n  dd[A == 1, round(median(time), 1)]\n  \n}\n\ndm &lt;- rbindlist(lapply(\n  log(seq(1, 2, by = .1)), \n  function(x) data.table(HR = exp(x), median = getmedian(x))\n))</pre>\n<p><img data-lazy-src=\"https://i1.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_median-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i1.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_median-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</div>\n</div>\n<div class=\"section level3\" id=\"simulating-the-three-arm-study-data\">\n<h3>Simulating the three-arm study data</h3>\n<p>In the proposed three-arm cluster randomized trial, there are three levels of measurement: patient, provider, and clinic. Randomization is conducted at the provider level, stratified by clinic. The hazard for individual <span class=\"math inline\">\\(i\\)</span>, treated by provider <span class=\"math inline\">\\(j\\)</span> in clinic <span class=\"math inline\">\\(k\\)</span>, is modeled as:</p>\n<p><span class=\"math display\">\\[\nh_{ijk}(t) = h_0(t) \\exp\\left( \\beta_1 A_{ijk} + \\beta_2 AB_{ijk} + b_j + g_k \\right)\n\\]</span></p>\n<p>where:</p>\n<ul>\n<li><span class=\"math inline\">\\(h_0(t)\\)</span> is the baseline hazard function,</li>\n<li><span class=\"math inline\">\\(\\beta_1\\)</span> is the effect of treatment <span class=\"math inline\">\\(A\\)</span> alone,</li>\n<li><span class=\"math inline\">\\(\\beta_2\\)</span> is the effect of the combination of <span class=\"math inline\">\\(A + B\\)</span>,</li>\n<li><span class=\"math inline\">\\(b_j \\sim N(0, \\sigma^2_b)\\)</span> is the random effect for provider <span class=\"math inline\">\\(j\\)</span>,</li>\n<li><span class=\"math inline\">\\(g_k \\sim N(0, \\sigma^2_g)\\)</span> is the random effect for clinic <span class=\"math inline\">\\(k\\)</span>,</li>\n<li><span class=\"math inline\">\\(A_{ijk} = 1\\)</span> if provider <span class=\"math inline\">\\(j\\)</span> is randomized to treatment <span class=\"math inline\">\\(A\\)</span>, and <span class=\"math inline\">\\(0\\)</span> otherwise,</li>\n<li><span class=\"math inline\">\\(AB_{ijk} = 1\\)</span> if provider <span class=\"math inline\">\\(j\\)</span> is randomized to treatment <span class=\"math inline\">\\(A + B\\)</span>, and 0 otherwise.</li>\n</ul>\n<div class=\"section level4\" id=\"data-definititions\">\n<h4>Data definititions</h4>\n<p>While the model is semi-parametric (i.e., it does not assume a specific distribution for event times), the data generation process is fully parametric, based on the Weibull distribution. Despite this difference, the two are closely aligned: if all goes well, we should be able to recover the parameters used for data generation when fitting the semi-parametric model as we did in the simpler RCT case above.</p>\n<p>Data generation occurs in three broad steps:</p>\n<ol style=\"list-style-type: decimal\">\n<li>Clinic-level: generate the clinic-specific random effect <span class=\"math inline\">\\(g\\)</span>.</li>\n<li>Provider-level: generate the provider-specific random effect <span class=\"math inline\">\\(b\\)</span> and assign treatment.</li>\n<li>Patient-level: generate individual time-to-event outcomes.</li>\n</ol>\n<p>These steps are implemented using the following definitions:</p>\n<pre>defC &lt;- defData(varname = \"g\", formula = 0, variance = \"..s2_clinic\")\n\ndefP &lt;- \n  defDataAdd(varname = \"b\", formula = 0, variance = \"..s2_prov\") |&gt;\n  defDataAdd(varname = \"A\", formula = \"1;1;1\", variance = \"clinic\", dist = \"trtAssign\")\n\ndefS &lt;- defSurv(\n  varname = \"eventTime\", \n  formula = \"..int + b + g + (A==2)*..eff_A + (A==3)*..eff_AB\", \n  shape = \"..shape\") </pre>\n</div>\n<div class=\"section level4\" id=\"data-generation\">\n<h4>Data generation</h4>\n<p>For this simulation, we assumed 16 clinics, each with 6 providers, and 48 patients per provider. A key element of the study is that recruitment occurs over 12 months, and patients are followed for up to 6 months after their recruitment period ends. Thus, follow-up duration varies depending on when a patient enters the study: patients recruited earlier have longer potential follow-up, while those recruited later are more likely to be censored.</p>\n<p>This staggered follow-up is implemented in the final step of data generation:</p>\n<pre>nC &lt;- 16               # number of clinics (clusters)\nnP &lt;- 6                # number of providers per clinic\nnI &lt;- 48               # number of patients per provider\ns2_clinic &lt;- 0.10      # variation across clinics (g)\ns2_prov &lt;- 0.25        # variation across providers (b)\neff_A &lt;- log(c(1.4))   # log HR of intervention A (compared to control)\neff_AB &lt;- log(c(1.6))  # log HR of combined A+B (compared to control)\n\nds &lt;- genData(nC, defC, id = \"clinic\")\ndp &lt;- genCluster(ds, \"clinic\", nP, \"provider\")\ndp &lt;- addColumns(defP, dp)\ndd &lt;- genCluster(dp, \"provider\", nI, \"id\")\ndd &lt;- genSurv(dd, defS)\n\n# assign a patient to a particular month - 4 per month\n\ndd &lt;- trtAssign(dd, nTrt = 12, strata = \"provider\", grpName = \"month\")\n  \ndd[, event := as.integer(eventTime &lt;= 18 - month)]\ndd[, obsTime := pmin(eventTime, 18 - month)]</pre>\n<p>Below is a Kaplan-Meier plot showing survival curves for each provider within each clinic, color-coded by study arm:</p>\n<p><img data-lazy-src=\"https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_provider_km-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_provider_km-1.png?w=450&amp;ssl=1\"/></noscript></p>\n<p>The mixed-effects Cox model recovers the variance components and coefficients used in data generation:</p>\n<pre>me.fit &lt;- coxme(\n  Surv(eventTime, event) ~ factor(A) + (1|provider) + (1|clinic), \n  data = dd\n)\n\nsummary(me.fit)\n## Mixed effects coxme model\n##  Formula: Surv(eventTime, event) ~ factor(A) + (1 | provider) + (1 | clinic) \n##     Data: dd \n## \n##   events, n = 3411, 4608\n## \n## Random effects:\n##      group  variable        sd   variance\n## 1 provider Intercept 0.5437050 0.29561511\n## 2   clinic Intercept 0.3051615 0.09312354\n##                    Chisq    df p    AIC   BIC\n## Integrated loglik  919.4  4.00 0  911.4 886.9\n##  Penalized loglik 1251.0 86.81 0 1077.3 544.8\n## \n## Fixed effects:\n##              coef exp(coef) se(coef)    z       p\n## factor(A)2 0.3207    1.3781   0.1493 2.15 0.03173\n## factor(A)3 0.4650    1.5921   0.1472 3.16 0.00158</pre>\n<p>Typically, I would use this data generation and model fitting code to estimate power or sample size requirements. While I did carry out those steps, I’ve left them out here so that you can try them yourself (though I’m happy to share my code if you’re interested). Beyond estimating sample size, simulation studies like this can also be used to evaluate the Type I error rates of the gatekeeping hypothesis testing framework.</p>\n<!-- ### Power estimates -->\n<!-- ```{r plot_provider, echo=FALSE, fig.width=7, fig.height=4} -->\n<!-- load(\"data/power.rda\") -->\n<!-- ggplot(data = pdata_provider, aes(x = eff_A, y = power, group = diff)) + -->\n<!--   geom_hline(yintercept = 0.8, color = \"white\") + -->\n<!--   geom_line(color = \"grey75\") + -->\n<!--   geom_point(aes(color = factor(diff))) + -->\n<!--   scale_color_manual( -->\n<!--     values = c(\"#004488\", \"#BB5566\"),  -->\n<!--     name = \"HR difference for\\ncombined intervention\") + -->\n<!--   xlab(\"Hazard ratio for provider intervention alone\") + -->\n<!--   guides(color = guide_legend(reverse = TRUE, title.position = \"left\")) + -->\n<!--   scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2)) + -->\n<!--   ggtitle(\"Estimated power: randomization by provider\") + -->\n<!--   theme(panel.grid = element_blank(), -->\n<!--         plot.title = element_text(size = 10, face = \"bold\"), -->\n<!--         legend.title = element_text(size = 8, family = \"Verdana\"), -->\n<!--         legend.position = \"inside\", -->\n<!--         legend.position.inside = c(.75, .25), -->\n<!--         legend.box.just = \"center\" -->\n<!--   ) -->\n<!-- ``` -->\n<!-- ```{r plot_clinic_1, echo=FALSE, fig.width=7, fig.height=4} -->\n<!-- ggplot(data = pdata_clinic_1, aes(x = eff_A, y = power, group = diff)) + -->\n<!--   geom_hline(yintercept = 0.8, color = \"white\") + -->\n<!--   geom_line(color = \"grey75\") + -->\n<!--   geom_point(aes(color = factor(diff))) + -->\n<!--   scale_color_manual( -->\n<!--     values = c(\"#004488\", \"#BB5566\"),  -->\n<!--     name = \"HR difference for\\ncombined intervention\") + -->\n<!--   xlab(\"Hazard ratio for provider intervention alone\") + -->\n<!--   guides(color = guide_legend(reverse = TRUE, title.position = \"left\")) + -->\n<!--   scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2)) + -->\n<!--   ggtitle(\"Estimated power: randomization by clinic\") + -->\n<!--   theme(panel.grid = element_blank(), -->\n<!--         plot.title = element_text(size = 10, face = \"bold\"), -->\n<!--         legend.title = element_text(size = 8, family = \"Verdana\"), -->\n<!--         legend.position = \"inside\", -->\n<!--         legend.position.inside = c(.75, .25), -->\n<!--         legend.box.just = \"center\" -->\n<!--   ) -->\n<!-- ``` -->\n<!-- ```{r plot_clinic_2, echo=FALSE, fig.width=7, fig.height=4} -->\n<!-- ggplot(data = pdata_clinic_2, aes(x = nC, y = power)) + -->\n<!--   geom_hline(yintercept = 0.8, color = \"white\") + -->\n<!--   geom_line(color = \"grey75\") + -->\n<!--   geom_point() + -->\n<!--   xlab(\"Number of clinics\") + -->\n<!--   guides(color = guide_legend(reverse = TRUE, title.position = \"left\")) + -->\n<!--   scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2)) + -->\n<!--   ggtitle(\"Estimated power: randomization by clinic\") + -->\n<!--   theme(panel.grid = element_blank(), -->\n<!--         plot.title = element_text(size = 10, face = \"bold\")) -->\n<!-- ``` -->\n<p>\n</p><p><small><font color=\"darkkhaki\">\nReferences:</font></small></p>\n<p>Proschan, M.A. and Brittain, E.H., 2020. A primer on strong vs weak control of familywise error rate. Statistics in medicine, 39(9), pp.1407-1413.</p>\n</div>\n</div>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/\"> ouR data generation</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
    "main_text": "Planning for a 3-arm cluster randomized trial with a nested intervention and a time-to-event outcome\nPosted on\nMay 19, 2025\nby\nouR data generation\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nouR data generation\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nA researcher recently approached me for advice on a cluster-randomized trial he is developing. He is interested in testing the effectiveness of two interventions and wondered whether a 2×2 factorial design might be the best approach.\nAs we discussed the interventions (I’ll call them\n\\(A\\)\nand\n\\(B\\)\n), it became clear that\n\\(A\\)\nwas the primary focus. Intervention\n\\(B\\)\nmight enhance the effectiveness of\n\\(A\\)\n, but on its own,\n\\(B\\)\nwas not expected to have much impact. (It’s also possible that\n\\(A\\)\nalone doesn’t work, but once\n\\(B\\)\nis in place, the combination may reap benefits.) Given this, it didn’t seem worthwhile to randomize clinics or providers to receive B alone. We agreed that a three-arm cluster-randomized trial—with (1) control, (2)\n\\(A\\)\nalone, and (3)\n\\(A + B\\)\n—would be a more efficient and relevant design.\nA while ago, I\nwrote about\na proposal to conduct a three-arm trial using a two-step randomization scheme. That design assumes that outcomes in the enhanced arm (\n\\(A + B\\)\n) are uncorrelated with those in the standalone arm\n\\(A\\)\nwithin the same cluster. For this project, that assumption didn’t seem plausible, so I recommended sticking with a standard cluster-level randomization.\nThe study has three goals:\nAssess the effectiveness of\n\\(A\\)\nversus control\nCompare\n\\(A + B\\)\nversus\n\\(A\\)\nalone\nIf\n\\(A\\)\nalone is ineffective, compare\n\\(A + B\\)\nversus control\nIn other words, we want to make three pairwise comparisons. Initially, we were concerned about needing to adjust our tests for multiple comparisons. However, we decided to use a\ngatekeeping\nstrategy that maintains the overall Type I error rate at 5% while allowing each test to be performed at\n\\(\\alpha = 0.05\\)\n.\nThis post describes how I set up simulations to evaluate sample size requirements for the proposed trial. The primary outcome is a time-to-event measure: the time from an index physician visit to a follow-up visit, which the intervention aims to shorten. I first generated survival data based on estimates from the literature, then simulated the study design under various sample size assumptions. For each scenario, I generated multiple data sets and applied the gatekeeping hypothesis testing framework to estimate statistical power.\nPreliminaries\nBefore getting started, here are the\nR\npackages used in this post. In addition, I’ve set a randomization seed so that if you try to replicate the approach taken here, our results should align.\nlibrary(simstudy)\nlibrary(data.table)\nlibrary(survival)\nlibrary(coxme)\nlibrary(broom)\n\nset.seed(8271)\nGenerating time-to-event data\nWhen simulating time-to-event outcomes, one of the first decisions is what the underlying survival curves should look like. I typically start by defining a curve for the control (baseline) condition, and then generate curves for the intervention arms relative to that baseline.\nGetting parameters that define survival curve\nWe identified a comparable study that reported quintiles for the time-to-event outcome. Specifically, 20% of participants had a follow-up within 1.4 months, 40% by 4.7 months, 60% by 8.7 months, and 80% by just over 15 months. We used the\nsurvGetParams\nfunction from the\nsimstudy\npackage to estimate the Weibull distribution parameters—the intercept in the Weibull formula and the shape—that characterize this baseline survival curve.\nq20 <- c(1.44, 4.68, 8.69, 15.32)\n\npoints <- list(c(q20[1], 0.80), c(q20[2], 0.60), c(q20[3], 0.40), c(q20[4], 0.20))\ns <- survGetParams(points)\n\ns\n## [1] -1.868399  1.194869\nWe can visualize the idealized survival curve that will be generated using these parameters stored in the vector\ns\n:\nsurvParamPlot(f = s[1], shape = s[2], points, limits = c(0, 20))\nGenerating data for a simpler two-arm RCT\nBefore getting into the more complicated three-armed cluster randomized trial, I started with a simpler, two-armed randomized controlled trial. The only covariate at the individual level is the binary treatment indicator\n\\(A\\)\nwhich takes on values of\n\\(0\\)\n(control) and\n\\(1\\)\n(treatment). The time-to-event outcome is a function of the Weibull parameters we just generated based on the quintiles, along with the treatment indicator.\ndef <- defData(varname = \"A\", formula = \"1;1\", dist = \"trtAssign\")\n\ndefS <- \n  defSurv(varname = \"time\", formula = \"..int + A * ..eff\", shape = \"..shape\") |>\n  defSurv(varname = \"censor\", formula = -40, scale = 0.5, shape = 0.10)\nI generated a large data set to that we can recreate the idealized curve from above. I assumed a hazard ratio of 2 (which is actually parameterized on the log scale):\nint <- s[1]\nshape <- s[2]\n\neff <- log(2)\n\ndd <- genData(100000, def)\ndd <- genSurv(dd, defS, timeName = \"time\", censorName = \"censor\")\nHere are the quintiles (and median) from the control arm, which are fairly close to the quintiles from the study:\ndd[A==0, round(quantile(time, probs = c(0.20, 0.40, 0.50, 0.60, 0.80)), 1)]\n##  20%  40%  50%  60%  80% \n##  1.6  4.2  6.1  8.5 16.4\nVisualizing the curve and assessing its properties\nA plot of the survival curves from the two arms is shown below, with the control arm in yellow and the intervention arm in red:\nFitting a model\nI fit a Cox proportional hazards model just to make sure I could recover the hazard ratio I used in generating the data:\nfit <- coxph(Surv(time, event) ~  factor(A), data = dd)\ntidy(fit, exponentiate = TRUE)\n## # A tibble: 1 × 5\n##   term       estimate std.error statistic p.value\n##   <chr>         <dbl>     <dbl>     <dbl>   <dbl>\n## 1 factor(A)1     1.99   0.00665      103.       0\nRelationship of HR to median time-to-event\nMy collaborator is especially interested in how the interventions might shift the\nmedian\ntime-to-event. This essentially raises the question of how the hazard ratio translates to a change in the median. To explore this, I generated a series of data sets using hazard ratios ranging from 1 to 2 and recorded the observed median for each. As expected, when the hazard ratio is 1, the median closely aligns with that of the baseline distribution.\ngetmedian <- function(eff = 0) {\n  \n  dd <- genData(100000, def)\n  dd <- genSurv(dd, defS, timeName = \"time\", censorName = \"censor\")\n  dd[A == 1, round(median(time), 1)]\n  \n}\n\ndm <- rbindlist(lapply(\n  log(seq(1, 2, by = .1)), \n  function(x) data.table(HR = exp(x), median = getmedian(x))\n))\nSimulating the three-arm study data\nIn the proposed three-arm cluster randomized trial, there are three levels of measurement: patient, provider, and clinic. Randomization is conducted at the provider level, stratified by clinic. The hazard for individual\n\\(i\\)\n, treated by provider\n\\(j\\)\nin clinic\n\\(k\\)\n, is modeled as:\n\\[\nh_{ijk}(t) = h_0(t) \\exp\\left( \\beta_1 A_{ijk} + \\beta_2 AB_{ijk} + b_j + g_k \\right)\n\\]\nwhere:\n\\(h_0(t)\\)\nis the baseline hazard function,\n\\(\\beta_1\\)\nis the effect of treatment\n\\(A\\)\nalone,\n\\(\\beta_2\\)\nis the effect of the combination of\n\\(A + B\\)\n,\n\\(b_j \\sim N(0, \\sigma^2_b)\\)\nis the random effect for provider\n\\(j\\)\n,\n\\(g_k \\sim N(0, \\sigma^2_g)\\)\nis the random effect for clinic\n\\(k\\)\n,\n\\(A_{ijk} = 1\\)\nif provider\n\\(j\\)\nis randomized to treatment\n\\(A\\)\n, and\n\\(0\\)\notherwise,\n\\(AB_{ijk} = 1\\)\nif provider\n\\(j\\)\nis randomized to treatment\n\\(A + B\\)\n, and 0 otherwise.\nData definititions\nWhile the model is semi-parametric (i.e., it does not assume a specific distribution for event times), the data generation process is fully parametric, based on the Weibull distribution. Despite this difference, the two are closely aligned: if all goes well, we should be able to recover the parameters used for data generation when fitting the semi-parametric model as we did in the simpler RCT case above.\nData generation occurs in three broad steps:\nClinic-level: generate the clinic-specific random effect\n\\(g\\)\n.\nProvider-level: generate the provider-specific random effect\n\\(b\\)\nand assign treatment.\nPatient-level: generate individual time-to-event outcomes.\nThese steps are implemented using the following definitions:\ndefC <- defData(varname = \"g\", formula = 0, variance = \"..s2_clinic\")\n\ndefP <- \n  defDataAdd(varname = \"b\", formula = 0, variance = \"..s2_prov\") |>\n  defDataAdd(varname = \"A\", formula = \"1;1;1\", variance = \"clinic\", dist = \"trtAssign\")\n\ndefS <- defSurv(\n  varname = \"eventTime\", \n  formula = \"..int + b + g + (A==2)*..eff_A + (A==3)*..eff_AB\", \n  shape = \"..shape\")\nData generation\nFor this simulation, we assumed 16 clinics, each with 6 providers, and 48 patients per provider. A key element of the study is that recruitment occurs over 12 months, and patients are followed for up to 6 months after their recruitment period ends. Thus, follow-up duration varies depending on when a patient enters the study: patients recruited earlier have longer potential follow-up, while those recruited later are more likely to be censored.\nThis staggered follow-up is implemented in the final step of data generation:\nnC <- 16               # number of clinics (clusters)\nnP <- 6                # number of providers per clinic\nnI <- 48               # number of patients per provider\ns2_clinic <- 0.10      # variation across clinics (g)\ns2_prov <- 0.25        # variation across providers (b)\neff_A <- log(c(1.4))   # log HR of intervention A (compared to control)\neff_AB <- log(c(1.6))  # log HR of combined A+B (compared to control)\n\nds <- genData(nC, defC, id = \"clinic\")\ndp <- genCluster(ds, \"clinic\", nP, \"provider\")\ndp <- addColumns(defP, dp)\ndd <- genCluster(dp, \"provider\", nI, \"id\")\ndd <- genSurv(dd, defS)\n\n# assign a patient to a particular month - 4 per month\n\ndd <- trtAssign(dd, nTrt = 12, strata = \"provider\", grpName = \"month\")\n  \ndd[, event := as.integer(eventTime <= 18 - month)]\ndd[, obsTime := pmin(eventTime, 18 - month)]\nBelow is a Kaplan-Meier plot showing survival curves for each provider within each clinic, color-coded by study arm:\nThe mixed-effects Cox model recovers the variance components and coefficients used in data generation:\nme.fit <- coxme(\n  Surv(eventTime, event) ~ factor(A) + (1|provider) + (1|clinic), \n  data = dd\n)\n\nsummary(me.fit)\n## Mixed effects coxme model\n##  Formula: Surv(eventTime, event) ~ factor(A) + (1 | provider) + (1 | clinic) \n##     Data: dd \n## \n##   events, n = 3411, 4608\n## \n## Random effects:\n##      group  variable        sd   variance\n## 1 provider Intercept 0.5437050 0.29561511\n## 2   clinic Intercept 0.3051615 0.09312354\n##                    Chisq    df p    AIC   BIC\n## Integrated loglik  919.4  4.00 0  911.4 886.9\n##  Penalized loglik 1251.0 86.81 0 1077.3 544.8\n## \n## Fixed effects:\n##              coef exp(coef) se(coef)    z       p\n## factor(A)2 0.3207    1.3781   0.1493 2.15 0.03173\n## factor(A)3 0.4650    1.5921   0.1472 3.16 0.00158\nTypically, I would use this data generation and model fitting code to estimate power or sample size requirements. While I did carry out those steps, I’ve left them out here so that you can try them yourself (though I’m happy to share my code if you’re interested). Beyond estimating sample size, simulation studies like this can also be used to evaluate the Type I error rates of the gatekeeping hypothesis testing framework.\nReferences:\nProschan, M.A. and Brittain, E.H., 2020. A primer on strong vs weak control of familywise error rate. Statistics in medicine, 39(9), pp.1407-1413.\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nouR data generation\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
    "meta_description": "A researcher recently approached me for advice on a cluster-randomized trial he is developing. He is interested in testing the effectiveness of two interventions and wondered whether a 2×2 factorial design might be the best approach. As we discussed...",
    "meta_keywords": null,
    "og_description": "A researcher recently approached me for advice on a cluster-randomized trial he is developing. He is interested in testing the effectiveness of two interventions and wondered whether a 2×2 factorial design might be the best approach. As we discussed...",
    "og_image": "https://www.rdatagen.net/post/2025-05-20-planning-for-a-three-arm-trial-with-a-nested-intervention/index.en_files/figure-html/plot_parameters-1.png",
    "og_title": "Planning for a 3-arm cluster randomized trial with a nested intervention and a time-to-event outcome | R-bloggers",
    "raw_jsonld_article": null,
    "reading_time_min": 9.9,
    "sitemap_lastmod": null,
    "twitter_description": "A researcher recently approached me for advice on a cluster-randomized trial he is developing. He is interested in testing the effectiveness of two interventions and wondered whether a 2×2 factorial design might be the best approach. As we discussed...",
    "twitter_title": "Planning for a 3-arm cluster randomized trial with a nested intervention and a time-to-event outcome | R-bloggers",
    "url": "https://www.r-bloggers.com/2025/05/planning-for-a-3-arm-cluster-randomized-trial-with-a-nested-intervention-and-a-time-to-event-outcome/",
    "word_count": 1979
  }
}