{
  "id": "dfeaa6f1cb1f3dd4da6f6a65e2fae3a5467e3aef",
  "url": "https://www.r-bloggers.com/2024/01/explain-that-tidymodels-blackbox/",
  "created_at_utc": "2025-11-17T20:38:40Z",
  "data": null,
  "raw_original": {
    "uuid": "a4f63e46-131a-41c6-92a0-bad83b19f8c9",
    "created_at": "2025-11-17 20:38:40",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2024/01/explain-that-tidymodels-blackbox/",
      "crawled_at": "2025-11-17T09:22:24.080668",
      "external_links": [
        {
          "href": "https://lorentzen.ch/index.php/2024/01/07/explain-that-tidymodels-blackbox/",
          "text": "R – Michael's and Christian's Blog"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://www.kaggle.com/datasets/iammustafatz/diabetes-prediction-dataset",
          "text": "diabetes prediction dataset of Kaggle"
        },
        {
          "href": "https://lorentzen.ch/index.php/2023/08/01/its-the-interactions/",
          "text": "earlier blog post"
        },
        {
          "href": "https://github.com/lorentzenchr/notebooks/blob/master/blogposts/2024-01-07%20Explain_tidymodels.R",
          "text": "The full R script"
        },
        {
          "href": "https://lorentzen.ch/index.php/2024/01/07/explain-that-tidymodels-blackbox/",
          "text": "R – Michael's and Christian's Blog"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "Explain that tidymodels blackbox! | R-bloggers",
      "images": [
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-2.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-7.png?resize=431%2C369&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-4.png?resize=440%2C357&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-5.png?resize=436%2C376&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-11.png?resize=430%2C352&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-10-1024x404.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-9.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-8.png?resize=431%2C383&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-14.png?resize=435%2C375&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-13.png?resize=423%2C381&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-12-1024x375.png?w=450&ssl=1"
        }
      ],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/michael-mayer/",
          "text": "Michael Mayer"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-381357 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Explain that tidymodels blackbox!</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">January 7, 2024</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/michael-mayer/\">Michael Mayer</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \r\n<div style=\"min-height: 30px;\">\r\n[social4i size=\"small\" align=\"align-left\"]\r\n</div>\r\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\r\n[This article was first published on  <strong><a href=\"https://lorentzen.ch/index.php/2024/01/07/explain-that-tidymodels-blackbox/\"> R – Michael's and Christian's Blog</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 3.8.9-->\n<p>Let’s explain a {tidymodels} random forest by classic explainability methods (permutation importance, partial dependence plots (PDP), Friedman’s H statistics), and also fancy SHAP.</p>\n<p>Disclaimer: {hstats}, {kernelshap} and {shapviz} are three of my own packages.</p>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1394\" data-lazy-sizes=\"(max-width: 458px) 100vw, 458px\" data-lazy-src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-2.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" fetchpriority=\"high\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-2.png?w=450&amp;ssl=1 458w, https://lorentzen.ch/wp-content/uploads/2024/01/image-2-243x300.png 243w\"/><noscript><img alt=\"\" class=\"wp-image-1394\" data-recalc-dims=\"1\" decoding=\"async\" fetchpriority=\"high\" loading=\"lazy\" sizes=\"(max-width: 458px) 100vw, 458px\" src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-2.png?w=450&amp;ssl=1\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-2.png?w=450&amp;ssl=1 458w, https://lorentzen.ch/wp-content/uploads/2024/01/image-2-243x300.png 243w\"/></noscript></figure>\n<h2 class=\"wp-block-heading\">Diabetes data</h2>\n<p>We will use the <a href=\"https://www.kaggle.com/datasets/iammustafatz/diabetes-prediction-dataset\" rel=\"nofollow\" target=\"_blank\">diabetes prediction dataset of Kaggle</a> to model diabetes (yes/no) as a function of six demographic features (age, gender, BMI, hypertension, heart disease, and smoking history). It has 100k rows.</p>\n<p>Note: The data additionally contains the typical diabetes indicators HbA1c level and blood glucose level, but we wont use them to avoid potential causality issues, and to gain insights also for people that do not know these values.</p>\n<div class=\"wp-block-ub-tabbed-content wp-block-ub-tabbed-content-holder wp-block-ub-tabbed-content-horizontal-holder-mobile wp-block-ub-tabbed-content-horizontal-holder-tablet\" id=\"ub-tabbed-content-e6feb20e-f93c-44ee-be02-57d019571e24\">\n<div class=\"wp-block-ub-tabbed-content-tab-holder horizontal-tab-width-mobile horizontal-tab-width-tablet\">\n<div class=\"wp-block-ub-tabbed-content-tabs-title wp-block-ub-tabbed-content-tabs-title-mobile-horizontal-tab wp-block-ub-tabbed-content-tabs-title-tablet-horizontal-tab\" role=\"tablist\"><div aria-controls=\"ub-tabbed-content-e6feb20e-f93c-44ee-be02-57d019571e24-panel-0\" aria-selected=\"true\" class=\"wp-block-ub-tabbed-content-tab-title-wrap active\" id=\"ub-tabbed-content-e6feb20e-f93c-44ee-be02-57d019571e24-tab-0\" role=\"tab\" tabindex=\"-1\">\n<div class=\"wp-block-ub-tabbed-content-tab-title\"><br/><br/>R</div></div></div></div>\n<div class=\"wp-block-ub-tabbed-content-tabs-content\"><div aria-labelledby=\"ub-tabbed-content-61eea646-d523-4e66-9f82-7861e79faf4c-tab-0\" class=\"wp-block-ub-tabbed-content-tab-content-wrap active\" id=\"ub-tabbed-content-61eea646-d523-4e66-9f82-7861e79faf4c-panel-0\" role=\"tabpanel\" tabindex=\"0\">\n<pre># https://www.kaggle.com/datasets/iammustafatz/diabetes-prediction-dataset\n\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(hstats)\nlibrary(kernelshap)\nlibrary(shapviz)\nlibrary(patchwork)\n\ndf0 &lt;- read.csv(\"diabetes_prediction_dataset.csv\")  # from above Kaggle link\ndim(df0)  # 100000 9\nhead(df0)\n# gender age hypertension heart_disease smoking_history   bmi HbA1c_level blood_glucose_level diabetes\n# Female  80            0             1           never 25.19         6.6                 140        0\n# Female  54            0             0         No Info 27.32         6.6                  80        0\n#   Male  28            0             0           never 27.32         5.7                 158        0\n# Female  36            0             0         current 23.45         5.0                 155        0\n#   Male  76            1             1         current 20.14         4.8                 155        0\n# Female  20            0             0           never 27.32         6.6                  85        0\n\nsummary(df0)\nanyNA(df0)  # FALSE\ntable(df0$smoking_history, useNA = \"ifany\")\n\n# DATA PREPARATION\n\n# Note: tidymodels needs a factor response for classification\ndf1 &lt;- df0 |&gt;\n  transform(\n    y = factor(diabetes, levels = 0:1, labels = c(\"No\", \"Yes\")),\n    female = (gender == \"Female\") * 1,\n    smoking_history = factor(\n      smoking_history, \n      levels = c(\"No Info\", \"never\", \"former\", \"not current\", \"current\", \"ever\")\n    ),\n    bmi = pmin(bmi, 50)\n  )\n\n# UNIVARIATE ANALYSIS\n\nggplot(df1, aes(diabetes)) +\n  geom_bar(fill = \"chartreuse4\")\n\ndf1  |&gt;  \n  select(age, bmi, HbA1c_level, blood_glucose_level) |&gt; \n  pivot_longer(everything()) |&gt; \n  ggplot(aes(value)) +\n  geom_histogram(fill = \"chartreuse4\", bins = 19) +\n  facet_wrap(~ name, scale = \"free_x\")\n\nggplot(df1, aes(smoking_history)) +\n  geom_bar(fill = \"chartreuse4\")\n\ndf1 |&gt; \n  select(heart_disease, hypertension, female) |&gt;\n  pivot_longer(everything()) |&gt; \n  ggplot(aes(name, value)) +\n  stat_summary(fun = mean, geom = \"bar\", fill = \"chartreuse4\") +\n  xlab(element_blank())\n</pre>\n</div></div>\n</div>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1399\" data-lazy-sizes=\"(max-width: 431px) 100vw, 431px\" data-lazy-src=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-7.png?resize=431%2C369&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" height=\"369\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-7.png?resize=431%2C369&amp;ssl=1 431w, https://lorentzen.ch/wp-content/uploads/2024/01/image-7-300x257.png 300w\" width=\"431\"/><noscript><img alt=\"\" class=\"wp-image-1399\" data-recalc-dims=\"1\" decoding=\"async\" height=\"369\" loading=\"lazy\" sizes=\"(max-width: 431px) 100vw, 431px\" src=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-7.png?resize=431%2C369&amp;ssl=1\" srcset_temp=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-7.png?resize=431%2C369&amp;ssl=1 431w, https://lorentzen.ch/wp-content/uploads/2024/01/image-7-300x257.png 300w\" width=\"431\"/></noscript><figcaption class=\"wp-element-caption\">“yes” proportion of binary variables (including the response)</figcaption></figure>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1396\" data-lazy-sizes=\"(max-width: 440px) 100vw, 440px\" data-lazy-src=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-4.png?resize=440%2C357&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" height=\"357\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-4.png?resize=440%2C357&amp;ssl=1 440w, https://lorentzen.ch/wp-content/uploads/2024/01/image-4-300x243.png 300w\" width=\"440\"/><noscript><img alt=\"\" class=\"wp-image-1396\" data-recalc-dims=\"1\" decoding=\"async\" height=\"357\" loading=\"lazy\" sizes=\"(max-width: 440px) 100vw, 440px\" src=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-4.png?resize=440%2C357&amp;ssl=1\" srcset_temp=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-4.png?resize=440%2C357&amp;ssl=1 440w, https://lorentzen.ch/wp-content/uploads/2024/01/image-4-300x243.png 300w\" width=\"440\"/></noscript><figcaption class=\"wp-element-caption\">Distribution of numeric variables</figcaption></figure>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1397\" data-lazy-sizes=\"(max-width: 436px) 100vw, 436px\" data-lazy-src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-5.png?resize=436%2C376&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" height=\"376\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-5.png?resize=436%2C376&amp;ssl=1 436w, https://lorentzen.ch/wp-content/uploads/2024/01/image-5-300x259.png 300w\" width=\"436\"/><noscript><img alt=\"\" class=\"wp-image-1397\" data-recalc-dims=\"1\" decoding=\"async\" height=\"376\" loading=\"lazy\" sizes=\"(max-width: 436px) 100vw, 436px\" src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-5.png?resize=436%2C376&amp;ssl=1\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-5.png?resize=436%2C376&amp;ssl=1 436w, https://lorentzen.ch/wp-content/uploads/2024/01/image-5-300x259.png 300w\" width=\"436\"/></noscript><figcaption class=\"wp-element-caption\">Distribution of smoking_history</figcaption></figure>\n<h2 class=\"wp-block-heading\">Modeling</h2>\n<p>Let’s fit a random forest via tidymodels with {ranger} backend. </p>\n<p>We add a predict function <code>pf()</code> that outputs only the probability of the “Yes” class.</p>\n<pre>set.seed(1)\nix &lt;- initial_split(df1, strata = diabetes, prop = 0.8)\ntrain &lt;- training(ix)\ntest &lt;- testing(ix)\n\nxvars &lt;- c(\"age\", \"bmi\", \"smoking_history\", \"heart_disease\", \"hypertension\", \"female\")\n\nrf_spec &lt;- rand_forest(trees = 500) |&gt; \n  set_mode(\"classification\") |&gt; \n  set_engine(\"ranger\", num.threads = NULL, seed = 49)\n\nrf_wf &lt;- workflow() |&gt; \n  add_model(rf_spec) |&gt;\n  add_formula(reformulate(xvars, \"y\"))\n\nmodel &lt;- rf_wf |&gt; \n    fit(train)\n\n# predict() gives No/Yes columns\npredict(model, head(test), type = \"prob\")\n# .pred_No .pred_Yes\n#    0.981    0.0185\n\n# We need to extract only the \"Yes\" probabilities\npf &lt;- function(m, X) {\n  predict(m, X, type = \"prob\")$.pred_Yes\n}\npf(model, head(test))  # 0.01854290 ...\n</pre>\n<h2 class=\"wp-block-heading\">Classic explanation methods</h2>\n<pre># 4 times repeated permutation importance wrt test logloss\nimp &lt;- perm_importance(\n  model, X = test, y = \"diabetes\", v = xvars, pred_fun = pf, loss = \"logloss\"\n)\nplot(imp) +\n  xlab(\"Increase in test logloss\")\n\n# Partial dependence of age\npartial_dep(model, v = \"age\", train, pred_fun = pf) |&gt; \n  plot()\n\n# All PDP in one patchwork\np &lt;- lapply(xvars, function(x) plot(partial_dep(model, v = x, X = train, pred_fun = pf)))\nwrap_plots(p) &amp;\n  ylim(0, 0.23) &amp;\n  ylab(\"Probability\")\n\n# Friedman's H stats\nsystem.time( # 20 s\n  H &lt;- hstats(model, train[xvars], approx = TRUE, pred_fun = pf)\n)\nH  # 15% of prediction variability comes from interactions\nplot(H)\n\n# Stratified PDP of strongest interaction\npartial_dep(model, \"age\", BY = \"bmi\", X = train, pred_fun = pf) |&gt; \n  plot(show_points = FALSE)</pre>\n<h3 class=\"wp-block-heading\">Feature importance</h3>\n<p><em>Permutation importance</em> measures by how much the average test loss (in our case log loss) increases when a feature is shuffled before calculating the losses. We repeat the process four times and also show standard errors.</p>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1403\" data-lazy-sizes=\"(max-width: 430px) 100vw, 430px\" data-lazy-src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-11.png?resize=430%2C352&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" height=\"352\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-11.png?resize=430%2C352&amp;ssl=1 430w, https://lorentzen.ch/wp-content/uploads/2024/01/image-11-300x246.png 300w\" width=\"430\"/><noscript><img alt=\"\" class=\"wp-image-1403\" data-recalc-dims=\"1\" decoding=\"async\" height=\"352\" loading=\"lazy\" sizes=\"(max-width: 430px) 100vw, 430px\" src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-11.png?resize=430%2C352&amp;ssl=1\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-11.png?resize=430%2C352&amp;ssl=1 430w, https://lorentzen.ch/wp-content/uploads/2024/01/image-11-300x246.png 300w\" width=\"430\"/></noscript><figcaption class=\"wp-element-caption\">Permutation importance: Age and BMI are the two main risk factors.</figcaption></figure>\n<h3 class=\"wp-block-heading\">Main effects</h3>\n<p>Main effects are estimated by PDP. They show how the average prediction changes with a feature, keeping every other feature fixed. Using a fixed vertical axis helps to grasp the strenght of the effect.</p>\n<figure class=\"wp-block-image size-large is-resized\"><img alt=\"\" class=\"wp-image-1402\" data-lazy-sizes=\"(max-width: 1024px) 100vw, 1024px\" data-lazy-src=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-10-1024x404.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-10-1024x404.png?w=450&amp;ssl=1 1024w, https://lorentzen.ch/wp-content/uploads/2024/01/image-10-300x118.png 300w, https://lorentzen.ch/wp-content/uploads/2024/01/image-10-768x303.png 768w, https://lorentzen.ch/wp-content/uploads/2024/01/image-10.png 1189w\" style=\"aspect-ratio:2.5346534653465347;width:1014px;height:auto\"/><noscript><img alt=\"\" class=\"wp-image-1402\" data-recalc-dims=\"1\" decoding=\"async\" loading=\"lazy\" sizes=\"(max-width: 1024px) 100vw, 1024px\" src=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-10-1024x404.png?w=450&amp;ssl=1\" srcset_temp=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-10-1024x404.png?w=450&amp;ssl=1 1024w, https://lorentzen.ch/wp-content/uploads/2024/01/image-10-300x118.png 300w, https://lorentzen.ch/wp-content/uploads/2024/01/image-10-768x303.png 768w, https://lorentzen.ch/wp-content/uploads/2024/01/image-10.png 1189w\" style=\"aspect-ratio:2.5346534653465347;width:1014px;height:auto\"/></noscript><figcaption class=\"wp-element-caption\">PDPs: The diabetes risk tends to increase with age, high (and very low) BMI, presence of heart disease/hypertension, and it is a bit lower for females and non-smoker.</figcaption></figure>\n<h3 class=\"wp-block-heading\">Interaction strength</h3>\n<p>Interaction strength can be measured by Friedman’s H statistics, see the <a href=\"https://lorentzen.ch/index.php/2023/08/01/its-the-interactions/\" rel=\"nofollow\" target=\"_blank\">earlier blog post</a>. A specific interaction can then be visualized by a stratified PDP.</p>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1401\" data-lazy-sizes=\"(max-width: 898px) 100vw, 898px\" data-lazy-src=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-9.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-9.png?w=450&amp;ssl=1 898w, https://lorentzen.ch/wp-content/uploads/2024/01/image-9-300x129.png 300w, https://lorentzen.ch/wp-content/uploads/2024/01/image-9-768x330.png 768w\"/><noscript><img alt=\"\" class=\"wp-image-1401\" data-recalc-dims=\"1\" decoding=\"async\" loading=\"lazy\" sizes=\"(max-width: 898px) 100vw, 898px\" src=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-9.png?w=450&amp;ssl=1\" srcset_temp=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-9.png?w=450&amp;ssl=1 898w, https://lorentzen.ch/wp-content/uploads/2024/01/image-9-300x129.png 300w, https://lorentzen.ch/wp-content/uploads/2024/01/image-9-768x330.png 768w\"/></noscript><figcaption class=\"wp-element-caption\">Friedman’s H statistics: Left: BMI and age are the two features with clearly strongest interactions. Right: Their pairwise interaction explains about 10% of their joint effect variability.</figcaption></figure>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1400\" data-lazy-sizes=\"(max-width: 431px) 100vw, 431px\" data-lazy-src=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-8.png?resize=431%2C383&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" height=\"383\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-8.png?resize=431%2C383&amp;ssl=1 431w, https://lorentzen.ch/wp-content/uploads/2024/01/image-8-300x267.png 300w\" width=\"431\"/><noscript><img alt=\"\" class=\"wp-image-1400\" data-recalc-dims=\"1\" decoding=\"async\" height=\"383\" loading=\"lazy\" sizes=\"(max-width: 431px) 100vw, 431px\" src=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-8.png?resize=431%2C383&amp;ssl=1\" srcset_temp=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-8.png?resize=431%2C383&amp;ssl=1 431w, https://lorentzen.ch/wp-content/uploads/2024/01/image-8-300x267.png 300w\" width=\"431\"/></noscript><figcaption class=\"wp-element-caption\">Stratified PDP: The strong interaction between age and BMI is clearly visible. A high BMI makes the age effect on diabetes stronger.</figcaption></figure>\n<h2 class=\"wp-block-heading\">SHAP</h2>\n<p>What insights does a SHAP analysis bring? </p>\n<p>We will crunch slow exact permutation SHAP values via <code>kernelshap::permshap()</code>. If we had more features, we could switch to </p>\n<ul>\n<li><code>kernelshap::kernelshap()</code></li>\n<li>Brandon Greenwell’s {fastshap}, or to the  </li>\n<li>{treeshap} package of my colleages from TU Warsaw.</li>\n</ul>\n<pre>set.seed(1)\nX_explain &lt;- train[sample(1:nrow(train), 1000), xvars]\nX_background &lt;- train[sample(1:nrow(train), 200), ]\n\nsystem.time(  # 10 minutes\n  shap_values &lt;- permshap(model, X = X_explain, bg_X = X_background, pred_fun = pf)\n)\nshap_values &lt;- shapviz(shap_values)\nshap_values  # 'shapviz' object representing 1000 x 6 SHAP matrix\nsaveRDS(shap_values, file = \"shap_values.rds\")\n# shap_values &lt;- readRDS(\"shap_values.rds\")\n\nsv_importance(shap_values, show_numbers = TRUE)\nsv_importance(shap_values, kind = \"bee\")\nsv_dependence(shap_values, v = xvars) &amp;\n  ylim(-0.14, 0.24) &amp;\n  ylab(\"Probability\")</pre>\n<h3 class=\"wp-block-heading\">SHAP importance</h3>\n<figure class=\"wp-block-image size-full\"><img alt=\"\" class=\"wp-image-1406\" data-lazy-sizes=\"(max-width: 435px) 100vw, 435px\" data-lazy-src=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-14.png?resize=435%2C375&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" height=\"375\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-14.png?resize=435%2C375&amp;ssl=1 435w, https://lorentzen.ch/wp-content/uploads/2024/01/image-14-300x259.png 300w\" width=\"435\"/><noscript><img alt=\"\" class=\"wp-image-1406\" data-recalc-dims=\"1\" decoding=\"async\" height=\"375\" loading=\"lazy\" sizes=\"(max-width: 435px) 100vw, 435px\" src=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-14.png?resize=435%2C375&amp;ssl=1\" srcset_temp=\"https://i1.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-14.png?resize=435%2C375&amp;ssl=1 435w, https://lorentzen.ch/wp-content/uploads/2024/01/image-14-300x259.png 300w\" width=\"435\"/></noscript><figcaption class=\"wp-element-caption\">SHAP importance: On average, the age increases or decreases the diabetes probability by 4.7% etc. In this case, the top three features are the same as in permutation importance.</figcaption></figure>\n<h3 class=\"wp-block-heading\">SHAP “summary” plot</h3>\n<figure class=\"wp-block-image size-full is-resized\"><img alt=\"\" class=\"wp-image-1405\" data-lazy-sizes=\"(max-width: 423px) 100vw, 423px\" data-lazy-src=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-13.png?resize=423%2C381&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" height=\"381\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-13.png?resize=423%2C381&amp;ssl=1 423w, https://lorentzen.ch/wp-content/uploads/2024/01/image-13-300x270.png 300w\" style=\"aspect-ratio:1.110236220472441;width:540px;height:auto\" width=\"423\"/><noscript><img alt=\"\" class=\"wp-image-1405\" data-recalc-dims=\"1\" decoding=\"async\" height=\"381\" loading=\"lazy\" sizes=\"(max-width: 423px) 100vw, 423px\" src=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-13.png?resize=423%2C381&amp;ssl=1\" srcset_temp=\"https://i0.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-13.png?resize=423%2C381&amp;ssl=1 423w, https://lorentzen.ch/wp-content/uploads/2024/01/image-13-300x270.png 300w\" style=\"aspect-ratio:1.110236220472441;width:540px;height:auto\" width=\"423\"/></noscript><figcaption class=\"wp-element-caption\">SHAP “summary” plot: Additionally to the bar plot, we see that higher age, higher BMI, hypertension, smoking, males, and having a heart disease are associated with higher diabetes risk.</figcaption></figure>\n<h3 class=\"wp-block-heading\">SHAP dependence plots</h3>\n<figure class=\"wp-block-image size-large is-resized\"><img alt=\"\" class=\"wp-image-1404\" data-lazy-sizes=\"(max-width: 1024px) 100vw, 1024px\" data-lazy-src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-12-1024x375.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" decoding=\"async\" loading=\"lazy\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-12-1024x375.png?w=450&amp;ssl=1 1024w, https://lorentzen.ch/wp-content/uploads/2024/01/image-12-300x110.png 300w, https://lorentzen.ch/wp-content/uploads/2024/01/image-12-768x282.png 768w, https://lorentzen.ch/wp-content/uploads/2024/01/image-12.png 1069w\" style=\"aspect-ratio:2.7306666666666666;width:1171px;height:auto\"/><noscript><img alt=\"\" class=\"wp-image-1404\" data-recalc-dims=\"1\" decoding=\"async\" loading=\"lazy\" sizes=\"(max-width: 1024px) 100vw, 1024px\" src=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-12-1024x375.png?w=450&amp;ssl=1\" srcset_temp=\"https://i2.wp.com/lorentzen.ch/wp-content/uploads/2024/01/image-12-1024x375.png?w=450&amp;ssl=1 1024w, https://lorentzen.ch/wp-content/uploads/2024/01/image-12-300x110.png 300w, https://lorentzen.ch/wp-content/uploads/2024/01/image-12-768x282.png 768w, https://lorentzen.ch/wp-content/uploads/2024/01/image-12.png 1069w\" style=\"aspect-ratio:2.7306666666666666;width:1171px;height:auto\"/></noscript><figcaption class=\"wp-element-caption\">SHAP dependence plots: We see similar shapes as in the PDPs. Thanks to the vertical scatter, we can, e.g., spot that the BMI effect strongly depends on the age. As in the PDPs, we have selected a common vertical scale to also see the effect strength.</figcaption></figure>\n<h2 class=\"wp-block-heading\">Final words</h2>\n<ul>\n<li>{hstats}, {kernelshal} and {shapviz} can explain any model with XAI methods like permutation importance, PDPs, Friedman’s H, and SHAP. This, obviously, also includes models developed with {tidymodels}.</li>\n<li>They would actually even work for multi-output models, e.g., classification with more than two categories.</li>\n<li>Studying a blackbox with XAI methods is always worth the effort, even if the methods have their issues. I.e., an imperfect explanation is still better than no explanation.</li>\n<li>Model-agnostic SHAP takes a little bit of time, but it is usually worth the effort.</li>\n</ul>\n<p><a href=\"https://github.com/lorentzenchr/notebooks/blob/master/blogposts/2024-01-07%20Explain_tidymodels.R\" rel=\"nofollow\" target=\"_blank\">The full R script</a></p>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 3.8.9-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://lorentzen.ch/index.php/2024/01/07/explain-that-tidymodels-blackbox/\"> R – Michael's and Christian's Blog</a></strong>.</div>\n<hr>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\r\n\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</hr></div> </div>\n</article>",
      "main_text": "Explain that tidymodels blackbox!\nPosted on\nJanuary 7, 2024\nby\nMichael Mayer\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nR – Michael's and Christian's Blog\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nLet’s explain a {tidymodels} random forest by classic explainability methods (permutation importance, partial dependence plots (PDP), Friedman’s H statistics), and also fancy SHAP.\nDisclaimer: {hstats}, {kernelshap} and {shapviz} are three of my own packages.\nDiabetes data\nWe will use the\ndiabetes prediction dataset of Kaggle\nto model diabetes (yes/no) as a function of six demographic features (age, gender, BMI, hypertension, heart disease, and smoking history). It has 100k rows.\nNote: The data additionally contains the typical diabetes indicators HbA1c level and blood glucose level, but we wont use them to avoid potential causality issues, and to gain insights also for people that do not know these values.\nR\n# https://www.kaggle.com/datasets/iammustafatz/diabetes-prediction-dataset\n\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(hstats)\nlibrary(kernelshap)\nlibrary(shapviz)\nlibrary(patchwork)\n\ndf0 <- read.csv(\"diabetes_prediction_dataset.csv\")  # from above Kaggle link\ndim(df0)  # 100000 9\nhead(df0)\n# gender age hypertension heart_disease smoking_history   bmi HbA1c_level blood_glucose_level diabetes\n# Female  80            0             1           never 25.19         6.6                 140        0\n# Female  54            0             0         No Info 27.32         6.6                  80        0\n#   Male  28            0             0           never 27.32         5.7                 158        0\n# Female  36            0             0         current 23.45         5.0                 155        0\n#   Male  76            1             1         current 20.14         4.8                 155        0\n# Female  20            0             0           never 27.32         6.6                  85        0\n\nsummary(df0)\nanyNA(df0)  # FALSE\ntable(df0$smoking_history, useNA = \"ifany\")\n\n# DATA PREPARATION\n\n# Note: tidymodels needs a factor response for classification\ndf1 <- df0 |>\n  transform(\n    y = factor(diabetes, levels = 0:1, labels = c(\"No\", \"Yes\")),\n    female = (gender == \"Female\") * 1,\n    smoking_history = factor(\n      smoking_history, \n      levels = c(\"No Info\", \"never\", \"former\", \"not current\", \"current\", \"ever\")\n    ),\n    bmi = pmin(bmi, 50)\n  )\n\n# UNIVARIATE ANALYSIS\n\nggplot(df1, aes(diabetes)) +\n  geom_bar(fill = \"chartreuse4\")\n\ndf1  |>  \n  select(age, bmi, HbA1c_level, blood_glucose_level) |> \n  pivot_longer(everything()) |> \n  ggplot(aes(value)) +\n  geom_histogram(fill = \"chartreuse4\", bins = 19) +\n  facet_wrap(~ name, scale = \"free_x\")\n\nggplot(df1, aes(smoking_history)) +\n  geom_bar(fill = \"chartreuse4\")\n\ndf1 |> \n  select(heart_disease, hypertension, female) |>\n  pivot_longer(everything()) |> \n  ggplot(aes(name, value)) +\n  stat_summary(fun = mean, geom = \"bar\", fill = \"chartreuse4\") +\n  xlab(element_blank())\n“yes” proportion of binary variables (including the response)\nDistribution of numeric variables\nDistribution of smoking_history\nModeling\nLet’s fit a random forest via tidymodels with {ranger} backend.\nWe add a predict function\npf()\nthat outputs only the probability of the “Yes” class.\nset.seed(1)\nix <- initial_split(df1, strata = diabetes, prop = 0.8)\ntrain <- training(ix)\ntest <- testing(ix)\n\nxvars <- c(\"age\", \"bmi\", \"smoking_history\", \"heart_disease\", \"hypertension\", \"female\")\n\nrf_spec <- rand_forest(trees = 500) |> \n  set_mode(\"classification\") |> \n  set_engine(\"ranger\", num.threads = NULL, seed = 49)\n\nrf_wf <- workflow() |> \n  add_model(rf_spec) |>\n  add_formula(reformulate(xvars, \"y\"))\n\nmodel <- rf_wf |> \n    fit(train)\n\n# predict() gives No/Yes columns\npredict(model, head(test), type = \"prob\")\n# .pred_No .pred_Yes\n#    0.981    0.0185\n\n# We need to extract only the \"Yes\" probabilities\npf <- function(m, X) {\n  predict(m, X, type = \"prob\")$.pred_Yes\n}\npf(model, head(test))  # 0.01854290 ...\nClassic explanation methods\n# 4 times repeated permutation importance wrt test logloss\nimp <- perm_importance(\n  model, X = test, y = \"diabetes\", v = xvars, pred_fun = pf, loss = \"logloss\"\n)\nplot(imp) +\n  xlab(\"Increase in test logloss\")\n\n# Partial dependence of age\npartial_dep(model, v = \"age\", train, pred_fun = pf) |> \n  plot()\n\n# All PDP in one patchwork\np <- lapply(xvars, function(x) plot(partial_dep(model, v = x, X = train, pred_fun = pf)))\nwrap_plots(p) &\n  ylim(0, 0.23) &\n  ylab(\"Probability\")\n\n# Friedman's H stats\nsystem.time( # 20 s\n  H <- hstats(model, train[xvars], approx = TRUE, pred_fun = pf)\n)\nH  # 15% of prediction variability comes from interactions\nplot(H)\n\n# Stratified PDP of strongest interaction\npartial_dep(model, \"age\", BY = \"bmi\", X = train, pred_fun = pf) |> \n  plot(show_points = FALSE)\nFeature importance\nPermutation importance\nmeasures by how much the average test loss (in our case log loss) increases when a feature is shuffled before calculating the losses. We repeat the process four times and also show standard errors.\nPermutation importance: Age and BMI are the two main risk factors.\nMain effects\nMain effects are estimated by PDP. They show how the average prediction changes with a feature, keeping every other feature fixed. Using a fixed vertical axis helps to grasp the strenght of the effect.\nPDPs: The diabetes risk tends to increase with age, high (and very low) BMI, presence of heart disease/hypertension, and it is a bit lower for females and non-smoker.\nInteraction strength\nInteraction strength can be measured by Friedman’s H statistics, see the\nearlier blog post\n. A specific interaction can then be visualized by a stratified PDP.\nFriedman’s H statistics: Left: BMI and age are the two features with clearly strongest interactions. Right: Their pairwise interaction explains about 10% of their joint effect variability.\nStratified PDP: The strong interaction between age and BMI is clearly visible. A high BMI makes the age effect on diabetes stronger.\nSHAP\nWhat insights does a SHAP analysis bring?\nWe will crunch slow exact permutation SHAP values via\nkernelshap::permshap()\n. If we had more features, we could switch to\nkernelshap::kernelshap()\nBrandon Greenwell’s {fastshap}, or to the\n{treeshap} package of my colleages from TU Warsaw.\nset.seed(1)\nX_explain <- train[sample(1:nrow(train), 1000), xvars]\nX_background <- train[sample(1:nrow(train), 200), ]\n\nsystem.time(  # 10 minutes\n  shap_values <- permshap(model, X = X_explain, bg_X = X_background, pred_fun = pf)\n)\nshap_values <- shapviz(shap_values)\nshap_values  # 'shapviz' object representing 1000 x 6 SHAP matrix\nsaveRDS(shap_values, file = \"shap_values.rds\")\n# shap_values <- readRDS(\"shap_values.rds\")\n\nsv_importance(shap_values, show_numbers = TRUE)\nsv_importance(shap_values, kind = \"bee\")\nsv_dependence(shap_values, v = xvars) &\n  ylim(-0.14, 0.24) &\n  ylab(\"Probability\")\nSHAP importance\nSHAP importance: On average, the age increases or decreases the diabetes probability by 4.7% etc. In this case, the top three features are the same as in permutation importance.\nSHAP “summary” plot\nSHAP “summary” plot: Additionally to the bar plot, we see that higher age, higher BMI, hypertension, smoking, males, and having a heart disease are associated with higher diabetes risk.\nSHAP dependence plots\nSHAP dependence plots: We see similar shapes as in the PDPs. Thanks to the vertical scatter, we can, e.g., spot that the BMI effect strongly depends on the age. As in the PDPs, we have selected a common vertical scale to also see the effect strength.\nFinal words\n{hstats}, {kernelshal} and {shapviz} can explain any model with XAI methods like permutation importance, PDPs, Friedman’s H, and SHAP. This, obviously, also includes models developed with {tidymodels}.\nThey would actually even work for multi-output models, e.g., classification with more than two categories.\nStudying a blackbox with XAI methods is always worth the effort, even if the methods have their issues. I.e., an imperfect explanation is still better than no explanation.\nModel-agnostic SHAP takes a little bit of time, but it is usually worth the effort.\nThe full R script\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nR – Michael's and Christian's Blog\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "In this post you will learn how to explain a {tidymodels} blackbox with classic XAI and SHAP.",
      "meta_keywords": null,
      "og_description": "In this post you will learn how to explain a {tidymodels} blackbox with classic XAI and SHAP.",
      "og_image": "https://lorentzen.ch/wp-content/uploads/2024/01/image-2.png",
      "og_title": "Explain that tidymodels blackbox! | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 6.2,
      "sitemap_lastmod": "2024-01-07T09:37:24+00:00",
      "twitter_description": "In this post you will learn how to explain a {tidymodels} blackbox with classic XAI and SHAP.",
      "twitter_title": "Explain that tidymodels blackbox! | R-bloggers",
      "url": "https://www.r-bloggers.com/2024/01/explain-that-tidymodels-blackbox/",
      "word_count": 1247
    }
  }
}