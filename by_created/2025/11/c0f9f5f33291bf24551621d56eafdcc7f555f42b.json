{
  "id": "c0f9f5f33291bf24551621d56eafdcc7f555f42b",
  "url": "https://www.r-bloggers.com/2025/03/a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/",
  "created_at_utc": "2025-11-22T19:59:04Z",
  "data": null,
  "raw_original": {
    "uuid": "d3e3df28-7d29-435f-bfb0-a0d0018f6d3a",
    "created_at": "2025-11-22 19:59:04",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2025/03/a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/",
      "crawled_at": "2025-11-22T10:52:30.817755",
      "external_links": [
        {
          "href": "https://www.rdatagen.net/post/2025-03-25-a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/",
          "text": "ouR data generation"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/",
          "text": "introduced"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/",
          "text": "extended"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/",
          "text": "post"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/",
          "text": "here"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/",
          "text": "here"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/",
          "text": "here"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-03-25-a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/",
          "text": "ouR data generation"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "A Bayesian proportional hazards model for a cluster randomized trial | R-bloggers",
      "images": [
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/www.rdatagen.net/post/2025-03-25-a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/index.en_files/figure-html/clusterplot-1.png?w=450&ssl=1"
        }
      ],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/keith-goldfeld/",
          "text": "Keith Goldfeld"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-391429 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">A Bayesian proportional hazards model for a cluster randomized trial</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">March 24, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/keith-goldfeld/\">Keith Goldfeld</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://www.rdatagen.net/post/2025-03-25-a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/\"> ouR data generation</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<p>In recent posts, I <a href=\"https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/\" rel=\"nofollow\" target=\"_blank\">introduced</a> a Bayesian approach to proportional hazards modeling and then <a href=\"https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/\" rel=\"nofollow\" target=\"_blank\">extended</a> it to incorporate a penalized spline. (There was also a third <a href=\"https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/\" rel=\"nofollow\" target=\"_blank\">post</a> on handling ties when multiple individuals share the same event time.) This post describes another extension: a random effect to account for clustering in a cluster randomized trial. With this in place, I’ll be ready to tackle the final step—building a model for analyzing a stepped-wedge cluster-randomized trial that incorporates both splines and site-specific random effects.</p>\n<div class=\"section level3\" id=\"simulating-data-with-a-cluster-specific-random-effect\">\n<h3>Simulating data with a cluster-specific random effect</h3>\n<p>Here are the <code>R</code> packages used in the post:</p>\n<pre>library(simstudy)\nlibrary(ggplot2)\nlibrary(data.table)\nlibrary(survival)\nlibrary(survminer)\nlibrary(cmdstanr)</pre>\n<p>The dataset simulates a cluster randomized trial where sites are randomized in a <span class=\"math inline\">\\(1:1\\)</span> ratio to either the treatment group (<span class=\"math inline\">\\(A=1\\)</span>) or control group (<span class=\"math inline\">\\(A=0\\)</span>). Patients are affiliated with sites and receive the intervention based on site-level randomization. The time-to-event outcome, <span class=\"math inline\">\\(Y\\)</span>, is measured at the patient level and depends on both the site’s treatment assignment and unmeasured site effects:</p>\n<pre>defC &lt;- \n  defData(varname = \"b\", formula = 0, variance = \"..s2_b\", dist = \"normal\") |&gt;\n  defData(varname = \"A\", formula = \"1;1\", dist = \"trtAssign\")\n\ndefS &lt;-\n  defSurv(\n    varname = \"timeEvent\",\n    formula = \"-11.6 + ..delta_f * A + b\",\n    shape = 0.30\n  )  |&gt;\n  defSurv(varname = \"censorTime\", formula = -11.3, shape = .40)\ndelta_f &lt;- 0.7\ns2_b &lt;- 0.4^2</pre>\n<p>I’ve generated a single data set of 50 sites, with 25 in each arm. Each site includes 100 patients. The plot below shows the site-specific Kaplan-Meier curves for each intervention arm.</p>\n<pre>set.seed(1821)\n\ndc &lt;- genData(50, defC, id = \"site\")\ndd &lt;- genCluster(dc, \"site\", numIndsVar = 100, level1ID = \"id\")\ndd &lt;- genSurv(dd, defS, timeName = \"Y\", censorName = \"censorTime\",\n             eventName = \"event\", typeName = \"eventType\", keepEvents = TRUE)</pre>\n<p><img data-lazy-src=\"https://i0.wp.com/www.rdatagen.net/post/2025-03-25-a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/index.en_files/figure-html/clusterplot-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/www.rdatagen.net/post/2025-03-25-a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/index.en_files/figure-html/clusterplot-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</div>\n<div class=\"section level3\" id=\"bayesian-model\">\n<h3>Bayesian model</h3>\n<p>Since this is the fourth iteration of the Bayesian proportional hazards model I’ve been working on, it naturally builds directly on the approach from my previous three posts (<a href=\"https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/\" rel=\"nofollow\" target=\"_blank\">here</a>. <a href=\"https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/\" rel=\"nofollow\" target=\"_blank\">here</a>, and <a href=\"https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/\" rel=\"nofollow\" target=\"_blank\">here</a>). Now, the partial log likelihood is a function of the treatment effect and cluster-specific random effects, given by:</p>\n<p><span class=\"math display\">\\[\n\\log L(\\beta) = \\sum_{j=1}^{J} \\left[ \\sum_{i \\in D_j}  \\left(\\beta A_i + b_{s[i]} \\right) - \\sum_{r=0}^{d_j-1} \\log \\left( \\sum_{k \\in R_j}  \\left(\\beta A_k + b_{s[k]} \\right) - r \\cdot \\bar{w}_j \\right) \\right] \\\\\n\\]</span></p>\n<ul>\n<li><span class=\"math inline\">\\(D_j\\)</span> is the set of individuals who experience an event at time <span class=\"math inline\">\\(t_j\\)</span>.</li>\n<li><span class=\"math inline\">\\(R_j\\)</span> is the risk set at time <span class=\"math inline\">\\(t_j\\)</span>, including all individuals who are still at risk at that time.</li>\n<li><span class=\"math inline\">\\(d_j\\)</span> is the number of events occurring at time <span class=\"math inline\">\\(t_j\\)</span>.</li>\n<li><span class=\"math inline\">\\(r\\)</span> ranges from 0 to <span class=\"math inline\">\\(d_j - 1\\)</span>, iterating over the tied events.</li>\n<li><span class=\"math inline\">\\(\\bar{w}_j\\)</span> represents the average risk weight of individuals experiencing an event at <span class=\"math inline\">\\(t_j\\)</span>:</li>\n</ul>\n<p><span class=\"math display\">\\[\\bar{w}_j = \\frac{1}{d_j} \\sum_{i \\in D_j}  \\left(\\beta A_i + b_{s[i]} \\right)\\]</span></p>\n<p>where:</p>\n<ul>\n<li><span class=\"math inline\">\\(N\\)</span>: number of observations (censored or not)</li>\n<li><span class=\"math inline\">\\(A_i\\)</span>: binary indicator for treatment</li>\n<li><span class=\"math inline\">\\(\\delta_i\\)</span>: event indicator (<span class=\"math inline\">\\(\\delta_i = 1\\)</span> if the event occurred, <span class=\"math inline\">\\(\\delta_i = 0\\)</span> if censored)</li>\n<li><span class=\"math inline\">\\(\\beta\\)</span>: treatment coefficient</li>\n<li><span class=\"math inline\">\\(b_{s[i]}\\)</span>: cluster-specific random effect, where <span class=\"math inline\">\\(s[i]\\)</span> is the cluster of patient <span class=\"math inline\">\\(i\\)</span></li>\n<li><span class=\"math inline\">\\(R(t_i)\\)</span>: risk set at time <span class=\"math inline\">\\(t_i\\)</span> (including only individuals censored <em>after</em> <span class=\"math inline\">\\(t_i\\)</span>)</li>\n</ul>\n<p>The assumed prior distributions for <span class=\"math inline\">\\(\\beta\\)</span> and the random effects are:</p>\n<p><span class=\"math display\">\\[\n\\begin{aligned}\n\\beta &amp;\\sim N(0,4) \\\\\nb_i &amp;\\sim N(0,\\sigma_b) \\\\\n\\sigma_b &amp;\\sim t_{\\text{student}}(df = 3, \\mu=0, \\sigma = 2)\n\\end{aligned}\n\\]</span></p>\n<pre>stan_code &lt;- \n\"\ndata {\n  \n  int&lt;lower=0&gt; S;                   // Number of clusters\n\n  int&lt;lower=0&gt; K;                   // Number of covariates\n  int&lt;lower=0&gt; N_o;                 // Number of uncensored observations\n  array[N_o] int i_o;               // Index in data set\n\n  int&lt;lower=0&gt; N;                   // Number of total observations\n  matrix[N, K] x;                   // Covariates for all observations\n  array[N] int&lt;lower=1,upper=S&gt; s;  // Cluster for each observation\n  \n  array[N] int index;\n  \n  int&lt;lower=0&gt; T;            // Number of records as ties\n  int&lt;lower=1&gt; G;            // Number of groups of ties\n  array[T] int t_grp;        // Indicating tie group\n  array[T] int t_index;      // Index in data set\n  vector[T] t_adj;           // Adjustment for ties (efron)\n\n}\n\nparameters {\n  \n  vector[K] beta;          // Fixed effects for covariates\n  vector[S] b;             // Random effects\n  real&lt;lower=0&gt; sigma_b;   // Variance of random effect\n  \n}\n\nmodel {\n  \n  // Prior\n  \n  beta ~ normal(0, 4);\n  b ~ normal(0, sigma_b);\n  sigma_b ~ student_t(3, 0, 2);\n  \n  // Calculate theta for each observation to be used in likelihood\n  \n  vector[N] theta;\n  vector[N] log_sum_exp_theta;\n  vector[G] exp_theta_grp = rep_vector(0, G);\n  \n  int first_in_grp;\n\n  \n  for (i in 1:N) {\n    theta[i] = dot_product(x[i], beta) + b[s[i]];  \n  }\n  \n  // Computing cumulative sum of log(exp(theta)) from last to first observation\n  \n  log_sum_exp_theta[N] = theta[N];\n  \n  for (i in tail(sort_indices_desc(index), N-1)) {\n    log_sum_exp_theta[i] = log_sum_exp(theta[i], log_sum_exp_theta[i + 1]);\n  }\n\n  // Efron algorithm - adjusting cumulative sum for ties\n  \n  for (i in 1:T) {\n    exp_theta_grp[t_grp[i]] += exp(theta[t_index[i]]);\n  }\n\n  for (i in 1:T) {\n  \n    if (t_adj[i] == 0) {\n      first_in_grp = t_index[i];\n    }\n\n    log_sum_exp_theta[t_index[i]] =\n      log( exp(log_sum_exp_theta[first_in_grp]) - t_adj[i] * exp_theta_grp[t_grp[i]]);\n  }\n  \n  // Likelihood for uncensored observations\n\n  for (n_o in 1:N_o) {\n    target += theta[i_o[n_o]] - log_sum_exp_theta[i_o[n_o]];\n  }\n}\n\"</pre>\n<p>Getting the data ready to pass to <code>Stan</code>, compiling the <code>Stan</code> code, and sampling from the model using <code>cmdstanr</code>:</p>\n<pre>dx &lt;- copy(dd)\nsetorder(dx, Y)\ndx[, index := .I]\n\ndx.obs &lt;- dx[event == 1]\nN_obs &lt;- dx.obs[, .N]\ni_obs &lt;- dx.obs[, index]\n\nN_all &lt;- dx[, .N]\nx_all &lt;- data.frame(dx[, .(A)])\ns_all &lt;- dx[, site]\n\nK &lt;- ncol(x_all)                 # num covariates - in this case just A\nS &lt;- dx[, length(unique(site))]\n\nties &lt;- dx[, .N, keyby = Y][N&gt;1, .(grp = .I, Y)]\nties &lt;- merge(ties, dx, by = \"Y\")\nties &lt;- ties[, order := 1:.N, keyby = grp][, .(grp, index)]\nties[, adj := 0:(.N-1)/.N, keyby = grp]\n\nstan_data &lt;- list(\n  S = S,\n  K = K,\n  N_o = N_obs,\n  i_o = i_obs,\n  N = N_all,\n  x = x_all,\n  s = s_all,\n  index = dx$index,\n  T = nrow(ties),\n  G = max(ties$grp),\n  t_grp = ties$grp,\n  t_index = ties$index,\n  t_adj = ties$adj\n)\n\n# compiling code\n\nstan_model &lt;- cmdstan_model(write_stan_file(stan_code))\n\n# sampling from model\n\nfit &lt;- stan_model$sample(\n  data = stan_data,\n  seed = 1234, \n  iter_warmup = 1000,\n  iter_sampling = 4000,\n  chains = 4,\n  parallel_chains = 4,\n  refresh = 0\n)\n## Running MCMC with 4 parallel chains...\n## Chain 2 finished in 40.0 seconds.\n## Chain 3 finished in 40.0 seconds.\n## Chain 1 finished in 40.3 seconds.\n## Chain 4 finished in 40.5 seconds.\n## \n## All 4 chains finished successfully.\n## Mean chain execution time: 40.2 seconds.\n## Total execution time: 40.6 seconds.</pre>\n<p>The posterior mean for <span class=\"math inline\">\\(\\beta\\)</span>, the treatment effect, is quite close to the “true” value of 0.70, as is the estimate of the standard deviation of the random effect (we used <span class=\"math inline\">\\(sd = 0.4\\)</span> in the data generating process):</p>\n<pre>fit$summary(variables = c(\"beta\", \"sigma_b\"))\n## # A tibble: 2 × 10\n##   variable  mean median     sd    mad    q5   q95  rhat ess_bulk ess_tail\n##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;\n## 1 beta[1]  0.659  0.660 0.124  0.124  0.455 0.863  1.00    1529.    3265.\n## 2 sigma_b  0.417  0.413 0.0472 0.0458 0.347 0.501  1.00   15493.   11171.</pre>\n<p>The final post in this series will include code to simulate data from a stepped-wedge cluster-randomized trial with a time-to-event outcome. This model will integrate both the spline and random effect components. I’m curious to see how well it performs, as the required computational resources could be substantial.</p>\n</div>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://www.rdatagen.net/post/2025-03-25-a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/\"> ouR data generation</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
      "main_text": "A Bayesian proportional hazards model for a cluster randomized trial\nPosted on\nMarch 24, 2025\nby\nKeith Goldfeld\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nouR data generation\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nIn recent posts, I\nintroduced\na Bayesian approach to proportional hazards modeling and then\nextended\nit to incorporate a penalized spline. (There was also a third\npost\non handling ties when multiple individuals share the same event time.) This post describes another extension: a random effect to account for clustering in a cluster randomized trial. With this in place, I’ll be ready to tackle the final step—building a model for analyzing a stepped-wedge cluster-randomized trial that incorporates both splines and site-specific random effects.\nSimulating data with a cluster-specific random effect\nHere are the\nR\npackages used in the post:\nlibrary(simstudy)\nlibrary(ggplot2)\nlibrary(data.table)\nlibrary(survival)\nlibrary(survminer)\nlibrary(cmdstanr)\nThe dataset simulates a cluster randomized trial where sites are randomized in a\n\\(1:1\\)\nratio to either the treatment group (\n\\(A=1\\)\n) or control group (\n\\(A=0\\)\n). Patients are affiliated with sites and receive the intervention based on site-level randomization. The time-to-event outcome,\n\\(Y\\)\n, is measured at the patient level and depends on both the site’s treatment assignment and unmeasured site effects:\ndefC <- \n  defData(varname = \"b\", formula = 0, variance = \"..s2_b\", dist = \"normal\") |>\n  defData(varname = \"A\", formula = \"1;1\", dist = \"trtAssign\")\n\ndefS <-\n  defSurv(\n    varname = \"timeEvent\",\n    formula = \"-11.6 + ..delta_f * A + b\",\n    shape = 0.30\n  )  |>\n  defSurv(varname = \"censorTime\", formula = -11.3, shape = .40)\ndelta_f <- 0.7\ns2_b <- 0.4^2\nI’ve generated a single data set of 50 sites, with 25 in each arm. Each site includes 100 patients. The plot below shows the site-specific Kaplan-Meier curves for each intervention arm.\nset.seed(1821)\n\ndc <- genData(50, defC, id = \"site\")\ndd <- genCluster(dc, \"site\", numIndsVar = 100, level1ID = \"id\")\ndd <- genSurv(dd, defS, timeName = \"Y\", censorName = \"censorTime\",\n             eventName = \"event\", typeName = \"eventType\", keepEvents = TRUE)\nBayesian model\nSince this is the fourth iteration of the Bayesian proportional hazards model I’ve been working on, it naturally builds directly on the approach from my previous three posts (\nhere\n.\nhere\n, and\nhere\n). Now, the partial log likelihood is a function of the treatment effect and cluster-specific random effects, given by:\n\\[\n\\log L(\\beta) = \\sum_{j=1}^{J} \\left[ \\sum_{i \\in D_j}  \\left(\\beta A_i + b_{s[i]} \\right) - \\sum_{r=0}^{d_j-1} \\log \\left( \\sum_{k \\in R_j}  \\left(\\beta A_k + b_{s[k]} \\right) - r \\cdot \\bar{w}_j \\right) \\right] \\\\\n\\]\n\\(D_j\\)\nis the set of individuals who experience an event at time\n\\(t_j\\)\n.\n\\(R_j\\)\nis the risk set at time\n\\(t_j\\)\n, including all individuals who are still at risk at that time.\n\\(d_j\\)\nis the number of events occurring at time\n\\(t_j\\)\n.\n\\(r\\)\nranges from 0 to\n\\(d_j - 1\\)\n, iterating over the tied events.\n\\(\\bar{w}_j\\)\nrepresents the average risk weight of individuals experiencing an event at\n\\(t_j\\)\n:\n\\[\\bar{w}_j = \\frac{1}{d_j} \\sum_{i \\in D_j}  \\left(\\beta A_i + b_{s[i]} \\right)\\]\nwhere:\n\\(N\\)\n: number of observations (censored or not)\n\\(A_i\\)\n: binary indicator for treatment\n\\(\\delta_i\\)\n: event indicator (\n\\(\\delta_i = 1\\)\nif the event occurred,\n\\(\\delta_i = 0\\)\nif censored)\n\\(\\beta\\)\n: treatment coefficient\n\\(b_{s[i]}\\)\n: cluster-specific random effect, where\n\\(s[i]\\)\nis the cluster of patient\n\\(i\\)\n\\(R(t_i)\\)\n: risk set at time\n\\(t_i\\)\n(including only individuals censored\nafter\n\\(t_i\\)\n)\nThe assumed prior distributions for\n\\(\\beta\\)\nand the random effects are:\n\\[\n\\begin{aligned}\n\\beta &\\sim N(0,4) \\\\\nb_i &\\sim N(0,\\sigma_b) \\\\\n\\sigma_b &\\sim t_{\\text{student}}(df = 3, \\mu=0, \\sigma = 2)\n\\end{aligned}\n\\]\nstan_code <- \n\"\ndata {\n  \n  int<lower=0> S;                   // Number of clusters\n\n  int<lower=0> K;                   // Number of covariates\n  int<lower=0> N_o;                 // Number of uncensored observations\n  array[N_o] int i_o;               // Index in data set\n\n  int<lower=0> N;                   // Number of total observations\n  matrix[N, K] x;                   // Covariates for all observations\n  array[N] int<lower=1,upper=S> s;  // Cluster for each observation\n  \n  array[N] int index;\n  \n  int<lower=0> T;            // Number of records as ties\n  int<lower=1> G;            // Number of groups of ties\n  array[T] int t_grp;        // Indicating tie group\n  array[T] int t_index;      // Index in data set\n  vector[T] t_adj;           // Adjustment for ties (efron)\n\n}\n\nparameters {\n  \n  vector[K] beta;          // Fixed effects for covariates\n  vector[S] b;             // Random effects\n  real<lower=0> sigma_b;   // Variance of random effect\n  \n}\n\nmodel {\n  \n  // Prior\n  \n  beta ~ normal(0, 4);\n  b ~ normal(0, sigma_b);\n  sigma_b ~ student_t(3, 0, 2);\n  \n  // Calculate theta for each observation to be used in likelihood\n  \n  vector[N] theta;\n  vector[N] log_sum_exp_theta;\n  vector[G] exp_theta_grp = rep_vector(0, G);\n  \n  int first_in_grp;\n\n  \n  for (i in 1:N) {\n    theta[i] = dot_product(x[i], beta) + b[s[i]];  \n  }\n  \n  // Computing cumulative sum of log(exp(theta)) from last to first observation\n  \n  log_sum_exp_theta[N] = theta[N];\n  \n  for (i in tail(sort_indices_desc(index), N-1)) {\n    log_sum_exp_theta[i] = log_sum_exp(theta[i], log_sum_exp_theta[i + 1]);\n  }\n\n  // Efron algorithm - adjusting cumulative sum for ties\n  \n  for (i in 1:T) {\n    exp_theta_grp[t_grp[i]] += exp(theta[t_index[i]]);\n  }\n\n  for (i in 1:T) {\n  \n    if (t_adj[i] == 0) {\n      first_in_grp = t_index[i];\n    }\n\n    log_sum_exp_theta[t_index[i]] =\n      log( exp(log_sum_exp_theta[first_in_grp]) - t_adj[i] * exp_theta_grp[t_grp[i]]);\n  }\n  \n  // Likelihood for uncensored observations\n\n  for (n_o in 1:N_o) {\n    target += theta[i_o[n_o]] - log_sum_exp_theta[i_o[n_o]];\n  }\n}\n\"\nGetting the data ready to pass to\nStan\n, compiling the\nStan\ncode, and sampling from the model using\ncmdstanr\n:\ndx <- copy(dd)\nsetorder(dx, Y)\ndx[, index := .I]\n\ndx.obs <- dx[event == 1]\nN_obs <- dx.obs[, .N]\ni_obs <- dx.obs[, index]\n\nN_all <- dx[, .N]\nx_all <- data.frame(dx[, .(A)])\ns_all <- dx[, site]\n\nK <- ncol(x_all)                 # num covariates - in this case just A\nS <- dx[, length(unique(site))]\n\nties <- dx[, .N, keyby = Y][N>1, .(grp = .I, Y)]\nties <- merge(ties, dx, by = \"Y\")\nties <- ties[, order := 1:.N, keyby = grp][, .(grp, index)]\nties[, adj := 0:(.N-1)/.N, keyby = grp]\n\nstan_data <- list(\n  S = S,\n  K = K,\n  N_o = N_obs,\n  i_o = i_obs,\n  N = N_all,\n  x = x_all,\n  s = s_all,\n  index = dx$index,\n  T = nrow(ties),\n  G = max(ties$grp),\n  t_grp = ties$grp,\n  t_index = ties$index,\n  t_adj = ties$adj\n)\n\n# compiling code\n\nstan_model <- cmdstan_model(write_stan_file(stan_code))\n\n# sampling from model\n\nfit <- stan_model$sample(\n  data = stan_data,\n  seed = 1234, \n  iter_warmup = 1000,\n  iter_sampling = 4000,\n  chains = 4,\n  parallel_chains = 4,\n  refresh = 0\n)\n## Running MCMC with 4 parallel chains...\n## Chain 2 finished in 40.0 seconds.\n## Chain 3 finished in 40.0 seconds.\n## Chain 1 finished in 40.3 seconds.\n## Chain 4 finished in 40.5 seconds.\n## \n## All 4 chains finished successfully.\n## Mean chain execution time: 40.2 seconds.\n## Total execution time: 40.6 seconds.\nThe posterior mean for\n\\(\\beta\\)\n, the treatment effect, is quite close to the “true” value of 0.70, as is the estimate of the standard deviation of the random effect (we used\n\\(sd = 0.4\\)\nin the data generating process):\nfit$summary(variables = c(\"beta\", \"sigma_b\"))\n## # A tibble: 2 × 10\n##   variable  mean median     sd    mad    q5   q95  rhat ess_bulk ess_tail\n##   <chr>    <dbl>  <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl>    <dbl>    <dbl>\n## 1 beta[1]  0.659  0.660 0.124  0.124  0.455 0.863  1.00    1529.    3265.\n## 2 sigma_b  0.417  0.413 0.0472 0.0458 0.347 0.501  1.00   15493.   11171.\nThe final post in this series will include code to simulate data from a stepped-wedge cluster-randomized trial with a time-to-event outcome. This model will integrate both the spline and random effect components. I’m curious to see how well it performs, as the required computational resources could be substantial.\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nouR data generation\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "In recent posts, I introduced a Bayesian approach to proportional hazards modeling and then extended it to incorporate a penalized spline. (There was also a third post on handling ties when multiple individuals share the same event time.) This post ...",
      "meta_keywords": null,
      "og_description": "In recent posts, I introduced a Bayesian approach to proportional hazards modeling and then extended it to incorporate a penalized spline. (There was also a third post on handling ties when multiple individuals share the same event time.) This post ...",
      "og_image": "https://www.rdatagen.net/post/2025-03-25-a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/index.en_files/figure-html/clusterplot-1.png",
      "og_title": "A Bayesian proportional hazards model for a cluster randomized trial | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 6.8,
      "sitemap_lastmod": null,
      "twitter_description": "In recent posts, I introduced a Bayesian approach to proportional hazards modeling and then extended it to incorporate a penalized spline. (There was also a third post on handling ties when multiple individuals share the same event time.) This post ...",
      "twitter_title": "A Bayesian proportional hazards model for a cluster randomized trial | R-bloggers",
      "url": "https://www.r-bloggers.com/2025/03/a-bayesian-proportional-hazards-model-for-a-cluster-randomized-trial/",
      "word_count": 1362
    }
  }
}