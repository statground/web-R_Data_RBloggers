{
  "id": "8251c7c66f70a6393d887e67829b7bc3d8c802b5",
  "url": "https://www.r-bloggers.com/2025/05/spatial-machine-learning-with-the-tidymodels-framework/",
  "created_at_utc": "2025-11-22T19:58:29Z",
  "data": null,
  "raw_original": {
    "uuid": "ddad1418-ff34-415a-8f58-4ccfa2ef05a2",
    "created_at": "2025-11-22 19:58:29",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2025/05/spatial-machine-learning-with-the-tidymodels-framework/",
      "crawled_at": "2025-11-22T10:48:09.894701",
      "external_links": [
        {
          "href": "https://geocompx.org/post/2025/sml-bp3/",
          "text": "geocompx"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://geocompx.org/post/2025/sml-bp1/",
          "text": "in part one"
        },
        {
          "href": "https://docs.ropensci.org/waywiser/",
          "text": "documentation"
        },
        {
          "href": "https://doi.org/10.5281/zenodo.15088973",
          "text": "https://doi.org/10.5281/zenodo.15088973"
        },
        {
          "href": "https://stevenpawley.github.io/recipeselectors/",
          "text": "https://stevenpawley.github.io/recipeselectors/"
        },
        {
          "href": "https://creativecommons.org/licenses/by/4.0/",
          "text": "CC BY 4.0"
        },
        {
          "href": "https://geocompx.org/post/2025/sml-bp3/",
          "text": "https://geocompx.org/post/2025/sml-bp3/"
        },
        {
          "href": "https://geocompx.org/post/2025/sml-bp3/",
          "text": "geocompx"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "Spatial machine learning with the tidymodels framework | R-bloggers",
      "images": [
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-5-1.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-6-1.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i1.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-9-1.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-11-1.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i1.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-12-1.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-12-2.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-13-1.png?w=450&ssl=1"
        }
      ],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/hanna-meyer/",
          "text": "Hanna Meyer"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-392643 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Spatial machine learning with the tidymodels framework</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">May 27, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/hanna-meyer/\">Hanna Meyer</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://geocompx.org/post/2025/sml-bp3/\"> geocompx</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div class=\"callout callout-style-simple callout-note\">\n<div class=\"callout-body d-flex\">\n<div class=\"callout-icon-container\">\n<i class=\"callout-icon\"></i>\n</div>\n<div class=\"callout-body-container\">\n<p>This is the third part of a blog post series on spatial machine learning with R.</p>\n<p>You can find the list of other blog posts in this series <a href=\"https://geocompx.org/post/2025/sml-bp1/\" rel=\"nofollow\" target=\"_blank\">in part one</a>.</p>\n</div>\n</div>\n</div>\n<section class=\"level2\" id=\"introduction\">\n<h2 class=\"anchored\" data-anchor-id=\"introduction\">Introduction</h2>\n<p>In this blog post, we will show how to use the <strong>tidymodels</strong> framework for spatial machine learning. The <strong>tidymodels</strong> framework is a collection of R packages for modeling and machine learning using <em>tidyverse</em> principles.</p>\n</section>\n<section class=\"level2\" id=\"prepare-data\">\n<h2 class=\"anchored\" data-anchor-id=\"prepare-data\">Prepare data</h2>\n<p>Load the required packages:</p>\n<div class=\"cell\">\n<pre>library(terra)\nlibrary(sf)\nlibrary(tidymodels)\nlibrary(ranger)\nlibrary(dplyr)\nlibrary(spatialsample)\nlibrary(waywiser)\nlibrary(vip)</pre>\n</div>\n<p>Read data:</p>\n<div class=\"cell\">\n<pre>trainingdata &lt;- sf::st_read(\"https://github.com/LOEK-RS/FOSSGIS2025-examples/raw/refs/heads/main/data/temp_train.gpkg\")\npredictors &lt;- terra::rast(\"https://github.com/LOEK-RS/FOSSGIS2025-examples/raw/refs/heads/main/data/predictors.tif\")</pre>\n</div>\n<p>Prepare data by extracting the training data from the raster and converting it to a <code>sf</code> object.</p>\n<div class=\"cell\">\n<pre>trainDat &lt;- sf::st_as_sf(terra::extract(predictors, trainingdata, bind = TRUE))\npredictor_names &lt;- names(predictors) # Extract predictor names from the raster\nresponse_name &lt;- \"temp\"</pre>\n</div>\n<div class=\"callout callout-style-default callout-note callout-titled\">\n<div class=\"callout-header d-flex align-content-center\">\n<div class=\"callout-icon-container\">\n<i class=\"callout-icon\"></i>\n</div>\n<div class=\"callout-title-container flex-fill\">\nNote\n</div>\n</div>\n<div class=\"callout-body-container callout-body\">\n<p>Compared to <strong>caret</strong>, no dropping of the geometries is required.</p>\n</div>\n</div>\n</section>\n<section class=\"level2\" id=\"a-simple-model-training-and-prediction\">\n<h2 class=\"anchored\" data-anchor-id=\"a-simple-model-training-and-prediction\">A simple model training and prediction</h2>\n<p>First, we train a random forest model. This is done by defining a recipe and a model, and then combining them into a workflow. Such a workflow can then be used to fit the model to the data.</p>\n<div class=\"cell\">\n<pre># Define the recipe\nformula &lt;- as.formula(paste(\n    response_name,\n    \"~\",\n    paste(predictor_names, collapse = \" + \")\n))\nrecipe &lt;- recipes::recipe(formula, data = trainDat)\n\nrf_model &lt;- parsnip::rand_forest(trees = 100, mode = \"regression\") |&gt;\n    set_engine(\"ranger\", importance = \"impurity\")\n\n# Create the workflow\nworkflow &lt;- workflows::workflow() |&gt;\n    workflows::add_recipe(recipe) |&gt;\n    workflows::add_model(rf_model)\n\n# Fit the model\nrf_fit &lt;- parsnip::fit(workflow, data = trainDat)</pre>\n</div>\n<p>Now, let’s use the model for spatial prediction with <code>terra::predict()</code>.</p>\n<div class=\"cell\">\n<pre>prediction_raster &lt;- terra::predict(predictors, rf_fit, na.rm = TRUE)\nplot(prediction_raster)</pre>\n<div class=\"cell-output-display\">\n<div>\n<figure class=\"figure\">\n<p><img class=\"img-fluid figure-img\" data-lazy-src=\"https://i2.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-5-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img class=\"img-fluid figure-img\" data-recalc-dims=\"1\" src=\"https://i2.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-5-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</figure>\n</div>\n</div>\n</div>\n</section>\n<section class=\"level2\" id=\"spatial-cross-validation\">\n<h2 class=\"anchored\" data-anchor-id=\"spatial-cross-validation\">Spatial cross-validation</h2>\n<p>Cross-validation requires to specify how the data is split into folds. Here, we define a non-spatial cross-validation with <code>rsample::vfold_cv()</code> and a spatial cross-validation with <code>spatialsample::spatial_block_cv()</code>.</p>\n<div class=\"cell\">\n<pre>random_folds &lt;- rsample::vfold_cv(trainDat, v = 4)\nblock_folds &lt;- spatialsample::spatial_block_cv(trainDat, v = 4, n = 2)\nspatialsample::autoplot(block_folds)</pre>\n<div class=\"cell-output-display\">\n<div>\n<figure class=\"figure\">\n<p><img class=\"img-fluid figure-img\" data-lazy-src=\"https://i2.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-6-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img class=\"img-fluid figure-img\" data-recalc-dims=\"1\" src=\"https://i2.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-6-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</figure>\n</div>\n</div>\n<pre># control cross-validation\nkeep_pred &lt;- tune::control_resamples(save_pred = TRUE, save_workflow = TRUE)</pre>\n</div>\n<p>Next, we fit the model to the data using cross-validation with <code>tune::fit_resamples()</code>.</p>\n<div class=\"cell\">\n<pre>### Cross-validation\nrf_random &lt;- tune::fit_resamples(\n    workflow,\n    resamples = random_folds,\n    control = keep_pred\n)\nrf_spatial &lt;- tune::fit_resamples(\n    workflow,\n    resamples = block_folds,\n    control = keep_pred\n)</pre>\n</div>\n<p>To compare the fitted models, we can use the <code>tune::collect_metrics()</code> function to get the metrics.</p>\n<div class=\"cell\">\n<pre>### get CV metrics\ntune::collect_metrics(rf_random)</pre>\n<div class=\"cell-output cell-output-stdout\">\n<pre># A tibble: 2 × 6\n  .metric .estimator  mean     n std_err .config             \n  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               \n1 rmse    standard   0.934     4  0.0610 Preprocessor1_Model1\n2 rsq     standard   0.908     4  0.0154 Preprocessor1_Model1</pre>\n</div>\n<pre>tune::collect_metrics(rf_spatial)</pre>\n<div class=\"cell-output cell-output-stdout\">\n<pre># A tibble: 2 × 6\n  .metric .estimator  mean     n std_err .config             \n  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               \n1 rmse    standard   1.33      4  0.271  Preprocessor1_Model1\n2 rsq     standard   0.740     4  0.0783 Preprocessor1_Model1</pre>\n</div>\n<pre># rf_spatial$.metrics # metrics from each fold</pre>\n</div>\n<p>Additionally, we can visualize the models by extracting their predictions with <code>tune::collect_predictions()</code> and plotting them.</p>\n<div class=\"cell\">\n<div class=\"cell-output-display\">\n<div>\n<figure class=\"figure\">\n<p><img class=\"img-fluid figure-img\" data-lazy-src=\"https://i1.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-9-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img class=\"img-fluid figure-img\" data-recalc-dims=\"1\" src=\"https://i1.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-9-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</figure>\n</div>\n</div>\n</div>\n<div class=\"callout callout-style-default callout-note callout-titled\">\n<div class=\"callout-header d-flex align-content-center\">\n<div class=\"callout-icon-container\">\n<i class=\"callout-icon\"></i>\n</div>\n<div class=\"callout-title-container flex-fill\">\nNote\n</div>\n</div>\n<div class=\"callout-body-container callout-body\">\n<p>Similar to <strong>caret</strong>, we first define folds and a definition of train control. The final model, however, is still stored in a separate object.</p>\n</div>\n</div>\n</section>\n<section class=\"level2\" id=\"model-tuning-spatial-hyperparameter-tuning-and-variable-selection\">\n<h2 class=\"anchored\" data-anchor-id=\"model-tuning-spatial-hyperparameter-tuning-and-variable-selection\">Model tuning: spatial hyperparameter tuning and variable selection</h2>\n<section class=\"level3\" id=\"hyperparameter-tuning\">\n<h3 class=\"anchored\" data-anchor-id=\"hyperparameter-tuning\">Hyperparameter tuning</h3>\n<p>Next, we tune the model hyperparameters. For this, we change the workflow to include the tuning specifications by using the <code>tune()</code> function inside the model definition and define a grid of hyperparameters to search over. The tuning is done with <code>tune::tune_grid()</code>.</p>\n<div class=\"cell\">\n<pre># mark two parameters for tuning:\nrf_model &lt;- parsnip::rand_forest(\n    trees = 100,\n    mode = \"regression\",\n    mtry = tune(),\n    min_n = tune()\n) |&gt;\n    set_engine(\"ranger\", importance = \"impurity\")\n\nworkflow &lt;- update_model(workflow, rf_model)\n\n# define tune grid:\ngrid_rf &lt;-\n    grid_space_filling(\n        mtry(range = c(1, 20)),\n        min_n(range = c(2, 10)),\n        size = 30\n    )\n\n# tune:\nrf_tuning &lt;- tune_grid(\n    workflow,\n    resamples = block_folds,\n    grid = grid_rf,\n    control = keep_pred\n)</pre>\n</div>\n<p>The results can be extracted with <code>collect_metrics()</code> and then visualized.</p>\n<div class=\"cell\">\n<pre>rf_tuning |&gt;\n    collect_metrics()</pre>\n<div class=\"cell-output cell-output-stdout\">\n<pre># A tibble: 60 × 8\n    mtry min_n .metric .estimator  mean     n std_err .config              \n   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                \n 1     1     5 rmse    standard   1.91      4  0.307  Preprocessor1_Model01\n 2     1     5 rsq     standard   0.613     4  0.0849 Preprocessor1_Model01\n 3     1     9 rmse    standard   1.93      4  0.311  Preprocessor1_Model02\n 4     1     9 rsq     standard   0.582     4  0.103  Preprocessor1_Model02\n 5     2     4 rmse    standard   1.61      4  0.318  Preprocessor1_Model03\n 6     2     4 rsq     standard   0.697     4  0.0692 Preprocessor1_Model03\n 7     2     2 rmse    standard   1.68      4  0.285  Preprocessor1_Model04\n 8     2     2 rsq     standard   0.654     4  0.111  Preprocessor1_Model04\n 9     3     7 rmse    standard   1.47      4  0.304  Preprocessor1_Model05\n10     3     7 rsq     standard   0.713     4  0.0837 Preprocessor1_Model05\n# ℹ 50 more rows</pre>\n</div>\n<pre>rf_tuning |&gt;\n    collect_metrics() |&gt;\n    mutate(min_n = factor(min_n)) |&gt;\n    ggplot(aes(mtry, mean, color = min_n)) +\n    geom_line(linewidth = 1.5, alpha = 0.6) +\n    geom_point(size = 2) +\n    facet_wrap(~.metric, scales = \"free\", nrow = 2) +\n    scale_x_log10(labels = scales::label_number()) +\n    scale_color_viridis_d(option = \"plasma\", begin = .9, end = 0)</pre>\n<div class=\"cell-output-display\">\n<div>\n<figure class=\"figure\">\n<p><img class=\"img-fluid figure-img\" data-lazy-src=\"https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-11-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img class=\"img-fluid figure-img\" data-recalc-dims=\"1\" src=\"https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-11-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</figure>\n</div>\n</div>\n</div>\n<p>Finally, we can extract the best model and use it to get the variable importance and make predictions.</p>\n<div class=\"cell\">\n<pre>finalmodel &lt;- fit_best(rf_tuning)\nfinalmodel</pre>\n<div class=\"cell-output cell-output-stdout\">\n<pre>══ Workflow [trained] ══════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: rand_forest()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n0 Recipe Steps\n\n── Model ───────────────────────────────────────────────────────────────────────\nRanger result\n\nCall:\n ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~19L,      x), num.trees = ~100, min.node.size = min_rows(~3L, x), importance = ~\"impurity\",      num.threads = 1, verbose = FALSE, seed = sample.int(10^5,          1)) \n\nType:                             Regression \nNumber of trees:                  100 \nSample size:                      195 \nNumber of independent variables:  22 \nMtry:                             19 \nTarget node size:                 3 \nVariable importance mode:         impurity \nSplitrule:                        variance \nOOB prediction error (MSE):       0.7477837 \nR squared (OOB):                  0.9062111 </pre>\n</div>\n<pre>imp &lt;- extract_fit_parsnip(finalmodel) |&gt;\n    vip::vip()\nimp</pre>\n<div class=\"cell-output-display\">\n<div>\n<figure class=\"figure\">\n<p><img class=\"img-fluid figure-img\" data-lazy-src=\"https://i1.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-12-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img class=\"img-fluid figure-img\" data-recalc-dims=\"1\" src=\"https://i1.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-12-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</figure>\n</div>\n</div>\n<pre>final_pred &lt;- terra::predict(predictors, finalmodel, na.rm = TRUE)\nplot(final_pred)</pre>\n<div class=\"cell-output-display\">\n<div>\n<figure class=\"figure\">\n<p><img class=\"img-fluid figure-img\" data-lazy-src=\"https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-12-2.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img class=\"img-fluid figure-img\" data-recalc-dims=\"1\" src=\"https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-12-2.png?w=450&amp;ssl=1\"/></noscript></p>\n</figure>\n</div>\n</div>\n</div>\n</section>\n</section>\n<section class=\"level2\" id=\"area-of-applicability\">\n<h2 class=\"anchored\" data-anchor-id=\"area-of-applicability\">Area of applicability</h2>\n<p>The <strong>waywiser</strong> package provides a set of tools for assessing spatial models, including an implementation of multi-scale assessment and area of applicability. The area of applicability is a measure of how well the model (given the training data) can be applied to the prediction data. It can be calculated with the <code>ww_area_of_applicability()</code> function, and then predicted on the raster with <code>terra::predict()</code>.</p>\n<div class=\"cell\">\n<pre>model_aoa &lt;- waywiser::ww_area_of_applicability(\n    st_drop_geometry(trainDat[, predictor_names]),\n    importance = vip::vi_model(finalmodel)\n)\nAOA &lt;- terra::predict(predictors, model_aoa)\nplot(AOA$aoa)</pre>\n<div class=\"cell-output-display\">\n<div>\n<figure class=\"figure\">\n<p><img class=\"img-fluid figure-img\" data-lazy-src=\"https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-13-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img class=\"img-fluid figure-img\" data-recalc-dims=\"1\" src=\"https://i0.wp.com/geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-13-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</figure>\n</div>\n</div>\n</div>\n<p>More information on the <strong>waywiser</strong> package can be found in its <a href=\"https://docs.ropensci.org/waywiser/\" rel=\"nofollow\" target=\"_blank\">documentation</a>.</p>\n</section>\n<section class=\"level2\" id=\"summary\">\n<h2 class=\"anchored\" data-anchor-id=\"summary\">Summary</h2>\n<p>This blog post showed how to use the <strong>tidymodels</strong> framework for spatial machine learning. We demonstrated how to train a random forest model, perform spatial cross-validation, tune hyperparameters, and assess the area of applicability. We also showed how to visualize the results and extract variable importance.<sup>1</sup></p>\n<p>The <strong>tidymodels</strong> framework with its packages <strong>spatialsample</strong> and <strong>waywiser</strong> provides a powerful and flexible way to perform spatial machine learning in R. At the same time, it is a bit more complex than <strong>caret</strong>: it requires getting familiar with several packages<sup>2</sup> and relationships between them. Thus, the decision of which framework to use depends on the specific needs and preferences of the user.</p>\n<div class=\"callout callout-style-simple callout-note\">\n<div class=\"callout-body d-flex\">\n<div class=\"callout-icon-container\">\n<i class=\"callout-icon\"></i>\n</div>\n<div class=\"callout-body-container\">\n<p>This blog post was originally written as a supplement to the poster “An Inventory of Spatial Machine Learning Packages in R” presented at the FOSSGIS 2025 conference in Muenster, Germany. The poster is available at <a class=\"uri\" href=\"https://doi.org/10.5281/zenodo.15088973\" rel=\"nofollow\" target=\"_blank\">https://doi.org/10.5281/zenodo.15088973</a>.</p>\n</div>\n</div>\n</div>\n</section>\n<div class=\"default\" id=\"quarto-appendix\"><section class=\"footnotes footnotes-end-of-document\" id=\"footnotes\"><h2 class=\"anchored quarto-appendix-heading\">Footnotes</h2>\n<ol>\n<li id=\"fn1\"><p>We have not, though, covered all the features of the <strong>tidymodels</strong> framework, such as feature selection (<a class=\"uri\" href=\"https://stevenpawley.github.io/recipeselectors/\" rel=\"nofollow\" target=\"_blank\">https://stevenpawley.github.io/recipeselectors/</a>) or model ensembling.↩︎</p></li>\n<li id=\"fn2\"><p>Including remembering their names and roles↩︎</p></li>\n</ol>\n</section><section class=\"quarto-appendix-contents\" id=\"quarto-reuse\"><h2 class=\"anchored quarto-appendix-heading\">Reuse</h2><div class=\"quarto-appendix-contents\"><div><a href=\"https://creativecommons.org/licenses/by/4.0/\" rel=\"nofollow\" target=\"_blank\">CC BY 4.0</a></div></div></section><section class=\"quarto-appendix-contents\" id=\"quarto-citation\"><h2 class=\"anchored quarto-appendix-heading\">Citation</h2><div><div class=\"quarto-appendix-secondary-label\">BibTeX citation:</div><pre>@online{meyer2025,\n  author = {Meyer, Hanna and Nowosad, Jakub},\n  title = {Spatial Machine Learning with the Tidymodels Framework},\n  date = {2025-05-28},\n  url = {https://geocompx.org/post/2025/sml-bp3/},\n  langid = {en}\n}\n</pre><div class=\"quarto-appendix-secondary-label\">For attribution, please cite this work as:</div><div class=\"csl-entry quarto-appendix-citeas\" id=\"ref-meyer2025\">\nMeyer, Hanna, and Jakub Nowosad. 2025. <span>“Spatial Machine Learning\nwith the Tidymodels Framework.”</span> May 28, 2025. <a href=\"https://geocompx.org/post/2025/sml-bp3/\" rel=\"nofollow\" target=\"_blank\">https://geocompx.org/post/2025/sml-bp3/</a>.\n</div></div></section></div>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://geocompx.org/post/2025/sml-bp3/\"> geocompx</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
      "main_text": "Spatial machine learning with the tidymodels framework\nPosted on\nMay 27, 2025\nby\nHanna Meyer\nin\nR bloggers\n| 0 Comments\n[This article was first published on\ngeocompx\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nThis is the third part of a blog post series on spatial machine learning with R.\nYou can find the list of other blog posts in this series\nin part one\n.\nIntroduction\nIn this blog post, we will show how to use the\ntidymodels\nframework for spatial machine learning. The\ntidymodels\nframework is a collection of R packages for modeling and machine learning using\ntidyverse\nprinciples.\nPrepare data\nLoad the required packages:\nlibrary(terra)\nlibrary(sf)\nlibrary(tidymodels)\nlibrary(ranger)\nlibrary(dplyr)\nlibrary(spatialsample)\nlibrary(waywiser)\nlibrary(vip)\nRead data:\ntrainingdata <- sf::st_read(\"https://github.com/LOEK-RS/FOSSGIS2025-examples/raw/refs/heads/main/data/temp_train.gpkg\")\npredictors <- terra::rast(\"https://github.com/LOEK-RS/FOSSGIS2025-examples/raw/refs/heads/main/data/predictors.tif\")\nPrepare data by extracting the training data from the raster and converting it to a\nsf\nobject.\ntrainDat <- sf::st_as_sf(terra::extract(predictors, trainingdata, bind = TRUE))\npredictor_names <- names(predictors) # Extract predictor names from the raster\nresponse_name <- \"temp\"\nNote\nCompared to\ncaret\n, no dropping of the geometries is required.\nA simple model training and prediction\nFirst, we train a random forest model. This is done by defining a recipe and a model, and then combining them into a workflow. Such a workflow can then be used to fit the model to the data.\n# Define the recipe\nformula <- as.formula(paste(\n    response_name,\n    \"~\",\n    paste(predictor_names, collapse = \" + \")\n))\nrecipe <- recipes::recipe(formula, data = trainDat)\n\nrf_model <- parsnip::rand_forest(trees = 100, mode = \"regression\") |>\n    set_engine(\"ranger\", importance = \"impurity\")\n\n# Create the workflow\nworkflow <- workflows::workflow() |>\n    workflows::add_recipe(recipe) |>\n    workflows::add_model(rf_model)\n\n# Fit the model\nrf_fit <- parsnip::fit(workflow, data = trainDat)\nNow, let’s use the model for spatial prediction with\nterra::predict()\n.\nprediction_raster <- terra::predict(predictors, rf_fit, na.rm = TRUE)\nplot(prediction_raster)\nSpatial cross-validation\nCross-validation requires to specify how the data is split into folds. Here, we define a non-spatial cross-validation with\nrsample::vfold_cv()\nand a spatial cross-validation with\nspatialsample::spatial_block_cv()\n.\nrandom_folds <- rsample::vfold_cv(trainDat, v = 4)\nblock_folds <- spatialsample::spatial_block_cv(trainDat, v = 4, n = 2)\nspatialsample::autoplot(block_folds)\n# control cross-validation\nkeep_pred <- tune::control_resamples(save_pred = TRUE, save_workflow = TRUE)\nNext, we fit the model to the data using cross-validation with\ntune::fit_resamples()\n.\n### Cross-validation\nrf_random <- tune::fit_resamples(\n    workflow,\n    resamples = random_folds,\n    control = keep_pred\n)\nrf_spatial <- tune::fit_resamples(\n    workflow,\n    resamples = block_folds,\n    control = keep_pred\n)\nTo compare the fitted models, we can use the\ntune::collect_metrics()\nfunction to get the metrics.\n### get CV metrics\ntune::collect_metrics(rf_random)\n# A tibble: 2 × 6\n  .metric .estimator  mean     n std_err .config             \n  <chr>   <chr>      <dbl> <int>   <dbl> <chr>               \n1 rmse    standard   0.934     4  0.0610 Preprocessor1_Model1\n2 rsq     standard   0.908     4  0.0154 Preprocessor1_Model1\ntune::collect_metrics(rf_spatial)\n# A tibble: 2 × 6\n  .metric .estimator  mean     n std_err .config             \n  <chr>   <chr>      <dbl> <int>   <dbl> <chr>               \n1 rmse    standard   1.33      4  0.271  Preprocessor1_Model1\n2 rsq     standard   0.740     4  0.0783 Preprocessor1_Model1\n# rf_spatial$.metrics # metrics from each fold\nAdditionally, we can visualize the models by extracting their predictions with\ntune::collect_predictions()\nand plotting them.\nNote\nSimilar to\ncaret\n, we first define folds and a definition of train control. The final model, however, is still stored in a separate object.\nModel tuning: spatial hyperparameter tuning and variable selection\nHyperparameter tuning\nNext, we tune the model hyperparameters. For this, we change the workflow to include the tuning specifications by using the\ntune()\nfunction inside the model definition and define a grid of hyperparameters to search over. The tuning is done with\ntune::tune_grid()\n.\n# mark two parameters for tuning:\nrf_model <- parsnip::rand_forest(\n    trees = 100,\n    mode = \"regression\",\n    mtry = tune(),\n    min_n = tune()\n) |>\n    set_engine(\"ranger\", importance = \"impurity\")\n\nworkflow <- update_model(workflow, rf_model)\n\n# define tune grid:\ngrid_rf <-\n    grid_space_filling(\n        mtry(range = c(1, 20)),\n        min_n(range = c(2, 10)),\n        size = 30\n    )\n\n# tune:\nrf_tuning <- tune_grid(\n    workflow,\n    resamples = block_folds,\n    grid = grid_rf,\n    control = keep_pred\n)\nThe results can be extracted with\ncollect_metrics()\nand then visualized.\nrf_tuning |>\n    collect_metrics()\n# A tibble: 60 × 8\n    mtry min_n .metric .estimator  mean     n std_err .config              \n   <int> <int> <chr>   <chr>      <dbl> <int>   <dbl> <chr>                \n 1     1     5 rmse    standard   1.91      4  0.307  Preprocessor1_Model01\n 2     1     5 rsq     standard   0.613     4  0.0849 Preprocessor1_Model01\n 3     1     9 rmse    standard   1.93      4  0.311  Preprocessor1_Model02\n 4     1     9 rsq     standard   0.582     4  0.103  Preprocessor1_Model02\n 5     2     4 rmse    standard   1.61      4  0.318  Preprocessor1_Model03\n 6     2     4 rsq     standard   0.697     4  0.0692 Preprocessor1_Model03\n 7     2     2 rmse    standard   1.68      4  0.285  Preprocessor1_Model04\n 8     2     2 rsq     standard   0.654     4  0.111  Preprocessor1_Model04\n 9     3     7 rmse    standard   1.47      4  0.304  Preprocessor1_Model05\n10     3     7 rsq     standard   0.713     4  0.0837 Preprocessor1_Model05\n# ℹ 50 more rows\nrf_tuning |>\n    collect_metrics() |>\n    mutate(min_n = factor(min_n)) |>\n    ggplot(aes(mtry, mean, color = min_n)) +\n    geom_line(linewidth = 1.5, alpha = 0.6) +\n    geom_point(size = 2) +\n    facet_wrap(~.metric, scales = \"free\", nrow = 2) +\n    scale_x_log10(labels = scales::label_number()) +\n    scale_color_viridis_d(option = \"plasma\", begin = .9, end = 0)\nFinally, we can extract the best model and use it to get the variable importance and make predictions.\nfinalmodel <- fit_best(rf_tuning)\nfinalmodel\n══ Workflow [trained] ══════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: rand_forest()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n0 Recipe Steps\n\n── Model ───────────────────────────────────────────────────────────────────────\nRanger result\n\nCall:\n ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~19L,      x), num.trees = ~100, min.node.size = min_rows(~3L, x), importance = ~\"impurity\",      num.threads = 1, verbose = FALSE, seed = sample.int(10^5,          1)) \n\nType:                             Regression \nNumber of trees:                  100 \nSample size:                      195 \nNumber of independent variables:  22 \nMtry:                             19 \nTarget node size:                 3 \nVariable importance mode:         impurity \nSplitrule:                        variance \nOOB prediction error (MSE):       0.7477837 \nR squared (OOB):                  0.9062111\nimp <- extract_fit_parsnip(finalmodel) |>\n    vip::vip()\nimp\nfinal_pred <- terra::predict(predictors, finalmodel, na.rm = TRUE)\nplot(final_pred)\nArea of applicability\nThe\nwaywiser\npackage provides a set of tools for assessing spatial models, including an implementation of multi-scale assessment and area of applicability. The area of applicability is a measure of how well the model (given the training data) can be applied to the prediction data. It can be calculated with the\nww_area_of_applicability()\nfunction, and then predicted on the raster with\nterra::predict()\n.\nmodel_aoa <- waywiser::ww_area_of_applicability(\n    st_drop_geometry(trainDat[, predictor_names]),\n    importance = vip::vi_model(finalmodel)\n)\nAOA <- terra::predict(predictors, model_aoa)\nplot(AOA$aoa)\nMore information on the\nwaywiser\npackage can be found in its\ndocumentation\n.\nSummary\nThis blog post showed how to use the\ntidymodels\nframework for spatial machine learning. We demonstrated how to train a random forest model, perform spatial cross-validation, tune hyperparameters, and assess the area of applicability. We also showed how to visualize the results and extract variable importance.\n1\nThe\ntidymodels\nframework with its packages\nspatialsample\nand\nwaywiser\nprovides a powerful and flexible way to perform spatial machine learning in R. At the same time, it is a bit more complex than\ncaret\n: it requires getting familiar with several packages\n2\nand relationships between them. Thus, the decision of which framework to use depends on the specific needs and preferences of the user.\nThis blog post was originally written as a supplement to the poster “An Inventory of Spatial Machine Learning Packages in R” presented at the FOSSGIS 2025 conference in Muenster, Germany. The poster is available at\nhttps://doi.org/10.5281/zenodo.15088973\n.\nFootnotes\nWe have not, though, covered all the features of the\ntidymodels\nframework, such as feature selection (\nhttps://stevenpawley.github.io/recipeselectors/\n) or model ensembling.↩︎\nIncluding remembering their names and roles↩︎\nReuse\nCC BY 4.0\nCitation\nBibTeX citation:\n@online{meyer2025,\n  author = {Meyer, Hanna and Nowosad, Jakub},\n  title = {Spatial Machine Learning with the Tidymodels Framework},\n  date = {2025-05-28},\n  url = {https://geocompx.org/post/2025/sml-bp3/},\n  langid = {en}\n}\nFor attribution, please cite this work as:\nMeyer, Hanna, and Jakub Nowosad. 2025.\n“Spatial Machine Learning\nwith the Tidymodels Framework.”\nMay 28, 2025.\nhttps://geocompx.org/post/2025/sml-bp3/\n.\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\ngeocompx\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "This is the third part of a blog post series on spatial machine learning with R. You can find the list of other blog posts in this series in part one. Introduction In this blog post, we will show how to use the tidymodels framework for ...",
      "meta_keywords": null,
      "og_description": "This is the third part of a blog post series on spatial machine learning with R. You can find the list of other blog posts in this series in part one. Introduction In this blog post, we will show how to use the tidymodels framework for ...",
      "og_image": "https://geocompx.org/post/2025/sml-bp3/index_files/figure-html/unnamed-chunk-5-1.png",
      "og_title": "Spatial machine learning with the tidymodels framework | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 7.1,
      "sitemap_lastmod": null,
      "twitter_description": "This is the third part of a blog post series on spatial machine learning with R. You can find the list of other blog posts in this series in part one. Introduction In this blog post, we will show how to use the tidymodels framework for ...",
      "twitter_title": "Spatial machine learning with the tidymodels framework | R-bloggers",
      "url": "https://www.r-bloggers.com/2025/05/spatial-machine-learning-with-the-tidymodels-framework/",
      "word_count": 1419
    }
  }
}