{
  "uuid": "b25b32cb-6c47-4211-9ef2-6103c5d5f4fe",
  "created_at": "2025-11-22 19:59:03",
  "raw_json": {
    "article_author": null,
    "article_headline": null,
    "article_modified": null,
    "article_published": null,
    "article_section": null,
    "article_tags": null,
    "canonical_url": "https://www.r-bloggers.com/2025/03/conformalize-improved-prediction-intervals-and-simulations-any-r-machine-learning-model-with-miscconformalize/",
    "crawled_at": "2025-11-22T10:52:29.657023",
    "external_links": [
      {
        "href": "https://thierrymoudiki.github.io//blog/2025/03/25/r/conformalize-R",
        "text": "T. Moudiki's Webpage - R"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      },
      {
        "href": "https://r-packages.techtonique.net/packages",
        "text": "misc"
      },
      {
        "href": "https://thierrymoudiki.github.io//blog/2025/03/25/r/conformalize-R",
        "text": "T. Moudiki's Webpage - R"
      },
      {
        "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
        "text": "daily e-mail updates"
      },
      {
        "href": "https://www.r-project.org/",
        "text": "R"
      },
      {
        "href": "https://www.r-users.com/",
        "text": "Click here if you're looking to post or find an R/data-science job"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      }
    ],
    "h1_title": "R-bloggers",
    "html_title": "Conformalize (improved prediction intervals and simulations) any R Machine Learning model with misc::conformalize | R-bloggers",
    "images": [
      {
        "alt": "image-title-here",
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": "image-title-here",
        "base64": null,
        "src": "https://i2.wp.com/thierrymoudiki.github.io/images/2025-03-24/2025-03-24-image1.png?w=578&ssl=1"
      }
    ],
    "internal_links": [
      {
        "href": "https://www.r-bloggers.com/author/t-moudiki/",
        "text": "T. Moudiki"
      },
      {
        "href": "https://www.r-bloggers.com/category/r-bloggers/",
        "text": "R bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/contact-us/",
        "text": "here"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers.com"
      },
      {
        "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
        "text": "learning R"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      }
    ],
    "lang": "en-US",
    "main_html": "<article class=\"post-391441 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Conformalize (improved prediction intervals and simulations) any R Machine Learning model with misc::conformalize</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">March 24, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/t-moudiki/\">T. Moudiki</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://thierrymoudiki.github.io//blog/2025/03/25/r/conformalize-R\"> T. Moudiki's Webpage - R</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47--><p>In the new version of <a href=\"https://r-packages.techtonique.net/packages\" rel=\"nofollow\" target=\"_blank\"><code>misc</code></a>, we introduce the <code>conformalize</code> function (work in progress, along with <code>predict</code> and <code>simulate</code> S3 methods), which allows you to perform conformal prediction with any R machine learning model. Conformal prediction improves prediction intervals’ coverage rate thanks to held-out set cross-validation errors.</p>\n<pre>options(repos = c(techtonique = \"https://r-packages.techtonique.net\",\n                  CRAN = \"https://cloud.r-project.org\"))\n\ninstall.packages(\"misc\")\n</pre>\n<h2 id=\"example-conformal-prediction-with-out-of-sample-coverage\">Example: Conformal Prediction with Out-of-Sample Coverage</h2>\n<p>In this example, we demonstrate how to use the <code>misc::conformalize</code> function to perform conformal prediction and calculate the out-of-sample coverage rate.</p>\n<h3 id=\"simulated-data\">Simulated Data</h3>\n<p>We will generate a simple dataset for demonstration purposes.</p>\n<pre>set.seed(123)\nn &lt;- 200\nx &lt;- matrix(runif(n * 2), ncol = 2)\ny &lt;- 3 * x[, 1] + 2 * x[, 2] + rnorm(n, sd = 0.5)\ndata &lt;- data.frame(x1 = x[, 1], x2 = x[, 2], y = y)\n</pre>\n<h3 id=\"fit-conformal-model\">Fit Conformal Model</h3>\n<p>Now, we’ll use a linear model (<code>lm</code>) as the <code>fit_func</code> and its corresponding <code>predict</code> function as the <code>predict_func</code>.</p>\n<pre>library(misc)\nlibrary(stats)\n\n# Define fit and predict functions\nfit_func &lt;- function(formula, data, ...) lm(formula, data = data, ...)\npredict_func &lt;- function(fit, newdata, ...) predict(fit, newdata = newdata, ...)\n\n# Apply conformalize\nconformal_model &lt;- misc::conformalize(\n  formula = y ~ x1 + x2,\n  data = data,\n  fit_func = fit_func,\n  predict_func = predict_func,\n  split_ratio = 0.8,\n  seed = 123\n)\n</pre>\n<h3 id=\"generate-predictions-and-prediction-intervals\">Generate Predictions and Prediction Intervals</h3>\n<p>We will use the <code>predict</code> method to generate predictions and calculate prediction intervals.</p>\n<pre># New data for prediction\nnew_data &lt;- data.frame(x1 = runif(50), x2 = runif(50))\n\n# Predict with split conformal method\npredictions &lt;- predict(\n  conformal_model,\n  newdata = new_data,\n  level = 0.95,\n  method = \"split\"\n)\n\nhead(predictions)\n\n##         fit        lwr      upr\n## 1 1.6023773  0.5217324 2.683022\n## 2 2.4634938  1.3828489 3.544139\n## 3 0.6216433 -0.4590017 1.702288\n## 4 0.9257140 -0.1549310 2.006359\n## 5 2.0106565  0.9300115 3.091301\n## 6 0.7427247 -0.3379203 1.823370\n\nhead(simulate(conformal_model, newdata = new_data, method = \"kde\")[,1:10])\n\n         [,1]      [,2]      [,3]        [,4]      [,5]       [,6]      [,7]     [,8]\n[1,]  1.0061613 1.4378707 1.5956107  0.82351501 2.7246968 0.73219187 2.0356222 1.695236\n[2,]  1.8008609 2.7971134 1.2861305  2.58125871 3.4363754 1.86727777 1.2363179 3.012968\n[3,]  0.7061998 1.0880965 0.7643145 -0.01608328 0.6978976 0.08354196 1.2873470 1.644337\n[4,]  1.6744387 2.1808671 1.3589588  0.71969680 0.6200716 0.41251896 0.2132685 1.143104\n[5,]  2.5601307 2.6514539 0.9412205  1.71331614 1.8461498 2.50201601 1.6053888 2.244651\n[6,] -0.1938776 0.6363327 0.6612391  0.95181269 2.2220346 1.91485674 1.5329600 1.151063\n          [,9]     [,10]\n[1,] 0.9646508 1.8197675\n[2,] 2.8635302 2.1993619\n[3,] 1.0299818 0.3076988\n[4,] 1.7906682 0.7944157\n[5,] 2.3608802 2.0952129\n[6,] 0.5367075 1.9065546\n</pre>\n<h3 id=\"calculate-out-of-sample-coverage-rate\">Calculate Out-of-Sample Coverage Rate</h3>\n<p>The coverage rate is the proportion of true values that fall within the prediction intervals.</p>\n<pre># Simulate true values for the new data\ntrue_y &lt;- 3 * new_data$x1 + 2 * new_data$x2 + rnorm(50, sd = 0.5)\n\n# Check if true values fall within the prediction intervals\ncoverage &lt;- mean(true_y &gt;= predictions[, \"lwr\"] &amp; true_y &lt;= predictions[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate:\", coverage)\n\n## Out-of-sample coverage rate: 0.98\n</pre>\n<h3 id=\"results\">Results</h3>\n<ul>\n<li>The prediction intervals are calculated using the split conformal method.</li>\n<li>The out-of-sample coverage rate is displayed, which should be close to the specified confidence level (e.g., 0.95).</li>\n</ul>\n<h2 id=\"example-conformal-prediction-with-the-massboston-dataset\">Example: Conformal Prediction with the <code>MASS::Boston</code> Dataset</h2>\n<p>In this example, we use the <code>MASS::Boston</code> dataset to demonstrate conformal prediction.</p>\n<h3 id=\"load-the-data\">Load the Data</h3>\n<p>We will use the <code>MASS</code> package to access the <code>Boston</code> dataset.</p>\n<pre>library(MASS)\n\n# Load the Boston dataset\ndata(Boston)\n\n# Inspect the dataset\nhead(Boston)\n\n##      crim zn indus chas   nox    rm  age    dis rad tax ptratio  black lstat\n## 1 0.00632 18  2.31    0 0.538 6.575 65.2 4.0900   1 296    15.3 396.90  4.98\n## 2 0.02731  0  7.07    0 0.469 6.421 78.9 4.9671   2 242    17.8 396.90  9.14\n## 3 0.02729  0  7.07    0 0.469 7.185 61.1 4.9671   2 242    17.8 392.83  4.03\n## 4 0.03237  0  2.18    0 0.458 6.998 45.8 6.0622   3 222    18.7 394.63  2.94\n## 5 0.06905  0  2.18    0 0.458 7.147 54.2 6.0622   3 222    18.7 396.90  5.33\n## 6 0.02985  0  2.18    0 0.458 6.430 58.7 6.0622   3 222    18.7 394.12  5.21\n##   medv\n## 1 24.0\n## 2 21.6\n## 3 34.7\n## 4 33.4\n## 5 36.2\n## 6 28.7\n</pre>\n<h3 id=\"split-the-data\">Split the Data</h3>\n<p>We will split the data into training and test sets to ensure they are disjoint.</p>\n<pre>set.seed(123)\nn &lt;- nrow(Boston)\ntrain_indices &lt;- sample(seq_len(n), size = floor(0.8 * n))\ntrain_data &lt;- Boston[train_indices, ]\ntest_data &lt;- Boston[-train_indices, ]\n</pre>\n<h3 id=\"fit-conformal-model-1\">Fit Conformal Model 1</h3>\n<pre># Define fit and predict functions\nfit_func &lt;- function(formula, data, ...) MASS::rlm(formula, data = data, ...)\npredict_func &lt;- function(fit, newdata, ...) predict(fit, newdata, ...)\n\n# Apply conformalize using the training data\nconformal_model_boston &lt;- misc::conformalize(\n  formula = medv ~ .,\n  data = train_data,\n  fit_func = fit_func,\n  predict_func = predict_func,\n  seed = 123\n)\n</pre>\n<h3 id=\"generate-predictions-and-prediction-intervals-1\">Generate Predictions and Prediction Intervals 1</h3>\n<p>We will use the <code>predict.conformalize</code> method to generate predictions and calculate prediction intervals for the test set.</p>\n<pre># Predict with split conformal method on the test data\npredictions_boston &lt;- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"split\"\n)\n\nhead(predictions_boston)\n\n##         fit       lwr      upr\n## 1  29.92942 20.263283 39.59556\n## 15 19.30837  9.642229 28.97451\n## 17 20.71124 11.045100 30.37738\n## 19 14.86650  5.200365 24.53264\n## 28 14.79883  5.132688 24.46497\n## 37 20.98752 11.321382 30.65366\n</pre>\n<h3 id=\"calculate-out-of-sample-coverage-rate-1\">Calculate Out-of-Sample Coverage Rate 1</h3>\n<p>The coverage rate is the proportion of true values in the test set that fall within the prediction intervals.</p>\n<pre># True values for the test set\ntrue_y_boston &lt;- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston &lt;- mean(true_y_boston &gt;= predictions_boston[, \"lwr\"] &amp; true_y_boston &lt;= predictions_boston[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9509804\n</pre>\n<h3 id=\"fit-conformal-model-2\">Fit Conformal Model 2</h3>\n<pre># Define fit and predict functions\nfit_func &lt;- function(formula, data, ...) stats::glm(formula, data = data, ...)\npredict_func &lt;- function(fit, newdata, ...) predict(fit, newdata, ...)\n\n# Apply conformalize using the training data\nconformal_model_boston &lt;- misc::conformalize(\n  formula = medv ~ .,\n  data = train_data,\n  fit_func = fit_func,\n  predict_func = predict_func,\n  seed = 123\n)\n</pre>\n<h3 id=\"generate-predictions-and-prediction-intervals-2\">Generate Predictions and Prediction Intervals 2</h3>\n<p>We will use the <code>predict.conformalize</code> method to generate predictions and calculate prediction intervals for the test set.</p>\n<pre># Predict with split conformal method on the test data\npredictions_boston &lt;- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"split\"\n)\n\nhead(predictions_boston)\n\n# Predict with split conformal method on the test data\npredictions_boston2 &lt;- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"kde\"\n)\n\nhead(predictions_boston2)\n\n# Predict with split conformal method on the test data\npredictions_boston3 &lt;- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"surrogate\"\n)\n\nhead(predictions_boston3)\n\n# Predict with split conformal method on the test data\npredictions_boston4 &lt;- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"bootstrap\"\n)\n\nhead(predictions_boston4)\n</pre>\n<h3 id=\"fit-conformal-model-2-1\">Fit Conformal Model 2</h3>\n<pre># Define fit and predict functions\nfit_func &lt;- function(formula, data, ...) ranger::ranger(formula, data = data)\npredict_func &lt;- function(fit, newdata, ...) predict(fit, newdata)$predictions\n\n# Apply conformalize using the training data\nconformal_model_boston_rf &lt;- misc::conformalize(\n  formula = medv ~ .,\n  data = train_data,\n  fit_func = fit_func,\n  predict_func = predict_func,\n  seed = 123\n)\n\n# Predict with split conformal method on the test data\npredictions_boston_rf &lt;- predict(\n  conformal_model_boston_rf,\n  newdata = test_data,\n  predict_func = predict_func,\n  level = 0.95,\n  method = \"kde\"\n)\n\nhead(predictions_boston_rf)\n\n##           fit       lwr      upr\n## [1,] 27.03134 21.991838 32.43038\n## [2,] 19.20299 13.542260 25.05314\n## [3,] 21.34472 17.000993 30.77696\n## [4,] 18.77455 12.341589 25.88818\n## [5,] 15.60764  9.157478 21.48264\n## [6,] 21.31355 14.591954 29.75374\n\n# Create a data frame for plotting\nplot_data &lt;- data.frame(\n  Observation = seq_len(nrow(test_data)),\n  TrueValue = test_data$medv,\n  LowerBound = predictions_boston_rf[, \"lwr\"],\n  UpperBound = predictions_boston_rf[, \"upr\"]\n)\n\n# Sort data by observation for proper plotting\nplot_data &lt;- plot_data[order(plot_data$Observation), ]\n\n# Plot the true values\nplot(\n  plot_data$Observation, plot_data$TrueValue,\n  pch = 16, col = \"blue\", cex = 0.7,\n  xlab = \"Observation\", ylab = \"Value\",\n  main = \"Prediction Intervals vs True Values\"\n)\n\n# Add the prediction intervals using polygon\npolygon(\n  c(plot_data$Observation, rev(plot_data$Observation)),\n  c(plot_data$LowerBound, rev(plot_data$UpperBound)),\n  col = rgb(1, 0, 0, 0.2), border = NA\n)\n\n# Add points for true values again to overlay on the polygon\npoints(\n  plot_data$Observation, plot_data$TrueValue,\n  pch = 16, col = \"blue\", cex = 0.7\n)\n</pre>\n<p><img alt=\"image-title-here\" data-lazy-src=\"https://i2.wp.com/thierrymoudiki.github.io/images/2025-03-24/2025-03-24-image1.png?w=578&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img alt=\"image-title-here\" data-recalc-dims=\"1\" src=\"https://i2.wp.com/thierrymoudiki.github.io/images/2025-03-24/2025-03-24-image1.png?w=578&amp;ssl=1\"/></noscript></p>\n<h3 id=\"calculate-out-of-sample-coverage-rate-2\">Calculate Out-of-Sample Coverage Rate 2</h3>\n<p>The coverage rate is the proportion of true values in the test set that fall within the prediction intervals.</p>\n<pre># True values for the test set\ntrue_y_boston &lt;- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston &lt;- mean(true_y_boston &gt;= predictions_boston[, \"lwr\"] &amp; true_y_boston &lt;= predictions_boston[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9411765\n\n# True values for the test set\ntrue_y_boston &lt;- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston &lt;- mean(true_y_boston &gt;= predictions_boston2[, \"lwr\"] &amp; true_y_boston &lt;= predictions_boston2[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9607843\n\n# True values for the test set\ntrue_y_boston &lt;- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston &lt;- mean(true_y_boston &gt;= predictions_boston3[, \"lwr\"] &amp; true_y_boston &lt;= predictions_boston3[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9705882\n\n# True values for the test set\ntrue_y_boston &lt;- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston &lt;- mean(true_y_boston &gt;= predictions_boston4[, \"lwr\"] &amp; true_y_boston &lt;= predictions_boston4[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9607843\n\n# True values for the test set\ntrue_y_boston &lt;- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston &lt;- mean(true_y_boston &gt;= predictions_boston_rf[, \"lwr\"] &amp; true_y_boston &lt;= predictions_boston_rf[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9215686\n</pre>\n<h3 id=\"results-1\">Results</h3>\n<ul>\n<li>The prediction intervals are calculated using the split conformal method.</li>\n<li>The out-of-sample coverage rate is displayed, which should be close to the specified confidence level (e.g., 0.95).</li>\n</ul>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://thierrymoudiki.github.io//blog/2025/03/25/r/conformalize-R\"> T. Moudiki's Webpage - R</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
    "main_text": "Conformalize (improved prediction intervals and simulations) any R Machine Learning model with misc::conformalize\nPosted on\nMarch 24, 2025\nby\nT. Moudiki\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nT. Moudiki's Webpage - R\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nIn the new version of\nmisc\n, we introduce the\nconformalize\nfunction (work in progress, along with\npredict\nand\nsimulate\nS3 methods), which allows you to perform conformal prediction with any R machine learning model. Conformal prediction improves prediction intervals’ coverage rate thanks to held-out set cross-validation errors.\noptions(repos = c(techtonique = \"https://r-packages.techtonique.net\",\n                  CRAN = \"https://cloud.r-project.org\"))\n\ninstall.packages(\"misc\")\nExample: Conformal Prediction with Out-of-Sample Coverage\nIn this example, we demonstrate how to use the\nmisc::conformalize\nfunction to perform conformal prediction and calculate the out-of-sample coverage rate.\nSimulated Data\nWe will generate a simple dataset for demonstration purposes.\nset.seed(123)\nn <- 200\nx <- matrix(runif(n * 2), ncol = 2)\ny <- 3 * x[, 1] + 2 * x[, 2] + rnorm(n, sd = 0.5)\ndata <- data.frame(x1 = x[, 1], x2 = x[, 2], y = y)\nFit Conformal Model\nNow, we’ll use a linear model (\nlm\n) as the\nfit_func\nand its corresponding\npredict\nfunction as the\npredict_func\n.\nlibrary(misc)\nlibrary(stats)\n\n# Define fit and predict functions\nfit_func <- function(formula, data, ...) lm(formula, data = data, ...)\npredict_func <- function(fit, newdata, ...) predict(fit, newdata = newdata, ...)\n\n# Apply conformalize\nconformal_model <- misc::conformalize(\n  formula = y ~ x1 + x2,\n  data = data,\n  fit_func = fit_func,\n  predict_func = predict_func,\n  split_ratio = 0.8,\n  seed = 123\n)\nGenerate Predictions and Prediction Intervals\nWe will use the\npredict\nmethod to generate predictions and calculate prediction intervals.\n# New data for prediction\nnew_data <- data.frame(x1 = runif(50), x2 = runif(50))\n\n# Predict with split conformal method\npredictions <- predict(\n  conformal_model,\n  newdata = new_data,\n  level = 0.95,\n  method = \"split\"\n)\n\nhead(predictions)\n\n##         fit        lwr      upr\n## 1 1.6023773  0.5217324 2.683022\n## 2 2.4634938  1.3828489 3.544139\n## 3 0.6216433 -0.4590017 1.702288\n## 4 0.9257140 -0.1549310 2.006359\n## 5 2.0106565  0.9300115 3.091301\n## 6 0.7427247 -0.3379203 1.823370\n\nhead(simulate(conformal_model, newdata = new_data, method = \"kde\")[,1:10])\n\n         [,1]      [,2]      [,3]        [,4]      [,5]       [,6]      [,7]     [,8]\n[1,]  1.0061613 1.4378707 1.5956107  0.82351501 2.7246968 0.73219187 2.0356222 1.695236\n[2,]  1.8008609 2.7971134 1.2861305  2.58125871 3.4363754 1.86727777 1.2363179 3.012968\n[3,]  0.7061998 1.0880965 0.7643145 -0.01608328 0.6978976 0.08354196 1.2873470 1.644337\n[4,]  1.6744387 2.1808671 1.3589588  0.71969680 0.6200716 0.41251896 0.2132685 1.143104\n[5,]  2.5601307 2.6514539 0.9412205  1.71331614 1.8461498 2.50201601 1.6053888 2.244651\n[6,] -0.1938776 0.6363327 0.6612391  0.95181269 2.2220346 1.91485674 1.5329600 1.151063\n          [,9]     [,10]\n[1,] 0.9646508 1.8197675\n[2,] 2.8635302 2.1993619\n[3,] 1.0299818 0.3076988\n[4,] 1.7906682 0.7944157\n[5,] 2.3608802 2.0952129\n[6,] 0.5367075 1.9065546\nCalculate Out-of-Sample Coverage Rate\nThe coverage rate is the proportion of true values that fall within the prediction intervals.\n# Simulate true values for the new data\ntrue_y <- 3 * new_data$x1 + 2 * new_data$x2 + rnorm(50, sd = 0.5)\n\n# Check if true values fall within the prediction intervals\ncoverage <- mean(true_y >= predictions[, \"lwr\"] & true_y <= predictions[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate:\", coverage)\n\n## Out-of-sample coverage rate: 0.98\nResults\nThe prediction intervals are calculated using the split conformal method.\nThe out-of-sample coverage rate is displayed, which should be close to the specified confidence level (e.g., 0.95).\nExample: Conformal Prediction with the\nMASS::Boston\nDataset\nIn this example, we use the\nMASS::Boston\ndataset to demonstrate conformal prediction.\nLoad the Data\nWe will use the\nMASS\npackage to access the\nBoston\ndataset.\nlibrary(MASS)\n\n# Load the Boston dataset\ndata(Boston)\n\n# Inspect the dataset\nhead(Boston)\n\n##      crim zn indus chas   nox    rm  age    dis rad tax ptratio  black lstat\n## 1 0.00632 18  2.31    0 0.538 6.575 65.2 4.0900   1 296    15.3 396.90  4.98\n## 2 0.02731  0  7.07    0 0.469 6.421 78.9 4.9671   2 242    17.8 396.90  9.14\n## 3 0.02729  0  7.07    0 0.469 7.185 61.1 4.9671   2 242    17.8 392.83  4.03\n## 4 0.03237  0  2.18    0 0.458 6.998 45.8 6.0622   3 222    18.7 394.63  2.94\n## 5 0.06905  0  2.18    0 0.458 7.147 54.2 6.0622   3 222    18.7 396.90  5.33\n## 6 0.02985  0  2.18    0 0.458 6.430 58.7 6.0622   3 222    18.7 394.12  5.21\n##   medv\n## 1 24.0\n## 2 21.6\n## 3 34.7\n## 4 33.4\n## 5 36.2\n## 6 28.7\nSplit the Data\nWe will split the data into training and test sets to ensure they are disjoint.\nset.seed(123)\nn <- nrow(Boston)\ntrain_indices <- sample(seq_len(n), size = floor(0.8 * n))\ntrain_data <- Boston[train_indices, ]\ntest_data <- Boston[-train_indices, ]\nFit Conformal Model 1\n# Define fit and predict functions\nfit_func <- function(formula, data, ...) MASS::rlm(formula, data = data, ...)\npredict_func <- function(fit, newdata, ...) predict(fit, newdata, ...)\n\n# Apply conformalize using the training data\nconformal_model_boston <- misc::conformalize(\n  formula = medv ~ .,\n  data = train_data,\n  fit_func = fit_func,\n  predict_func = predict_func,\n  seed = 123\n)\nGenerate Predictions and Prediction Intervals 1\nWe will use the\npredict.conformalize\nmethod to generate predictions and calculate prediction intervals for the test set.\n# Predict with split conformal method on the test data\npredictions_boston <- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"split\"\n)\n\nhead(predictions_boston)\n\n##         fit       lwr      upr\n## 1  29.92942 20.263283 39.59556\n## 15 19.30837  9.642229 28.97451\n## 17 20.71124 11.045100 30.37738\n## 19 14.86650  5.200365 24.53264\n## 28 14.79883  5.132688 24.46497\n## 37 20.98752 11.321382 30.65366\nCalculate Out-of-Sample Coverage Rate 1\nThe coverage rate is the proportion of true values in the test set that fall within the prediction intervals.\n# True values for the test set\ntrue_y_boston <- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston <- mean(true_y_boston >= predictions_boston[, \"lwr\"] & true_y_boston <= predictions_boston[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9509804\nFit Conformal Model 2\n# Define fit and predict functions\nfit_func <- function(formula, data, ...) stats::glm(formula, data = data, ...)\npredict_func <- function(fit, newdata, ...) predict(fit, newdata, ...)\n\n# Apply conformalize using the training data\nconformal_model_boston <- misc::conformalize(\n  formula = medv ~ .,\n  data = train_data,\n  fit_func = fit_func,\n  predict_func = predict_func,\n  seed = 123\n)\nGenerate Predictions and Prediction Intervals 2\nWe will use the\npredict.conformalize\nmethod to generate predictions and calculate prediction intervals for the test set.\n# Predict with split conformal method on the test data\npredictions_boston <- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"split\"\n)\n\nhead(predictions_boston)\n\n# Predict with split conformal method on the test data\npredictions_boston2 <- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"kde\"\n)\n\nhead(predictions_boston2)\n\n# Predict with split conformal method on the test data\npredictions_boston3 <- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"surrogate\"\n)\n\nhead(predictions_boston3)\n\n# Predict with split conformal method on the test data\npredictions_boston4 <- predict(\n  conformal_model_boston,\n  newdata = test_data,\n  level = 0.95,\n  method = \"bootstrap\"\n)\n\nhead(predictions_boston4)\nFit Conformal Model 2\n# Define fit and predict functions\nfit_func <- function(formula, data, ...) ranger::ranger(formula, data = data)\npredict_func <- function(fit, newdata, ...) predict(fit, newdata)$predictions\n\n# Apply conformalize using the training data\nconformal_model_boston_rf <- misc::conformalize(\n  formula = medv ~ .,\n  data = train_data,\n  fit_func = fit_func,\n  predict_func = predict_func,\n  seed = 123\n)\n\n# Predict with split conformal method on the test data\npredictions_boston_rf <- predict(\n  conformal_model_boston_rf,\n  newdata = test_data,\n  predict_func = predict_func,\n  level = 0.95,\n  method = \"kde\"\n)\n\nhead(predictions_boston_rf)\n\n##           fit       lwr      upr\n## [1,] 27.03134 21.991838 32.43038\n## [2,] 19.20299 13.542260 25.05314\n## [3,] 21.34472 17.000993 30.77696\n## [4,] 18.77455 12.341589 25.88818\n## [5,] 15.60764  9.157478 21.48264\n## [6,] 21.31355 14.591954 29.75374\n\n# Create a data frame for plotting\nplot_data <- data.frame(\n  Observation = seq_len(nrow(test_data)),\n  TrueValue = test_data$medv,\n  LowerBound = predictions_boston_rf[, \"lwr\"],\n  UpperBound = predictions_boston_rf[, \"upr\"]\n)\n\n# Sort data by observation for proper plotting\nplot_data <- plot_data[order(plot_data$Observation), ]\n\n# Plot the true values\nplot(\n  plot_data$Observation, plot_data$TrueValue,\n  pch = 16, col = \"blue\", cex = 0.7,\n  xlab = \"Observation\", ylab = \"Value\",\n  main = \"Prediction Intervals vs True Values\"\n)\n\n# Add the prediction intervals using polygon\npolygon(\n  c(plot_data$Observation, rev(plot_data$Observation)),\n  c(plot_data$LowerBound, rev(plot_data$UpperBound)),\n  col = rgb(1, 0, 0, 0.2), border = NA\n)\n\n# Add points for true values again to overlay on the polygon\npoints(\n  plot_data$Observation, plot_data$TrueValue,\n  pch = 16, col = \"blue\", cex = 0.7\n)\nCalculate Out-of-Sample Coverage Rate 2\nThe coverage rate is the proportion of true values in the test set that fall within the prediction intervals.\n# True values for the test set\ntrue_y_boston <- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston <- mean(true_y_boston >= predictions_boston[, \"lwr\"] & true_y_boston <= predictions_boston[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9411765\n\n# True values for the test set\ntrue_y_boston <- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston <- mean(true_y_boston >= predictions_boston2[, \"lwr\"] & true_y_boston <= predictions_boston2[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9607843\n\n# True values for the test set\ntrue_y_boston <- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston <- mean(true_y_boston >= predictions_boston3[, \"lwr\"] & true_y_boston <= predictions_boston3[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9705882\n\n# True values for the test set\ntrue_y_boston <- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston <- mean(true_y_boston >= predictions_boston4[, \"lwr\"] & true_y_boston <= predictions_boston4[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9607843\n\n# True values for the test set\ntrue_y_boston <- test_data$medv\n\n# Check if true values fall within the prediction intervals\ncoverage_boston <- mean(true_y_boston >= predictions_boston_rf[, \"lwr\"] & true_y_boston <= predictions_boston_rf[, \"upr\"])\n\ncat(\"Out-of-sample coverage rate for Boston dataset:\", coverage_boston)\n\n## Out-of-sample coverage rate for Boston dataset: 0.9215686\nResults\nThe prediction intervals are calculated using the split conformal method.\nThe out-of-sample coverage rate is displayed, which should be close to the specified confidence level (e.g., 0.95).\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nT. Moudiki's Webpage - R\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
    "meta_description": "A new function in the misc package allows you to perform conformal prediction with any R machine learning model. Conformal prediction improves prediction intervals' coverage rate thanks to held-out set cross-validation errors.",
    "meta_keywords": null,
    "og_description": "A new function in the misc package allows you to perform conformal prediction with any R machine learning model. Conformal prediction improves prediction intervals' coverage rate thanks to held-out set cross-validation errors.",
    "og_image": "https://thierrymoudiki.github.io/images/2025-03-24/2025-03-24-image1.png",
    "og_title": "Conformalize (improved prediction intervals and simulations) any R Machine Learning model with misc::conformalize | R-bloggers",
    "raw_jsonld_article": null,
    "reading_time_min": 9.2,
    "sitemap_lastmod": null,
    "twitter_description": "A new function in the misc package allows you to perform conformal prediction with any R machine learning model. Conformal prediction improves prediction intervals' coverage rate thanks to held-out set cross-validation errors.",
    "twitter_title": "Conformalize (improved prediction intervals and simulations) any R Machine Learning model with misc::conformalize | R-bloggers",
    "url": "https://www.r-bloggers.com/2025/03/conformalize-improved-prediction-intervals-and-simulations-any-r-machine-learning-model-with-miscconformalize/",
    "word_count": 1840
  }
}