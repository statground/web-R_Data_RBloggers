{
  "id": "95c88f86c7ae8d3a72ddd37bda2885aee991bd91",
  "url": "https://www.r-bloggers.com/2023/12/qeml-example-nonparametric-quantile-regression/",
  "created_at_utc": "2025-11-17T20:38:46Z",
  "data": null,
  "raw_original": {
    "uuid": "a5c5814d-3273-468a-a610-b9abea9bb249",
    "created_at": "2025-11-17 20:38:46",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2023/12/qeml-example-nonparametric-quantile-regression/",
      "crawled_at": "2025-11-17T09:26:34.649724",
      "external_links": [
        {
          "href": "https://matloff.wordpress.com/2023/12/22/qeml-example-nonparametric-quantile-regression/",
          "text": "Mad (Data) Scientist"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://matloff.wordpress.com/2023/12/22/qeml-example-nonparametric-quantile-regression/",
          "text": "Mad (Data) Scientist"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "qeML Example: Nonparametric Quantile Regression | R-bloggers",
      "images": [],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/matloff/",
          "text": "matloff"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-381077 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">qeML Example: Nonparametric Quantile Regression</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">December 22, 2023</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/matloff/\">matloff</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \r\n<div style=\"min-height: 30px;\">\r\n[social4i size=\"small\" align=\"align-left\"]\r\n</div>\r\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\r\n[This article was first published on  <strong><a href=\"https://matloff.wordpress.com/2023/12/22/qeml-example-nonparametric-quantile-regression/\"> Mad (Data) Scientist</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 3.8.9-->\n<p>In this post, I will first introduce the concept of quantile regression (QR), a powerful technique that is rarely taught in stat courses. I’ll give an example from the <strong>quantreg </strong>package, and then will show how <strong>qeML</strong> can be used to do model-free QR estimation. Along the way, I will also illustrate the use of <em>closures</em> in R.</p>\n<p>Notation: We are predicting a scalar Y (including the case of dummy/one-hot variables) from a feature vector X.</p>\n<p>In its simplest form, QR estimates the conditional median of Y given X, as opposed to the usual conditional mean, using a linear model. As we all know, the median is less affected by outliers than is the mean, so QR is giving us outlier robustness. As a bonus, we dispense with the homoskedasticity assumption, i.e. constant Var(Y|X).</p>\n<p>But it’s more than that. We can model any conditional quantile, e.g. estimate the 80th percentile weight for each human height. Quantile analysis has a variety of applications.</p>\n<p>One can conduct QR in R with the <strong>quantreg</strong> package, written by Prof. Roger Koenker, one of the major names in the QR field. Here is an example, using the <strong>qeML</strong> dataset <strong>mlb</strong>:</p>\n<pre>&gt; data(mlb)\n&gt; library(quantreg)\n&gt; z &lt;- rq(Weight ~ Height,data=mlb,tau=0.80)\n&gt; summary(z)\n\nCall: rq(formula = Weight ~ Height, tau = 0.8, data = mlb)\n\ntau: [1] 0.8\n\nCoefficients:\n            Value      Std. Error t value    Pr(&gt;|t|)  \n(Intercept) -201.66667   17.58797  -11.46617    0.00000\nHeight         5.66667    0.23856   23.75376    0.00000</pre>\n<p>As you can see, the call form here is like that of the R linear model function <strong>lm</strong>, and we could have had multiple predictors, e.g. age in addition to height.</p>\n<p>But what if we don’t believe a linear model is appropriate? Of course, as usual we may consider adding polynomial terms, and there is also a package <strong>quantreg.nonpar</strong>. But we obtain model-free estimates easily using <strong>qeKNN</strong> in <strong>qeML</strong>.</p>\n<p>Standard k-Nearest Neighbors estimation is simple. Say to predict the weight of someone 70 inches tall and 28 years ago, we find the k closest data points in our training data to the vector (70,28). We then compute the mean weight among those k people, and it’s then our predicted weight for the new person who has known height and age but unknown weight.</p>\n<p>But <strong>qeKNN </strong>offers the user more flexibility, via an argument <strong>smoothingFtn</strong>. Instead of computing mean Y among the neighbors, we can specify the median, or even specify that a small linear model be fit to the neighboring data. The latter may be useful if the new person to be predicted is either very short or very tall, as things tend to be biased near the edges of a dataset. If the new person is 77 inches tall, most or all people in our neighboring data will be shorter than this, thus lighter, so our prediction based on the mean will be biased downward.</p>\n<p>But we can also specify our own smoothingFtn, perfect for QR. We simply define a function that gives us the desired Y quantile among the neighbors.</p>\n<p>The call form is</p>\n<pre>smoothingFtn(nearIdxs,x,y,predpt)</pre>\n<p>Here <strong>x</strong> and <strong>y</strong> are our X and Y training data, <strong>predpt</strong> is the new X value at which we wish to predict (redundant in most cases), and <strong>nearIdxs</strong> are the indices in <strong>x </strong>and <strong>y</strong> of the nearest neighbors to <strong>predpt</strong>. Note that at the time kNN calls <strong>smoothingFtn</strong>, the indices have already been computed. </p>\n<p>Our code is then</p>\n<pre>sftn &lt;- function(nearIdxs,x,y,predpt)\n{\n   nearYs &lt;- y[nearIdxs]\n   quantile(nearYs,0.80)\n}\n\nu &lt;- mlb[c('Height','Age','Weight')]\nset.seed(9999) # qeML ftns do random holdout\nz &lt;- qeKNN(u,'Weight',smoothingFtn=sftn)\npredict(z,c(70,28)) # prints 200</pre>\n<p>It would be nice, though, to run this for a general quantile level <strong>q</strong>, rather than the special case 0.80. But we can’t do that directly, because the <strong>smoothingFtn</strong> argument to <strong>qeKNN</strong> must be a function object, no provision there for an argument to <strong>smoothingFtn</strong>. But we can accomplish what we want via R <em>closures</em>.</p>\n<pre>makeSmFtn &lt;- function(q) function(newIdxs,x,y,predpt) quantile(y[newIdxs],q)\n</pre>\n<p>To understand this, one must first know more about the R reserved word <strong>function</strong>. Consider this simple example:</p>\n<pre>f &lt;- function(x) x^2</pre>\n<p>Here we are saying, “R, please create a function for me. Its formal argument will be named <strong>x</strong>, and it will compute and return the square of that quantity. After you create that function–an object, just like other R entities–assign it to <strong>f</strong>.” In other words, <strong>function</strong> creates functions. As I like to tell my students,</p>\n<pre>The function of the function named function is to create functions!</pre>\n<p>Now, going back to <strong>makeQFtn</strong> above, it creates a function object (the call to quantile), and returns that object, just as with <strong>f </strong>above, but the key point is that here the value of <strong>q</strong> will be “baked in” to that object.</p>\n<p>So our call to <strong>qeKNN</strong> for general <strong>q</strong> would be</p>\n<p>z &lt;- qeKNN(u,’Weight’,smoothingFtn=makeSmFtn(q))</p>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 3.8.9-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://matloff.wordpress.com/2023/12/22/qeml-example-nonparametric-quantile-regression/\"> Mad (Data) Scientist</a></strong>.</div>\n<hr>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\r\n\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</hr></div> </div>\n</article>",
      "main_text": "qeML Example: Nonparametric Quantile Regression\nPosted on\nDecember 22, 2023\nby\nmatloff\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nMad (Data) Scientist\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nIn this post, I will first introduce the concept of quantile regression (QR), a powerful technique that is rarely taught in stat courses. I’ll give an example from the\nquantreg\npackage, and then will show how\nqeML\ncan be used to do model-free QR estimation. Along the way, I will also illustrate the use of\nclosures\nin R.\nNotation: We are predicting a scalar Y (including the case of dummy/one-hot variables) from a feature vector X.\nIn its simplest form, QR estimates the conditional median of Y given X, as opposed to the usual conditional mean, using a linear model. As we all know, the median is less affected by outliers than is the mean, so QR is giving us outlier robustness. As a bonus, we dispense with the homoskedasticity assumption, i.e. constant Var(Y|X).\nBut it’s more than that. We can model any conditional quantile, e.g. estimate the 80th percentile weight for each human height. Quantile analysis has a variety of applications.\nOne can conduct QR in R with the\nquantreg\npackage, written by Prof. Roger Koenker, one of the major names in the QR field. Here is an example, using the\nqeML\ndataset\nmlb\n:\n> data(mlb)\n> library(quantreg)\n> z <- rq(Weight ~ Height,data=mlb,tau=0.80)\n> summary(z)\n\nCall: rq(formula = Weight ~ Height, tau = 0.8, data = mlb)\n\ntau: [1] 0.8\n\nCoefficients:\n            Value      Std. Error t value    Pr(>|t|)  \n(Intercept) -201.66667   17.58797  -11.46617    0.00000\nHeight         5.66667    0.23856   23.75376    0.00000\nAs you can see, the call form here is like that of the R linear model function\nlm\n, and we could have had multiple predictors, e.g. age in addition to height.\nBut what if we don’t believe a linear model is appropriate? Of course, as usual we may consider adding polynomial terms, and there is also a package\nquantreg.nonpar\n. But we obtain model-free estimates easily using\nqeKNN\nin\nqeML\n.\nStandard k-Nearest Neighbors estimation is simple. Say to predict the weight of someone 70 inches tall and 28 years ago, we find the k closest data points in our training data to the vector (70,28). We then compute the mean weight among those k people, and it’s then our predicted weight for the new person who has known height and age but unknown weight.\nBut\nqeKNN\noffers the user more flexibility, via an argument\nsmoothingFtn\n. Instead of computing mean Y among the neighbors, we can specify the median, or even specify that a small linear model be fit to the neighboring data. The latter may be useful if the new person to be predicted is either very short or very tall, as things tend to be biased near the edges of a dataset. If the new person is 77 inches tall, most or all people in our neighboring data will be shorter than this, thus lighter, so our prediction based on the mean will be biased downward.\nBut we can also specify our own smoothingFtn, perfect for QR. We simply define a function that gives us the desired Y quantile among the neighbors.\nThe call form is\nsmoothingFtn(nearIdxs,x,y,predpt)\nHere\nx\nand\ny\nare our X and Y training data,\npredpt\nis the new X value at which we wish to predict (redundant in most cases), and\nnearIdxs\nare the indices in\nx\nand\ny\nof the nearest neighbors to\npredpt\n. Note that at the time kNN calls\nsmoothingFtn\n, the indices have already been computed.\nOur code is then\nsftn <- function(nearIdxs,x,y,predpt)\n{\n   nearYs <- y[nearIdxs]\n   quantile(nearYs,0.80)\n}\n\nu <- mlb[c('Height','Age','Weight')]\nset.seed(9999) # qeML ftns do random holdout\nz <- qeKNN(u,'Weight',smoothingFtn=sftn)\npredict(z,c(70,28)) # prints 200\nIt would be nice, though, to run this for a general quantile level\nq\n, rather than the special case 0.80. But we can’t do that directly, because the\nsmoothingFtn\nargument to\nqeKNN\nmust be a function object, no provision there for an argument to\nsmoothingFtn\n. But we can accomplish what we want via R\nclosures\n.\nmakeSmFtn <- function(q) function(newIdxs,x,y,predpt) quantile(y[newIdxs],q)\nTo understand this, one must first know more about the R reserved word\nfunction\n. Consider this simple example:\nf <- function(x) x^2\nHere we are saying, “R, please create a function for me. Its formal argument will be named\nx\n, and it will compute and return the square of that quantity. After you create that function–an object, just like other R entities–assign it to\nf\n.” In other words,\nfunction\ncreates functions. As I like to tell my students,\nThe function of the function named function is to create functions!\nNow, going back to\nmakeQFtn\nabove, it creates a function object (the call to quantile), and returns that object, just as with\nf\nabove, but the key point is that here the value of\nq\nwill be “baked in” to that object.\nSo our call to\nqeKNN\nfor general\nq\nwould be\nz <- qeKNN(u,’Weight’,smoothingFtn=makeSmFtn(q))\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nMad (Data) Scientist\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "In this post, I will first introduce the concept of quantile regression (QR), a powerful technique that is rarely taught in stat courses. I’ll give an example from the quantreg package, and then will show how qeML can be used to do model-free QR estimation. Along the way, I will also illustrate the use of … Continue reading qeML Example: Nonparametric Quantile Regression →",
      "meta_keywords": null,
      "og_description": "In this post, I will first introduce the concept of quantile regression (QR), a powerful technique that is rarely taught in stat courses. I’ll give an example from the quantreg package, and then will show how qeML can be used to do model-free QR estimation. Along the way, I will also illustrate the use of … Continue reading qeML Example: Nonparametric Quantile Regression →",
      "og_image": "https://www.r-bloggers.com/wp-content/uploads/2016/04/R_02_2016-05-01.png",
      "og_title": "qeML Example: Nonparametric Quantile Regression | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 5,
      "sitemap_lastmod": "2023-12-23T00:50:53+00:00",
      "twitter_description": "In this post, I will first introduce the concept of quantile regression (QR), a powerful technique that is rarely taught in stat courses. I’ll give an example from the quantreg package, and then will show how qeML can be used to do model-free QR estimation. Along the way, I will also illustrate the use of … Continue reading qeML Example: Nonparametric Quantile Regression →",
      "twitter_title": "qeML Example: Nonparametric Quantile Regression | R-bloggers",
      "url": "https://www.r-bloggers.com/2023/12/qeml-example-nonparametric-quantile-regression/",
      "word_count": 997
    }
  }
}