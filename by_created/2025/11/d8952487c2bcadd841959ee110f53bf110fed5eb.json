{
  "id": "d8952487c2bcadd841959ee110f53bf110fed5eb",
  "url": "https://www.r-bloggers.com/2025/03/a-bayesian-proportional-hazards-model-with-a-penalized-spline/",
  "created_at_utc": "2025-11-22T19:59:07Z",
  "data": null,
  "raw_original": {
    "uuid": "086ba04a-fdc7-481c-91ec-94b49bd9b4fc",
    "created_at": "2025-11-22 19:59:07",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2025/03/a-bayesian-proportional-hazards-model-with-a-penalized-spline/",
      "crawled_at": "2025-11-22T10:52:55.732693",
      "external_links": [
        {
          "href": "https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/",
          "text": "ouR data generation"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/",
          "text": "post"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/",
          "text": "post"
        },
        {
          "href": "https://www.rdatagen.net/post/2024-10-08-can-chatgpt-help-construct-non-trivial-bayesian-models-with-cluster-specific-splines/",
          "text": "described"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/",
          "text": "ouR data generation"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "A Bayesian proportional hazards model with a penalized spline | R-bloggers",
      "images": [
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/index.en_files/figure-html/surv_plots-1.png?w=288&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/index.en_files/figure-html/lHRplot-1.png?w=450&ssl=1"
        }
      ],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/keith-goldfeld/",
          "text": "Keith Goldfeld"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-390997 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">A Bayesian proportional hazards model with a penalized spline</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">March 3, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/keith-goldfeld/\">Keith Goldfeld</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/\"> ouR data generation</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<p>In my previous <a href=\"https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/\" rel=\"nofollow\" target=\"_blank\">post</a>, I outlined a Bayesian approach to proportional hazards modeling. This post serves as an addendum, providing code to incorporate a spline to model a time-varying hazard ratio non linearly. In a second addendum to come I will present a separate model with a site-specific random effect, essential for a cluster-randomized trial. These components lay the groundwork for analyzing a stepped-wedge cluster-randomized trial, where both splines and site-specific random effects will be integrated into a single model. I plan on describing this comprehensive model in a final post.</p>\n<div class=\"section level3\" id=\"simulating-data-with-a-time-varying-hazard-ratio\">\n<h3>Simulating data with a time-varying hazard ratio</h3>\n<p>Here are the <code>R</code> packages used in the post:</p>\n<pre>library(simstudy)\nlibrary(ggplot2)\nlibrary(data.table)\nlibrary(survival)\nlibrary(survminer)\nlibrary(splines)\nlibrary(splines2)\nlibrary(cmdstanr)</pre>\n<p>The dataset simulates a randomized controlled trial in which patients are assigned either to the treatment group (<span class=\"math inline\">\\(A=1\\)</span>) or control group (<span class=\"math inline\">\\(A=0\\)</span>) in a <span class=\"math inline\">\\(1:1\\)</span> ratio. Patients enroll over nine quarters, with the enrollment quarter denoted by <span class=\"math inline\">\\(M\\)</span>, <span class=\"math inline\">\\(M \\in \\{0, \\dots, 8 \\}\\)</span>. The time-to-event outcome, <span class=\"math inline\">\\(Y\\)</span>, depends on both treatment assignment and enrollment quarter. To introduce non-linearity, I define the relationship using a cubic function, with true parameters specified as follows:</p>\n<pre>defI &lt;- \n  defData(varname = \"A\", formula = \"1;1\", dist = \"trtAssign\") |&gt;\n  defData(varname = \"M\", formula = \"0;8\", dist = \"uniformInt\")\n\ndefS &lt;-\n  defSurv(\n    varname = \"eventTime\",\n    formula = \"..int + ..beta * A + ..alpha_1 * M + ..alpha_2 * M^2 + ..alpha_3 * M^3\",\n    shape = 0.30)  |&gt;\n  defSurv(varname = \"censorTime\", formula = -11.3, shape = 0.40)\n\n# parameters\n\nint &lt;- -11.6      \nbeta &lt;-  0.70\nalpha_1 &lt;-  0.10   \nalpha_2 &lt;-  0.40    \nalpha_3 &lt;- -0.05</pre>\n<p>I’ve generated a single data set of <span class=\"math inline\">\\(640\\)</span> study participants, <span class=\"math inline\">\\(320\\)</span> in each arm. The plot below shows the Kaplan-Meier curves by arm for each enrollment period.</p>\n<pre>set.seed(7368) # 7362\n\ndd &lt;- genData(640, defI)\ndd &lt;- genSurv(dd, defS, timeName = \"Y\", censorName = \"censorTime\",\n  eventName = \"event\", typeName = \"eventType\", keepEvents = TRUE)</pre>\n<p><img data-lazy-src=\"https://i2.wp.com/www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/index.en_files/figure-html/surv_plots-1.png?w=288&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i2.wp.com/www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/index.en_files/figure-html/surv_plots-1.png?w=288&amp;ssl=1\"/></noscript></p>\n</div>\n<div class=\"section level3\" id=\"bayesian-model\">\n<h3>Bayesian model</h3>\n<p>This Bayesian proportional hazards model builds directly on the approach from my previous <a href=\"https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/\" rel=\"nofollow\" target=\"_blank\">post</a>. Since the effect of <span class=\"math inline\">\\(M\\)</span> on <span class=\"math inline\">\\(Y\\)</span> follows a non-linear pattern, I model this relationship using a spline to account for temporal variation in the hazard. The partial likelihood is a function of the treatment effect and spline basis function coefficients, given by:</p>\n<p><span class=\"math display\">\\[\nL(\\beta,\\mathbf{\\gamma}) = \\prod_{i=1}^{N} \\left( \\frac{\\exp \\left(\\beta A_i + \\sum_{m=1} ^ M \\gamma_m X_{m_i} \\right)} {\\sum_{j \\in R(t_i)} \\exp\\left(\\beta A_j + \\sum_{m=1} ^ M \\gamma_m X_{m_j}\\right) } \\right)^{\\delta_i}\n\\]</span>\nwhere:</p>\n<ul>\n<li><span class=\"math inline\">\\(M\\)</span>: number of spline basis functions</li>\n<li><span class=\"math inline\">\\(N\\)</span>: number of observations (censored or not)</li>\n<li><span class=\"math inline\">\\(A_i\\)</span>: binary indicator for treatment</li>\n<li><span class=\"math inline\">\\(X_{m_i}\\)</span>: value of the <span class=\"math inline\">\\(m^{\\text{th}}\\)</span> spline basis function for the <span class=\"math inline\">\\(i^{\\text{th}}\\)</span> observation</li>\n<li><span class=\"math inline\">\\(\\delta_i\\)</span>: event indicator (<span class=\"math inline\">\\(\\delta_i = 1\\)</span> if the event occurred, <span class=\"math inline\">\\(\\delta_i = 0\\)</span> if censored)</li>\n<li><span class=\"math inline\">\\(\\beta\\)</span>: treatment coefficient</li>\n<li><span class=\"math inline\">\\(\\gamma_m\\)</span>: spline coefficient for the <span class=\"math inline\">\\(m^\\text{th}\\)</span> spline basis function</li>\n<li><span class=\"math inline\">\\(R(t_i)\\)</span>: risk set at time <span class=\"math inline\">\\(t_i\\)</span> (including only individuals censored <em>after</em> <span class=\"math inline\">\\(t_i\\)</span>)</li>\n</ul>\n<p>The spline component of the model is adapted from a model I <a href=\"https://www.rdatagen.net/post/2024-10-08-can-chatgpt-help-construct-non-trivial-bayesian-models-with-cluster-specific-splines/\" rel=\"nofollow\" target=\"_blank\">described</a> last year. In this formulation, time-to-event is modeled as a function of the vector <span class=\"math inline\">\\(\\mathbf{X_i}\\)</span> rather than the period itself. The number of basis functions is determined by the number of knots, with each segment of the curve estimated using B-spline basis functions. To minimize overfitting, we include a penalization term based on the second derivative of the B-spline basis functions. The strength of this penalization is controlled by a tuning parameter, <span class=\"math inline\">\\(\\lambda\\)</span>, which is provided to the model.</p>\n<p>The Stan code, provided in full here, was explained in earlier posts. The principal difference from the previous post is the addition of the spline-related data and parameters, as well as the penalization term in the model.:</p>\n<pre>stan_code &lt;-\n\"\nfunctions {\n\n  // Binary search optimized to return the last index with the target value\n\n  int binary_search(vector v, real tar_val) {\n    int low = 1;\n    int high = num_elements(v);\n    int result = -1;\n\n    while (low &lt;= high) {\n      int mid = (low + high) %/% 2;\n      if (v[mid] == tar_val) {\n        result = mid; // Store the index\n        high = mid - 1; // Look for earlier occurrences\n      } else if (v[mid] &lt; tar_val) {\n        low = mid + 1;\n      } else {\n        high = mid - 1;\n      }\n    }\n    return result;\n  }\n}\n\ndata {\n\n  int&lt;lower=0&gt; K;          // Number of covariates\n  int&lt;lower=0&gt; N_o;        // Number of uncensored observations\n  vector[N_o] t_o;         // Event times (sorted in decreasing order)\n\n  int&lt;lower=0&gt; N;          // Number of total observations\n  vector[N] t;             // Individual times (sorted in decreasing order)\n  matrix[N, K] x;          // Covariates for all observations\n\n  // Spline-related data\n  \n  int&lt;lower=1&gt; Q;          // Number of basis functions\n  matrix[N, Q] B;          // Spline basis matrix\n  matrix[N, Q] D2_spline;  // 2nd derivative for penalization\n  real lambda;             // penalization term\n}\n\nparameters {\n  vector[K] beta;          // Fixed effects for covariates\n  vector[Q] gamma;         // Spline coefficients\n}\n\nmodel {\n  \n  // Prior\n  \n  beta ~ normal(0, 4);\n  \n  // Spline coefficients prior\n  \n  gamma ~ normal(0, 4);\n  \n  // Penalization term for spline second derivative\n  \n  target += -lambda * sum(square(D2_spline * gamma));\n  \n  // Calculate theta for each observation to be used in likelihood\n  \n  vector[N] theta;\n  vector[N] log_sum_exp_theta;\n  \n  for (i in 1:N) {\n    theta[i] = dot_product(x[i], beta) + dot_product(B[i], gamma);  \n  }\n  \n  // Compute cumulative sum of log(exp(theta)) from last to first observation\n  \n  log_sum_exp_theta[N] = theta[N];\n  \n  for (i in tail(sort_indices_desc(t), N-1)) {\n    log_sum_exp_theta[i] = log_sum_exp(theta[i], log_sum_exp_theta[i + 1]);\n  }\n\n  // Likelihood for uncensored observations\n  \n  for (n_o in 1:N_o) {\n    int start_risk = binary_search(t, t_o[n_o]); // Use binary search\n    \n    real log_denom = log_sum_exp_theta[start_risk];\n    target += theta[start_risk] - log_denom;\n  }\n}\n\"</pre>\n<p>To estimate the model, we need to get the data ready to pass to <code>Stan</code>, compile the <code>Stan</code> code, and then sample from the model using <code>cmdstanr</code>:</p>\n<pre>dx &lt;- copy(dd)\nsetorder(dx, Y)\n\ndx.obs &lt;- dx[event == 1]\nN_obs &lt;- dx.obs[, .N]\nt_obs &lt;- dx.obs[, Y]\n\nN_all &lt;- dx[, .N]\nt_all &lt;- dx[, Y]\nx_all &lt;- data.frame(dx[, .(A)])\n\n# Spline-related info\n\nn_knots &lt;- 5\nspline_degree &lt;- 3\nknot_dist &lt;- 1/(n_knots + 1)\nprobs &lt;- seq(knot_dist, 1 - knot_dist, by = knot_dist)\nknots &lt;- quantile(dx$M, probs = probs)\nspline_basis &lt;- bs(dx$M, knots = knots, degree = spline_degree, intercept = TRUE)\nB &lt;- as.matrix(spline_basis)\n\nD2 &lt;- dbs(dx$M, knots = knots, degree = spline_degree, derivs = 2, intercept = TRUE)\nD2_spline &lt;- as.matrix(D2)\n\nK &lt;- ncol(x_all)             # num covariates - in this case just A\n\nstan_data &lt;- list(\n  K = K,\n  N_o = N_obs,\n  t_o = t_obs,\n  N = N_all,\n  t = t_all,\n  x = x_all,\n  Q = ncol(B),\n  B = B,\n  D2_spline = D2_spline,\n  lambda = 0.10\n)\n\n# compiling code\n\nstan_model &lt;- cmdstan_model(write_stan_file(stan_code))\n\n# sampling from model\n\nfit &lt;- stan_model$sample(\n  data = stan_data,\n  iter_warmup = 1000,\n  iter_sampling = 4000,\n  chains = 4,\n  parallel_chains = 4,\n  max_treedepth = 15,\n  refresh = 0\n)\n## Running MCMC with 4 parallel chains...\n## \n## Chain 4 finished in 64.1 seconds.\n## Chain 3 finished in 64.5 seconds.\n## Chain 2 finished in 65.2 seconds.\n## Chain 1 finished in 70.6 seconds.\n## \n## All 4 chains finished successfully.\n## Mean chain execution time: 66.1 seconds.\n## Total execution time: 70.8 seconds.</pre>\n<p>The posterior mean (and median) for <span class=\"math inline\">\\(\\beta\\)</span>, the treatment effect, are quite close to the “true” value of 0.70:</p>\n<pre>fit$summary(variables = c(\"beta\", \"gamma\"))\n## # A tibble: 10 × 10\n##    variable   mean median     sd    mad     q5   q95  rhat ess_bulk ess_tail\n##    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;\n##  1 beta[1]   0.689  0.689 0.0844 0.0857  0.551 0.828  1.00    3664.    4002.\n##  2 gamma[1] -1.75  -1.77  1.33   1.35   -3.91  0.468  1.00    1364.    1586.\n##  3 gamma[2] -1.59  -1.60  1.33   1.35   -3.75  0.626  1.00    1360.    1551.\n##  4 gamma[3] -1.22  -1.24  1.33   1.35   -3.39  0.978  1.00    1365.    1515.\n##  5 gamma[4] -0.115 -0.127 1.33   1.35   -2.28  2.09   1.00    1361.    1576.\n##  6 gamma[5]  1.97   1.95  1.34   1.35   -0.206 4.20   1.00    1366.    1581.\n##  7 gamma[6]  2.63   2.61  1.33   1.34    0.452 4.84   1.00    1358.    1586.\n##  8 gamma[7]  1.08   1.05  1.33   1.34   -1.08  3.28   1.00    1360.    1505.\n##  9 gamma[8] -0.238 -0.260 1.33   1.34   -2.40  1.97   1.00    1355.    1543.\n## 10 gamma[9] -0.914 -0.935 1.33   1.35   -3.07  1.30   1.00    1356.    1549.</pre>\n<p>The figure below shows the estimated spline and the 95% credible interval. The green line represents the posterior median log hazard ratio for each period (relative to the middle period, 4), with the shaded band indicating the corresponding credible interval. The purple points represent the log hazard ratios implied by the data generation process. For example, the log hazard ratio comparing period 1 to period 4 for both arms is:</p>\n<p><span class=\"math display\">\\[\n\\begin{array}{c}\n(-11.6 + 0.70A +0.10\\times1 + 0.40 \\times 1^2 -0.05\\times1^3) - (-11.6 + 0.70A +0.10\\times4 + 0.40 \\times 4^2 -0.05\\times4^3) = \\\\\n(0.10 + 0.40 - 0.05) - (0.10 \\times 4 + 0.40 \\times 16 - 0.05 \\times 64 ) = \\\\\n0.45 - 3.60 = -3.15\n\\end{array}\n\\]</span></p>\n<p>It appears that the median posterior aligns quite well with the values used in the data generation process:</p>\n<p><img data-lazy-src=\"https://i2.wp.com/www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/index.en_files/figure-html/lHRplot-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i2.wp.com/www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/index.en_files/figure-html/lHRplot-1.png?w=450&amp;ssl=1\"/></noscript></p>\n<p>For the next post, I will present another scenario that includes random effects for a cluster randomized trial (but will not include splines).</p>\n</div>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/\"> ouR data generation</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
      "main_text": "A Bayesian proportional hazards model with a penalized spline\nPosted on\nMarch 3, 2025\nby\nKeith Goldfeld\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nouR data generation\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nIn my previous\npost\n, I outlined a Bayesian approach to proportional hazards modeling. This post serves as an addendum, providing code to incorporate a spline to model a time-varying hazard ratio non linearly. In a second addendum to come I will present a separate model with a site-specific random effect, essential for a cluster-randomized trial. These components lay the groundwork for analyzing a stepped-wedge cluster-randomized trial, where both splines and site-specific random effects will be integrated into a single model. I plan on describing this comprehensive model in a final post.\nSimulating data with a time-varying hazard ratio\nHere are the\nR\npackages used in the post:\nlibrary(simstudy)\nlibrary(ggplot2)\nlibrary(data.table)\nlibrary(survival)\nlibrary(survminer)\nlibrary(splines)\nlibrary(splines2)\nlibrary(cmdstanr)\nThe dataset simulates a randomized controlled trial in which patients are assigned either to the treatment group (\n\\(A=1\\)\n) or control group (\n\\(A=0\\)\n) in a\n\\(1:1\\)\nratio. Patients enroll over nine quarters, with the enrollment quarter denoted by\n\\(M\\)\n,\n\\(M \\in \\{0, \\dots, 8 \\}\\)\n. The time-to-event outcome,\n\\(Y\\)\n, depends on both treatment assignment and enrollment quarter. To introduce non-linearity, I define the relationship using a cubic function, with true parameters specified as follows:\ndefI <- \n  defData(varname = \"A\", formula = \"1;1\", dist = \"trtAssign\") |>\n  defData(varname = \"M\", formula = \"0;8\", dist = \"uniformInt\")\n\ndefS <-\n  defSurv(\n    varname = \"eventTime\",\n    formula = \"..int + ..beta * A + ..alpha_1 * M + ..alpha_2 * M^2 + ..alpha_3 * M^3\",\n    shape = 0.30)  |>\n  defSurv(varname = \"censorTime\", formula = -11.3, shape = 0.40)\n\n# parameters\n\nint <- -11.6      \nbeta <-  0.70\nalpha_1 <-  0.10   \nalpha_2 <-  0.40    \nalpha_3 <- -0.05\nI’ve generated a single data set of\n\\(640\\)\nstudy participants,\n\\(320\\)\nin each arm. The plot below shows the Kaplan-Meier curves by arm for each enrollment period.\nset.seed(7368) # 7362\n\ndd <- genData(640, defI)\ndd <- genSurv(dd, defS, timeName = \"Y\", censorName = \"censorTime\",\n  eventName = \"event\", typeName = \"eventType\", keepEvents = TRUE)\nBayesian model\nThis Bayesian proportional hazards model builds directly on the approach from my previous\npost\n. Since the effect of\n\\(M\\)\non\n\\(Y\\)\nfollows a non-linear pattern, I model this relationship using a spline to account for temporal variation in the hazard. The partial likelihood is a function of the treatment effect and spline basis function coefficients, given by:\n\\[\nL(\\beta,\\mathbf{\\gamma}) = \\prod_{i=1}^{N} \\left( \\frac{\\exp \\left(\\beta A_i + \\sum_{m=1} ^ M \\gamma_m X_{m_i} \\right)} {\\sum_{j \\in R(t_i)} \\exp\\left(\\beta A_j + \\sum_{m=1} ^ M \\gamma_m X_{m_j}\\right) } \\right)^{\\delta_i}\n\\]\nwhere:\n\\(M\\)\n: number of spline basis functions\n\\(N\\)\n: number of observations (censored or not)\n\\(A_i\\)\n: binary indicator for treatment\n\\(X_{m_i}\\)\n: value of the\n\\(m^{\\text{th}}\\)\nspline basis function for the\n\\(i^{\\text{th}}\\)\nobservation\n\\(\\delta_i\\)\n: event indicator (\n\\(\\delta_i = 1\\)\nif the event occurred,\n\\(\\delta_i = 0\\)\nif censored)\n\\(\\beta\\)\n: treatment coefficient\n\\(\\gamma_m\\)\n: spline coefficient for the\n\\(m^\\text{th}\\)\nspline basis function\n\\(R(t_i)\\)\n: risk set at time\n\\(t_i\\)\n(including only individuals censored\nafter\n\\(t_i\\)\n)\nThe spline component of the model is adapted from a model I\ndescribed\nlast year. In this formulation, time-to-event is modeled as a function of the vector\n\\(\\mathbf{X_i}\\)\nrather than the period itself. The number of basis functions is determined by the number of knots, with each segment of the curve estimated using B-spline basis functions. To minimize overfitting, we include a penalization term based on the second derivative of the B-spline basis functions. The strength of this penalization is controlled by a tuning parameter,\n\\(\\lambda\\)\n, which is provided to the model.\nThe Stan code, provided in full here, was explained in earlier posts. The principal difference from the previous post is the addition of the spline-related data and parameters, as well as the penalization term in the model.:\nstan_code <-\n\"\nfunctions {\n\n  // Binary search optimized to return the last index with the target value\n\n  int binary_search(vector v, real tar_val) {\n    int low = 1;\n    int high = num_elements(v);\n    int result = -1;\n\n    while (low <= high) {\n      int mid = (low + high) %/% 2;\n      if (v[mid] == tar_val) {\n        result = mid; // Store the index\n        high = mid - 1; // Look for earlier occurrences\n      } else if (v[mid] < tar_val) {\n        low = mid + 1;\n      } else {\n        high = mid - 1;\n      }\n    }\n    return result;\n  }\n}\n\ndata {\n\n  int<lower=0> K;          // Number of covariates\n  int<lower=0> N_o;        // Number of uncensored observations\n  vector[N_o] t_o;         // Event times (sorted in decreasing order)\n\n  int<lower=0> N;          // Number of total observations\n  vector[N] t;             // Individual times (sorted in decreasing order)\n  matrix[N, K] x;          // Covariates for all observations\n\n  // Spline-related data\n  \n  int<lower=1> Q;          // Number of basis functions\n  matrix[N, Q] B;          // Spline basis matrix\n  matrix[N, Q] D2_spline;  // 2nd derivative for penalization\n  real lambda;             // penalization term\n}\n\nparameters {\n  vector[K] beta;          // Fixed effects for covariates\n  vector[Q] gamma;         // Spline coefficients\n}\n\nmodel {\n  \n  // Prior\n  \n  beta ~ normal(0, 4);\n  \n  // Spline coefficients prior\n  \n  gamma ~ normal(0, 4);\n  \n  // Penalization term for spline second derivative\n  \n  target += -lambda * sum(square(D2_spline * gamma));\n  \n  // Calculate theta for each observation to be used in likelihood\n  \n  vector[N] theta;\n  vector[N] log_sum_exp_theta;\n  \n  for (i in 1:N) {\n    theta[i] = dot_product(x[i], beta) + dot_product(B[i], gamma);  \n  }\n  \n  // Compute cumulative sum of log(exp(theta)) from last to first observation\n  \n  log_sum_exp_theta[N] = theta[N];\n  \n  for (i in tail(sort_indices_desc(t), N-1)) {\n    log_sum_exp_theta[i] = log_sum_exp(theta[i], log_sum_exp_theta[i + 1]);\n  }\n\n  // Likelihood for uncensored observations\n  \n  for (n_o in 1:N_o) {\n    int start_risk = binary_search(t, t_o[n_o]); // Use binary search\n    \n    real log_denom = log_sum_exp_theta[start_risk];\n    target += theta[start_risk] - log_denom;\n  }\n}\n\"\nTo estimate the model, we need to get the data ready to pass to\nStan\n, compile the\nStan\ncode, and then sample from the model using\ncmdstanr\n:\ndx <- copy(dd)\nsetorder(dx, Y)\n\ndx.obs <- dx[event == 1]\nN_obs <- dx.obs[, .N]\nt_obs <- dx.obs[, Y]\n\nN_all <- dx[, .N]\nt_all <- dx[, Y]\nx_all <- data.frame(dx[, .(A)])\n\n# Spline-related info\n\nn_knots <- 5\nspline_degree <- 3\nknot_dist <- 1/(n_knots + 1)\nprobs <- seq(knot_dist, 1 - knot_dist, by = knot_dist)\nknots <- quantile(dx$M, probs = probs)\nspline_basis <- bs(dx$M, knots = knots, degree = spline_degree, intercept = TRUE)\nB <- as.matrix(spline_basis)\n\nD2 <- dbs(dx$M, knots = knots, degree = spline_degree, derivs = 2, intercept = TRUE)\nD2_spline <- as.matrix(D2)\n\nK <- ncol(x_all)             # num covariates - in this case just A\n\nstan_data <- list(\n  K = K,\n  N_o = N_obs,\n  t_o = t_obs,\n  N = N_all,\n  t = t_all,\n  x = x_all,\n  Q = ncol(B),\n  B = B,\n  D2_spline = D2_spline,\n  lambda = 0.10\n)\n\n# compiling code\n\nstan_model <- cmdstan_model(write_stan_file(stan_code))\n\n# sampling from model\n\nfit <- stan_model$sample(\n  data = stan_data,\n  iter_warmup = 1000,\n  iter_sampling = 4000,\n  chains = 4,\n  parallel_chains = 4,\n  max_treedepth = 15,\n  refresh = 0\n)\n## Running MCMC with 4 parallel chains...\n## \n## Chain 4 finished in 64.1 seconds.\n## Chain 3 finished in 64.5 seconds.\n## Chain 2 finished in 65.2 seconds.\n## Chain 1 finished in 70.6 seconds.\n## \n## All 4 chains finished successfully.\n## Mean chain execution time: 66.1 seconds.\n## Total execution time: 70.8 seconds.\nThe posterior mean (and median) for\n\\(\\beta\\)\n, the treatment effect, are quite close to the “true” value of 0.70:\nfit$summary(variables = c(\"beta\", \"gamma\"))\n## # A tibble: 10 × 10\n##    variable   mean median     sd    mad     q5   q95  rhat ess_bulk ess_tail\n##    <chr>     <dbl>  <dbl>  <dbl>  <dbl>  <dbl> <dbl> <dbl>    <dbl>    <dbl>\n##  1 beta[1]   0.689  0.689 0.0844 0.0857  0.551 0.828  1.00    3664.    4002.\n##  2 gamma[1] -1.75  -1.77  1.33   1.35   -3.91  0.468  1.00    1364.    1586.\n##  3 gamma[2] -1.59  -1.60  1.33   1.35   -3.75  0.626  1.00    1360.    1551.\n##  4 gamma[3] -1.22  -1.24  1.33   1.35   -3.39  0.978  1.00    1365.    1515.\n##  5 gamma[4] -0.115 -0.127 1.33   1.35   -2.28  2.09   1.00    1361.    1576.\n##  6 gamma[5]  1.97   1.95  1.34   1.35   -0.206 4.20   1.00    1366.    1581.\n##  7 gamma[6]  2.63   2.61  1.33   1.34    0.452 4.84   1.00    1358.    1586.\n##  8 gamma[7]  1.08   1.05  1.33   1.34   -1.08  3.28   1.00    1360.    1505.\n##  9 gamma[8] -0.238 -0.260 1.33   1.34   -2.40  1.97   1.00    1355.    1543.\n## 10 gamma[9] -0.914 -0.935 1.33   1.35   -3.07  1.30   1.00    1356.    1549.\nThe figure below shows the estimated spline and the 95% credible interval. The green line represents the posterior median log hazard ratio for each period (relative to the middle period, 4), with the shaded band indicating the corresponding credible interval. The purple points represent the log hazard ratios implied by the data generation process. For example, the log hazard ratio comparing period 1 to period 4 for both arms is:\n\\[\n\\begin{array}{c}\n(-11.6 + 0.70A +0.10\\times1 + 0.40 \\times 1^2 -0.05\\times1^3) - (-11.6 + 0.70A +0.10\\times4 + 0.40 \\times 4^2 -0.05\\times4^3) = \\\\\n(0.10 + 0.40 - 0.05) - (0.10 \\times 4 + 0.40 \\times 16 - 0.05 \\times 64 ) = \\\\\n0.45 - 3.60 = -3.15\n\\end{array}\n\\]\nIt appears that the median posterior aligns quite well with the values used in the data generation process:\nFor the next post, I will present another scenario that includes random effects for a cluster randomized trial (but will not include splines).\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nouR data generation\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "In my previous post, I outlined a Bayesian approach to proportional hazards modeling. This post serves as an addendum, providing code to incorporate a spline to model a time-varying hazard ratio non linearly. In a second addendum to come I will pres...",
      "meta_keywords": null,
      "og_description": "In my previous post, I outlined a Bayesian approach to proportional hazards modeling. This post serves as an addendum, providing code to incorporate a spline to model a time-varying hazard ratio non linearly. In a second addendum to come I will pres...",
      "og_image": "https://www.rdatagen.net/post/2025-03-04-a-bayesian-proportional-hazards-model-with-splines/index.en_files/figure-html/surv_plots-1.png",
      "og_title": "A Bayesian proportional hazards model with a penalized spline | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 8.4,
      "sitemap_lastmod": null,
      "twitter_description": "In my previous post, I outlined a Bayesian approach to proportional hazards modeling. This post serves as an addendum, providing code to incorporate a spline to model a time-varying hazard ratio non linearly. In a second addendum to come I will pres...",
      "twitter_title": "A Bayesian proportional hazards model with a penalized spline | R-bloggers",
      "url": "https://www.r-bloggers.com/2025/03/a-bayesian-proportional-hazards-model-with-a-penalized-spline/",
      "word_count": 1688
    }
  }
}