{
  "uuid": "e84cadea-0df6-4f70-a348-4f542d7c4f40",
  "created_at": "2025-11-22 19:59:02",
  "raw_json": {
    "article_author": null,
    "article_headline": null,
    "article_modified": null,
    "article_published": null,
    "article_section": null,
    "article_tags": null,
    "canonical_url": "https://www.r-bloggers.com/2025/03/building-a-flask-service-to-get-yfinance-data-part-i/",
    "crawled_at": "2025-11-22T10:52:23.767018",
    "external_links": [
      {
        "href": "https://adam-gladstone.github.io/python-project/Building-a-Flask-service-to-get-yfinance-data-Part-I/",
        "text": "Adam’s Software Lab"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      },
      {
        "href": "https://www.youtube.com/watch?v=8jmjxXc5H8c",
        "text": "How to Calculate the Intrinsic Value of a Stock like Benjamin Graham"
      },
      {
        "href": "https://support.microsoft.com/en-us/office/get-started-with-python-in-excel-a33fbcbe-065b-41d3-82cf-23d05397f53d",
        "text": "PY="
      },
      {
        "href": "https://support.microsoft.com/en-us/office/open-source-libraries-and-python-in-excel-c817c897-41db-40a1-b9f3-d5ffe6d1bf3e",
        "text": "supports"
      },
      {
        "href": "https://flask.palletsprojects.com/en/stable/",
        "text": "Flask API"
      },
      {
        "href": "https://adam-gladstone.github.io/python-projects/Building-a-Flask-service-to-get-yfinance-data-Part-I/",
        "text": "Part I"
      },
      {
        "href": "https://github.com/Adam-Gladstone/YFinanceService",
        "text": "YFinanceService"
      },
      {
        "href": "https://adam-gladstone.github.io/python-projects/2025-03-19-Consuming-yfinance-data-in-Excel-Part-II/",
        "text": "Part II"
      },
      {
        "href": "https://github.com/SimplyWallSt",
        "text": "Simply Wall St."
      },
      {
        "href": "https://stablebread.com/how-to-calculate-the-intrinsic-value-of-a-company-like-benjamin-graham/",
        "text": "here"
      },
      {
        "href": "https://adam-gladstone.github.io/assets/images/YFinanceService.py",
        "text": "YFinanceService.py"
      },
      {
        "href": "https://adam-gladstone.github.io/python-projects/2025-03-19-Consuming-yfinance-data-in-Excel-Part-II/",
        "text": "Part II"
      },
      {
        "href": "https://adam-gladstone.github.io/python-project/Building-a-Flask-service-to-get-yfinance-data-Part-I/",
        "text": "Adam’s Software Lab"
      },
      {
        "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
        "text": "daily e-mail updates"
      },
      {
        "href": "https://www.r-project.org/",
        "text": "R"
      },
      {
        "href": "https://www.r-users.com/",
        "text": "Click here if you're looking to post or find an R/data-science job"
      },
      {
        "href": "http://r-posts.com/",
        "text": "here"
      }
    ],
    "h1_title": "R-bloggers",
    "html_title": "Building a Flask service to get yfinance data – Part I | R-bloggers",
    "images": [
      {
        "alt": "module not found error",
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": "module not found error",
        "base64": null,
        "src": "https://i2.wp.com/adam-gladstone.github.io/assets/images/Module-Not-Found-Error.png?w=578&ssl=1"
      },
      {
        "alt": "Starting the YFinanceService",
        "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
      },
      {
        "alt": "Starting the YFinanceService",
        "base64": null,
        "src": "https://i1.wp.com/adam-gladstone.github.io/assets/images/Running-Flask-app.png?w=578&ssl=1"
      }
    ],
    "internal_links": [
      {
        "href": "https://www.r-bloggers.com/author/adam-gladstone/",
        "text": "Adam Gladstone"
      },
      {
        "href": "https://www.r-bloggers.com/category/r-bloggers/",
        "text": "R bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers"
      },
      {
        "href": "https://www.r-bloggers.com/contact-us/",
        "text": "here"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      },
      {
        "href": "https://www.r-bloggers.com/",
        "text": "R-bloggers.com"
      },
      {
        "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
        "text": "learning R"
      },
      {
        "href": "https://www.r-bloggers.com/add-your-blog/",
        "text": "click here"
      }
    ],
    "lang": "en-US",
    "main_html": "<article class=\"post-391342 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Building a Flask service to get yfinance data – Part I</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">March 18, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/adam-gladstone/\">Adam Gladstone</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://adam-gladstone.github.io/python-project/Building-a-Flask-service-to-get-yfinance-data-Part-I/\"> Adam’s Software Lab</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47--><h3 id=\"introduction\">Introduction</h3>\n<p>Recently, I’ve been doing some portfolio analysis and I came across an interesting video: <a href=\"https://www.youtube.com/watch?v=8jmjxXc5H8c\" rel=\"nofollow\" target=\"_blank\">How to Calculate the Intrinsic Value of a Stock like Benjamin Graham</a>. Since not all the data is available in Excel, I thought it might be useful to automate the calculation using data from the (excellent) <strong>yfinance</strong> Python library. The formula itself, written in Python, is quite simple. The challenge was to obtain the individual parameters and inputs and be able to call the Python function from an Excel worksheet.</p>\n<p>It would have been nice to be able to use Excel’s Python support <a href=\"https://support.microsoft.com/en-us/office/get-started-with-python-in-excel-a33fbcbe-065b-41d3-82cf-23d05397f53d\" rel=\"nofollow\" target=\"_blank\">PY=</a>. But it turns out that importing <strong>yfinance</strong> produces a <img alt=\"module not found error\" data-lazy-src=\"https://i2.wp.com/adam-gladstone.github.io/assets/images/Module-Not-Found-Error.png?w=578&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img alt=\"module not found error\" data-recalc-dims=\"1\" src=\"https://i2.wp.com/adam-gladstone.github.io/assets/images/Module-Not-Found-Error.png?w=578&amp;ssl=1\"/></noscript>.</p>\n<p>According to the documentation <strong>yfinance</strong> is not one of the open source libraries that the Excel Python secure distribution <a href=\"https://support.microsoft.com/en-us/office/open-source-libraries-and-python-in-excel-c817c897-41db-40a1-b9f3-d5ffe6d1bf3e\" rel=\"nofollow\" target=\"_blank\">supports</a>.</p>\n<p>So, in order to bridge the gap between Excel and Python I thought it might be a good idea to write a <a href=\"https://flask.palletsprojects.com/en/stable/\" rel=\"nofollow\" target=\"_blank\">Flask API</a>. This arrangement allows us access to Python’s ecosystem, and provides a (relatively) simple means by which we can consume the data in Excel using the Power Query Web Connector.</p>\n<p>This blog is divided into two parts. In <a href=\"https://adam-gladstone.github.io/python-projects/Building-a-Flask-service-to-get-yfinance-data-Part-I/\" rel=\"nofollow\" target=\"_blank\">Part I</a>, I describe the <a href=\"https://github.com/Adam-Gladstone/YFinanceService\" rel=\"nofollow\" target=\"_blank\"><strong>YFinanceService</strong></a>. This is a basic Flask service with APIs to perform the stock valuation calculation and more generally to obtain ticker data using <strong>yfinance</strong>.</p>\n<p>In <a href=\"https://adam-gladstone.github.io/python-projects/2025-03-19-Consuming-yfinance-data-in-Excel-Part-II/\" rel=\"nofollow\" target=\"_blank\">Part II</a>, I describe how to use the <strong>YFinanceService</strong> from Excel Power Query to automate the process of performing a stock valuation calculation and to obtain a simple table of ticker data.</p>\n<p>There are several alternative approaches. One could try a custom Python add-in for Excel. If you have non-financial data perhaps use Excel’s built-in Python support. The approach adopted here is a simple and quite generic way to have access to Python and its ecosystem. It allows you to obtain data and invoke / perform calculations.</p>\n<h3 id=\"calculate-the-intrinsic-value-of-a-stock-using-grahams-formula\">Calculate the intrinsic value of a stock using Graham’s formula</h3>\n<p>In general, calculating stock values is quite involved. There are a number of different methods each with their advantages and disadvantages. For example <a href=\"https://github.com/SimplyWallSt\" rel=\"nofollow\" target=\"_blank\">Simply Wall St.</a> describes a number of more complicated approaches. The approach adopted here is to use Graham’s formula to calculate the intrinsic value of a stock with a view to determining whether it is cheap or expensive compared to its current price. The Python code is as follows:</p>\n<pre>\"\"\"\nEstimates the intrinsic value of a stock\n\"\"\"\n\n\ndef stock_valuation_graham(eps: float, pe_base: float, g: float, avg_yield: float, cur_yield: float) -&gt; float:\n    \"\"\"\n    Calculate the intrinsic value of a stock using Graham's formula\n    Reference: https://stablebread.com/how-to-calculate-the-intrinsic-value-of-a-company-like-benjamin-graham/\n\n        V = (eps * (pe_base + 2g) * avg_yield) / cur_yield\n\n    where:\n    V = intrinsic value per share (over the next 7-10 years)\n        EPS = earnings per share (over the trailing twelve months (TTM))\n        8.5 = price-to-earnings (P/E) base for a no-growth company\n        g = reasonably expected annual growth rate (over the next 7-10 years)\n        avg_yield = average yield of AAA Corporate Bonds\n        cur_yield = current yield of AAA Corporate Bonds\n    \"\"\"\n\n    V = (eps * (pe_base + 1.1 * g) * avg_yield) / cur_yield\n\n    return V\n\n</pre>\n<p>The formula itself is self-explanatory. A more detailed explanation of the calculation is available <a href=\"https://stablebread.com/how-to-calculate-the-intrinsic-value-of-a-company-like-benjamin-graham/\" rel=\"nofollow\" target=\"_blank\">here</a>. The parameters are divided into those values that we obtain per ticker and some global values. Thus, the EPS and the expected annual growth rate are obtained from the ticker info using <strong>yfinance</strong>. On the other hand, the average yield of AAA Corporate Bonds, and the current yield of AAA Corporate Bonds are setup as input parameters.</p>\n<p>Finally, both the price-to-earnings (P/E) base for a no-growth company and the factor applied to the expected annual growth are hardcoded. \nThe price-to-earnings (P/E) base for a no-growth company is established at <em>8.5</em>. The factor applied to the expected annual growth – <em>2g</em> seemed somewhat aggressive so we lower our expectations to <em>1.1g</em>. Later, both these values may be set up as input parameters.</p>\n<h3 id=\"the-yfinanceservice\">The YFinanceService</h3>\n<p>The <strong>YFinanceService</strong> consists of four main APIs (endpoints):</p>\n<ul>\n<li>TickerInfo</li>\n<li>TickerData</li>\n<li>IntrinsicValue</li>\n<li>IntrinsicValues</li>\n</ul>\n<p>These are declared in <a href=\"https://adam-gladstone.github.io/assets/images/YFinanceService.py\" rel=\"nofollow\" target=\"_blank\">YFinanceService.py</a>.</p>\n<pre># Flask application\napp = Flask(__name__)\napi = Api(app)\n\n# Register Endpoints\napi.namespace('YFinanceService', description='YFinance Service API')\n\napi.add_resource(VersionInfo, '/YFinanceService/VersionInfo')\napi.add_resource(TickerInfo, '/YFinanceService/TickerInfo')\napi.add_resource(TickerData, '/YFinanceService/TickerData')\napi.add_resource(IntrinsicValue, '/YFinanceService/IntrinsicValue')\napi.add_resource(IntrinsicValues, '/YFinanceService/IntrinsicValues')\n\n\nif __name__ == '__main__':\n    DEBUG = False\n    HOST = environ.get('SERVER_HOST', 'localhost')\n    try:\n        PORT = int(environ.get('SERVER_PORT', '5000'))\n    except ValueError:\n        PORT = 5000\n    # run our Flask app\n    app.run(HOST, PORT, DEBUG)\n\n</pre>\n<h4 id=\"running-the-yfinanceservice\">Running the YFinanceService</h4>\n<p>The <strong>YFinanceService</strong> can be run from the command line. cd to the <code>\\YFinanceService</code> subdirectory. At the command prompt, type <code>python YFinanceService.py</code>. Alternatively, it can be run directly with the debugger from within VSCode.</p>\n<p>You should see a message similar to the following:</p>\n<p><img alt=\"Starting the YFinanceService\" data-lazy-src=\"https://i1.wp.com/adam-gladstone.github.io/assets/images/Running-Flask-app.png?w=578&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img alt=\"Starting the YFinanceService\" data-recalc-dims=\"1\" src=\"https://i1.wp.com/adam-gladstone.github.io/assets/images/Running-Flask-app.png?w=578&amp;ssl=1\"/></noscript></p>\n<p>To test the service from a browser, type in the address bar: http://localhost:5000/YFinanceService/VersionInfo, and you should see the json response packet: <code>{\"VersionInfo\": {\"flask\": \"3.1.0\", \"yfinance\": \"0.2.54\", \"pandas\": \"2.2.3\"}}</code></p>\n<h3 id=\"yfinanceservice-endpoints\">YFinanceService Endpoints</h3>\n<p>With the service running, the API endpoints can be exercised via a browser using the examples below (assuming the service is running on port 5000).</p>\n<h4 id=\"intrinsicvalue-api\">IntrinsicValue API</h4>\n<p>The Flask API <code>IntrinsicValue</code> only supports the GET method. The other REST methods (PUT, POST, etc.) are not defined. The GET API takes three parameters:</p>\n<ul>\n<li>ticker – The ticker symbol</li>\n<li>avg_yield – The average yield of AAA Corporate Bonds</li>\n<li>cur_yield – The current yield of AAA Corporate Bonds</li>\n</ul>\n<p>The GET function is divided into two parts. The first part obtains the (required) parameters. The second part calls a wrapper function <code>stock_valuation</code>.</p>\n<pre>class IntrinsicValue(Resource):\n    \"\"\" Calculate the intrinsic value of a single stock using Graham's formula. \"\"\"\n    def get(self):\n\n        parser = reqparse.RequestParser()\n\n        parser.add_argument(\"ticker\", type=str, required=True, help=\"The ticker symbol of the stock\")\n        parser.add_argument(\"avg_yield\", type=float, required=True, help=\"Average yield of AAA Corporate Bonds\")\n        parser.add_argument(\"cur_yield\", type=float, required=True, help=\"Current yield of AAA Corporate Bonds\")\n\n        args = parser.parse_args()\n\n        symbol: str = args.get(\"ticker\")\n        avg_yield: float = args.get(\"avg_yield\")\n        cur_yield: float = args.get(\"cur_yield\")\n\n        v: float = stock_valuation(symbol, avg_yield, cur_yield)\n\n        return {\"value\": v}, 200  # return info and 200 OK code\n\n</pre>\n<p>The <code>stock_valuation</code> function obtains the <code>ticker.info</code> dictionary from <strong>yfinance</strong>, and uses this to get the trailing EPS. The price-to-earnings (P/E) base for a no-growth company is hardcoded at <code>8.5</code>. The expected growth rate <code>g</code> is obtained from the Yahoo finance stock info library. Finally, the <code>stock_valuation_graham</code> function is called with all the required parameters and the intrinsic value is returned.</p>\n<p>For example, to determine the instrinsic value of GM we can use the following query: http://localhost:5000/YFinanceService/IntrinsicValue?ticker=GM&amp;avg_yield=4.25&amp;cur_yield=3.25.</p>\n<p>This returns a dictionary with a single value: {“value”: 82.07549}. Comparing this to the current price of GM (46.72), we might conclude that the stock is undervalued.</p>\n<p>The <code>stock_valuation</code> function is also used by the <code>IntrinsicValues</code> API. This does the same as the <code>IntrinsicValue</code> API but for a list of tickers. For this reason, the <code>stock_valuation</code> function handles any errors and exceptions and returns <code>0.0</code> for example if a ticker is not found or the data item is not available. If this had been part of a web application, we might have returned an error code and some exception message via the API into an HTML page. However, in this arrangement, the client is Excel, and specifically the Power Query Web Connector. So to simplify the client (Excel) processing we have tried to make the API calls as resilient as possible.</p>\n<p>For example, the following: http://localhost:5000/YFinanceService/IntrinsicValues?tickers=SAN.MC,BBVA.MC,IBE.MC,AENA.MC&amp;avg_yield=3.25&amp;cur_yield=1.25 queries for the intrinsic values of four Spanish stocks. The results are returned as a comma-separated table with two columns: the ticker and the intrinsic value.</p>\n<h4 id=\"tickerdata-api\">TickerData API</h4>\n<p>The Flask API <code>TickerData</code> also only supports the GET method. The purpose of the API is to retrieve one or more fields from the <strong>yfinance</strong> ticker info for a given list of ticker symbols. The output is a <em>csv</em> string that can be parsed into a table with the column headers being the field names and the rows being the data corresponding to each ticker.</p>\n<pre>class TickerData(Resource):\n    \"\"\" Retrieve the specified fields from the input tickers \"\"\"\n    def get(self):\n\n        parser = reqparse.RequestParser()\n\n        parser.add_argument(\"tickers\", type=str, action='split', required=True, help=\"One or more ticker symbols\")\n        parser.add_argument(\"fields\", type=str, action='split', required=True, help=\"One or more fields\")\n\n        args = parser.parse_args()\n\n        symbols: list = args.get(\"tickers\")\n        fields: list = args.get(\"fields\")\n\n        headers: list = ['Ticker']\n        for field in fields:\n            headers.append(field)\n\n        rows: list = []\n\n        try:\n\n            for symbol in symbols:\n                rows.append(get_items(symbol, fields))\n\n        except Exception:\n            print(\"An error occured\")\n\n        df = pd.DataFrame(rows, columns=headers)\n\n        return df.to_csv(index=False, header=True), 200  # return info and 200 OK code\n\n</pre>\n<p>As previously the API is divided into two parts. The first part obtains the parameters, checks that the required parameters are present and sets up the table headers. The second part iterates over the input list of ticker symbols and for each symbol requests the data items from the <code>ticker.info</code> structure. Each row is appended to a list of rows. Finally, the <em>csv</em> table is returned using the <code>DataFrame.to_csv</code> method.</p>\n<p>The parameters are a comma-separated list of ticker symbols and a comma-separated list of fields (key names in the <code>ticker.info</code> dictionary). This provides a relatively flexible way to obtain stock financial data.</p>\n<p>For example to obtain the following indicators:</p>\n<ul>\n<li>trailingPegRatio</li>\n<li>trailingPE</li>\n<li>forwardPE</li>\n</ul>\n<p>for the symbols: MSFT, AMZN, WAL and TSLA we can create the following query:\nhttp://localhost:5000/YFinanceService/TickerData?tickers=MSFT,AMZN,WAL,TSLA&amp;fields=trailingPegRatio,trailingPE,forwardPE</p>\n<p>As before, the error handling is resilient rather than informative. The table will be built with empty values if there is a problem obtaining the data, if the key doesn’t exist, or if the ticker symbol is unavailable and so on. This is not necessarily ideal but it simplifies the client processing.</p>\n<h3 id=\"wrap-up\">Wrap Up</h3>\n<p>This blog has introduced the <strong>YFinanceService</strong>, a simple Flask service that defines some endpoints to allow us to perform a stock valuation calculation and more generally to obtain ticker data using the Python <strong>yfinance</strong> library. In <a href=\"https://adam-gladstone.github.io/python-projects/2025-03-19-Consuming-yfinance-data-in-Excel-Part-II/\" rel=\"nofollow\" target=\"_blank\">Part II</a> of the blog, I describe how to use the <em>raw</em> APIs in Excel via the Power Query Web Connector.</p>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://adam-gladstone.github.io/python-project/Building-a-Flask-service-to-get-yfinance-data-Part-I/\"> Adam’s Software Lab</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
    "main_text": "Building a Flask service to get yfinance data – Part I\nPosted on\nMarch 18, 2025\nby\nAdam Gladstone\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nAdam’s Software Lab\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nIntroduction\nRecently, I’ve been doing some portfolio analysis and I came across an interesting video:\nHow to Calculate the Intrinsic Value of a Stock like Benjamin Graham\n. Since not all the data is available in Excel, I thought it might be useful to automate the calculation using data from the (excellent)\nyfinance\nPython library. The formula itself, written in Python, is quite simple. The challenge was to obtain the individual parameters and inputs and be able to call the Python function from an Excel worksheet.\nIt would have been nice to be able to use Excel’s Python support\nPY=\n. But it turns out that importing\nyfinance\nproduces a\n.\nAccording to the documentation\nyfinance\nis not one of the open source libraries that the Excel Python secure distribution\nsupports\n.\nSo, in order to bridge the gap between Excel and Python I thought it might be a good idea to write a\nFlask API\n. This arrangement allows us access to Python’s ecosystem, and provides a (relatively) simple means by which we can consume the data in Excel using the Power Query Web Connector.\nThis blog is divided into two parts. In\nPart I\n, I describe the\nYFinanceService\n. This is a basic Flask service with APIs to perform the stock valuation calculation and more generally to obtain ticker data using\nyfinance\n.\nIn\nPart II\n, I describe how to use the\nYFinanceService\nfrom Excel Power Query to automate the process of performing a stock valuation calculation and to obtain a simple table of ticker data.\nThere are several alternative approaches. One could try a custom Python add-in for Excel. If you have non-financial data perhaps use Excel’s built-in Python support. The approach adopted here is a simple and quite generic way to have access to Python and its ecosystem. It allows you to obtain data and invoke / perform calculations.\nCalculate the intrinsic value of a stock using Graham’s formula\nIn general, calculating stock values is quite involved. There are a number of different methods each with their advantages and disadvantages. For example\nSimply Wall St.\ndescribes a number of more complicated approaches. The approach adopted here is to use Graham’s formula to calculate the intrinsic value of a stock with a view to determining whether it is cheap or expensive compared to its current price. The Python code is as follows:\n\"\"\"\nEstimates the intrinsic value of a stock\n\"\"\"\n\ndef stock_valuation_graham(eps: float, pe_base: float, g: float, avg_yield: float, cur_yield: float) -> float:\n    \"\"\"\n    Calculate the intrinsic value of a stock using Graham's formula\n    Reference: https://stablebread.com/how-to-calculate-the-intrinsic-value-of-a-company-like-benjamin-graham/\n\n        V = (eps * (pe_base + 2g) * avg_yield) / cur_yield\n\n    where:\n    V = intrinsic value per share (over the next 7-10 years)\n        EPS = earnings per share (over the trailing twelve months (TTM))\n        8.5 = price-to-earnings (P/E) base for a no-growth company\n        g = reasonably expected annual growth rate (over the next 7-10 years)\n        avg_yield = average yield of AAA Corporate Bonds\n        cur_yield = current yield of AAA Corporate Bonds\n    \"\"\"\n\n    V = (eps * (pe_base + 1.1 * g) * avg_yield) / cur_yield\n\n    return V\nThe formula itself is self-explanatory. A more detailed explanation of the calculation is available\nhere\n. The parameters are divided into those values that we obtain per ticker and some global values. Thus, the EPS and the expected annual growth rate are obtained from the ticker info using\nyfinance\n. On the other hand, the average yield of AAA Corporate Bonds, and the current yield of AAA Corporate Bonds are setup as input parameters.\nFinally, both the price-to-earnings (P/E) base for a no-growth company and the factor applied to the expected annual growth are hardcoded. \nThe price-to-earnings (P/E) base for a no-growth company is established at\n8.5\n. The factor applied to the expected annual growth –\n2g\nseemed somewhat aggressive so we lower our expectations to\n1.1g\n. Later, both these values may be set up as input parameters.\nThe YFinanceService\nThe\nYFinanceService\nconsists of four main APIs (endpoints):\nTickerInfo\nTickerData\nIntrinsicValue\nIntrinsicValues\nThese are declared in\nYFinanceService.py\n.\n# Flask application\napp = Flask(__name__)\napi = Api(app)\n\n# Register Endpoints\napi.namespace('YFinanceService', description='YFinance Service API')\n\napi.add_resource(VersionInfo, '/YFinanceService/VersionInfo')\napi.add_resource(TickerInfo, '/YFinanceService/TickerInfo')\napi.add_resource(TickerData, '/YFinanceService/TickerData')\napi.add_resource(IntrinsicValue, '/YFinanceService/IntrinsicValue')\napi.add_resource(IntrinsicValues, '/YFinanceService/IntrinsicValues')\n\nif __name__ == '__main__':\n    DEBUG = False\n    HOST = environ.get('SERVER_HOST', 'localhost')\n    try:\n        PORT = int(environ.get('SERVER_PORT', '5000'))\n    except ValueError:\n        PORT = 5000\n    # run our Flask app\n    app.run(HOST, PORT, DEBUG)\nRunning the YFinanceService\nThe\nYFinanceService\ncan be run from the command line. cd to the\n\\YFinanceService\nsubdirectory. At the command prompt, type\npython YFinanceService.py\n. Alternatively, it can be run directly with the debugger from within VSCode.\nYou should see a message similar to the following:\nTo test the service from a browser, type in the address bar: http://localhost:5000/YFinanceService/VersionInfo, and you should see the json response packet:\n{\"VersionInfo\": {\"flask\": \"3.1.0\", \"yfinance\": \"0.2.54\", \"pandas\": \"2.2.3\"}}\nYFinanceService Endpoints\nWith the service running, the API endpoints can be exercised via a browser using the examples below (assuming the service is running on port 5000).\nIntrinsicValue API\nThe Flask API\nIntrinsicValue\nonly supports the GET method. The other REST methods (PUT, POST, etc.) are not defined. The GET API takes three parameters:\nticker – The ticker symbol\navg_yield – The average yield of AAA Corporate Bonds\ncur_yield – The current yield of AAA Corporate Bonds\nThe GET function is divided into two parts. The first part obtains the (required) parameters. The second part calls a wrapper function\nstock_valuation\n.\nclass IntrinsicValue(Resource):\n    \"\"\" Calculate the intrinsic value of a single stock using Graham's formula. \"\"\"\n    def get(self):\n\n        parser = reqparse.RequestParser()\n\n        parser.add_argument(\"ticker\", type=str, required=True, help=\"The ticker symbol of the stock\")\n        parser.add_argument(\"avg_yield\", type=float, required=True, help=\"Average yield of AAA Corporate Bonds\")\n        parser.add_argument(\"cur_yield\", type=float, required=True, help=\"Current yield of AAA Corporate Bonds\")\n\n        args = parser.parse_args()\n\n        symbol: str = args.get(\"ticker\")\n        avg_yield: float = args.get(\"avg_yield\")\n        cur_yield: float = args.get(\"cur_yield\")\n\n        v: float = stock_valuation(symbol, avg_yield, cur_yield)\n\n        return {\"value\": v}, 200  # return info and 200 OK code\nThe\nstock_valuation\nfunction obtains the\nticker.info\ndictionary from\nyfinance\n, and uses this to get the trailing EPS. The price-to-earnings (P/E) base for a no-growth company is hardcoded at\n8.5\n. The expected growth rate\ng\nis obtained from the Yahoo finance stock info library. Finally, the\nstock_valuation_graham\nfunction is called with all the required parameters and the intrinsic value is returned.\nFor example, to determine the instrinsic value of GM we can use the following query: http://localhost:5000/YFinanceService/IntrinsicValue?ticker=GM&avg_yield=4.25&cur_yield=3.25.\nThis returns a dictionary with a single value: {“value”: 82.07549}. Comparing this to the current price of GM (46.72), we might conclude that the stock is undervalued.\nThe\nstock_valuation\nfunction is also used by the\nIntrinsicValues\nAPI. This does the same as the\nIntrinsicValue\nAPI but for a list of tickers. For this reason, the\nstock_valuation\nfunction handles any errors and exceptions and returns\n0.0\nfor example if a ticker is not found or the data item is not available. If this had been part of a web application, we might have returned an error code and some exception message via the API into an HTML page. However, in this arrangement, the client is Excel, and specifically the Power Query Web Connector. So to simplify the client (Excel) processing we have tried to make the API calls as resilient as possible.\nFor example, the following: http://localhost:5000/YFinanceService/IntrinsicValues?tickers=SAN.MC,BBVA.MC,IBE.MC,AENA.MC&avg_yield=3.25&cur_yield=1.25 queries for the intrinsic values of four Spanish stocks. The results are returned as a comma-separated table with two columns: the ticker and the intrinsic value.\nTickerData API\nThe Flask API\nTickerData\nalso only supports the GET method. The purpose of the API is to retrieve one or more fields from the\nyfinance\nticker info for a given list of ticker symbols. The output is a\ncsv\nstring that can be parsed into a table with the column headers being the field names and the rows being the data corresponding to each ticker.\nclass TickerData(Resource):\n    \"\"\" Retrieve the specified fields from the input tickers \"\"\"\n    def get(self):\n\n        parser = reqparse.RequestParser()\n\n        parser.add_argument(\"tickers\", type=str, action='split', required=True, help=\"One or more ticker symbols\")\n        parser.add_argument(\"fields\", type=str, action='split', required=True, help=\"One or more fields\")\n\n        args = parser.parse_args()\n\n        symbols: list = args.get(\"tickers\")\n        fields: list = args.get(\"fields\")\n\n        headers: list = ['Ticker']\n        for field in fields:\n            headers.append(field)\n\n        rows: list = []\n\n        try:\n\n            for symbol in symbols:\n                rows.append(get_items(symbol, fields))\n\n        except Exception:\n            print(\"An error occured\")\n\n        df = pd.DataFrame(rows, columns=headers)\n\n        return df.to_csv(index=False, header=True), 200  # return info and 200 OK code\nAs previously the API is divided into two parts. The first part obtains the parameters, checks that the required parameters are present and sets up the table headers. The second part iterates over the input list of ticker symbols and for each symbol requests the data items from the\nticker.info\nstructure. Each row is appended to a list of rows. Finally, the\ncsv\ntable is returned using the\nDataFrame.to_csv\nmethod.\nThe parameters are a comma-separated list of ticker symbols and a comma-separated list of fields (key names in the\nticker.info\ndictionary). This provides a relatively flexible way to obtain stock financial data.\nFor example to obtain the following indicators:\ntrailingPegRatio\ntrailingPE\nforwardPE\nfor the symbols: MSFT, AMZN, WAL and TSLA we can create the following query:\nhttp://localhost:5000/YFinanceService/TickerData?tickers=MSFT,AMZN,WAL,TSLA&fields=trailingPegRatio,trailingPE,forwardPE\nAs before, the error handling is resilient rather than informative. The table will be built with empty values if there is a problem obtaining the data, if the key doesn’t exist, or if the ticker symbol is unavailable and so on. This is not necessarily ideal but it simplifies the client processing.\nWrap Up\nThis blog has introduced the\nYFinanceService\n, a simple Flask service that defines some endpoints to allow us to perform a stock valuation calculation and more generally to obtain ticker data using the Python\nyfinance\nlibrary. In\nPart II\nof the blog, I describe how to use the\nraw\nAPIs in Excel via the Power Query Web Connector.\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nAdam’s Software Lab\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
    "meta_description": "Have you ever wanted access to __yfinance__ data in an Excel spreadsheet? If so, this two-part blog may be of interest. It describes an approach using a Flask API to access __yfinance__ data and the Power Query queries required to consume the data in Excel.",
    "meta_keywords": null,
    "og_description": "Have you ever wanted access to __yfinance__ data in an Excel spreadsheet? If so, this two-part blog may be of interest. It describes an approach using a Flask API to access __yfinance__ data and the Power Query queries required to consume the data in Excel.",
    "og_image": "https://adam-gladstone.github.io/assets/images/Module-Not-Found-Error.png",
    "og_title": "Building a Flask service to get yfinance data – Part I | R-bloggers",
    "raw_jsonld_article": null,
    "reading_time_min": 9.5,
    "sitemap_lastmod": null,
    "twitter_description": "Have you ever wanted access to __yfinance__ data in an Excel spreadsheet? If so, this two-part blog may be of interest. It describes an approach using a Flask API to access __yfinance__ data and the Power Query queries required to consume the data in Excel.",
    "twitter_title": "Building a Flask service to get yfinance data – Part I | R-bloggers",
    "url": "https://www.r-bloggers.com/2025/03/building-a-flask-service-to-get-yfinance-data-part-i/",
    "word_count": 1904
  }
}