{
  "id": "2175bd59d6de0ffe831ac1e7817290bb7f94e7ff",
  "url": "https://www.r-bloggers.com/2023/10/using-my-own-r-functions-in-webr-in-an-express-js-api-and-thoughts-on-building-web-apps-with-node-webr/",
  "created_at_utc": "2025-11-17T20:39:36Z",
  "data": null,
  "raw_original": {
    "uuid": "3cd42093-04ba-455f-b360-eaf80a3b62bd",
    "created_at": "2025-11-17 20:39:36",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2023/10/using-my-own-r-functions-in-webr-in-an-express-js-api-and-thoughts-on-building-web-apps-with-node-webr/",
      "crawled_at": "2025-11-17T10:08:02.280139",
      "external_links": [
        {
          "href": "https://colinfay.me/using-own-functions-in-webr-node-js/",
          "text": "Colin Fay"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://colinfay.me/calling-webr-from-expressjs/",
          "text": "Using webR in an Express JS REST API"
        },
        {
          "href": "https://colinfay.me/old-faithful-express-bootstrap-webr/",
          "text": "The Old Faithful Geyser Data shiny app with webR, Bootstrap & ExpressJS"
        },
        {
          "href": "https://colinfay.me/preloading-your-r-packages-in-webr-in-an-express-js-api/",
          "text": "Preloading your R packages in webR in an Express JS API"
        },
        {
          "href": "https://github.com/r-universe-org/build-wasm",
          "text": "Docker image"
        },
        {
          "href": "https://colinfay.me/preloading-your-r-packages-in-webr-in-an-express-js-api/",
          "text": "Preloading your R packages in webR in an Express JS API"
        },
        {
          "href": "https://colinfay.me/preloading-your-r-packages-in-webr-in-an-express-js-api/",
          "text": "Preloading your R packages in webR in an Express JS API"
        },
        {
          "href": "https://github.com/ColinFay/webr-examples/tree/main/webr-preload-funs",
          "text": "here"
        },
        {
          "href": "https://srv.colinfay.me/webr-preload-funs/Rodian",
          "text": "srv.colinfay.me/webr-preload-funs/"
        },
        {
          "href": "https://colinfay.me/using-own-functions-in-webr-node-js/",
          "text": "Colin Fay"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "Using my own R functions in webR in an Express JS API, and thoughts on building web apps with Node & webR | R-bloggers",
      "images": [],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/colin-fay/",
          "text": "Colin Fay"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/cdn-cgi/l/email-protection",
          "text": "[email¬†protected]"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-379239 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Using my own R functions in webR in an Express JS API, and thoughts on building web apps with Node &amp; webR</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">October 16, 2023</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/colin-fay/\">Colin Fay</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \r\n<div style=\"min-height: 30px;\">\r\n[social4i size=\"small\" align=\"align-left\"]\r\n</div>\r\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\r\n[This article was first published on  <strong><a href=\"https://colinfay.me/using-own-functions-in-webr-node-js/\"> Colin Fay</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 3.8.9--><p>This post is the fourth one of a series of post about webR:</p>\n<ul>\n<li><a href=\"https://colinfay.me/calling-webr-from-expressjs/\" rel=\"nofollow\" target=\"_blank\">Using webR in an Express JS REST API</a></li>\n<li><a href=\"https://colinfay.me/old-faithful-express-bootstrap-webr/\" rel=\"nofollow\" target=\"_blank\">The Old Faithful Geyser Data shiny app with webR, Bootstrap &amp; ExpressJS</a></li>\n<li><a href=\"https://colinfay.me/preloading-your-r-packages-in-webr-in-an-express-js-api/\" rel=\"nofollow\" target=\"_blank\">Preloading your R packages in webR in an Express JS API</a></li>\n<li>Using my own R functions in webR in an Express JS API, and thoughts on building web apps with Node &amp; webR</li>\n</ul>\n<blockquote>\n<p>Note: the first post of this series explaining roughly what webR is, I won‚Äôt introduce it again here.</p>\n</blockquote>\n<h2 id=\"the-problem\">The problem</h2>\n<p>Ok, so now that we have our webR / NodeJS machinery up and running, let‚Äôs try something more interesting: use our own R functions inside <code>webR</code>.</p>\n<p>How can I do that?</p>\n<p>There are at least three ways I could think of:</p>\n<p>1Ô∏è‚É£ Writing a function inside the JS code to define a function, something like :</p>\n<pre>await globalThis.webR.evalR(\"my_fun &lt;- function(x){...}\");\n</pre>\n<p>But that doesn‚Äôt check what I would expect from something I‚Äôll use in prod and I‚Äôm pretty sure you don‚Äôt need me to detail why üòÖ</p>\n<ul>\n<li>‚ùå Well organized</li>\n<li>‚ùå Documented</li>\n<li>‚ùå Tested</li>\n<li>‚ùå Safely installable</li>\n</ul>\n<p>2Ô∏è‚É£ Simply create an R script and source it. Something like:</p>\n<pre>const fs = require('fs');\nconst path = require('path');\nconst script = path.join(__dirname, 'script.R')\nconst data = fs.readFileSync(script);\nawait globalThis.webR.FS.writeFile(\n  \"/home/web_user/script.R\",\n  data\n);\nawait globalThis.webR.evalR(\"source('/home/web_user/script.R')\");\n</pre>\n<p>That‚Äôs a bit better, we can at least organize our code in a script and it will be:</p>\n<ul>\n<li>‚úÖ Well organized (more or less)</li>\n<li>‚úÖ Documented (more or less)</li>\n<li>‚ùå Tested</li>\n<li>‚ùå Safely installable</li>\n</ul>\n<p>3Ô∏è‚É£ I bet you saw me coming, the best way let‚Äôs put stuff into an R package, so that we can check all the boxes.</p>\n<ul>\n<li>‚úÖ Well organized</li>\n<li>‚úÖ Documented</li>\n<li>‚úÖ Tested</li>\n<li>‚úÖ Safely installable</li>\n</ul>\n<p>Jeroen has written a <a href=\"https://github.com/r-universe-org/build-wasm\" rel=\"nofollow\" target=\"_blank\">Docker image</a> to compile an R package to WASM, but I was looking for something that wouldn‚Äôt involve compiling via a docker container every time I make a change on my R package (even if that does sound appealing, I‚Äôm pretty sure this wouldn‚Äôt make for a seamless workflow).</p>\n<p>So here is what I‚Äôm thinking should be a well structured NodeJS / WebR app:</p>\n<ul>\n<li>Putting all the web stuff inside the NodeJS app, because, well, NodeJS is really good at doing that.</li>\n<li>Putting all the ‚Äúbusiness logic‚Äù, data-crunching, modeling stuff (and everything R is really good at) into an R package.</li>\n<li>load webR, write my R package to the webR file system, and <code>pkgload::load_all()</code> it into webR.</li>\n</ul>\n<p>That way, I can enjoy the best of both worlds:</p>\n<ul>\n<li>NodeJS is really good at doing web related things, and there are plenty of ways to test and deploy the code.</li>\n<li>And same goes for the R package: if you‚Äôre reading my blog I‚Äôm pretty sure I don‚Äôt need to convince you of why packages are the perfect tool for sharing production code.</li>\n</ul>\n<h2 id=\"the-how\">The how</h2>\n<p>Let‚Äôs start by creating our project:</p>\n<pre>mkdir webr-preload-funs\ncd webr-preload-funs\nnpm init -y\ntouch index.js\nnpm install express webr\nR -e \"usethis::create_package('rfuns', rstudio = FALSE)\"\n</pre>\n<p>Let‚Äôs now create a simple function :</p>\n<pre>&gt; usethis::use_r(\"sw\")\n\r\n#' @title Star Wars by Species\n#' @description Return a tibble of Star Wars characters by species\n#' @import dplyr\n#' @export\n#' @param species character\n#' @return tibble\n#' @examples\n#' star_wars_by_species(\"Human\")\n#' star_wars_by_species(\"Droid\")\n#' star_wars_by_species(\"Wookiee\")\n#' star_wars_by_species(\"Rodian\")\nstar_wars_by_species &lt;- function(species){\n  dplyr::starwars |&gt;\n    filter(species == )\n}\n</pre>\n<p>We can now add <code>{dplyr}</code> and <code>{pkgload}</code> to our <code>DESCRIPTION</code> (we‚Äôll need <code>{pkgload}</code> to <code>load_all()</code> the package).</p>\n<pre>usethis::use_package(\"dplyr\")\nusethis::use_package(\"pkgload\")\ndevtools::document()\n</pre>\n<p>Now that we have a package skeleton, we‚Äôll have to upload it to webR.</p>\n<p>As described in the previous post, I‚Äôve started a <code>webrtools</code> NodeJS module, which will contains function to play with webR.\nBefore this post, it had one function, <code>loadPackages</code>, that was used to build a webR dependency library (see <a href=\"https://colinfay.me/preloading-your-r-packages-in-webr-in-an-express-js-api/\" rel=\"nofollow\" target=\"_blank\">Preloading your R packages in webR in an Express JS API</a> for more info).</p>\n<p>We‚Äôll need to add two features :</p>\n<ul>\n<li>Install deps from DESCRIPTION (not just a package name), so a wrapper around the <code>Rscript ./node_modules/webrtools/r/install.R dplyr</code> from before</li>\n<li>Copy the package folder in NodeJS, so a more generic version of <code>loadPackages</code>, that can load any folder to the webR filesystem.</li>\n</ul>\n<p>First, in R, we‚Äôll need to read the <code>DESCRIPTION</code> and build the lib:</p>\n<pre>download_packs_and_deps_from_desc &lt;- function (\n  description,\n  path_to_installation = \"./webr_packages\"\n)\n{\n    if (!file.exists(description)) {\n        stop(\"DESCRIPTION file not found\")\n    }\n    deps &lt;- desc::desc_get_deps(description)\n    for (pak in deps$package) {\n        webrtools::download_packs_and_deps(pak, path_to_installation = path_to_installation)\n    }\n}\n</pre>\n<blockquote>\n<p>Note: the code of <code>webrtools::download_packs_and_deps()</code> is a wrapper around the R code described in <a href=\"https://colinfay.me/preloading-your-r-packages-in-webr-in-an-express-js-api/\" rel=\"nofollow\" target=\"_blank\">Preloading your R packages in webR in an Express JS API</a></p>\n</blockquote>\n<p>And in Node, we‚Äôll rework our <code>loadPackages</code> and split it into two functions ‚Äî one to load into any folder, and one to load into the package library:</p>\n<pre>async function loadFolder(webR, dirPath, outputdir = \"/usr/lib/R/library\") {\n  const files = getDirectoryTree(\n    dirPath\n  )\n  for await (const file of files) {\n    if (file.type === 'directory') {\n      await globalThis.webR.FS.mkdir(\n        `${outputdir}/${file.path}`,\n      );\n    } else {\n      const data = fs.readFileSync(`${dirPath}/${file.path}`);\n      await globalThis.webR.FS.writeFile(\n        `${outputdir}/${file.path}`,\n        data\n      );\n    }\n  }\n}\n\nasync function loadPackages(webR, dirPath) {\n  await loadFolder(webR, dirPath, outputdir = \"/usr/lib/R/library\");\n}\n</pre>\n<h2 id=\"the-end-app\">The end app</h2>\n<p>We now have everything we need!</p>\n<pre>npm i <a class=\"__cf_email__\" data-cfemail=\"a8dfcdcadadcc7c7c4dbe8988698869a\" href=\"/cdn-cgi/l/email-protection\">[email¬†protected]</a>\nRscript ./node_modules/webrtools/r/install_from_desc.R $(pwd)/rfuns/DESCRIPTION\n</pre>\n<p>And now, to our index.js</p>\n<pre>const app = require('express')()\nconst path = require('path');\nconst { loadPackages, loadFolder } = require('webrtools');\nconst { WebR } = require('webr');\n\n(async () =&gt; {\n  globalThis.webR = new WebR();\n  await globalThis.webR.init();\n\n  console.log(\"üöÄ webR is ready üöÄ\");\n\n  await loadPackages(\n    globalThis.webR,\n    path.join(__dirname, 'webr_packages')\n  )\n\n  await loadFolder(\n    globalThis.webR,\n    path.join(__dirname, 'rfuns'),\n    \"/home/web_user\"\n  )\n\n  console.log(\"üì¶ Packages written to webR üì¶\");\n\n  // see https://github.com/r-wasm/webr/issues/292\n  await globalThis.webR.evalR(\"options(expressions=1000)\")\n  await globalThis.webR.evalR(\"pkgload::load_all('/home/web_user')\");\n\n  app.listen(3000, '0.0.0.0', () =&gt; {\n    console.log('http://localhost:3000')\n  })\n\n})();\n\napp.get('/', async (req, res) =&gt; {\n  let result = await globalThis.webR.evalR(\n    'unique(dplyr::starwars$species)'\n  );\n  let js_res = await result.toJs()\n  res.send(js_res.values)\n})\n\n\napp.get('/:n', async (req, res) =&gt; {\n  let result = await globalThis.webR.evalR(\n    'star_wars_by_species(n)',\n    { env: { n: req.params.n } }\n    );\n  try {\n    const result_js = await result.toJs();\n    res.send(result_js)\n  } finally {\n    webR.destroy(result);\n  }\n});\n</pre>\n<p>Let‚Äôs now try from another terminal:</p>\n<pre>curl http://localhost:3000\n\r\n[\"Human\",\"Droid\",\"Wookiee\",\"Rodian\",\"Hutt\",\"Yoda's species\",\"Trandoshan\",\"Mon Calamari\",\"Ewok\",\"Sullustan\",\"Neimodian\",\"Gungan\",null,\"Toydarian\",\"Dug\",\"Zabrak\",\"Twi'lek\",\"Vulptereen\",\"Xexto\",\"Toong\",\"Cerean\",\"Nautolan\",\"Tholothian\",\"Iktotchi\",\"Quermian\",\"Kel Dor\",\"Chagrian\",\"Geonosian\",\"Mirialan\",\"Clawdite\",\"Besalisk\",\"Kaminoan\",\"Aleena\",\"Skakoan\",\"Muun\",\"Togruta\",\"Kaleesh\",\"Pau'an\"]\n\r\ncurl http://localhost:3000/Rodian\n\r\n{\"type\":\"list\",\"names\":[\"name\",\"height\",\"mass\",\"hair_color\",\"skin_color\",\"eye_color\",\"birth_year\",\"sex\",\"gender\",\"homeworld\",\"species\",\"films\",\"vehicles\",\"starships\"],\"values\":[{\"type\":\"character\",\"names\":null,\"values\":[\"Greedo\"]},{\"type\":\"integer\",\"names\":null,\"values\":[173]},{\"type\":\"double\",\"names\":null,\"values\":[74]},{\"type\":\"character\",\"names\":null,\"values\":[null]},{\"type\":\"character\",\"names\":null,\"values\":[\"green\"]},{\"type\":\"character\",\"names\":null,\"values\":[\"black\"]},{\"type\":\"double\",\"names\":null,\"values\":[44]},{\"type\":\"character\",\"names\":null,\"values\":[\"male\"]},{\"type\":\"character\",\"names\":null,\"values\":[\"masculine\"]},{\"type\":\"character\",\"names\":null,\"values\":[\"Rodia\"]},{\"type\":\"character\",\"names\":null,\"values\":[\"Rodian\"]},{\"type\":\"list\",\"names\":null,\"values\":[{\"type\":\"character\",\"names\":null,\"values\":[\"A New Hope\"]}]},{\"type\":\"list\",\"names\":null,\"values\":[{\"type\":\"character\",\"names\":null,\"values\":[]}]},{\"type\":\"list\",\"names\":null,\"values\":[{\"type\":\"character\",\"names\":null,\"values\":[]}]}]}\n</pre>\n<p>Yeay üéâ .</p>\n<p>You can find the code <a href=\"https://github.com/ColinFay/webr-examples/tree/main/webr-preload-funs\" rel=\"nofollow\" target=\"_blank\">here</a>, and see it live at <a href=\"https://srv.colinfay.me/webr-preload-funs/Rodian\" rel=\"nofollow\" target=\"_blank\">srv.colinfay.me/webr-preload-funs/</a>.</p>\n<p>You can also try it with</p>\n<pre>docker run -it -p 3000:3000 colinfay/webr-preload-funs\n</pre>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 3.8.9-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://colinfay.me/using-own-functions-in-webr-node-js/\"> Colin Fay</a></strong>.</div>\n<hr>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\r\n\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</hr></div> </div>\n</article>",
      "main_text": "Using my own R functions in webR in an Express JS API, and thoughts on building web apps with Node & webR\nPosted on\nOctober 16, 2023\nby\nColin Fay\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nColin Fay\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nThis post is the fourth one of a series of post about webR:\nUsing webR in an Express JS REST API\nThe Old Faithful Geyser Data shiny app with webR, Bootstrap & ExpressJS\nPreloading your R packages in webR in an Express JS API\nUsing my own R functions in webR in an Express JS API, and thoughts on building web apps with Node & webR\nNote: the first post of this series explaining roughly what webR is, I won‚Äôt introduce it again here.\nThe problem\nOk, so now that we have our webR / NodeJS machinery up and running, let‚Äôs try something more interesting: use our own R functions inside\nwebR\n.\nHow can I do that?\nThere are at least three ways I could think of:\n1Ô∏è‚É£ Writing a function inside the JS code to define a function, something like :\nawait globalThis.webR.evalR(\"my_fun <- function(x){...}\");\nBut that doesn‚Äôt check what I would expect from something I‚Äôll use in prod and I‚Äôm pretty sure you don‚Äôt need me to detail why üòÖ\n‚ùå Well organized\n‚ùå Documented\n‚ùå Tested\n‚ùå Safely installable\n2Ô∏è‚É£ Simply create an R script and source it. Something like:\nconst fs = require('fs');\nconst path = require('path');\nconst script = path.join(__dirname, 'script.R')\nconst data = fs.readFileSync(script);\nawait globalThis.webR.FS.writeFile(\n  \"/home/web_user/script.R\",\n  data\n);\nawait globalThis.webR.evalR(\"source('/home/web_user/script.R')\");\nThat‚Äôs a bit better, we can at least organize our code in a script and it will be:\n‚úÖ Well organized (more or less)\n‚úÖ Documented (more or less)\n‚ùå Tested\n‚ùå Safely installable\n3Ô∏è‚É£ I bet you saw me coming, the best way let‚Äôs put stuff into an R package, so that we can check all the boxes.\n‚úÖ Well organized\n‚úÖ Documented\n‚úÖ Tested\n‚úÖ Safely installable\nJeroen has written a\nDocker image\nto compile an R package to WASM, but I was looking for something that wouldn‚Äôt involve compiling via a docker container every time I make a change on my R package (even if that does sound appealing, I‚Äôm pretty sure this wouldn‚Äôt make for a seamless workflow).\nSo here is what I‚Äôm thinking should be a well structured NodeJS / WebR app:\nPutting all the web stuff inside the NodeJS app, because, well, NodeJS is really good at doing that.\nPutting all the ‚Äúbusiness logic‚Äù, data-crunching, modeling stuff (and everything R is really good at) into an R package.\nload webR, write my R package to the webR file system, and\npkgload::load_all()\nit into webR.\nThat way, I can enjoy the best of both worlds:\nNodeJS is really good at doing web related things, and there are plenty of ways to test and deploy the code.\nAnd same goes for the R package: if you‚Äôre reading my blog I‚Äôm pretty sure I don‚Äôt need to convince you of why packages are the perfect tool for sharing production code.\nThe how\nLet‚Äôs start by creating our project:\nmkdir webr-preload-funs\ncd webr-preload-funs\nnpm init -y\ntouch index.js\nnpm install express webr\nR -e \"usethis::create_package('rfuns', rstudio = FALSE)\"\nLet‚Äôs now create a simple function :\n> usethis::use_r(\"sw\")\n\n#' @title Star Wars by Species\n#' @description Return a tibble of Star Wars characters by species\n#' @import dplyr\n#' @export\n#' @param species character\n#' @return tibble\n#' @examples\n#' star_wars_by_species(\"Human\")\n#' star_wars_by_species(\"Droid\")\n#' star_wars_by_species(\"Wookiee\")\n#' star_wars_by_species(\"Rodian\")\nstar_wars_by_species <- function(species){\n  dplyr::starwars |>\n    filter(species == )\n}\nWe can now add\n{dplyr}\nand\n{pkgload}\nto our\nDESCRIPTION\n(we‚Äôll need\n{pkgload}\nto\nload_all()\nthe package).\nusethis::use_package(\"dplyr\")\nusethis::use_package(\"pkgload\")\ndevtools::document()\nNow that we have a package skeleton, we‚Äôll have to upload it to webR.\nAs described in the previous post, I‚Äôve started a\nwebrtools\nNodeJS module, which will contains function to play with webR.\nBefore this post, it had one function,\nloadPackages\n, that was used to build a webR dependency library (see\nPreloading your R packages in webR in an Express JS API\nfor more info).\nWe‚Äôll need to add two features :\nInstall deps from DESCRIPTION (not just a package name), so a wrapper around the\nRscript ./node_modules/webrtools/r/install.R dplyr\nfrom before\nCopy the package folder in NodeJS, so a more generic version of\nloadPackages\n, that can load any folder to the webR filesystem.\nFirst, in R, we‚Äôll need to read the\nDESCRIPTION\nand build the lib:\ndownload_packs_and_deps_from_desc <- function (\n  description,\n  path_to_installation = \"./webr_packages\"\n)\n{\n    if (!file.exists(description)) {\n        stop(\"DESCRIPTION file not found\")\n    }\n    deps <- desc::desc_get_deps(description)\n    for (pak in deps$package) {\n        webrtools::download_packs_and_deps(pak, path_to_installation = path_to_installation)\n    }\n}\nNote: the code of\nwebrtools::download_packs_and_deps()\nis a wrapper around the R code described in\nPreloading your R packages in webR in an Express JS API\nAnd in Node, we‚Äôll rework our\nloadPackages\nand split it into two functions ‚Äî one to load into any folder, and one to load into the package library:\nasync function loadFolder(webR, dirPath, outputdir = \"/usr/lib/R/library\") {\n  const files = getDirectoryTree(\n    dirPath\n  )\n  for await (const file of files) {\n    if (file.type === 'directory') {\n      await globalThis.webR.FS.mkdir(\n        `${outputdir}/${file.path}`,\n      );\n    } else {\n      const data = fs.readFileSync(`${dirPath}/${file.path}`);\n      await globalThis.webR.FS.writeFile(\n        `${outputdir}/${file.path}`,\n        data\n      );\n    }\n  }\n}\n\nasync function loadPackages(webR, dirPath) {\n  await loadFolder(webR, dirPath, outputdir = \"/usr/lib/R/library\");\n}\nThe end app\nWe now have everything we need!\nnpm i\n[email¬†protected]\nRscript ./node_modules/webrtools/r/install_from_desc.R $(pwd)/rfuns/DESCRIPTION\nAnd now, to our index.js\nconst app = require('express')()\nconst path = require('path');\nconst { loadPackages, loadFolder } = require('webrtools');\nconst { WebR } = require('webr');\n\n(async () => {\n  globalThis.webR = new WebR();\n  await globalThis.webR.init();\n\n  console.log(\"üöÄ webR is ready üöÄ\");\n\n  await loadPackages(\n    globalThis.webR,\n    path.join(__dirname, 'webr_packages')\n  )\n\n  await loadFolder(\n    globalThis.webR,\n    path.join(__dirname, 'rfuns'),\n    \"/home/web_user\"\n  )\n\n  console.log(\"üì¶ Packages written to webR üì¶\");\n\n  // see https://github.com/r-wasm/webr/issues/292\n  await globalThis.webR.evalR(\"options(expressions=1000)\")\n  await globalThis.webR.evalR(\"pkgload::load_all('/home/web_user')\");\n\n  app.listen(3000, '0.0.0.0', () => {\n    console.log('http://localhost:3000')\n  })\n\n})();\n\napp.get('/', async (req, res) => {\n  let result = await globalThis.webR.evalR(\n    'unique(dplyr::starwars$species)'\n  );\n  let js_res = await result.toJs()\n  res.send(js_res.values)\n})\n\napp.get('/:n', async (req, res) => {\n  let result = await globalThis.webR.evalR(\n    'star_wars_by_species(n)',\n    { env: { n: req.params.n } }\n    );\n  try {\n    const result_js = await result.toJs();\n    res.send(result_js)\n  } finally {\n    webR.destroy(result);\n  }\n});\nLet‚Äôs now try from another terminal:\ncurl http://localhost:3000\n\n[\"Human\",\"Droid\",\"Wookiee\",\"Rodian\",\"Hutt\",\"Yoda's species\",\"Trandoshan\",\"Mon Calamari\",\"Ewok\",\"Sullustan\",\"Neimodian\",\"Gungan\",null,\"Toydarian\",\"Dug\",\"Zabrak\",\"Twi'lek\",\"Vulptereen\",\"Xexto\",\"Toong\",\"Cerean\",\"Nautolan\",\"Tholothian\",\"Iktotchi\",\"Quermian\",\"Kel Dor\",\"Chagrian\",\"Geonosian\",\"Mirialan\",\"Clawdite\",\"Besalisk\",\"Kaminoan\",\"Aleena\",\"Skakoan\",\"Muun\",\"Togruta\",\"Kaleesh\",\"Pau'an\"]\n\ncurl http://localhost:3000/Rodian\n\n{\"type\":\"list\",\"names\":[\"name\",\"height\",\"mass\",\"hair_color\",\"skin_color\",\"eye_color\",\"birth_year\",\"sex\",\"gender\",\"homeworld\",\"species\",\"films\",\"vehicles\",\"starships\"],\"values\":[{\"type\":\"character\",\"names\":null,\"values\":[\"Greedo\"]},{\"type\":\"integer\",\"names\":null,\"values\":[173]},{\"type\":\"double\",\"names\":null,\"values\":[74]},{\"type\":\"character\",\"names\":null,\"values\":[null]},{\"type\":\"character\",\"names\":null,\"values\":[\"green\"]},{\"type\":\"character\",\"names\":null,\"values\":[\"black\"]},{\"type\":\"double\",\"names\":null,\"values\":[44]},{\"type\":\"character\",\"names\":null,\"values\":[\"male\"]},{\"type\":\"character\",\"names\":null,\"values\":[\"masculine\"]},{\"type\":\"character\",\"names\":null,\"values\":[\"Rodia\"]},{\"type\":\"character\",\"names\":null,\"values\":[\"Rodian\"]},{\"type\":\"list\",\"names\":null,\"values\":[{\"type\":\"character\",\"names\":null,\"values\":[\"A New Hope\"]}]},{\"type\":\"list\",\"names\":null,\"values\":[{\"type\":\"character\",\"names\":null,\"values\":[]}]},{\"type\":\"list\",\"names\":null,\"values\":[{\"type\":\"character\",\"names\":null,\"values\":[]}]}]}\nYeay üéâ .\nYou can find the code\nhere\n, and see it live at\nsrv.colinfay.me/webr-preload-funs/\n.\nYou can also try it with\ndocker run -it -p 3000:3000 colinfay/webr-preload-funs\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nColin Fay\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "This post is the fourth one of a series of post about webR: Using webR in an Express JS REST API The Old Faithful Geyser Data shiny app with webR, Bootstrap & ExpressJS Preloading your R packages in webR in an Express JS API Using my own ...",
      "meta_keywords": null,
      "og_description": "This post is the fourth one of a series of post about webR: Using webR in an Express JS REST API The Old Faithful Geyser Data shiny app with webR, Bootstrap & ExpressJS Preloading your R packages in webR in an Express JS API Using my own ...",
      "og_image": "https://www.r-bloggers.com/wp-content/uploads/2016/04/R_02_2016-05-01.png",
      "og_title": "Using my own R functions in webR in an Express JS API, and thoughts on building web apps with Node & webR | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 7.1,
      "sitemap_lastmod": "2023-10-17T00:00:00+00:00",
      "twitter_description": "This post is the fourth one of a series of post about webR: Using webR in an Express JS REST API The Old Faithful Geyser Data shiny app with webR, Bootstrap & ExpressJS Preloading your R packages in webR in an Express JS API Using my own ...",
      "twitter_title": "Using my own R functions in webR in an Express JS API, and thoughts on building web apps with Node & webR | R-bloggers",
      "url": "https://www.r-bloggers.com/2023/10/using-my-own-r-functions-in-webr-in-an-express-js-api-and-thoughts-on-building-web-apps-with-node-webr/",
      "word_count": 1416
    }
  }
}