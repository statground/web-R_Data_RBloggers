{
  "id": "9ae5e57bbc91eb5141ee3991de65f63e06a77f9f",
  "url": "https://www.r-bloggers.com/2025/03/accounting-for-ties-in-a-bayesian-proportional-hazards-model/",
  "created_at_utc": "2025-11-22T19:59:01Z",
  "data": null,
  "raw_original": {
    "uuid": "a9671df0-ff43-443c-ae28-e706bb7fcb9e",
    "created_at": "2025-11-22 19:59:01",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2025/03/accounting-for-ties-in-a-bayesian-proportional-hazards-model/",
      "crawled_at": "2025-11-22T10:52:16.253713",
      "external_links": [
        {
          "href": "https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/",
          "text": "ouR data generation"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://www.jstor.org/stable/2533573",
          "text": "Hertz-Picciotto and Rockhill"
        },
        {
          "href": "https://www.tandfonline.com/doi/abs/10.1080/01621459.1977.10480613",
          "text": "Efron"
        },
        {
          "href": "https://www.jstor.org/stable/2529620",
          "text": "Breslow"
        },
        {
          "href": "https://www.google.com/url?sa=t&source=web&rct=j&opi=89978449&url=https://myweb.uiowa.edu/pbreheny/7210/f15/notes/11-5.pdf",
          "text": "lecture notes"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/",
          "text": "earlier"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/",
          "text": "earlier"
        },
        {
          "href": "https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/",
          "text": "ouR data generation"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "Accounting for ties in a Bayesian proportional hazards model | R-bloggers",
      "images": [
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/figures/efron.png?w=90%25&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/index.en_files/figure-html/km_plot-1.png?w=450&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/index.en_files/figure-html/tied_plot-1.png?w=450&ssl=1"
        }
      ],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/keith-goldfeld/",
          "text": "Keith Goldfeld"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-391333 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Accounting for ties in a Bayesian proportional hazards model</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">March 19, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/keith-goldfeld/\">Keith Goldfeld</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/\"> ouR data generation</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<p>Over my past few posts, I’ve been progressively building towards a Bayesian model for a stepped-wedge cluster randomized trial with a time-to-event outcome, where time will be modeled using a spline function. I started with a simple Cox proportional hazards model for a traditional RCT, ignoring time as a factor. In the next post, I introduced a nonlinear time effect. For the third post—one I initially thought was ready to publish—I extended the model to a cluster randomized trial without explicitly incorporating time. I was then working on the grand finale, the full model, when I ran into an issue: I couldn’t recover the effect-size parameter used to generate the data.</p>\n<p>After an embarrassingly long debugging process, I finally realized the problem—many events shared the same event times, and my model failed to account for ties. This issue hadn’t been apparent in the earlier models, but the final version was particularly sensitive to it. So, I decided to step back and first implement a model that properly handles ties before moving ahead.</p>\n<div class=\"section level3\" id=\"whats-the-issue\">\n<h3>What’s the issue?</h3>\n<p>The fundamental issue is that the likelihood in the original model assumes event times are unique for each individual. This assumption is reasonable when time is measured in hours but becomes problematic when using days and even more so with weeks, especially if the study covers a broad time range.</p>\n<p>When multiple individuals experience an event at the same recorded time (ties), the challenge is defining the appropriate “risk set”—the group still at risk at that time. Two commonly used approaches for handling ties are the <em>Breslow</em> and <em>Efron</em> methods.</p>\n<ul>\n<li><p>The <em>Breslow</em> method takes a simple approach by assuming that all tied events share the same risk set. It treats them as if they happened sequentially but applies the same risk set to each event. This can work well when ties are rare but may introduce bias if they are frequent.</p></li>\n<li><p>The <em>Efron</em> method refines this by adjusting the risk set dynamically. Instead of treating all tied events as occurring with full risk sets, it reduces the risk set incrementally as each event happens. This better approximates a scenario where events truly occur in close succession rather than simultaneously.</p></li>\n</ul>\n<p>In practical terms, the <em>Efron</em> method provides a more accurate correction when ties are common, while <em>Breslow</em> remains a computationally simpler choice. Another option is the Exact method, which calculates the likelihood by considering all possible orderings of tied events. While this approach is the most precise, it is often computationally impractical for large datasets. Much of this is described nicely in\n<a href=\"https://www.jstor.org/stable/2533573\" rel=\"nofollow\" target=\"_blank\">Hertz-Picciotto and Rockhill</a>, though the original methods are detailed by <a href=\"https://www.tandfonline.com/doi/abs/10.1080/01621459.1977.10480613\" rel=\"nofollow\" target=\"_blank\">Efron</a> and\n<a href=\"https://www.jstor.org/stable/2529620\" rel=\"nofollow\" target=\"_blank\">Breslow</a>.\nFinally, these <a href=\"https://www.google.com/url?sa=t&amp;source=web&amp;rct=j&amp;opi=89978449&amp;url=https://myweb.uiowa.edu/pbreheny/7210/f15/notes/11-5.pdf\" rel=\"nofollow\" target=\"_blank\">lecture notes</a> by Patrick Breheny provide a nice explanation of algorithms for handling tied survival times.</p>\n</div>\n<div class=\"section level3\" id=\"implementing-the-efron-method\">\n<h3>Implementing the Efron method</h3>\n<p>Since the <em>Efron</em> method generally provides better estimates, I chose to incorporate this into the Bayesian model. The partial likelihood under this approach is</p>\n<p><span class=\"math display\">\\[\n\\log L(\\beta) = \\sum_{j=1}^{J} \\left[ \\sum_{i \\in D_j} x_i^\\top \\beta – \\sum_{r=0}^{d_j-1} \\log \\left( \\sum_{k \\in R_j} \\exp(x_k^\\top \\beta) – r \\cdot \\bar{w} \\right) \\right] \\\\\n\\]</span></p>\n<ul>\n<li><span class=\"math inline\">\\(D_j\\)</span> is the set of individuals who experience an event at time <span class=\"math inline\">\\(t_j\\)</span>.</li>\n<li><span class=\"math inline\">\\(R_j\\)</span> is the risk set at time <span class=\"math inline\">\\(t_j\\)</span>, including all individuals who are still at risk at that time.</li>\n<li><span class=\"math inline\">\\(d_j\\)</span> is the number of events occurring at time <span class=\"math inline\">\\(t_j\\)</span>.</li>\n<li><span class=\"math inline\">\\(r\\)</span> ranges from 0 to <span class=\"math inline\">\\(d_j – 1\\)</span>, iterating over the tied events.</li>\n<li><span class=\"math inline\">\\(\\bar{w}\\)</span> represents the average risk weight of individuals experiencing an event at <span class=\"math inline\">\\(t_j\\)</span>:</li>\n</ul>\n<p><span class=\"math display\">\\[\\bar{w} = \\frac{1}{d_j} \\sum_{i \\in D_j} \\exp(x_i^\\top \\beta)\\]</span></p>\n<p>The key idea here is that instead of treating all tied events as occurring simultaneously with the full risk set (as in Breslow’s method), <em>Efron</em> gradually reduces the risk set as each tied event is considered. This provides a more refined approximation of the true likelihood, particularly when ties are common.</p>\n<p>In case a simple numerical example is helpful, here is a toy example of 15 individuals, where three share a common event time of 14 days (shown as <span class=\"math inline\">\\(Y\\)</span>), and two share an event time of 25 days. The critical feature of the <em>Efron</em> correction is that <span class=\"math inline\">\\(\\bar{w}\\)</span> is computed by averaging <span class=\"math inline\">\\(\\text{exp}(\\theta)\\)</span> across the group experiencing the event at a given time.</p>\n<p>Initially, the cumulative sum of <span class=\"math inline\">\\(\\text{exp}(\\theta)\\)</span> for each individual in the group is identical. However, as each event in the tied group is processed sequentially, the risk set is dynamically updated, and the contribution from individuals who have already been accounted for is gradually reduced. This is reflected in the term <span class=\"math inline\">\\(Z = U-V\\)</span>, where <span class=\"math inline\">\\(U\\)</span> represents the initial total risk weight and <span class=\"math inline\">\\(V\\)</span> accounts for the incremental reduction as ties are processed.</p>\n<p><img data-lazy-src=\"https://i0.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/figures/efron.png?w=90%25&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/figures/efron.png?w=90%25&amp;ssl=1\"/></noscript></p>\n<p><br/></p>\n</div>\n<div class=\"section level3\" id=\"simulating-data\">\n<h3>Simulating data</h3>\n<p>To generate data for testing the Bayesian model, I am simulating an RCT with 1,000 individuals randomized 1:1 to one of two groups (represented by <span class=\"math inline\">\\(A\\)</span>). The treatment effect is defined by the hazard ratio <span class=\"math inline\">\\(\\delta_f\\)</span>. The data includes censoring and ties.</p>\n<p>We start with loading the necessary libraries:</p>\n<pre>library(simstudy)\nlibrary(data.table)\nlibrary(survival)\nlibrary(survminer)\nlibrary(cmdstanr)</pre>\n<p>Here is the simulation – definitions, parameters, and the data generation.</p>\n<pre>#### Data definitions\n\ndef &lt;- defData(varname = \"A\", formula = \"1;1\", dist = \"trtAssign\")\n\ndefS &lt;-\n  defSurv(\n    varname = \"timeEvent\",\n    formula = \"-11.6 + ..delta_f * A\",\n    shape = 0.30\n  )  |&gt;\n  defSurv(varname = \"censorTime\", formula = -11.3, shape = .35)\n\n#### Parameters\n\ndelta_f &lt;- log(1.5)\n\n#### Generate single data set\n\nset.seed(7398)\n\ndd &lt;- genData(1000, def)\ndd &lt;- genSurv(dd, defS, timeName = \"Y\", censorName = \"censorTime\", digits = 0,\n              eventName = \"event\", typeName = \"eventType\", keepEvents  = TRUE)</pre>\n<p>The Kaplan-Meier plot shows the two arms - red is intervention, and green is control, and the black crosses are the censoring times.</p>\n<p><img data-lazy-src=\"https://i0.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/index.en_files/figure-html/km_plot-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/index.en_files/figure-html/km_plot-1.png?w=450&amp;ssl=1\"/></noscript></p>\n<p>Of the 48 unique event times, 44 are shared by multiple individuals. This histogram shows the number of events at each time point:</p>\n<p><img data-lazy-src=\"https://i2.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/index.en_files/figure-html/tied_plot-1.png?w=450&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i2.wp.com/www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/index.en_files/figure-html/tied_plot-1.png?w=450&amp;ssl=1\"/></noscript></p>\n</div>\n<div class=\"section level3\" id=\"stan-model\">\n<h3>Stan model</h3>\n<p>The Stan code below extends the model to analyze survival data that I presented <a href=\"https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/\" rel=\"nofollow\" target=\"_blank\">earlier</a>, so much of the model remains the same. I’ve removed the binary search function that appeared in the earlier model, replacing it with an index field that is passed from <code>R</code>. There are additional data requirements that must also be sent from <code>R</code> to provide information about the ties. The model does not have additional parameters. The adjustment of the likelihood for the ties takes place in the “model” block.</p>\n<p>This Stan code extends the survival model I described <a href=\"https://www.rdatagen.net/post/2025-02-11-estimating-a-bayesian-proportional-hazards-model/\" rel=\"nofollow\" target=\"_blank\">earlier</a>, with much of the structure remaining unchanged. The binary search function from the previous model has been removed and replaced with an index field passed from <code>R</code>. New data fields related to ties are also required, which must be calculated in <code>R</code> and provided to the model. There are no additional parameters, and the likelihood adjustment for ties is handled in the “model” block.</p>\n<pre>stan_code &lt;-\n\"\ndata {\n\n  int&lt;lower=0&gt; N_o;        // Number of uncensored observations\n  array[N_o] int i_o;      // Index in data set\n\n  int&lt;lower=0&gt; N;          // Number of total observations\n  vector[N] x;             // Covariates for all observations\n  \n  array[N] int index;\n  \n  int&lt;lower=0&gt; T;            // Number of records as ties\n  int&lt;lower=1&gt; G;            // Number of groups of ties\n  array[T] int t_grp;        // Indicating tie group\n  array[T] int t_index;      // Index in data set\n  vector[T] t_adj;           // Adjustment for ties (efron)\n}\n\nparameters {\n  \n  real beta;          // Fixed effects for covariates\n\n}\n\nmodel {\n  \n  // Prior\n  \n  beta ~ normal(0, 4);\n  \n  // Calculate theta for each observation to be used in likelihood\n  \n  vector[N] theta;\n  vector[N] log_sum_exp_theta;\n  vector[G] exp_theta_grp = rep_vector(0, G);\n  \n  int first_in_grp;\n  \n  for (i in 1:N) {\n    theta[i] = x[i] * beta;  \n  }\n\n  // Computing cumulative sum of log(exp(theta)) from last to first observation\n  \n  log_sum_exp_theta[N] = theta[N];\n  \n  for (i in tail(sort_indices_desc(index), N-1)) {\n    log_sum_exp_theta[i] = log_sum_exp(theta[i], log_sum_exp_theta[i + 1]);\n  }\n  \n  // Efron algorithm - adjusting cumulative sum for ties\n  \n  for (i in 1:T) {\n    exp_theta_grp[t_grp[i]] += exp(theta[t_index[i]]);\n  }\n\n  for (i in 1:T) {\n  \n    if (t_adj[i] == 0) {\n      first_in_grp = t_index[i];\n    }\n\n    log_sum_exp_theta[t_index[i]] =\n      log( exp(log_sum_exp_theta[first_in_grp]) - t_adj[i] * exp_theta_grp[t_grp[i]]);\n  }\n  \n  // Likelihood for uncensored observations\n\n  for (n_o in 1:N_o) {\n    target += theta[i_o[n_o]] - log_sum_exp_theta[i_o[n_o]];\n  }\n  \n}\n\ngenerated quantities {\n  real exp_beta = exp(beta);\n}\n\"</pre>\n<div class=\"section level4\" id=\"compiling-the-model\">\n<h4>Compiling the model</h4>\n<pre>stan_model &lt;- cmdstan_model(write_stan_file(stan_code))</pre>\n</div>\n<div class=\"section level4\" id=\"preparing-the-data-for-stan\">\n<h4>Preparing the data for Stan</h4>\n<pre>dx &lt;- copy(dd)\nsetorder(dx, Y)\ndx[, index := .I]\n\ndx.obs &lt;- dx[event == 1]\nN_obs &lt;- dx.obs[, .N]\ni_obs &lt;- dx.obs[, index]\n\nN_all &lt;- dx[, .N]\nx_all &lt;- dx[, A]\n\nties &lt;- dx[, .N, keyby = Y][N&gt;1, .(grp = .I, Y)]\nties &lt;- merge(ties, dx, by = \"Y\")\nties &lt;- ties[, order := 1:.N, keyby = grp][, .(grp, index)]\nties[, adj := 0:(.N-1)/.N, keyby = grp]\n\nstan_data &lt;- list(\n  N_o = N_obs,\n  i_o = i_obs,\n  N = N_all,\n  x = x_all,\n  index = dx$index,\n  T = nrow(ties),\n  G = max(ties$grp),\n  t_grp = ties$grp,\n  t_index = ties$index,\n  t_adj = ties$adj\n)</pre>\n</div>\n<div class=\"section level4\" id=\"fitting-models\">\n<h4>Fitting models</h4>\n<p>First, I am estimating the Bayesian model. To save time, I’m using <code>$optimize()</code> to obtain the MLE for <code>beta</code> from the Stan model rather than using MCMC to sample the full posterior distribution. The estimated hazard ratio is right on target:</p>\n<pre>fit_mle &lt;- stan_model$optimize(data=stan_data, jacobian = FALSE)\nfit_mle$draws(format=\"df\")[1,c(\"beta\", \"exp_beta\")]\n## # A tibble: 1 × 2\n##    beta exp_beta\n##   &lt;dbl&gt;    &lt;dbl&gt;\n## 1 0.401     1.49</pre>\n<p>For comparison, I fit a Cox proportional hazards model using a frequentist (non-Bayesian) approach. The log hazard ratio estimate matches that of the Bayesian model.</p>\n<pre>cox_model &lt;- coxph(Surv(Y, event) ~ A , data = dd, ties = \"efron\")\n## # A tibble: 1 × 5\n##   term  estimate std.error statistic      p.value\n##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;\n## 1 A        0.401    0.0715      5.62 0.0000000194</pre>\n<p>Of course, I really should conduct more extensive simulations to better understand the operating characteristics of the Bayesian model, particularly to assess how estimates behave when the ties are ignored. However, I’m eager to get back to the original program, moving next to a random effects model, and then completing the full model by combining the random effect with the spline. I’ll leave these additional simulations for you to explore.</p>\n<p>\n</p><p><small><font color=\"darkkhaki\">\nReferences:</font></small></p>\n<p>Breslow, N., 1974. Covariance analysis of censored survival data. Biometrics, pp.89-99.</p>\n<p>Efron, B., 1977. The efficiency of Cox’s likelihood function for censored data. Journal of the American statistical Association, 72(359), pp.557-565.</p>\n<p>Hertz-Picciotto, I. and Rockhill, B., 1997. Validity and efficiency of approximation methods for tied survival times in Cox regression. Biometrics, pp.1151-1156.</p>\n</div>\n</div>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/\"> ouR data generation</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
      "main_text": "Accounting for ties in a Bayesian proportional hazards model\nPosted on\nMarch 19, 2025\nby\nKeith Goldfeld\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nouR data generation\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nOver my past few posts, I’ve been progressively building towards a Bayesian model for a stepped-wedge cluster randomized trial with a time-to-event outcome, where time will be modeled using a spline function. I started with a simple Cox proportional hazards model for a traditional RCT, ignoring time as a factor. In the next post, I introduced a nonlinear time effect. For the third post—one I initially thought was ready to publish—I extended the model to a cluster randomized trial without explicitly incorporating time. I was then working on the grand finale, the full model, when I ran into an issue: I couldn’t recover the effect-size parameter used to generate the data.\nAfter an embarrassingly long debugging process, I finally realized the problem—many events shared the same event times, and my model failed to account for ties. This issue hadn’t been apparent in the earlier models, but the final version was particularly sensitive to it. So, I decided to step back and first implement a model that properly handles ties before moving ahead.\nWhat’s the issue?\nThe fundamental issue is that the likelihood in the original model assumes event times are unique for each individual. This assumption is reasonable when time is measured in hours but becomes problematic when using days and even more so with weeks, especially if the study covers a broad time range.\nWhen multiple individuals experience an event at the same recorded time (ties), the challenge is defining the appropriate “risk set”—the group still at risk at that time. Two commonly used approaches for handling ties are the\nBreslow\nand\nEfron\nmethods.\nThe\nBreslow\nmethod takes a simple approach by assuming that all tied events share the same risk set. It treats them as if they happened sequentially but applies the same risk set to each event. This can work well when ties are rare but may introduce bias if they are frequent.\nThe\nEfron\nmethod refines this by adjusting the risk set dynamically. Instead of treating all tied events as occurring with full risk sets, it reduces the risk set incrementally as each event happens. This better approximates a scenario where events truly occur in close succession rather than simultaneously.\nIn practical terms, the\nEfron\nmethod provides a more accurate correction when ties are common, while\nBreslow\nremains a computationally simpler choice. Another option is the Exact method, which calculates the likelihood by considering all possible orderings of tied events. While this approach is the most precise, it is often computationally impractical for large datasets. Much of this is described nicely in\nHertz-Picciotto and Rockhill\n, though the original methods are detailed by\nEfron\nand\nBreslow\n.\nFinally, these\nlecture notes\nby Patrick Breheny provide a nice explanation of algorithms for handling tied survival times.\nImplementing the Efron method\nSince the\nEfron\nmethod generally provides better estimates, I chose to incorporate this into the Bayesian model. The partial likelihood under this approach is\n\\[\n\\log L(\\beta) = \\sum_{j=1}^{J} \\left[ \\sum_{i \\in D_j} x_i^\\top \\beta – \\sum_{r=0}^{d_j-1} \\log \\left( \\sum_{k \\in R_j} \\exp(x_k^\\top \\beta) – r \\cdot \\bar{w} \\right) \\right] \\\\\n\\]\n\\(D_j\\)\nis the set of individuals who experience an event at time\n\\(t_j\\)\n.\n\\(R_j\\)\nis the risk set at time\n\\(t_j\\)\n, including all individuals who are still at risk at that time.\n\\(d_j\\)\nis the number of events occurring at time\n\\(t_j\\)\n.\n\\(r\\)\nranges from 0 to\n\\(d_j – 1\\)\n, iterating over the tied events.\n\\(\\bar{w}\\)\nrepresents the average risk weight of individuals experiencing an event at\n\\(t_j\\)\n:\n\\[\\bar{w} = \\frac{1}{d_j} \\sum_{i \\in D_j} \\exp(x_i^\\top \\beta)\\]\nThe key idea here is that instead of treating all tied events as occurring simultaneously with the full risk set (as in Breslow’s method),\nEfron\ngradually reduces the risk set as each tied event is considered. This provides a more refined approximation of the true likelihood, particularly when ties are common.\nIn case a simple numerical example is helpful, here is a toy example of 15 individuals, where three share a common event time of 14 days (shown as\n\\(Y\\)\n), and two share an event time of 25 days. The critical feature of the\nEfron\ncorrection is that\n\\(\\bar{w}\\)\nis computed by averaging\n\\(\\text{exp}(\\theta)\\)\nacross the group experiencing the event at a given time.\nInitially, the cumulative sum of\n\\(\\text{exp}(\\theta)\\)\nfor each individual in the group is identical. However, as each event in the tied group is processed sequentially, the risk set is dynamically updated, and the contribution from individuals who have already been accounted for is gradually reduced. This is reflected in the term\n\\(Z = U-V\\)\n, where\n\\(U\\)\nrepresents the initial total risk weight and\n\\(V\\)\naccounts for the incremental reduction as ties are processed.\nSimulating data\nTo generate data for testing the Bayesian model, I am simulating an RCT with 1,000 individuals randomized 1:1 to one of two groups (represented by\n\\(A\\)\n). The treatment effect is defined by the hazard ratio\n\\(\\delta_f\\)\n. The data includes censoring and ties.\nWe start with loading the necessary libraries:\nlibrary(simstudy)\nlibrary(data.table)\nlibrary(survival)\nlibrary(survminer)\nlibrary(cmdstanr)\nHere is the simulation – definitions, parameters, and the data generation.\n#### Data definitions\n\ndef <- defData(varname = \"A\", formula = \"1;1\", dist = \"trtAssign\")\n\ndefS <-\n  defSurv(\n    varname = \"timeEvent\",\n    formula = \"-11.6 + ..delta_f * A\",\n    shape = 0.30\n  )  |>\n  defSurv(varname = \"censorTime\", formula = -11.3, shape = .35)\n\n#### Parameters\n\ndelta_f <- log(1.5)\n\n#### Generate single data set\n\nset.seed(7398)\n\ndd <- genData(1000, def)\ndd <- genSurv(dd, defS, timeName = \"Y\", censorName = \"censorTime\", digits = 0,\n              eventName = \"event\", typeName = \"eventType\", keepEvents  = TRUE)\nThe Kaplan-Meier plot shows the two arms - red is intervention, and green is control, and the black crosses are the censoring times.\nOf the 48 unique event times, 44 are shared by multiple individuals. This histogram shows the number of events at each time point:\nStan model\nThe Stan code below extends the model to analyze survival data that I presented\nearlier\n, so much of the model remains the same. I’ve removed the binary search function that appeared in the earlier model, replacing it with an index field that is passed from\nR\n. There are additional data requirements that must also be sent from\nR\nto provide information about the ties. The model does not have additional parameters. The adjustment of the likelihood for the ties takes place in the “model” block.\nThis Stan code extends the survival model I described\nearlier\n, with much of the structure remaining unchanged. The binary search function from the previous model has been removed and replaced with an index field passed from\nR\n. New data fields related to ties are also required, which must be calculated in\nR\nand provided to the model. There are no additional parameters, and the likelihood adjustment for ties is handled in the “model” block.\nstan_code <-\n\"\ndata {\n\n  int<lower=0> N_o;        // Number of uncensored observations\n  array[N_o] int i_o;      // Index in data set\n\n  int<lower=0> N;          // Number of total observations\n  vector[N] x;             // Covariates for all observations\n  \n  array[N] int index;\n  \n  int<lower=0> T;            // Number of records as ties\n  int<lower=1> G;            // Number of groups of ties\n  array[T] int t_grp;        // Indicating tie group\n  array[T] int t_index;      // Index in data set\n  vector[T] t_adj;           // Adjustment for ties (efron)\n}\n\nparameters {\n  \n  real beta;          // Fixed effects for covariates\n\n}\n\nmodel {\n  \n  // Prior\n  \n  beta ~ normal(0, 4);\n  \n  // Calculate theta for each observation to be used in likelihood\n  \n  vector[N] theta;\n  vector[N] log_sum_exp_theta;\n  vector[G] exp_theta_grp = rep_vector(0, G);\n  \n  int first_in_grp;\n  \n  for (i in 1:N) {\n    theta[i] = x[i] * beta;  \n  }\n\n  // Computing cumulative sum of log(exp(theta)) from last to first observation\n  \n  log_sum_exp_theta[N] = theta[N];\n  \n  for (i in tail(sort_indices_desc(index), N-1)) {\n    log_sum_exp_theta[i] = log_sum_exp(theta[i], log_sum_exp_theta[i + 1]);\n  }\n  \n  // Efron algorithm - adjusting cumulative sum for ties\n  \n  for (i in 1:T) {\n    exp_theta_grp[t_grp[i]] += exp(theta[t_index[i]]);\n  }\n\n  for (i in 1:T) {\n  \n    if (t_adj[i] == 0) {\n      first_in_grp = t_index[i];\n    }\n\n    log_sum_exp_theta[t_index[i]] =\n      log( exp(log_sum_exp_theta[first_in_grp]) - t_adj[i] * exp_theta_grp[t_grp[i]]);\n  }\n  \n  // Likelihood for uncensored observations\n\n  for (n_o in 1:N_o) {\n    target += theta[i_o[n_o]] - log_sum_exp_theta[i_o[n_o]];\n  }\n  \n}\n\ngenerated quantities {\n  real exp_beta = exp(beta);\n}\n\"\nCompiling the model\nstan_model <- cmdstan_model(write_stan_file(stan_code))\nPreparing the data for Stan\ndx <- copy(dd)\nsetorder(dx, Y)\ndx[, index := .I]\n\ndx.obs <- dx[event == 1]\nN_obs <- dx.obs[, .N]\ni_obs <- dx.obs[, index]\n\nN_all <- dx[, .N]\nx_all <- dx[, A]\n\nties <- dx[, .N, keyby = Y][N>1, .(grp = .I, Y)]\nties <- merge(ties, dx, by = \"Y\")\nties <- ties[, order := 1:.N, keyby = grp][, .(grp, index)]\nties[, adj := 0:(.N-1)/.N, keyby = grp]\n\nstan_data <- list(\n  N_o = N_obs,\n  i_o = i_obs,\n  N = N_all,\n  x = x_all,\n  index = dx$index,\n  T = nrow(ties),\n  G = max(ties$grp),\n  t_grp = ties$grp,\n  t_index = ties$index,\n  t_adj = ties$adj\n)\nFitting models\nFirst, I am estimating the Bayesian model. To save time, I’m using\n$optimize()\nto obtain the MLE for\nbeta\nfrom the Stan model rather than using MCMC to sample the full posterior distribution. The estimated hazard ratio is right on target:\nfit_mle <- stan_model$optimize(data=stan_data, jacobian = FALSE)\nfit_mle$draws(format=\"df\")[1,c(\"beta\", \"exp_beta\")]\n## # A tibble: 1 × 2\n##    beta exp_beta\n##   <dbl>    <dbl>\n## 1 0.401     1.49\nFor comparison, I fit a Cox proportional hazards model using a frequentist (non-Bayesian) approach. The log hazard ratio estimate matches that of the Bayesian model.\ncox_model <- coxph(Surv(Y, event) ~ A , data = dd, ties = \"efron\")\n## # A tibble: 1 × 5\n##   term  estimate std.error statistic      p.value\n##   <chr>    <dbl>     <dbl>     <dbl>        <dbl>\n## 1 A        0.401    0.0715      5.62 0.0000000194\nOf course, I really should conduct more extensive simulations to better understand the operating characteristics of the Bayesian model, particularly to assess how estimates behave when the ties are ignored. However, I’m eager to get back to the original program, moving next to a random effects model, and then completing the full model by combining the random effect with the spline. I’ll leave these additional simulations for you to explore.\nReferences:\nBreslow, N., 1974. Covariance analysis of censored survival data. Biometrics, pp.89-99.\nEfron, B., 1977. The efficiency of Cox’s likelihood function for censored data. Journal of the American statistical Association, 72(359), pp.557-565.\nHertz-Picciotto, I. and Rockhill, B., 1997. Validity and efficiency of approximation methods for tied survival times in Cox regression. Biometrics, pp.1151-1156.\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nouR data generation\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "Over my past few posts, I’ve been progressively building towards a Bayesian model for a stepped-wedge cluster randomized trial with a time-to-event outcome, where time will be modeled using a spline function. I started with a simple Cox proportional...",
      "meta_keywords": null,
      "og_description": "Over my past few posts, I’ve been progressively building towards a Bayesian model for a stepped-wedge cluster randomized trial with a time-to-event outcome, where time will be modeled using a spline function. I started with a simple Cox proportional...",
      "og_image": "https://www.rdatagen.net/post/2025-03-20-bayesian-survival-model-that-can-appropriately-handle-ties/figures/efron.png",
      "og_title": "Accounting for ties in a Bayesian proportional hazards model | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 9.4,
      "sitemap_lastmod": null,
      "twitter_description": "Over my past few posts, I’ve been progressively building towards a Bayesian model for a stepped-wedge cluster randomized trial with a time-to-event outcome, where time will be modeled using a spline function. I started with a simple Cox proportional...",
      "twitter_title": "Accounting for ties in a Bayesian proportional hazards model | R-bloggers",
      "url": "https://www.r-bloggers.com/2025/03/accounting-for-ties-in-a-bayesian-proportional-hazards-model/",
      "word_count": 1889
    }
  }
}