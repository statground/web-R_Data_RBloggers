{
  "id": "2f38695fb78d52c4db4df70dd0ba0ee3200c17f1",
  "url": "https://www.r-bloggers.com/2025/10/compositional-modeling-of-plant-communities-with-dirichlet-regression/",
  "created_at_utc": "2025-11-22T19:57:27Z",
  "data": null,
  "raw_original": {
    "uuid": "b140f687-a401-4409-a55d-825efe19d4a5",
    "created_at": "2025-11-22 19:57:27",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2025/10/compositional-modeling-of-plant-communities-with-dirichlet-regression/",
      "crawled_at": "2025-11-22T10:41:42.208923",
      "external_links": [
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/",
          "text": "GAMbler"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://doi.org/10.1111/j.2517-6161.1982.tb01195.x",
          "text": "Aitchison’s landmark work"
        },
        {
          "href": "https://link.springer.com/book/10.1007/978-3-642-36809-7",
          "text": "van den Boogaart & Tolosana-Delgado"
        },
        {
          "href": "https://link.springer.com/article/10.1007/s11222-022-10167-2",
          "text": "Riutort-Mayol et al’s approximate Hilbert space Gaussian processes"
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#overview-of-this-post",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/autocorrelated-gams/",
          "text": "GAMs for time series analysis"
        },
        {
          "href": "https://ecogambler.netlify.app/blog/distributed-lags-mgcv/",
          "text": "complex hierarchical models"
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#the-dirichlet-distribution-and-compositional-constraints",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#parameter-guide-for-dirichlet-regression",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#environment-setup",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#simulating-plant-community-data",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#exploratory-visualization",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#dirichlet-regression-with-gaussian-processes",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#model-predictions-and-effects",
          "text": null
        },
        {
          "href": "https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/",
          "text": "excellent guide to visualizing different types of posteriors"
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#marginal-effects-univariate-environmental-responses",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#visualizing-predicted-communities-with-waffle-plots",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#bivariate-surfaces-capturing-environmental-interactions",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#model-validation-checking-our-compositional-residuals",
          "text": null
        },
        {
          "href": "https://github.com/maiermarco/DirichletReg",
          "text": "Maier’s approach in the DirichletReg package"
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#model-interpretation-and-ecological-insights",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#take-home-messages",
          "text": null
        },
        {
          "href": "https://ecogambler.netlify.app/talk/",
          "text": "getting started with mvgam and brms for ecological data"
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/#further-reading",
          "text": null
        },
        {
          "href": "https://books.google.com/books/about/The_Statistical_Analysis_of_Compositiona.html?id=b_2YQgAACAAJ",
          "text": "The Statistical Analysis of Compositional Data"
        },
        {
          "href": "https://doi.org/10.1007/978-3-642-36809-7",
          "text": "Analyzing compositional data with R"
        },
        {
          "href": "https://doi.org/10.18637/jss.v080.i01",
          "text": "brms: An R package for Bayesian multilevel models using Stan"
        },
        {
          "href": "https://doi.org/10.32614/RJ-2018-017",
          "text": "Advanced Bayesian multilevel modeling with the R package brms"
        },
        {
          "href": "https://www.researchgate.net/publication/228576713_Modelling_compositional_data_using_Dirichlet_regression_models",
          "text": "Modelling compositional data using Dirichlet regression models"
        },
        {
          "href": "https://epub.wu.ac.at/4077/",
          "text": "DirichletReg: Dirichlet regression for compositional data in R"
        },
        {
          "href": "http://gaussianprocess.org/gpml/",
          "text": "Gaussian processes for machine learning"
        },
        {
          "href": "https://doi.org/10.1007/s11222-022-10167-2",
          "text": "Practical Hilbert space approximate Bayesian Gaussian processes for probabilistic programming"
        },
        {
          "href": "https://doi.org/10.1111/geb.12464",
          "text": "Joint dynamic species distribution models: a tool for community ordination and spatio-temporal monitoring"
        },
        {
          "href": "https://doi.org/10.1016/j.tree.2015.09.007",
          "text": "So many variables: joint modeling in community ecology"
        },
        {
          "href": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/",
          "text": "GAMbler"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "Compositional modeling of plant communities with Dirichlet regression | R-bloggers",
      "images": [
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i2.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-6-1.png?w=60%25&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i1.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-10-1.png?w=60%25&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-11-1.png?w=60%25&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-12-1.png?w=60%25&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-13-1.png?w=60%25&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-14-1.png?w=60%25&ssl=1"
        },
        {
          "alt": null,
          "base64": "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          "src": "https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif"
        },
        {
          "alt": null,
          "base64": null,
          "src": "https://i1.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-16-1.png?w=60%25&ssl=1"
        }
      ],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/gambler/",
          "text": "GAMbler"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-396217 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Compositional modeling of plant communities with Dirichlet regression</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">October 19, 2025</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/gambler/\">GAMbler</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/\"> GAMbler</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47--><p>Compositional data, where observations represent proportions that sum to a constant, are ubiquitous in ecology, yet many analysts fall back on problematic approaches like separate binomial models, beta regression on ratios, or worse, standard linear regression on raw proportions. These methods ignore the fundamental constraint that proportions must sum to unity and fail to model the inherent dependencies between components. \n<a href=\"https://doi.org/10.1111/j.2517-6161.1982.tb01195.x\" rel=\"nofollow\" target=\"_blank\">Aitchison’s landmark work</a> established the mathematical foundation for proper compositional analysis, while \n<a href=\"https://link.springer.com/book/10.1007/978-3-642-36809-7\" rel=\"nofollow\" target=\"_blank\">van den Boogaart &amp; Tolosana-Delgado</a> provide comprehensive coverage of modern compositional data analysis methods.</p>\n<p>Here I demonstrate how Dirichlet regression with Gaussian process smooths provides a principled, flexible framework for modeling plant community composition across environmental gradients. I’ll use \n<a href=\"https://link.springer.com/article/10.1007/s11222-022-10167-2\" rel=\"nofollow\" target=\"_blank\">Riutort-Mayol et al’s approximate Hilbert space Gaussian processes</a>, which make these models computationally tractable even for moderately large datasets.</p>\n<h2 id=\"overview-of-this-post\">Overview of this post\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#overview-of-this-post\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>Compositional data appears everywhere in scientific research: microbiome relative abundances in biology, market share distributions in economics, geological mineral compositions in earth sciences, time allocation in behavioral studies, and survey response proportions in social research. Yet despite this ubiquity, many analysts resort to problematic approaches that ignore the fundamental constraint that components must sum to a constant (typically 1 or 100%).</p>\n<p>This post addresses two critical challenges data scientists face with compositional data. Methodologically, I demonstrate why standard approaches like separate Binomial models or Beta regression on ratios fail to capture the inherent dependencies between components, leading to impossible predictions and inefficient inference. If you’ve worked with \n<a href=\"https://ecogambler.netlify.app/blog/autocorrelated-gams/\" rel=\"nofollow\" target=\"_blank\">GAMs for time series analysis</a> like I have, you’ll appreciate how Gaussian processes provide similar flexibility for capturing nonlinear relationships while respecting compositional constraints.</p>\n<p>Computationally, I show how approximate Hilbert space Gaussian processes make sophisticated nonlinear modeling feasible for realistic dataset sizes, overcoming the traditional scalability limitations of GP methods. This builds on the same computational advances that make \n<a href=\"https://ecogambler.netlify.app/blog/distributed-lags-mgcv/\" rel=\"nofollow\" target=\"_blank\">complex hierarchical models</a> practical for everyday use.</p>\n<p>I begin with the mathematical foundation of the Dirichlet distribution and its regression parameterization, emphasizing how brms enables separate linear predictors for each component. Next, I simulate realistic plant community data to demonstrate complex ecological relationships. I then fit Dirichlet regression models with bivariate Gaussian process smooths, extract and visualize predictions across environmental gradients, and interpret the results. Throughout, I emphasize practical implementation details and computational considerations that make this approach accessible for real-world applications.</p>\n<p>By the end, you’ll understand when and how to apply Dirichlet regression to your own compositional data, regardless of scientific domain. Plus, you’ll never again have to explain to a collaborator why your separate logistic regressions predict that 130% of survey respondents chose option A.</p>\n<h2 id=\"the-dirichlet-distribution-and-compositional-constraints\">The Dirichlet distribution and compositional constraints\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#the-dirichlet-distribution-and-compositional-constraints\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>For a <code>\\({\\color{#FDE725}{K}}\\)</code>-component composition <code>\\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, {\\color{#440154}{y_2}}, \\ldots, {\\color{#440154}{y_K}})\\)</code> where <code>\\(\\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}} = 1\\)</code> and <code>\\({\\color{#440154}{y_k}} &gt; 0\\)</code>, the Dirichlet distribution provides a natural model:</p>\n<p><code>$${\\color{#440154}{\\boldsymbol{y}}} \\sim \\text{Dirichlet}({\\color{#31688E}{\\boldsymbol{\\alpha}}})$$</code></p>\n<p>where <code>\\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, {\\color{#31688E}{\\alpha_2}}, \\ldots, {\\color{#31688E}{\\alpha_K}})\\)</code> are positive concentration parameters. The probability density is:</p>\n<p><code>$$f({\\color{#440154}{\\boldsymbol{y}}}|{\\color{#31688E}{\\boldsymbol{\\alpha}}}) = \\frac{\\Gamma({\\color{#31688E}{\\alpha_0}})}{\\prod_{k=1}^{\\color{#FDE725}{K}} \\Gamma({\\color{#31688E}{\\alpha_k}})} \\prod_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}}^{{\\color{#31688E}{\\alpha_k}} - 1}$$</code></p>\n<p>with <code>\\({\\color{#31688E}{\\alpha_0}} = \\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#31688E}{\\alpha_k}}\\)</code> and <code>\\(\\Gamma(\\cdot)\\)</code> the gamma function. The expected proportion for component <code>\\(k\\)</code> is <code>\\(\\mathbb{E}[{\\color{#440154}{y_k}}] = {\\color{#31688E}{\\alpha_k}} / {\\color{#31688E}{\\alpha_0}}\\)</code>, while the precision (inverse variance) increases with <code>\\({\\color{#31688E}{\\alpha_0}}\\)</code>.</p>\n<p>In regression contexts, we model how <code>\\({\\color{#31688E}{\\boldsymbol{\\alpha}}}\\)</code> depends on predictors. The brms package uses a multivariate logit parameterization where the expected proportions <code>\\({\\color{#35B779}{\\boldsymbol{\\mu}}} = \\mathbb{E}[{\\color{#440154}{\\boldsymbol{y}}}]\\)</code> are linked to linear predictors via:</p>\n<p><code>$${\\color{#35B779}{\\mu_j}} = \\frac{\\exp({\\color{#21918C}{\\eta_j}})}{\\sum_{k=1}^{\\color{#FDE725}{K}} \\exp({\\color{#21918C}{\\eta_k}})}$$</code></p>\n<p>where <code>\\({\\color{#21918C}{\\eta_j}}\\)</code> is the linear predictor for category <code>\\(j\\)</code>. For identifiability, one category (typically the last) serves as reference with <code>\\({\\color{#21918C}{\\eta_{\\text{ref}}}} = 0\\)</code>. This means we estimate separate linear predictors for <code>\\({\\color{#FDE725}{K}}-1\\)</code> categories:</p>\n<p><code>$${\\color{#21918C}{\\eta_j}} = \\boldsymbol{x}^T \\boldsymbol{\\beta}_j + f_j(\\boldsymbol{x}), \\quad j = 1, \\ldots, {\\color{#FDE725}{K}}-1$$</code></p>\n<p>where <code>\\(f_j(\\cdot)\\)</code> represents smooth functions (like our Gaussian processes). This approach naturally ensures <code>\\(\\sum_{k=1}^K \\mu_k = 1\\)</code> while allowing each functional group to have its own flexible, nonlinear response to environmental gradients.</p>\n<h3 id=\"parameter-guide-for-dirichlet-regression\">Parameter guide for Dirichlet regression\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#parameter-guide-for-dirichlet-regression\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h3>\n<p>Let me break down what each parameter means in our ecological context, using the same color scheme as above:</p>\n<ul>\n<li>\n<p><strong>Observed composition</strong> <code>\\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, ..., {\\color{#440154}{y_K}})\\)</code>: The actual proportions we observe at each site. In our case, this is a 5-element vector containing the relative abundances of grass, forb, shrub, tree, and lichen. These must sum to 1 and all be positive.</p>\n</li>\n<li>\n<p><strong>Concentration parameters</strong> <code>\\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, ..., {\\color{#31688E}{\\alpha_K}})\\)</code>: These control both the expected proportions and the precision of the distribution. Higher <code>\\({\\color{#31688E}{\\alpha_k}}\\)</code> means functional group <code>\\(k\\)</code> has higher expected proportion. The sum <code>\\({\\color{#31688E}{\\alpha_0}} = \\sum_k {\\color{#31688E}{\\alpha_k}}\\)</code> determines overall precision. Larger values mean less variance around expected proportions.</p>\n</li>\n<li>\n<p><strong>Expected proportions</strong> <code>\\({\\color{#35B779}{\\boldsymbol{\\mu}}} = ({\\color{#35B779}{\\mu_1}}, ..., {\\color{#35B779}{\\mu_K}})\\)</code>: The mean of the Dirichlet distribution, representing expected composition at any given environmental combination. This is what we’re ultimately interested in predicting, how community composition changes across environmental gradients.</p>\n</li>\n<li>\n<p><strong>Linear predictors</strong> <code>\\({\\color{#21918C}{\\eta_j}}\\)</code> for <code>\\(j = 1, ..., {\\color{#FDE725}{K}}-1\\)</code>: The unconstrained predictions before applying the softmax transformation. This is where we place our Gaussian process smooths of elevation and temperature. Note we only model <code>\\({\\color{#FDE725}{K}}-1\\)</code> predictors, with the last category serving as reference.</p>\n</li>\n<li>\n<p><strong>Number of categories</strong> <code>\\({\\color{#FDE725}{K}}\\)</code>: The dimensionality of our compositional data. For plant communities, <code>\\({\\color{#FDE725}{K}}=5\\)</code> functional groups. This could be any number of categories in other applications like market shares, time allocation, or mineral compositions.</p>\n</li>\n</ul>\n<p>The key insight is that the linear predictors <code>\\(\\eta_j\\)</code> are where we incorporate environmental effects through Gaussian process smooths, allowing each functional group to have its own flexible, nonlinear response to environmental gradients while ensuring all predictions respect compositional constraints.</p>\n<h2 id=\"environment-setup\">Environment setup\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#environment-setup\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>This tutorial relies on the following packages:</p>\n<pre>library(brms)            # Bayesian modeling with Stan\nlibrary(tidyverse)       # Data manipulation and visualization  \nlibrary(viridis)         # Color palettes\nlibrary(patchwork)       # Plot composition\nlibrary(waffle)          # Waffle plots for compositional visualization\nlibrary(cowplot)         # Extract and manipulate plot components\n</pre><p>A custom <code>ggplot2</code> theme; feel free to ignore if you have your own plot preferences</p>\n<pre># Set consistent ggplot theme for all visualizations\ntheme_set(\n  theme_classic(\n    base_size = 15, \n    base_family = 'serif'\n  ) +\n  theme(\n    axis.line.x.bottom = element_line(\n      colour = \"black\",\n      size = 1\n    ),\n    axis.line.y.left = element_line(\n      colour = \"black\",\n      size = 1\n    )\n  )\n)\n</pre>\n<h2 id=\"simulating-plant-community-data\">Simulating plant community data\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#simulating-plant-community-data\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>I simulate realistic plant community composition data across elevation and temperature gradients, where five functional groups (grasses, forbs, shrubs, trees, lichens) respond differently to environmental conditions. This simulation captures the ecological reality that different plant types show varying tolerance ranges and optimal growing conditions along environmental gradients—a pattern we’ll later model using Dirichlet regression.</p>\n<pre>simulate_plant_community &lt;- function(\n    n_sites = 60, \n    elevation_range = c(1, 3),\n    temp_range = c(5, 25)\n) {\n  \n  set.seed(42)\n  \n  # Generate elevation gradient with uniform random sampling\n  elevation &lt;- runif(\n    n_sites, \n    elevation_range[1], \n    elevation_range[2]\n  )\n  elev_norm &lt;- (elevation - elevation_range[1]) / \n    (elevation_range[2] - elevation_range[1])\n  \n  # Create realistic temperature-elevation relationship with plateau\n  # Temperature decreases with elevation but plateaus at high elevations\n  plateau_point &lt;- 0.8\n  sharpness &lt;- 2\n  temp_factor &lt;- 0.5 * (1 - tanh(sharpness * (elev_norm - plateau_point)))\n  temperature &lt;- temp_range[1] + \n    (temp_range[2] - temp_range[1]) * temp_factor +\n    rnorm(n_sites, 0, 3)\n  \n  \n  # Define functional group responses to environmental gradients\n  # Each group has distinct ecological preferences that create realistic\n  # community assembly patterns along elevation and temperature gradients\n  \n  # Grasses: peak abundance at mid-elevations with moderate temperatures\n  # Strong quadratic responses in both elevation and temperature\n  grass_logit &lt;- 0.2 + 0.6 * elevation - 0.3 * elevation^2 + \n    0.08 * temperature - 0.004 * temperature^2 + 0.02 * elevation * temperature\n  \n  # Forbs: prefer lower-mid elevations and warmer temperatures\n  # Negative elevation effect with positive temperature response\n  forb_logit &lt;- 0.8 - 0.8 * elevation + 0.12 * temperature - \n    0.005 * temperature^2 + -0.03 * elevation * temperature\n  \n  # Shrubs: adapted to mid-high elevations with moderate-cool temperatures\n  # Positive elevation effect with cool temperature preference\n  shrub_logit &lt;- 0.3 + 0.6 * elevation - 0.2 * elevation^2 + \n    -0.04 * temperature - 0.003 * temperature^2\n  \n  # Trees: dominate at lower elevations and warmer temperatures\n  # Strong negative elevation effects with positive temperature response\n  tree_logit &lt;- 1.2 - 1.5 * elevation - 0.3 * elevation^2 + \n    0.15 * temperature - 0.005 * temperature^2 + 0.04 * elevation * temperature\n  \n  # Lichens: alpine specialists preferring high elevation, cool temperatures\n  # Strong positive elevation effect with negative temperature preference\n  lichen_logit &lt;- -1.8 + 1.2 * elevation + 0.1 * elevation^2 + \n    -0.1 * temperature + 0.003 * temperature^2\n  \n  # Apply softmax transformation to ensure probabilities sum to 1\n  # This converts unconstrained logits to valid probability simplex\n  logits &lt;- cbind(\n    grass_logit, \n    forb_logit, \n    shrub_logit, \n    tree_logit, \n    lichen_logit\n  )\n  exp_logits &lt;- exp(logits)\n  probs &lt;- exp_logits / rowSums(exp_logits)\n  \n  # Set constant precision parameter for all sites\n  # This keeps the focus on mean compositional responses\n  precision &lt;- exp(3)\n  \n  # Generate Dirichlet-distributed compositions\n  # Each site gets alpha parameters = expected proportions * precision\n  compositions &lt;- matrix(NA, nrow = n_sites, ncol = 5)\n  for (i in 1:n_sites) {\n    alpha_params &lt;- probs[i, ] * precision\n    compositions[i, ] &lt;- brms::rdirichlet(1, alpha_params)\n  }\n  \n  # Add small offset and renormalize to ensure no exact zeros\n  # Dirichlet distribution requires all components &gt; 0\n  offset &lt;- 0.001\n  compositions &lt;- compositions + offset\n  compositions &lt;- compositions / rowSums(compositions)\n  \n  # Return structured data frame with environmental predictors and compositions\n  data.frame(\n    site_id = 1:n_sites,\n    elevation = elevation,\n    temperature = temperature, \n    grass = compositions[, 1],\n    forb = compositions[, 2],\n    shrub = compositions[, 3], \n    tree = compositions[, 4],\n    lichen = compositions[, 5]\n  )\n}\n\nplant_data &lt;- simulate_plant_community()\n\n# Define functional groups for consistent use across analysis\nfunctional_groups &lt;- c(\"forb\", \"grass\", \"lichen\", \"shrub\", \"tree\")\n</pre><p>Let’s verify our simulated compositions respect the fundamental constraint that proportions must sum to unity:</p>\n<pre># Verify compositions sum to 1 (within numerical precision)\nrowSums(plant_data[, functional_groups]) |&gt; \n  summary()\n\n##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n##       1       1       1       1       1       1\n</pre>\n<h2 id=\"exploratory-visualization\">Exploratory visualization\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#exploratory-visualization\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>These exploratory plots serve a crucial purpose before diving into modeling. The top panel shows how elevation and temperature covary in our simulated landscape—this realistic temperature lapse rate will affect how we interpret subsequent model results. The bottom panels reveal the raw compositional patterns that our Dirichlet regression will attempt to capture with smooth functions.</p>\n<pre># Visualize the environmental relationship between elevation and temperature\n# This shows the realistic temperature-elevation gradient we simulated\np1 &lt;- ggplot(\n  plant_data, \n  aes(elevation, temperature)\n) +\n  geom_point(\n    alpha = 0.6, \n    size = 2\n  ) +\n  geom_smooth(\n    method = \"loess\", \n    se = TRUE, \n    color = \"darkred\", \n    fill = \"darkred\"\n  ) +\n  labs(\n    x = \"Elevation (km)\", \n    y = \"Temperature (°C)\"\n  )\n\n# Reshape data to long format for plotting all functional groups together\n# This transformation allows us to visualize compositional changes efficiently\nplant_long &lt;- plant_data |&gt;\n  dplyr::select(\n    elevation, \n    temperature, \n    grass:lichen\n  ) |&gt;\n  tidyr::pivot_longer(\n    grass:lichen, \n    names_to = \"functional_group\", \n    values_to = \"proportion\"\n  )\n\n# Visualize how community composition changes along elevation gradient\n# Each functional group shows distinct elevational preferences\np2 &lt;- ggplot(\n  plant_long, \n  aes(\n    elevation, \n    proportion, \n    color = functional_group\n  )\n) +\n  geom_point(alpha = 0.4) +\n  geom_smooth(\n    method = \"loess\", \n    se = FALSE, \n    linewidth = 1\n  ) +\n  scale_color_viridis_d(name = \"Functional\\nGroup\") +\n  lims(y = c(0, 1)) +\n  labs(\n    x = \"Elevation (km)\", \n    y = \"Relative abundance\"\n  )\n\n# Visualize how community composition changes along temperature gradient\n# Temperature effects complement elevation patterns in shaping communities\np3 &lt;- ggplot(\n  plant_long, \n  aes(\n    temperature, \n    proportion, \n    color = functional_group\n  )\n) +\n  geom_point(alpha = 0.4) +\n  geom_smooth(\n    method = \"loess\", \n    se = FALSE, \n    linewidth = 1\n  ) +\n  scale_color_viridis_d(name = \"Functional\\nGroup\") +\n  lims(y = c(0, 1)) +\n  labs(\n    x = \"Temperature (°C)\", \n    y = \"\"\n  )\n\n# Create a more compact legend with smaller text and tighter spacing\np2_compact_legend &lt;- p2 + \n  theme(\n    legend.title = element_text(size = 9),\n    legend.text = element_text(size = 8),\n    legend.key.size = unit(0.8, \"lines\"),\n    legend.margin = margin(0, 0, 0, 0),\n    legend.box.margin = margin(0, 0, 0, 5)\n  )\n\n# Extract the compact legend\nlegend &lt;- cowplot::get_legend(p2_compact_legend)\n\n# Remove legends from both composition plots\np2_no_legend &lt;- p2 + theme(legend.position = \"none\")\np3_no_legend &lt;- p3 + theme(legend.position = \"none\")\n\n# Combine bottom plots first, then add legend\nbottom_row &lt;- (p2_no_legend | p3_no_legend | legend) + \n  patchwork::plot_layout(widths = c(9, 9, 2))\n\n# Combine top and bottom\np1 / bottom_row\n</pre><img data-lazy-src=\"https://i2.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-6-1.png?w=60%25&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" style=\"display: block; margin: auto;\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i2.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-6-1.png?w=60%25&amp;ssl=1\" style=\"display: block; margin: auto;\"/></noscript>\n<h2 id=\"dirichlet-regression-with-gaussian-processes\">Dirichlet regression with Gaussian processes\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#dirichlet-regression-with-gaussian-processes\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>Now comes the core modeling step: fitting Dirichlet regression with bivariate Gaussian process smooths. But first, let me explain why Gaussian processes are particularly well-suited for this ecological problem.</p>\n<p>Why choose Gaussian processes over other smoothing methods? Standard approaches like polynomial regression or splines make strong assumptions about functional form. Polynomials assume global relationships, while splines assume local smoothness within predefined knots. Gaussian processes, by contrast, are non-parametric: they let the data determine the appropriate level of smoothness at each point in covariate space. This flexibility is crucial for ecological data where relationships might be smooth in some regions (gradual transitions between communities) but abrupt in others (sharp ecotones at treelines).</p>\n<p>Traditional GPs face a computational challenge: they scale as O(n³) with sample size, making them impractical for datasets with more than 500 observations. The approximate Hilbert space Gaussian processes implemented in <code>brms</code> use basis function expansions that reduce this to O(n), enabling GP flexibility on realistic ecological datasets. This isn’t just a computational nicety, it opens up sophisticated nonparametric modeling for the sample sizes we actually encounter in field studies.</p>\n<p>The compositional modeling advantage here is that we can model each functional group’s response surface simultaneously while respecting compositional constraints. Unlike separate GAMs for each species that might predict impossible total abundances, Dirichlet regression with GPs ensures all predictions lie on the probability simplex.</p>\n<p>For the GP kernel, I use the exponential covariance function rather than the more common squared exponential (RBF) kernel. The exponential kernel is computationally more efficient in the Hilbert space approximation while still capturing smooth nonlinear relationships. This makes the difference between a model that fits in minutes versus hours for ecological datasets.</p>\n<pre># Prepare response matrix for Dirichlet regression\n# Each row represents a site's complete community composition\nY &lt;- with(\n  plant_data, \n  cbind(\n    grass, \n    forb, \n    shrub, \n    tree, \n    lichen\n  )\n)\nplant_data$Y &lt;- Y\n\n# Verify no zeros exist (Dirichlet distribution requires positive values)\n# Our simulation ensures this, but it's good practice to check\nmin(Y)\n\n# Specify model formula with bivariate Gaussian process smooth\n# k=10 basis functions provide good balance between flexibility and efficiency\n# c=5/4 sets the boundary factor for the approximation\nmodel_formula &lt;- bf(\n  Y ~ gp(\n    elevation, \n    temperature, \n    k = 10, \n    c = 5/4, \n    cov = \"exponential\"\n  )\n)\n\n# Fit Dirichlet regression model using Stan via brms\n# This estimates separate GP surfaces for each functional group\nplant_model &lt;- brm(\n  model_formula,\n  data = plant_data,\n  family = brms::dirichlet(),\n  chains = 4,\n  iter = 2000,\n  warmup = 1000,\n  cores = 4,\n  seed = 42,\n  backend = \"cmdstanr\",\n  silent = 2\n)\n</pre>\n<h2 id=\"model-predictions-and-effects\">Model predictions and effects\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#model-predictions-and-effects\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>With our fitted model, we can now extract predictions across environmental gradients to understand precisely how community composition responds to elevation and temperature. This is where we transition from model fitting to interpretation, and where understanding different types of posterior predictions becomes crucial.</p>\n<p>I use <code>posterior_epred()</code> rather than <code>posterior_predict()</code> because I want the expected values of the posterior predictive distribution, not new random draws from it. Andrew Heiss has an \n<a href=\"https://www.andrewheiss.com/blog/2022/09/26/guide-visualizing-types-posteriors/\" rel=\"nofollow\" target=\"_blank\">excellent guide to visualizing different types of posteriors</a> that explains these distinctions clearly. For compositional data, <code>posterior_epred()</code> gives us the model’s best estimate of expected proportions at each environmental combination, while <code>posterior_predict()</code> would add additional Dirichlet sampling variation on top. Since we want to understand the underlying functional relationships rather than prediction intervals for new observations, <code>posterior_epred()</code> is the right choice.</p>\n<p>I’ll create three complementary prediction scenarios: univariate effects along each environmental axis (holding the other at its mean), plus bivariate surfaces showing interactive effects. The prediction strategy here is key to interpretation. I create three different prediction grids that answer different ecological questions:</p>\n<pre># Create elevation gradient with temperature held at mean for marginal effects\n# This asks: \"How does composition change with elevation at average temperature?\"\nelev_grid &lt;- data.frame(\n  elevation = seq(\n    min(plant_data$elevation), \n    max(plant_data$elevation), \n    length.out = 100\n  ),\n  temperature = mean(plant_data$temperature)\n)\n\n# Create temperature gradient with elevation held at mean for marginal effects\n# This asks: \"How does composition change with temperature at average elevation?\"\ntemp_grid &lt;- data.frame(\n  elevation = mean(plant_data$elevation),\n  temperature = seq(\n    min(plant_data$temperature), \n    max(plant_data$temperature), \n    length.out = 100\n  )\n)\n\n# Create bivariate prediction grid for interactive response surfaces\n# This asks: \"How does composition vary across the full elevation-temperature space?\"\n# Coarser 20x20 grid (400 points) balances detail with computational efficiency\nelev_seq &lt;- seq(\n  min(plant_data$elevation), \n  max(plant_data$elevation), \n  length.out = 20\n)\ntemp_seq &lt;- seq(\n  min(plant_data$temperature), \n  max(plant_data$temperature), \n  length.out = 20\n)\nbivariate_grid &lt;- expand.grid(\n  elevation = elev_seq, \n  temperature = temp_seq\n)\n\n# Extract posterior predictions from fitted Dirichlet model\n# posterior_epred gives expected values (means) of predictive distribution\n# rather than new random samples, perfect for understanding relationships\nelev_post_pred &lt;- posterior_epred(\n  plant_model, \n  newdata = elev_grid, \n  ndraws = 500\n)\ntemp_post_pred &lt;- posterior_epred(\n  plant_model, \n  newdata = temp_grid, \n  ndraws = 500\n)\nbivar_post_pred &lt;- posterior_epred(\n  plant_model, \n  newdata = bivariate_grid, \n  ndraws = 500\n)\n</pre><p>Now I need to convert these posterior prediction arrays into something we can actually plot. The <code>posterior_epred</code> function returns a three-dimensional array: 500 posterior draws × 100 prediction points × 5 functional groups. This represents our uncertainty about expected proportions at each environmental combination.</p>\n<pre># Function to calculate summary statistics from posterior prediction draws\n# This converts arrays of posterior samples into plottable summaries\ncalc_pred_summary &lt;- function(post_draws, grid_data) {\n  n_cats &lt;- dim(post_draws)[3]\n  \n  # Validate dimensions match expected functional groups\n  # This catches potential mismatches between model and data\n  if (n_cats != length(functional_groups)) {\n    stop(\n      \"Number of categories in posterior draws (\", n_cats, \n      \") doesn't match functional groups (\", length(functional_groups), \")\"\n    )\n  }\n  \n  result &lt;- grid_data\n  \n  # Calculate summary statistics for each functional group\n  # Mean captures central tendency, quantiles provide uncertainty\n  for (i in seq_along(functional_groups)) {\n    cat_name &lt;- functional_groups[i]\n    cat_draws &lt;- post_draws[, , i]\n    \n    # Calculate posterior mean and 95% credible intervals efficiently\n    # This summarizes 500 posterior draws into point estimates + uncertainty\n    stats &lt;- apply(\n      cat_draws, \n      2, \n      function(x) {\n        c(\n          mean = mean(x), \n          lower = quantile(x, 0.025, names = FALSE),\n          upper = quantile(x, 0.975, names = FALSE)\n        )\n      }\n    )\n    \n    # Assign summary statistics to result dataframe with clear naming\n    result[[paste0(cat_name, \"_mean\")]] &lt;- stats[\"mean\", ]\n    result[[paste0(cat_name, \"_lower\")]] &lt;- stats[\"lower\", ]\n    result[[paste0(cat_name, \"_upper\")]] &lt;- stats[\"upper\", ]\n  }\n  \n  return(result)\n}\n\n# Apply summary function to convert posterior arrays to dataframes\nelev_summary &lt;- calc_pred_summary(elev_post_pred, elev_grid)\ntemp_summary &lt;- calc_pred_summary(temp_post_pred, temp_grid)\nbivar_summary &lt;- calc_pred_summary(bivar_post_pred, bivariate_grid)\n</pre>\n<h2 id=\"marginal-effects-univariate-environmental-responses\">Marginal effects: univariate environmental responses\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#marginal-effects-univariate-environmental-responses\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>Marginal effects plots reveal how each functional group responds to single environmental gradients while holding other variables constant. These plots answer questions like “How does community composition change as I walk up an elevation transect at average temperature?” The ribbons around each line represent our uncertainty about these relationships. Wider ribbons indicate less confidence, typically where we have fewer data points or the GP is interpolating across larger gaps.</p>\n<pre># Function to create marginal effects plots for any environmental variable\n# This unified approach ensures consistent styling across all visualizations\ncreate_marginal_plot &lt;- function(pred_data, x_var, x_label) {\n  # Reshape prediction data from wide to long format for ggplot\n  # Extract only the focal variable and all functional group statistics\n  plot_data &lt;- pred_data |&gt;\n    dplyr::select(\n      dplyr::all_of(x_var), \n      dplyr::matches(\n        paste0(\n          \"(\", \n          paste(functional_groups, collapse = \"|\"), \n          \")_(mean|lower|upper)$\"\n        )\n      )\n    ) |&gt;\n    tidyr::pivot_longer(\n      cols = -dplyr::all_of(x_var),\n      names_to = c(\"functional_group\", \"stat\"),\n      names_pattern = \"(.+)_(mean|lower|upper)$\",\n      values_to = \"value\"\n    ) |&gt;\n    tidyr::pivot_wider(\n      names_from = stat, \n      values_from = value\n    )\n  \n  # Create ggplot with ribbon for uncertainty and line for mean response\n  # Consistent styling across all marginal effects plots\n  ggplot(\n    plot_data, \n    aes(\n      x = .data[[x_var]], \n      y = mean, \n      color = functional_group, \n      fill = functional_group\n    )\n  ) +\n    geom_ribbon(\n      aes(\n        ymin = lower, \n        ymax = upper\n      ), \n      alpha = 0.2, \n      color = NA\n    ) +\n    geom_line(linewidth = 1.2) +\n    scale_color_viridis_d(\n      name = \"Functional\\nGroup\", \n      option = \"D\"\n    ) +\n    scale_fill_viridis_d(\n      name = \"Functional\\nGroup\", \n      option = \"D\"\n    ) +\n    labs(\n      x = x_label, \n      y = \"Predicted Proportion\"\n    ) +\n    theme(legend.position = \"right\")\n}\n\n# Generate marginal effects plots\np_elevation &lt;- create_marginal_plot(\n  elev_summary, \n  \"elevation\", \n  \"Elevation (km)\"\n)\np_temperature &lt;- create_marginal_plot(\n  temp_summary, \n  \"temperature\", \n  \"Temperature (°C)\"\n)\n\n# Display elevation effects\np_elevation\n</pre><img data-lazy-src=\"https://i1.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-10-1.png?w=60%25&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" style=\"display: block; margin: auto;\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i1.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-10-1.png?w=60%25&amp;ssl=1\" style=\"display: block; margin: auto;\"/></noscript>\n<pre># Display temperature effects\np_temperature\n</pre><img data-lazy-src=\"https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-11-1.png?w=60%25&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" style=\"display: block; margin: auto;\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-11-1.png?w=60%25&amp;ssl=1\" style=\"display: block; margin: auto;\"/></noscript>\n<p>These marginal effects reveal clear ecological zonation patterns. The elevation responses show grasses peaking around 1.5km elevation, consistent with montane grassland ecology. Trees decline steadily with elevation from maximum abundance at low elevations, capturing realistic treeline dynamics. Lichens show the opposite pattern, with minimal presence below 2km but increasing dramatically at high elevations where harsh conditions exclude other functional groups.</p>\n<p>The temperature responses show equally complex patterns. Lichens dominate at the coldest temperatures (~8°C), decline at moderate temperatures, then increase again toward warmer conditions, creating a bimodal response. Grasses show a complex multimodal temperature response with peaks around 11°C and 20°C. Trees exhibit a strong positive response to warming, reaching maximum abundance around 25°C. Forbs and shrubs remain relatively stable across temperature gradients.</p>\n<h2 id=\"visualizing-predicted-communities-with-waffle-plots\">Visualizing predicted communities with waffle plots\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#visualizing-predicted-communities-with-waffle-plots\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>Before diving into complex bivariate surfaces, let’s visualize what these predicted communities actually look like at specific elevations. Waffle plots provide an intuitive representation where each square represents an individual plant, making abstract proportions concrete and interpretable.</p>\n<pre># Prepare data for multiple elevations\nelev_values &lt;- c(1.2, 1.6, 2.0, 2.4, 2.8, 3.2)\ntotal_plants &lt;- 50\n\n# Build waffle data for all elevations\nall_waffle_data &lt;- NULL\n\nfor (elev in elev_values) {\n  # Prepare prediction point at mean temperature\n  pred_point &lt;- data.frame(\n    elevation = elev,\n    temperature = mean(plant_data$temperature)\n  )\n  \n  # Get predictions\n  pred &lt;- posterior_epred(\n    plant_model, \n    newdata = pred_point, \n    ndraws = 100\n  )\n  \n  # Calculate mean proportions\n  mean_props &lt;- apply(pred[, 1, ], 2, mean)\n  \n  # Convert to counts ensuring sum equals total_plants\n  counts &lt;- round(mean_props * total_plants)\n  if (sum(counts) != total_plants) {\n    diff &lt;- total_plants - sum(counts)\n    max_idx &lt;- which.max(counts)\n    counts[max_idx] &lt;- counts[max_idx] + diff\n  }\n  \n  # Create expanded data for this elevation (one row per plant)\n  for (i in seq_along(functional_groups)) {\n    if (counts[i] &gt; 0) {\n      elev_data &lt;- data.frame(\n        elevation = factor(\n          paste0(elev, \"km\"), \n          levels = paste0(elev_values, \"km\")\n        ),\n        functional_group = factor(\n          functional_groups[i], \n          levels = c(\"forb\", \"grass\", \"lichen\", \"shrub\", \"tree\")\n        ),\n        count = rep(1, counts[i])\n      )\n      all_waffle_data &lt;- rbind(all_waffle_data, elev_data)\n    }\n  }\n}\n\n# Create faceted waffle plot\nall_waffle_data |&gt;\n  ggplot(\n    aes(\n      fill = functional_group, \n      values = count\n    )\n  ) +\n  waffle::geom_waffle(\n    n_rows = 10,\n    size = 0.3,\n    colour = \"white\",\n    flip = TRUE,\n    make_proportional = FALSE\n  ) +\n  facet_wrap(\n    ~ elevation, \n    nrow = 2\n  ) +\n  scale_fill_viridis_d(\n    name = \"Functional Group\",\n    option = \"D\"\n  ) +\n  coord_equal() +\n  theme_minimal(base_size = 15, base_family = 'serif') +\n  theme(\n    legend.position = \"bottom\",\n    legend.direction = \"horizontal\",\n    strip.background = element_blank(),\n    panel.grid = element_blank(),\n    panel.background = element_blank(),\n    axis.text = element_blank(),\n    axis.title = element_blank(),\n    axis.ticks = element_blank()\n  ) +\n  guides(\n    fill = guide_legend(\n      nrow = 1,\n      title.position = \"top\",\n      title.hjust = 0.5\n    )\n  )\n</pre><img data-lazy-src=\"https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-12-1.png?w=60%25&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" style=\"display: block; margin: auto;\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-12-1.png?w=60%25&amp;ssl=1\" style=\"display: block; margin: auto;\"/></noscript>\n<p>These waffle plots make the compositional changes tangible. At low elevations (1.2km), grasses (blue squares) dominate with trees (yellow) as codominants and small amounts of forbs (purple). Moving upslope to 1.6km, grasses remain dominant but trees and shrubs (green) become more prominent. At 2.0km, we see the beginning of the major transition as lichens (teal) start appearing significantly alongside the still-dominant grasses. By 2.4km, lichens become the dominant functional group with grasses remaining substantial. At the highest elevation (3.2km), lichens overwhelmingly dominate the alpine community. Each square represents an individual plant out of 50 total, so readers can literally count how community composition shifts from grass-tree lowlands to lichen-dominated alpine zones, much more intuitive than abstract proportions.</p>\n<h2 id=\"bivariate-surfaces-capturing-environmental-interactions\">Bivariate surfaces: capturing environmental interactions\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#bivariate-surfaces-capturing-environmental-interactions\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>While marginal effects are useful, they miss a crucial aspect of ecological reality: environmental variables interact. Temperature and elevation don’t operate independently. Their combined effects often differ from what we’d predict by simply adding their separate influences. Bivariate response surfaces reveal these interactions by showing how functional groups respond across the full environmental space.</p>\n<pre># Function to create bivariate response surface for focal functional group\n# Shows how group abundance varies across both environmental dimensions\ncreate_bivariate_plot &lt;- function(pred_data, focal_group = \"grass\") {\n  # Validate that focal group is one of the modeled functional groups\n  if (!focal_group %in% functional_groups) {\n    stop(\n      \"focal_group must be one of: \", \n      paste(functional_groups, collapse = \", \")\n    )\n  }\n  \n  # Construct column name and legend title for focal group\n  col_name &lt;- paste0(focal_group, \"_mean\")\n  legend_title &lt;- stringr::str_to_title(\n    paste(focal_group, \"\\nProportion\")\n  )\n  \n  # Create response surface plot with raster and contour overlay\n  ggplot(\n    pred_data, \n    aes(\n      x = elevation, \n      y = temperature\n    )\n  ) +\n    geom_raster(\n      aes(fill = .data[[col_name]]), \n      interpolate = TRUE\n    ) +\n    geom_contour(\n      aes(z = .data[[col_name]]), \n      color = \"white\", \n      alpha = 0.6, \n      size = 0.3\n    ) +\n    scale_fill_viridis_c(\n      name = legend_title, \n      option = \"plasma\"\n    ) +\n    labs(\n      x = \"Elevation (km)\", \n      y = \"Temperature (°C)\"\n    )\n}\n\n# Generate bivariate surface plots for key functional groups\np_bivariate_grass &lt;- create_bivariate_plot(\n  bivar_summary, \n  \"grass\"\n)\np_bivariate_tree &lt;- create_bivariate_plot(\n  bivar_summary, \n  \"tree\"\n)\n\n# Display grass response surface\np_bivariate_grass\n</pre><img data-lazy-src=\"https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-13-1.png?w=60%25&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" style=\"display: block; margin: auto;\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-13-1.png?w=60%25&amp;ssl=1\" style=\"display: block; margin: auto;\"/></noscript>\n<pre># Display tree response surface\np_bivariate_tree\n</pre><img data-lazy-src=\"https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-14-1.png?w=60%25&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" style=\"display: block; margin: auto;\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i0.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-14-1.png?w=60%25&amp;ssl=1\" style=\"display: block; margin: auto;\"/></noscript>\n<p>These bivariate surfaces reveal interactions that marginal plots miss entirely. The grass surface shows a clear “sweet spot” around 1.2-1.4km elevation and 12-15°C temperature, not just peak abundance at mid-elevation, but specifically at this elevation-temperature combination. The tree surface demonstrates highest abundances at the lowest elevations (1.0km) combined with the warmest temperatures (25°C), with tree proportions declining steeply as both elevation increases and temperatures cool, perfectly capturing treeline ecology.</p>\n<h2 id=\"model-validation-checking-our-compositional-residuals\">Model validation: checking our compositional residuals\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#model-validation-checking-our-compositional-residuals\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>Before diving into ecological interpretation, let’s validate that our Dirichlet regression actually captures the patterns in our data. This step is crucial but often skipped in compositional analyses. I’ll show you how to compute proper residuals for compositional data and why traditional approaches fail.</p>\n<p>Computing residuals for compositional data isn’t straightforward. You can’t just subtract predicted from observed proportions because this ignores the constraint that components sum to unity and the unique variance structure of the Dirichlet distribution. Following \n<a href=\"https://github.com/maiermarco/DirichletReg\" rel=\"nofollow\" target=\"_blank\">Maier’s approach in the DirichletReg package</a>, we need to account for both the mean-variance relationship and the precision parameter.</p>\n<p>The key insight is that for Dirichlet regression, the variance of each component depends on both its expected proportion μ and the overall precision φ:</p>\n<p><code>$$\\text{Var}(Y_k) = \\frac{\\mu_k(1-\\mu_k)}{1+\\phi}$$</code></p>\n<p>This formula captures two important features: components with intermediate proportions (μ ≈ 0.5) have higher variance than those near 0 or 1, and higher precision φ reduces variance across all components. Traditional Pearson residuals ignore this structure entirely.</p>\n<pre># Extract fitted values from our Dirichlet model\n# brms returns a 3D array: [sites, statistics, components]\nfitted_values &lt;- fitted(plant_model)\nmu &lt;- fitted_values[, \"Estimate\", ]  # Extract just the expected proportions\n\n# Extract precision parameter from posterior samples\n# In brms, phi controls the Dirichlet precision\nphi_samples &lt;- as_draws_df(plant_model) |&gt;\n  dplyr::select(dplyr::contains(\"phi\"))\nphi_mean &lt;- mean(phi_samples[[1]])\n\n# Observed compositions as matrix\nY &lt;- as.matrix(plant_data[, functional_groups])\n\n# Calculate proper Dirichlet variance structure\n# This accounts for both mean-variance relationship AND precision\nV &lt;- mu * (1 - mu) / (1 + phi_mean)\n\n# Standardized residuals: (observed - expected) / sqrt(variance)\n# These should be approximately normal if our model fits well\npearson_residuals &lt;- (Y - mu) / sqrt(V)\n</pre><p>Now let’s examine whether our residuals show problematic patterns. Well-behaved residuals should be roughly normal and show no systematic trends across environmental gradients. If we see strong patterns, it suggests our model is missing important relationships.</p>\n<pre># Create Q-Q plots to check if standardized residuals are approximately normal\n# Reshape residuals to long format for easy plotting\nresidual_long &lt;- pearson_residuals |&gt;\n  as.data.frame() |&gt;\n  dplyr::mutate(site_id = 1:nrow(pearson_residuals)) |&gt;\n  tidyr::pivot_longer(\n    cols = -site_id,\n    names_to = \"functional_group\",\n    values_to = \"residual\"\n  )\n\n# Q-Q plot comparing residuals to theoretical normal distribution\nggplot(\n  residual_long,\n  aes(sample = residual, color = functional_group)\n) +\n  stat_qq(alpha = 0.6) +\n  stat_qq_line() +\n  facet_wrap(~ functional_group, scales = \"free\") +\n  scale_color_viridis_d(name = \"Functional\\nGroup\") +\n  labs(\n    x = \"Theoretical quantiles\",\n    y = \"Sample quantiles\"\n  ) +\n  theme(legend.position = \"none\")\n</pre><img data-lazy-src=\"https://i1.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-16-1.png?w=60%25&amp;ssl=1\" data-recalc-dims=\"1\" src=\"https://www.r-bloggers.com/wp-content/plugins/jetpack/modules/lazy-images/images/1x1.trans.gif\" style=\"display: block; margin: auto;\"/><noscript><img data-recalc-dims=\"1\" src=\"https://i1.wp.com/ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-16-1.png?w=60%25&amp;ssl=1\" style=\"display: block; margin: auto;\"/></noscript>\n<p>These Q-Q plots reveal how well our model captures the data structure for each functional group. Points should roughly follow the diagonal line if residuals are normally distributed. What we see here is largely reassuring: most functional groups show reasonably normal residual behavior, though some groups like forbs and lichens exhibit moderate deviations from normality in the tails.</p>\n<p>These moderate deviations aren’t necessarily problematic. They likely reflect the ecological reality that some sites have genuinely unusual community compositions that any model would struggle to predict perfectly. The Gaussian process smooths are doing well at capturing the main compositional patterns while the Dirichlet structure ensures all predictions respect compositional constraints.</p>\n<p>Compare this to what happens with naive approaches that ignore compositional constraints. If we fit separate binomial models for each functional group, we often get predicted total abundances that exceed 100%—a mathematical impossibility that reveals fundamental model misspecification. Our Dirichlet approach automatically prevents such nonsensical predictions while providing flexible nonlinear responses through Gaussian processes.</p>\n<h2 id=\"model-interpretation-and-ecological-insights\">Model interpretation and ecological insights\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#model-interpretation-and-ecological-insights\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>The Dirichlet regression successfully captures the complex, nonlinear relationships between environmental gradients and plant community composition. What makes this particularly satisfying is how the model recovers the ecological patterns we built into our simulation while respecting compositional constraints.</p>\n<p>What’s particularly elegant about this approach is how the compositional constraint enforcement works seamlessly. Unlike separate binomial models that could predict impossible total abundances exceeding 100%, our Dirichlet regression automatically ensures all predictions sum to unity. This isn’t just a statistical nicety, it reflects the biological reality that plant communities partition available space and resources.</p>\n<p>The approximate Hilbert space Gaussian processes deserve special mention here. Traditional GP methods would be computationally prohibitive for this dataset size, but the Hilbert space approximation maintains the flexibility to capture nonlinear responses while scaling to realistic sample sizes.</p>\n<h2 id=\"take-home-messages\">Take-home messages\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#take-home-messages\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>Dirichlet regression with Gaussian process smooths offers a principled framework for compositional data that:</p>\n<ul>\n<li>Respects the mathematical constraints of compositional data</li>\n<li>Models dependencies between components naturally</li>\n<li>Provides flexible, nonlinear relationships via Gaussian processes</li>\n<li>Scales computationally via approximate Hilbert space methods</li>\n<li>Generates predictions that automatically satisfy compositional constraints</li>\n</ul>\n<p>For data scientists working with compositional data, whether ecological communities, market shares, time allocation, or survey responses, this framework offers a principled alternative to problematic approaches. The combination of Dirichlet regression with approximate Gaussian processes provides both statistical rigor and computational tractability. Most importantly, it generates predictions that respect the mathematical structure of your data, avoiding the impossible predictions that plague naive approaches.</p>\n<p>I’d encourage you to try this approach on your own compositional datasets. The <code>brms</code> package makes implementation remarkably straightforward, and the computational efficiency of approximate GPs means you can fit these models on realistic dataset sizes without specialized hardware. The investment in learning this framework pays dividends in more reliable predictions and deeper insights into how your compositions respond to predictors.  Plus, you’ll never again have to explain to a collaborator why your separate logistic regressions predict that 130% of survey respondents chose option A. If you’re new to Bayesian modeling in ecology, I cover \n<a href=\"https://ecogambler.netlify.app/talk/\" rel=\"nofollow\" target=\"_blank\">getting started with mvgam and brms for ecological data</a> in many of my talks.</p>\n<h2 id=\"further-reading\">Further reading\n  <a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/#further-reading\" rel=\"nofollow\" target=\"_blank\"><svg aria-hidden=\"true\" class=\"anchor-symbol\" height=\"26\" viewbox=\"0 0 22 22\" width=\"26\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M0 0h24v24H0z\" fill=\"currentColor\"></path>\n<path d=\"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z\"></path>\n</svg></a>\n</h2>\n<p>The following papers and resources offer useful material for working with compositional data analysis and Gaussian processes</p>\n<p>Aitchison, J. (1986). \n<a href=\"https://books.google.com/books/about/The_Statistical_Analysis_of_Compositiona.html?id=b_2YQgAACAAJ\" rel=\"nofollow\" target=\"_blank\">The Statistical Analysis of Compositional Data</a>. <em>Chapman and Hall</em>, London.</p>\n<p>van den Boogaart, K. G., &amp; Tolosana-Delgado, R. (2013). \n<a href=\"https://doi.org/10.1007/978-3-642-36809-7\" rel=\"nofollow\" target=\"_blank\">Analyzing compositional data with R</a>. <em>Springer</em>.</p>\n<p>Bürkner, P. C. (2017). \n<a href=\"https://doi.org/10.18637/jss.v080.i01\" rel=\"nofollow\" target=\"_blank\">brms: An R package for Bayesian multilevel models using Stan</a>. <em>Journal of Statistical Software</em>, 80(1), 1-28.</p>\n<p>Bürkner, P. C. (2018). \n<a href=\"https://doi.org/10.32614/RJ-2018-017\" rel=\"nofollow\" target=\"_blank\">Advanced Bayesian multilevel modeling with the R package brms</a>. <em>The R Journal</em>, 10(1), 395-411.</p>\n<p>Hijazi, R. H., &amp; Jernigan, R. W. (2009). \n<a href=\"https://www.researchgate.net/publication/228576713_Modelling_compositional_data_using_Dirichlet_regression_models\" rel=\"nofollow\" target=\"_blank\">Modelling compositional data using Dirichlet regression models</a>. <em>Journal of Applied Probability &amp; Statistics</em>, 4(1), 77-91.</p>\n<p>Maier, M. J. (2014). \n<a href=\"https://epub.wu.ac.at/4077/\" rel=\"nofollow\" target=\"_blank\">DirichletReg: Dirichlet regression for compositional data in R</a>. <em>Research Report Series</em>, Department of Statistics and Mathematics, 125.</p>\n<p>Rasmussen, C. E., &amp; Williams, C. K. I. (2006). \n<a href=\"http://gaussianprocess.org/gpml/\" rel=\"nofollow\" target=\"_blank\">Gaussian processes for machine learning</a>. <em>MIT Press</em>.</p>\n<p>Riutort-Mayol, G., Bürkner, P. C., Andersen, M. R., Solin, A., &amp; Vehtari, A. (2023). \n<a href=\"https://doi.org/10.1007/s11222-022-10167-2\" rel=\"nofollow\" target=\"_blank\">Practical Hilbert space approximate Bayesian Gaussian processes for probabilistic programming</a>. <em>Statistics and Computing</em>, 33(1), 17.</p>\n<p>Thorson, J. T., Ianelli, J. N., Larsen, E. A., Ries, L., Scheuerell, M. D., Szuwalski, C., &amp; Zipkin, E. F. (2016). \n<a href=\"https://doi.org/10.1111/geb.12464\" rel=\"nofollow\" target=\"_blank\">Joint dynamic species distribution models: a tool for community ordination and spatio-temporal monitoring</a>. <em>Global Ecology and Biogeography</em>, 25(9), 1144-1158.</p>\n<p>Warton, D. I., Blanchet, F. G., O’Hara, R. B., Ovaskainen, O., Taskinen, S., Walker, S. C., &amp; Hui, F. K. (2015). \n<a href=\"https://doi.org/10.1016/j.tree.2015.09.007\" rel=\"nofollow\" target=\"_blank\">So many variables: joint modeling in community ecology</a>. <em>Trends in Ecology &amp; Evolution</em>, 30(12), 766-779.</p>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://ecogambler.netlify.app/blog/plant-community-dirichlet/\"> GAMbler</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
      "main_text": "Compositional modeling of plant communities with Dirichlet regression\nPosted on\nOctober 19, 2025\nby\nGAMbler\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nGAMbler\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nCompositional data, where observations represent proportions that sum to a constant, are ubiquitous in ecology, yet many analysts fall back on problematic approaches like separate binomial models, beta regression on ratios, or worse, standard linear regression on raw proportions. These methods ignore the fundamental constraint that proportions must sum to unity and fail to model the inherent dependencies between components.\nAitchison’s landmark work\nestablished the mathematical foundation for proper compositional analysis, while\nvan den Boogaart & Tolosana-Delgado\nprovide comprehensive coverage of modern compositional data analysis methods.\nHere I demonstrate how Dirichlet regression with Gaussian process smooths provides a principled, flexible framework for modeling plant community composition across environmental gradients. I’ll use\nRiutort-Mayol et al’s approximate Hilbert space Gaussian processes\n, which make these models computationally tractable even for moderately large datasets.\nOverview of this post\nCompositional data appears everywhere in scientific research: microbiome relative abundances in biology, market share distributions in economics, geological mineral compositions in earth sciences, time allocation in behavioral studies, and survey response proportions in social research. Yet despite this ubiquity, many analysts resort to problematic approaches that ignore the fundamental constraint that components must sum to a constant (typically 1 or 100%).\nThis post addresses two critical challenges data scientists face with compositional data. Methodologically, I demonstrate why standard approaches like separate Binomial models or Beta regression on ratios fail to capture the inherent dependencies between components, leading to impossible predictions and inefficient inference. If you’ve worked with\nGAMs for time series analysis\nlike I have, you’ll appreciate how Gaussian processes provide similar flexibility for capturing nonlinear relationships while respecting compositional constraints.\nComputationally, I show how approximate Hilbert space Gaussian processes make sophisticated nonlinear modeling feasible for realistic dataset sizes, overcoming the traditional scalability limitations of GP methods. This builds on the same computational advances that make\ncomplex hierarchical models\npractical for everyday use.\nI begin with the mathematical foundation of the Dirichlet distribution and its regression parameterization, emphasizing how brms enables separate linear predictors for each component. Next, I simulate realistic plant community data to demonstrate complex ecological relationships. I then fit Dirichlet regression models with bivariate Gaussian process smooths, extract and visualize predictions across environmental gradients, and interpret the results. Throughout, I emphasize practical implementation details and computational considerations that make this approach accessible for real-world applications.\nBy the end, you’ll understand when and how to apply Dirichlet regression to your own compositional data, regardless of scientific domain. Plus, you’ll never again have to explain to a collaborator why your separate logistic regressions predict that 130% of survey respondents chose option A.\nThe Dirichlet distribution and compositional constraints\nFor a\n\\({\\color{#FDE725}{K}}\\)\n-component composition\n\\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, {\\color{#440154}{y_2}}, \\ldots, {\\color{#440154}{y_K}})\\)\nwhere\n\\(\\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}} = 1\\)\nand\n\\({\\color{#440154}{y_k}} > 0\\)\n, the Dirichlet distribution provides a natural model:\n$${\\color{#440154}{\\boldsymbol{y}}} \\sim \\text{Dirichlet}({\\color{#31688E}{\\boldsymbol{\\alpha}}})$$\nwhere\n\\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, {\\color{#31688E}{\\alpha_2}}, \\ldots, {\\color{#31688E}{\\alpha_K}})\\)\nare positive concentration parameters. The probability density is:\n$$f({\\color{#440154}{\\boldsymbol{y}}}|{\\color{#31688E}{\\boldsymbol{\\alpha}}}) = \\frac{\\Gamma({\\color{#31688E}{\\alpha_0}})}{\\prod_{k=1}^{\\color{#FDE725}{K}} \\Gamma({\\color{#31688E}{\\alpha_k}})} \\prod_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}}^{{\\color{#31688E}{\\alpha_k}} - 1}$$\nwith\n\\({\\color{#31688E}{\\alpha_0}} = \\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#31688E}{\\alpha_k}}\\)\nand\n\\(\\Gamma(\\cdot)\\)\nthe gamma function. The expected proportion for component\n\\(k\\)\nis\n\\(\\mathbb{E}[{\\color{#440154}{y_k}}] = {\\color{#31688E}{\\alpha_k}} / {\\color{#31688E}{\\alpha_0}}\\)\n, while the precision (inverse variance) increases with\n\\({\\color{#31688E}{\\alpha_0}}\\)\n.\nIn regression contexts, we model how\n\\({\\color{#31688E}{\\boldsymbol{\\alpha}}}\\)\ndepends on predictors. The brms package uses a multivariate logit parameterization where the expected proportions\n\\({\\color{#35B779}{\\boldsymbol{\\mu}}} = \\mathbb{E}[{\\color{#440154}{\\boldsymbol{y}}}]\\)\nare linked to linear predictors via:\n$${\\color{#35B779}{\\mu_j}} = \\frac{\\exp({\\color{#21918C}{\\eta_j}})}{\\sum_{k=1}^{\\color{#FDE725}{K}} \\exp({\\color{#21918C}{\\eta_k}})}$$\nwhere\n\\({\\color{#21918C}{\\eta_j}}\\)\nis the linear predictor for category\n\\(j\\)\n. For identifiability, one category (typically the last) serves as reference with\n\\({\\color{#21918C}{\\eta_{\\text{ref}}}} = 0\\)\n. This means we estimate separate linear predictors for\n\\({\\color{#FDE725}{K}}-1\\)\ncategories:\n$${\\color{#21918C}{\\eta_j}} = \\boldsymbol{x}^T \\boldsymbol{\\beta}_j + f_j(\\boldsymbol{x}), \\quad j = 1, \\ldots, {\\color{#FDE725}{K}}-1$$\nwhere\n\\(f_j(\\cdot)\\)\nrepresents smooth functions (like our Gaussian processes). This approach naturally ensures\n\\(\\sum_{k=1}^K \\mu_k = 1\\)\nwhile allowing each functional group to have its own flexible, nonlinear response to environmental gradients.\nParameter guide for Dirichlet regression\nLet me break down what each parameter means in our ecological context, using the same color scheme as above:\nObserved composition\n\\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, ..., {\\color{#440154}{y_K}})\\)\n: The actual proportions we observe at each site. In our case, this is a 5-element vector containing the relative abundances of grass, forb, shrub, tree, and lichen. These must sum to 1 and all be positive.\nConcentration parameters\n\\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, ..., {\\color{#31688E}{\\alpha_K}})\\)\n: These control both the expected proportions and the precision of the distribution. Higher\n\\({\\color{#31688E}{\\alpha_k}}\\)\nmeans functional group\n\\(k\\)\nhas higher expected proportion. The sum\n\\({\\color{#31688E}{\\alpha_0}} = \\sum_k {\\color{#31688E}{\\alpha_k}}\\)\ndetermines overall precision. Larger values mean less variance around expected proportions.\nExpected proportions\n\\({\\color{#35B779}{\\boldsymbol{\\mu}}} = ({\\color{#35B779}{\\mu_1}}, ..., {\\color{#35B779}{\\mu_K}})\\)\n: The mean of the Dirichlet distribution, representing expected composition at any given environmental combination. This is what we’re ultimately interested in predicting, how community composition changes across environmental gradients.\nLinear predictors\n\\({\\color{#21918C}{\\eta_j}}\\)\nfor\n\\(j = 1, ..., {\\color{#FDE725}{K}}-1\\)\n: The unconstrained predictions before applying the softmax transformation. This is where we place our Gaussian process smooths of elevation and temperature. Note we only model\n\\({\\color{#FDE725}{K}}-1\\)\npredictors, with the last category serving as reference.\nNumber of categories\n\\({\\color{#FDE725}{K}}\\)\n: The dimensionality of our compositional data. For plant communities,\n\\({\\color{#FDE725}{K}}=5\\)\nfunctional groups. This could be any number of categories in other applications like market shares, time allocation, or mineral compositions.\nThe key insight is that the linear predictors\n\\(\\eta_j\\)\nare where we incorporate environmental effects through Gaussian process smooths, allowing each functional group to have its own flexible, nonlinear response to environmental gradients while ensuring all predictions respect compositional constraints.\nEnvironment setup\nThis tutorial relies on the following packages:\nlibrary(brms)            # Bayesian modeling with Stan\nlibrary(tidyverse)       # Data manipulation and visualization  \nlibrary(viridis)         # Color palettes\nlibrary(patchwork)       # Plot composition\nlibrary(waffle)          # Waffle plots for compositional visualization\nlibrary(cowplot)         # Extract and manipulate plot components\nA custom\nggplot2\ntheme; feel free to ignore if you have your own plot preferences\n# Set consistent ggplot theme for all visualizations\ntheme_set(\n  theme_classic(\n    base_size = 15, \n    base_family = 'serif'\n  ) +\n  theme(\n    axis.line.x.bottom = element_line(\n      colour = \"black\",\n      size = 1\n    ),\n    axis.line.y.left = element_line(\n      colour = \"black\",\n      size = 1\n    )\n  )\n)\nSimulating plant community data\nI simulate realistic plant community composition data across elevation and temperature gradients, where five functional groups (grasses, forbs, shrubs, trees, lichens) respond differently to environmental conditions. This simulation captures the ecological reality that different plant types show varying tolerance ranges and optimal growing conditions along environmental gradients—a pattern we’ll later model using Dirichlet regression.\nsimulate_plant_community <- function(\n    n_sites = 60, \n    elevation_range = c(1, 3),\n    temp_range = c(5, 25)\n) {\n  \n  set.seed(42)\n  \n  # Generate elevation gradient with uniform random sampling\n  elevation <- runif(\n    n_sites, \n    elevation_range[1], \n    elevation_range[2]\n  )\n  elev_norm <- (elevation - elevation_range[1]) / \n    (elevation_range[2] - elevation_range[1])\n  \n  # Create realistic temperature-elevation relationship with plateau\n  # Temperature decreases with elevation but plateaus at high elevations\n  plateau_point <- 0.8\n  sharpness <- 2\n  temp_factor <- 0.5 * (1 - tanh(sharpness * (elev_norm - plateau_point)))\n  temperature <- temp_range[1] + \n    (temp_range[2] - temp_range[1]) * temp_factor +\n    rnorm(n_sites, 0, 3)\n  \n  \n  # Define functional group responses to environmental gradients\n  # Each group has distinct ecological preferences that create realistic\n  # community assembly patterns along elevation and temperature gradients\n  \n  # Grasses: peak abundance at mid-elevations with moderate temperatures\n  # Strong quadratic responses in both elevation and temperature\n  grass_logit <- 0.2 + 0.6 * elevation - 0.3 * elevation^2 + \n    0.08 * temperature - 0.004 * temperature^2 + 0.02 * elevation * temperature\n  \n  # Forbs: prefer lower-mid elevations and warmer temperatures\n  # Negative elevation effect with positive temperature response\n  forb_logit <- 0.8 - 0.8 * elevation + 0.12 * temperature - \n    0.005 * temperature^2 + -0.03 * elevation * temperature\n  \n  # Shrubs: adapted to mid-high elevations with moderate-cool temperatures\n  # Positive elevation effect with cool temperature preference\n  shrub_logit <- 0.3 + 0.6 * elevation - 0.2 * elevation^2 + \n    -0.04 * temperature - 0.003 * temperature^2\n  \n  # Trees: dominate at lower elevations and warmer temperatures\n  # Strong negative elevation effects with positive temperature response\n  tree_logit <- 1.2 - 1.5 * elevation - 0.3 * elevation^2 + \n    0.15 * temperature - 0.005 * temperature^2 + 0.04 * elevation * temperature\n  \n  # Lichens: alpine specialists preferring high elevation, cool temperatures\n  # Strong positive elevation effect with negative temperature preference\n  lichen_logit <- -1.8 + 1.2 * elevation + 0.1 * elevation^2 + \n    -0.1 * temperature + 0.003 * temperature^2\n  \n  # Apply softmax transformation to ensure probabilities sum to 1\n  # This converts unconstrained logits to valid probability simplex\n  logits <- cbind(\n    grass_logit, \n    forb_logit, \n    shrub_logit, \n    tree_logit, \n    lichen_logit\n  )\n  exp_logits <- exp(logits)\n  probs <- exp_logits / rowSums(exp_logits)\n  \n  # Set constant precision parameter for all sites\n  # This keeps the focus on mean compositional responses\n  precision <- exp(3)\n  \n  # Generate Dirichlet-distributed compositions\n  # Each site gets alpha parameters = expected proportions * precision\n  compositions <- matrix(NA, nrow = n_sites, ncol = 5)\n  for (i in 1:n_sites) {\n    alpha_params <- probs[i, ] * precision\n    compositions[i, ] <- brms::rdirichlet(1, alpha_params)\n  }\n  \n  # Add small offset and renormalize to ensure no exact zeros\n  # Dirichlet distribution requires all components > 0\n  offset <- 0.001\n  compositions <- compositions + offset\n  compositions <- compositions / rowSums(compositions)\n  \n  # Return structured data frame with environmental predictors and compositions\n  data.frame(\n    site_id = 1:n_sites,\n    elevation = elevation,\n    temperature = temperature, \n    grass = compositions[, 1],\n    forb = compositions[, 2],\n    shrub = compositions[, 3], \n    tree = compositions[, 4],\n    lichen = compositions[, 5]\n  )\n}\n\nplant_data <- simulate_plant_community()\n\n# Define functional groups for consistent use across analysis\nfunctional_groups <- c(\"forb\", \"grass\", \"lichen\", \"shrub\", \"tree\")\nLet’s verify our simulated compositions respect the fundamental constraint that proportions must sum to unity:\n# Verify compositions sum to 1 (within numerical precision)\nrowSums(plant_data[, functional_groups]) |> \n  summary()\n\n##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n##       1       1       1       1       1       1\nExploratory visualization\nThese exploratory plots serve a crucial purpose before diving into modeling. The top panel shows how elevation and temperature covary in our simulated landscape—this realistic temperature lapse rate will affect how we interpret subsequent model results. The bottom panels reveal the raw compositional patterns that our Dirichlet regression will attempt to capture with smooth functions.\n# Visualize the environmental relationship between elevation and temperature\n# This shows the realistic temperature-elevation gradient we simulated\np1 <- ggplot(\n  plant_data, \n  aes(elevation, temperature)\n) +\n  geom_point(\n    alpha = 0.6, \n    size = 2\n  ) +\n  geom_smooth(\n    method = \"loess\", \n    se = TRUE, \n    color = \"darkred\", \n    fill = \"darkred\"\n  ) +\n  labs(\n    x = \"Elevation (km)\", \n    y = \"Temperature (°C)\"\n  )\n\n# Reshape data to long format for plotting all functional groups together\n# This transformation allows us to visualize compositional changes efficiently\nplant_long <- plant_data |>\n  dplyr::select(\n    elevation, \n    temperature, \n    grass:lichen\n  ) |>\n  tidyr::pivot_longer(\n    grass:lichen, \n    names_to = \"functional_group\", \n    values_to = \"proportion\"\n  )\n\n# Visualize how community composition changes along elevation gradient\n# Each functional group shows distinct elevational preferences\np2 <- ggplot(\n  plant_long, \n  aes(\n    elevation, \n    proportion, \n    color = functional_group\n  )\n) +\n  geom_point(alpha = 0.4) +\n  geom_smooth(\n    method = \"loess\", \n    se = FALSE, \n    linewidth = 1\n  ) +\n  scale_color_viridis_d(name = \"Functional\\nGroup\") +\n  lims(y = c(0, 1)) +\n  labs(\n    x = \"Elevation (km)\", \n    y = \"Relative abundance\"\n  )\n\n# Visualize how community composition changes along temperature gradient\n# Temperature effects complement elevation patterns in shaping communities\np3 <- ggplot(\n  plant_long, \n  aes(\n    temperature, \n    proportion, \n    color = functional_group\n  )\n) +\n  geom_point(alpha = 0.4) +\n  geom_smooth(\n    method = \"loess\", \n    se = FALSE, \n    linewidth = 1\n  ) +\n  scale_color_viridis_d(name = \"Functional\\nGroup\") +\n  lims(y = c(0, 1)) +\n  labs(\n    x = \"Temperature (°C)\", \n    y = \"\"\n  )\n\n# Create a more compact legend with smaller text and tighter spacing\np2_compact_legend <- p2 + \n  theme(\n    legend.title = element_text(size = 9),\n    legend.text = element_text(size = 8),\n    legend.key.size = unit(0.8, \"lines\"),\n    legend.margin = margin(0, 0, 0, 0),\n    legend.box.margin = margin(0, 0, 0, 5)\n  )\n\n# Extract the compact legend\nlegend <- cowplot::get_legend(p2_compact_legend)\n\n# Remove legends from both composition plots\np2_no_legend <- p2 + theme(legend.position = \"none\")\np3_no_legend <- p3 + theme(legend.position = \"none\")\n\n# Combine bottom plots first, then add legend\nbottom_row <- (p2_no_legend | p3_no_legend | legend) + \n  patchwork::plot_layout(widths = c(9, 9, 2))\n\n# Combine top and bottom\np1 / bottom_row\nDirichlet regression with Gaussian processes\nNow comes the core modeling step: fitting Dirichlet regression with bivariate Gaussian process smooths. But first, let me explain why Gaussian processes are particularly well-suited for this ecological problem.\nWhy choose Gaussian processes over other smoothing methods? Standard approaches like polynomial regression or splines make strong assumptions about functional form. Polynomials assume global relationships, while splines assume local smoothness within predefined knots. Gaussian processes, by contrast, are non-parametric: they let the data determine the appropriate level of smoothness at each point in covariate space. This flexibility is crucial for ecological data where relationships might be smooth in some regions (gradual transitions between communities) but abrupt in others (sharp ecotones at treelines).\nTraditional GPs face a computational challenge: they scale as O(n³) with sample size, making them impractical for datasets with more than 500 observations. The approximate Hilbert space Gaussian processes implemented in\nbrms\nuse basis function expansions that reduce this to O(n), enabling GP flexibility on realistic ecological datasets. This isn’t just a computational nicety, it opens up sophisticated nonparametric modeling for the sample sizes we actually encounter in field studies.\nThe compositional modeling advantage here is that we can model each functional group’s response surface simultaneously while respecting compositional constraints. Unlike separate GAMs for each species that might predict impossible total abundances, Dirichlet regression with GPs ensures all predictions lie on the probability simplex.\nFor the GP kernel, I use the exponential covariance function rather than the more common squared exponential (RBF) kernel. The exponential kernel is computationally more efficient in the Hilbert space approximation while still capturing smooth nonlinear relationships. This makes the difference between a model that fits in minutes versus hours for ecological datasets.\n# Prepare response matrix for Dirichlet regression\n# Each row represents a site's complete community composition\nY <- with(\n  plant_data, \n  cbind(\n    grass, \n    forb, \n    shrub, \n    tree, \n    lichen\n  )\n)\nplant_data$Y <- Y\n\n# Verify no zeros exist (Dirichlet distribution requires positive values)\n# Our simulation ensures this, but it's good practice to check\nmin(Y)\n\n# Specify model formula with bivariate Gaussian process smooth\n# k=10 basis functions provide good balance between flexibility and efficiency\n# c=5/4 sets the boundary factor for the approximation\nmodel_formula <- bf(\n  Y ~ gp(\n    elevation, \n    temperature, \n    k = 10, \n    c = 5/4, \n    cov = \"exponential\"\n  )\n)\n\n# Fit Dirichlet regression model using Stan via brms\n# This estimates separate GP surfaces for each functional group\nplant_model <- brm(\n  model_formula,\n  data = plant_data,\n  family = brms::dirichlet(),\n  chains = 4,\n  iter = 2000,\n  warmup = 1000,\n  cores = 4,\n  seed = 42,\n  backend = \"cmdstanr\",\n  silent = 2\n)\nModel predictions and effects\nWith our fitted model, we can now extract predictions across environmental gradients to understand precisely how community composition responds to elevation and temperature. This is where we transition from model fitting to interpretation, and where understanding different types of posterior predictions becomes crucial.\nI use\nposterior_epred()\nrather than\nposterior_predict()\nbecause I want the expected values of the posterior predictive distribution, not new random draws from it. Andrew Heiss has an\nexcellent guide to visualizing different types of posteriors\nthat explains these distinctions clearly. For compositional data,\nposterior_epred()\ngives us the model’s best estimate of expected proportions at each environmental combination, while\nposterior_predict()\nwould add additional Dirichlet sampling variation on top. Since we want to understand the underlying functional relationships rather than prediction intervals for new observations,\nposterior_epred()\nis the right choice.\nI’ll create three complementary prediction scenarios: univariate effects along each environmental axis (holding the other at its mean), plus bivariate surfaces showing interactive effects. The prediction strategy here is key to interpretation. I create three different prediction grids that answer different ecological questions:\n# Create elevation gradient with temperature held at mean for marginal effects\n# This asks: \"How does composition change with elevation at average temperature?\"\nelev_grid <- data.frame(\n  elevation = seq(\n    min(plant_data$elevation), \n    max(plant_data$elevation), \n    length.out = 100\n  ),\n  temperature = mean(plant_data$temperature)\n)\n\n# Create temperature gradient with elevation held at mean for marginal effects\n# This asks: \"How does composition change with temperature at average elevation?\"\ntemp_grid <- data.frame(\n  elevation = mean(plant_data$elevation),\n  temperature = seq(\n    min(plant_data$temperature), \n    max(plant_data$temperature), \n    length.out = 100\n  )\n)\n\n# Create bivariate prediction grid for interactive response surfaces\n# This asks: \"How does composition vary across the full elevation-temperature space?\"\n# Coarser 20x20 grid (400 points) balances detail with computational efficiency\nelev_seq <- seq(\n  min(plant_data$elevation), \n  max(plant_data$elevation), \n  length.out = 20\n)\ntemp_seq <- seq(\n  min(plant_data$temperature), \n  max(plant_data$temperature), \n  length.out = 20\n)\nbivariate_grid <- expand.grid(\n  elevation = elev_seq, \n  temperature = temp_seq\n)\n\n# Extract posterior predictions from fitted Dirichlet model\n# posterior_epred gives expected values (means) of predictive distribution\n# rather than new random samples, perfect for understanding relationships\nelev_post_pred <- posterior_epred(\n  plant_model, \n  newdata = elev_grid, \n  ndraws = 500\n)\ntemp_post_pred <- posterior_epred(\n  plant_model, \n  newdata = temp_grid, \n  ndraws = 500\n)\nbivar_post_pred <- posterior_epred(\n  plant_model, \n  newdata = bivariate_grid, \n  ndraws = 500\n)\nNow I need to convert these posterior prediction arrays into something we can actually plot. The\nposterior_epred\nfunction returns a three-dimensional array: 500 posterior draws × 100 prediction points × 5 functional groups. This represents our uncertainty about expected proportions at each environmental combination.\n# Function to calculate summary statistics from posterior prediction draws\n# This converts arrays of posterior samples into plottable summaries\ncalc_pred_summary <- function(post_draws, grid_data) {\n  n_cats <- dim(post_draws)[3]\n  \n  # Validate dimensions match expected functional groups\n  # This catches potential mismatches between model and data\n  if (n_cats != length(functional_groups)) {\n    stop(\n      \"Number of categories in posterior draws (\", n_cats, \n      \") doesn't match functional groups (\", length(functional_groups), \")\"\n    )\n  }\n  \n  result <- grid_data\n  \n  # Calculate summary statistics for each functional group\n  # Mean captures central tendency, quantiles provide uncertainty\n  for (i in seq_along(functional_groups)) {\n    cat_name <- functional_groups[i]\n    cat_draws <- post_draws[, , i]\n    \n    # Calculate posterior mean and 95% credible intervals efficiently\n    # This summarizes 500 posterior draws into point estimates + uncertainty\n    stats <- apply(\n      cat_draws, \n      2, \n      function(x) {\n        c(\n          mean = mean(x), \n          lower = quantile(x, 0.025, names = FALSE),\n          upper = quantile(x, 0.975, names = FALSE)\n        )\n      }\n    )\n    \n    # Assign summary statistics to result dataframe with clear naming\n    result[[paste0(cat_name, \"_mean\")]] <- stats[\"mean\", ]\n    result[[paste0(cat_name, \"_lower\")]] <- stats[\"lower\", ]\n    result[[paste0(cat_name, \"_upper\")]] <- stats[\"upper\", ]\n  }\n  \n  return(result)\n}\n\n# Apply summary function to convert posterior arrays to dataframes\nelev_summary <- calc_pred_summary(elev_post_pred, elev_grid)\ntemp_summary <- calc_pred_summary(temp_post_pred, temp_grid)\nbivar_summary <- calc_pred_summary(bivar_post_pred, bivariate_grid)\nMarginal effects: univariate environmental responses\nMarginal effects plots reveal how each functional group responds to single environmental gradients while holding other variables constant. These plots answer questions like “How does community composition change as I walk up an elevation transect at average temperature?” The ribbons around each line represent our uncertainty about these relationships. Wider ribbons indicate less confidence, typically where we have fewer data points or the GP is interpolating across larger gaps.\n# Function to create marginal effects plots for any environmental variable\n# This unified approach ensures consistent styling across all visualizations\ncreate_marginal_plot <- function(pred_data, x_var, x_label) {\n  # Reshape prediction data from wide to long format for ggplot\n  # Extract only the focal variable and all functional group statistics\n  plot_data <- pred_data |>\n    dplyr::select(\n      dplyr::all_of(x_var), \n      dplyr::matches(\n        paste0(\n          \"(\", \n          paste(functional_groups, collapse = \"|\"), \n          \")_(mean|lower|upper)$\"\n        )\n      )\n    ) |>\n    tidyr::pivot_longer(\n      cols = -dplyr::all_of(x_var),\n      names_to = c(\"functional_group\", \"stat\"),\n      names_pattern = \"(.+)_(mean|lower|upper)$\",\n      values_to = \"value\"\n    ) |>\n    tidyr::pivot_wider(\n      names_from = stat, \n      values_from = value\n    )\n  \n  # Create ggplot with ribbon for uncertainty and line for mean response\n  # Consistent styling across all marginal effects plots\n  ggplot(\n    plot_data, \n    aes(\n      x = .data[[x_var]], \n      y = mean, \n      color = functional_group, \n      fill = functional_group\n    )\n  ) +\n    geom_ribbon(\n      aes(\n        ymin = lower, \n        ymax = upper\n      ), \n      alpha = 0.2, \n      color = NA\n    ) +\n    geom_line(linewidth = 1.2) +\n    scale_color_viridis_d(\n      name = \"Functional\\nGroup\", \n      option = \"D\"\n    ) +\n    scale_fill_viridis_d(\n      name = \"Functional\\nGroup\", \n      option = \"D\"\n    ) +\n    labs(\n      x = x_label, \n      y = \"Predicted Proportion\"\n    ) +\n    theme(legend.position = \"right\")\n}\n\n# Generate marginal effects plots\np_elevation <- create_marginal_plot(\n  elev_summary, \n  \"elevation\", \n  \"Elevation (km)\"\n)\np_temperature <- create_marginal_plot(\n  temp_summary, \n  \"temperature\", \n  \"Temperature (°C)\"\n)\n\n# Display elevation effects\np_elevation\n# Display temperature effects\np_temperature\nThese marginal effects reveal clear ecological zonation patterns. The elevation responses show grasses peaking around 1.5km elevation, consistent with montane grassland ecology. Trees decline steadily with elevation from maximum abundance at low elevations, capturing realistic treeline dynamics. Lichens show the opposite pattern, with minimal presence below 2km but increasing dramatically at high elevations where harsh conditions exclude other functional groups.\nThe temperature responses show equally complex patterns. Lichens dominate at the coldest temperatures (~8°C), decline at moderate temperatures, then increase again toward warmer conditions, creating a bimodal response. Grasses show a complex multimodal temperature response with peaks around 11°C and 20°C. Trees exhibit a strong positive response to warming, reaching maximum abundance around 25°C. Forbs and shrubs remain relatively stable across temperature gradients.\nVisualizing predicted communities with waffle plots\nBefore diving into complex bivariate surfaces, let’s visualize what these predicted communities actually look like at specific elevations. Waffle plots provide an intuitive representation where each square represents an individual plant, making abstract proportions concrete and interpretable.\n# Prepare data for multiple elevations\nelev_values <- c(1.2, 1.6, 2.0, 2.4, 2.8, 3.2)\ntotal_plants <- 50\n\n# Build waffle data for all elevations\nall_waffle_data <- NULL\n\nfor (elev in elev_values) {\n  # Prepare prediction point at mean temperature\n  pred_point <- data.frame(\n    elevation = elev,\n    temperature = mean(plant_data$temperature)\n  )\n  \n  # Get predictions\n  pred <- posterior_epred(\n    plant_model, \n    newdata = pred_point, \n    ndraws = 100\n  )\n  \n  # Calculate mean proportions\n  mean_props <- apply(pred[, 1, ], 2, mean)\n  \n  # Convert to counts ensuring sum equals total_plants\n  counts <- round(mean_props * total_plants)\n  if (sum(counts) != total_plants) {\n    diff <- total_plants - sum(counts)\n    max_idx <- which.max(counts)\n    counts[max_idx] <- counts[max_idx] + diff\n  }\n  \n  # Create expanded data for this elevation (one row per plant)\n  for (i in seq_along(functional_groups)) {\n    if (counts[i] > 0) {\n      elev_data <- data.frame(\n        elevation = factor(\n          paste0(elev, \"km\"), \n          levels = paste0(elev_values, \"km\")\n        ),\n        functional_group = factor(\n          functional_groups[i], \n          levels = c(\"forb\", \"grass\", \"lichen\", \"shrub\", \"tree\")\n        ),\n        count = rep(1, counts[i])\n      )\n      all_waffle_data <- rbind(all_waffle_data, elev_data)\n    }\n  }\n}\n\n# Create faceted waffle plot\nall_waffle_data |>\n  ggplot(\n    aes(\n      fill = functional_group, \n      values = count\n    )\n  ) +\n  waffle::geom_waffle(\n    n_rows = 10,\n    size = 0.3,\n    colour = \"white\",\n    flip = TRUE,\n    make_proportional = FALSE\n  ) +\n  facet_wrap(\n    ~ elevation, \n    nrow = 2\n  ) +\n  scale_fill_viridis_d(\n    name = \"Functional Group\",\n    option = \"D\"\n  ) +\n  coord_equal() +\n  theme_minimal(base_size = 15, base_family = 'serif') +\n  theme(\n    legend.position = \"bottom\",\n    legend.direction = \"horizontal\",\n    strip.background = element_blank(),\n    panel.grid = element_blank(),\n    panel.background = element_blank(),\n    axis.text = element_blank(),\n    axis.title = element_blank(),\n    axis.ticks = element_blank()\n  ) +\n  guides(\n    fill = guide_legend(\n      nrow = 1,\n      title.position = \"top\",\n      title.hjust = 0.5\n    )\n  )\nThese waffle plots make the compositional changes tangible. At low elevations (1.2km), grasses (blue squares) dominate with trees (yellow) as codominants and small amounts of forbs (purple). Moving upslope to 1.6km, grasses remain dominant but trees and shrubs (green) become more prominent. At 2.0km, we see the beginning of the major transition as lichens (teal) start appearing significantly alongside the still-dominant grasses. By 2.4km, lichens become the dominant functional group with grasses remaining substantial. At the highest elevation (3.2km), lichens overwhelmingly dominate the alpine community. Each square represents an individual plant out of 50 total, so readers can literally count how community composition shifts from grass-tree lowlands to lichen-dominated alpine zones, much more intuitive than abstract proportions.\nBivariate surfaces: capturing environmental interactions\nWhile marginal effects are useful, they miss a crucial aspect of ecological reality: environmental variables interact. Temperature and elevation don’t operate independently. Their combined effects often differ from what we’d predict by simply adding their separate influences. Bivariate response surfaces reveal these interactions by showing how functional groups respond across the full environmental space.\n# Function to create bivariate response surface for focal functional group\n# Shows how group abundance varies across both environmental dimensions\ncreate_bivariate_plot <- function(pred_data, focal_group = \"grass\") {\n  # Validate that focal group is one of the modeled functional groups\n  if (!focal_group %in% functional_groups) {\n    stop(\n      \"focal_group must be one of: \", \n      paste(functional_groups, collapse = \", \")\n    )\n  }\n  \n  # Construct column name and legend title for focal group\n  col_name <- paste0(focal_group, \"_mean\")\n  legend_title <- stringr::str_to_title(\n    paste(focal_group, \"\\nProportion\")\n  )\n  \n  # Create response surface plot with raster and contour overlay\n  ggplot(\n    pred_data, \n    aes(\n      x = elevation, \n      y = temperature\n    )\n  ) +\n    geom_raster(\n      aes(fill = .data[[col_name]]), \n      interpolate = TRUE\n    ) +\n    geom_contour(\n      aes(z = .data[[col_name]]), \n      color = \"white\", \n      alpha = 0.6, \n      size = 0.3\n    ) +\n    scale_fill_viridis_c(\n      name = legend_title, \n      option = \"plasma\"\n    ) +\n    labs(\n      x = \"Elevation (km)\", \n      y = \"Temperature (°C)\"\n    )\n}\n\n# Generate bivariate surface plots for key functional groups\np_bivariate_grass <- create_bivariate_plot(\n  bivar_summary, \n  \"grass\"\n)\np_bivariate_tree <- create_bivariate_plot(\n  bivar_summary, \n  \"tree\"\n)\n\n# Display grass response surface\np_bivariate_grass\n# Display tree response surface\np_bivariate_tree\nThese bivariate surfaces reveal interactions that marginal plots miss entirely. The grass surface shows a clear “sweet spot” around 1.2-1.4km elevation and 12-15°C temperature, not just peak abundance at mid-elevation, but specifically at this elevation-temperature combination. The tree surface demonstrates highest abundances at the lowest elevations (1.0km) combined with the warmest temperatures (25°C), with tree proportions declining steeply as both elevation increases and temperatures cool, perfectly capturing treeline ecology.\nModel validation: checking our compositional residuals\nBefore diving into ecological interpretation, let’s validate that our Dirichlet regression actually captures the patterns in our data. This step is crucial but often skipped in compositional analyses. I’ll show you how to compute proper residuals for compositional data and why traditional approaches fail.\nComputing residuals for compositional data isn’t straightforward. You can’t just subtract predicted from observed proportions because this ignores the constraint that components sum to unity and the unique variance structure of the Dirichlet distribution. Following\nMaier’s approach in the DirichletReg package\n, we need to account for both the mean-variance relationship and the precision parameter.\nThe key insight is that for Dirichlet regression, the variance of each component depends on both its expected proportion μ and the overall precision φ:\n$$\\text{Var}(Y_k) = \\frac{\\mu_k(1-\\mu_k)}{1+\\phi}$$\nThis formula captures two important features: components with intermediate proportions (μ ≈ 0.5) have higher variance than those near 0 or 1, and higher precision φ reduces variance across all components. Traditional Pearson residuals ignore this structure entirely.\n# Extract fitted values from our Dirichlet model\n# brms returns a 3D array: [sites, statistics, components]\nfitted_values <- fitted(plant_model)\nmu <- fitted_values[, \"Estimate\", ]  # Extract just the expected proportions\n\n# Extract precision parameter from posterior samples\n# In brms, phi controls the Dirichlet precision\nphi_samples <- as_draws_df(plant_model) |>\n  dplyr::select(dplyr::contains(\"phi\"))\nphi_mean <- mean(phi_samples[[1]])\n\n# Observed compositions as matrix\nY <- as.matrix(plant_data[, functional_groups])\n\n# Calculate proper Dirichlet variance structure\n# This accounts for both mean-variance relationship AND precision\nV <- mu * (1 - mu) / (1 + phi_mean)\n\n# Standardized residuals: (observed - expected) / sqrt(variance)\n# These should be approximately normal if our model fits well\npearson_residuals <- (Y - mu) / sqrt(V)\nNow let’s examine whether our residuals show problematic patterns. Well-behaved residuals should be roughly normal and show no systematic trends across environmental gradients. If we see strong patterns, it suggests our model is missing important relationships.\n# Create Q-Q plots to check if standardized residuals are approximately normal\n# Reshape residuals to long format for easy plotting\nresidual_long <- pearson_residuals |>\n  as.data.frame() |>\n  dplyr::mutate(site_id = 1:nrow(pearson_residuals)) |>\n  tidyr::pivot_longer(\n    cols = -site_id,\n    names_to = \"functional_group\",\n    values_to = \"residual\"\n  )\n\n# Q-Q plot comparing residuals to theoretical normal distribution\nggplot(\n  residual_long,\n  aes(sample = residual, color = functional_group)\n) +\n  stat_qq(alpha = 0.6) +\n  stat_qq_line() +\n  facet_wrap(~ functional_group, scales = \"free\") +\n  scale_color_viridis_d(name = \"Functional\\nGroup\") +\n  labs(\n    x = \"Theoretical quantiles\",\n    y = \"Sample quantiles\"\n  ) +\n  theme(legend.position = \"none\")\nThese Q-Q plots reveal how well our model captures the data structure for each functional group. Points should roughly follow the diagonal line if residuals are normally distributed. What we see here is largely reassuring: most functional groups show reasonably normal residual behavior, though some groups like forbs and lichens exhibit moderate deviations from normality in the tails.\nThese moderate deviations aren’t necessarily problematic. They likely reflect the ecological reality that some sites have genuinely unusual community compositions that any model would struggle to predict perfectly. The Gaussian process smooths are doing well at capturing the main compositional patterns while the Dirichlet structure ensures all predictions respect compositional constraints.\nCompare this to what happens with naive approaches that ignore compositional constraints. If we fit separate binomial models for each functional group, we often get predicted total abundances that exceed 100%—a mathematical impossibility that reveals fundamental model misspecification. Our Dirichlet approach automatically prevents such nonsensical predictions while providing flexible nonlinear responses through Gaussian processes.\nModel interpretation and ecological insights\nThe Dirichlet regression successfully captures the complex, nonlinear relationships between environmental gradients and plant community composition. What makes this particularly satisfying is how the model recovers the ecological patterns we built into our simulation while respecting compositional constraints.\nWhat’s particularly elegant about this approach is how the compositional constraint enforcement works seamlessly. Unlike separate binomial models that could predict impossible total abundances exceeding 100%, our Dirichlet regression automatically ensures all predictions sum to unity. This isn’t just a statistical nicety, it reflects the biological reality that plant communities partition available space and resources.\nThe approximate Hilbert space Gaussian processes deserve special mention here. Traditional GP methods would be computationally prohibitive for this dataset size, but the Hilbert space approximation maintains the flexibility to capture nonlinear responses while scaling to realistic sample sizes.\nTake-home messages\nDirichlet regression with Gaussian process smooths offers a principled framework for compositional data that:\nRespects the mathematical constraints of compositional data\nModels dependencies between components naturally\nProvides flexible, nonlinear relationships via Gaussian processes\nScales computationally via approximate Hilbert space methods\nGenerates predictions that automatically satisfy compositional constraints\nFor data scientists working with compositional data, whether ecological communities, market shares, time allocation, or survey responses, this framework offers a principled alternative to problematic approaches. The combination of Dirichlet regression with approximate Gaussian processes provides both statistical rigor and computational tractability. Most importantly, it generates predictions that respect the mathematical structure of your data, avoiding the impossible predictions that plague naive approaches.\nI’d encourage you to try this approach on your own compositional datasets. The\nbrms\npackage makes implementation remarkably straightforward, and the computational efficiency of approximate GPs means you can fit these models on realistic dataset sizes without specialized hardware. The investment in learning this framework pays dividends in more reliable predictions and deeper insights into how your compositions respond to predictors.  Plus, you’ll never again have to explain to a collaborator why your separate logistic regressions predict that 130% of survey respondents chose option A. If you’re new to Bayesian modeling in ecology, I cover\ngetting started with mvgam and brms for ecological data\nin many of my talks.\nFurther reading\nThe following papers and resources offer useful material for working with compositional data analysis and Gaussian processes\nAitchison, J. (1986).\nThe Statistical Analysis of Compositional Data\n.\nChapman and Hall\n, London.\nvan den Boogaart, K. G., & Tolosana-Delgado, R. (2013).\nAnalyzing compositional data with R\n.\nSpringer\n.\nBürkner, P. C. (2017).\nbrms: An R package for Bayesian multilevel models using Stan\n.\nJournal of Statistical Software\n, 80(1), 1-28.\nBürkner, P. C. (2018).\nAdvanced Bayesian multilevel modeling with the R package brms\n.\nThe R Journal\n, 10(1), 395-411.\nHijazi, R. H., & Jernigan, R. W. (2009).\nModelling compositional data using Dirichlet regression models\n.\nJournal of Applied Probability & Statistics\n, 4(1), 77-91.\nMaier, M. J. (2014).\nDirichletReg: Dirichlet regression for compositional data in R\n.\nResearch Report Series\n, Department of Statistics and Mathematics, 125.\nRasmussen, C. E., & Williams, C. K. I. (2006).\nGaussian processes for machine learning\n.\nMIT Press\n.\nRiutort-Mayol, G., Bürkner, P. C., Andersen, M. R., Solin, A., & Vehtari, A. (2023).\nPractical Hilbert space approximate Bayesian Gaussian processes for probabilistic programming\n.\nStatistics and Computing\n, 33(1), 17.\nThorson, J. T., Ianelli, J. N., Larsen, E. A., Ries, L., Scheuerell, M. D., Szuwalski, C., & Zipkin, E. F. (2016).\nJoint dynamic species distribution models: a tool for community ordination and spatio-temporal monitoring\n.\nGlobal Ecology and Biogeography\n, 25(9), 1144-1158.\nWarton, D. I., Blanchet, F. G., O’Hara, R. B., Ovaskainen, O., Taskinen, S., Walker, S. C., & Hui, F. K. (2015).\nSo many variables: joint modeling in community ecology\n.\nTrends in Ecology & Evolution\n, 30(12), 766-779.\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nGAMbler\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "Compositional data, where observations represent proportions that sum to a constant, are ubiquitous in ecology, yet many analysts fall back on problematic approaches like separate binomial models, beta regression on ratios, or worse, standard linear regression on raw proportions. These methods ignore the fundamental constraint that proportions must sum to unity and fail to model the inherent dependencies between components. Aitchison’s landmark work established the mathematical foundation for proper compositional analysis, while van den Boogaart & Tolosana-Delgado provide comprehensive coverage of modern compositional data analysis methods. Here I demonstrate how Dirichlet regression with Gaussian process smooths provides a principled, flexible framework for modeling plant community composition across environmental gradients. I’ll use Riutort-Mayol et al’s approximate Hilbert space Gaussian processes, which make these models computationally tractable even for moderately large datasets. Overview of this post Compositional data appears everywhere in scientific research: microbiome relative abundances in biology, market share distributions in economics, geological mineral compositions in earth sciences, time allocation in behavioral studies, and survey response proportions in social research. Yet despite this ubiquity, many analysts resort to problematic approaches that ignore the fundamental constraint that components must sum to a constant (typically 1 or 100%). This post addresses two critical challenges data scientists face with compositional data. Methodologically, I demonstrate why standard approaches like separate Binomial models or Beta regression on ratios fail to capture the inherent dependencies between components, leading to impossible predictions and inefficient inference. If you’ve worked with GAMs for time series analysis like I have, you’ll appreciate how Gaussian processes provide similar flexibility for capturing nonlinear relationships while respecting compositional constraints. Computationally, I show how approximate Hilbert space Gaussian processes make sophisticated nonlinear modeling feasible for realistic dataset sizes, overcoming the traditional scalability limitations of GP methods. This builds on the same computational advances that make complex hierarchical models practical for everyday use. I begin with the mathematical foundation of the Dirichlet distribution and its regression parameterization, emphasizing how brms enables separate linear predictors for each component. Next, I simulate realistic plant community data to demonstrate complex ecological relationships. I then fit Dirichlet regression models with bivariate Gaussian process smooths, extract and visualize predictions across environmental gradients, and interpret the results. Throughout, I emphasize practical implementation details and computational considerations that make this approach accessible for real-world applications. By the end, you’ll understand when and how to apply Dirichlet regression to your own compositional data, regardless of scientific domain. Plus, you’ll never again have to explain to a collaborator why your separate logistic regressions predict that 130% of survey respondents chose option A. The Dirichlet distribution and compositional constraints For a \\({\\color{#FDE725}{K}}\\)-component composition \\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, {\\color{#440154}{y_2}}, \\ldots, {\\color{#440154}{y_K}})\\) where \\(\\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}} = 1\\) and \\({\\color{#440154}{y_k}} > 0\\), the Dirichlet distribution provides a natural model: $${\\color{#440154}{\\boldsymbol{y}}} \\sim \\text{Dirichlet}({\\color{#31688E}{\\boldsymbol{\\alpha}}})$$ where \\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, {\\color{#31688E}{\\alpha_2}}, \\ldots, {\\color{#31688E}{\\alpha_K}})\\) are positive concentration parameters. The probability density is: $$f({\\color{#440154}{\\boldsymbol{y}}}|{\\color{#31688E}{\\boldsymbol{\\alpha}}}) = \\frac{\\Gamma({\\color{#31688E}{\\alpha_0}})}{\\prod_{k=1}^{\\color{#FDE725}{K}} \\Gamma({\\color{#31688E}{\\alpha_k}})} \\prod_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}}^{{\\color{#31688E}{\\alpha_k}} - 1}$$ with \\({\\color{#31688E}{\\alpha_0}} = \\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#31688E}{\\alpha_k}}\\) and \\(\\Gamma(\\cdot)\\) the gamma function. The expected proportion for component \\(k\\) is \\(\\mathbb{E}[{\\color{#440154}{y_k}}] = {\\color{#31688E}{\\alpha_k}} / {\\color{#31688E}{\\alpha_0}}\\), while the precision (inverse variance) increases with \\({\\color{#31688E}{\\alpha_0}}\\). In regression contexts, we model how \\({\\color{#31688E}{\\boldsymbol{\\alpha}}}\\) depends on predictors. The brms package uses a multivariate logit parameterization where the expected proportions \\({\\color{#35B779}{\\boldsymbol{\\mu}}} = \\mathbb{E}[{\\color{#440154}{\\boldsymbol{y}}}]\\) are linked to linear predictors via: $${\\color{#35B779}{\\mu_j}} = \\frac{\\exp({\\color{#21918C}{\\eta_j}})}{\\sum_{k=1}^{\\color{#FDE725}{K}} \\exp({\\color{#21918C}{\\eta_k}})}$$ where \\({\\color{#21918C}{\\eta_j}}\\) is the linear predictor for category \\(j\\). For identifiability, one category (typically the last) serves as reference with \\({\\color{#21918C}{\\eta_{\\text{ref}}}} = 0\\). This means we estimate separate linear predictors for \\({\\color{#FDE725}{K}}-1\\) categories: $${\\color{#21918C}{\\eta_j}} = \\boldsymbol{x}^T \\boldsymbol{\\beta}_j + f_j(\\boldsymbol{x}), \\quad j = 1, \\ldots, {\\color{#FDE725}{K}}-1$$ where \\(f_j(\\cdot)\\) represents smooth functions (like our Gaussian processes). This approach naturally ensures \\(\\sum_{k=1}^K \\mu_k = 1\\) while allowing each functional group to have its own flexible, nonlinear response to environmental gradients. Parameter guide for Dirichlet regression Let me break down what each parameter means in our ecological context, using the same color scheme as above: Observed composition \\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, ..., {\\color{#440154}{y_K}})\\): The actual proportions we observe at each site. In our case, this is a 5-element vector containing the relative abundances of grass, forb, shrub, tree, and lichen. These must sum to 1 and all be positive. Concentration parameters \\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, ..., {\\color{#31688E}{\\alpha_K}})\\): These control both the expected proportions and the precision of the distribution. Higher \\({\\color{#31688E}{\\alpha_k}}\\) means functional group \\(k\\) has higher expected proportion. The sum \\({\\color{#31688E}{\\alpha_0}} = \\sum_k {\\color{#31688E}{\\alpha_k}}\\) determines overall precision. Larger values mean less variance around expected proportions. Expected proportions \\({\\color{#35B779}{\\boldsymbol{\\mu}}} = ({\\color{#35B779}{\\mu_1}}, ..., {\\color{#35B779}{\\mu_K}})\\): The mean of the Dirichlet distribution, representing expected composition at any given environmental combination. This is what we’re ultimately interested in predicting, how community composition changes across environmental gradients. Linear predictors \\({\\color{#21918C}{\\eta_j}}\\) for \\(j = 1, ..., {\\color{#FDE725}{K}}-1\\): The unconstrained predictions before applying the softmax transformation. This is where we place our Gaussian process smooths of elevation and temperature. Note we only model \\({\\color{#FDE725}{K}}-1\\) predictors, with the last category serving as reference. Number of categories \\({\\color{#FDE725}{K}}\\): The dimensionality of our compositional data. For plant communities, \\({\\color{#FDE725}{K}}=5\\) functional groups. This could be any number of categories in other applications like market shares, time allocation, or mineral compositions. The key insight is that the linear predictors \\(\\eta_j\\) are where we incorporate environmental effects through Gaussian process smooths, allowing each functional group to have its own flexible, nonlinear response to environmental gradients while ensuring all predictions respect compositional constraints. Environment setup This tutorial relies on the following packages: library(brms) # Bayesian modeling with Stan library(tidyverse) # Data manipulation and visualization library(viridis) # Color palettes library(patchwork) # Plot composition library(waffle) # Waffle plots for compositional visualization library(cowplot) # Extract and manipulate plot components A custom ggplot2 theme; feel free to ignore if you have your own plot preferences # Set consistent ggplot theme for all visualizations theme_set( theme_classic( base_size = 15, base_family = 'serif' ) + theme( axis.line.x.bottom = element_line( colour = \"black\", size = 1 ), axis.line.y.left = element_line( colour = \"black\", size = 1 ) ) ) Simulating plant community data I simulate realistic plant community composition data across elevation and temperature gradients, where five functional groups (grasses, forbs, shrubs, trees, lichens) respond differently to environmental conditions. This simulation captures the ecological reality that different plant types show varying tolerance ranges and optimal growing conditions along environmental gradients—a pattern we’ll later model using Dirichlet regression. simulate_plant_community",
      "meta_keywords": null,
      "og_description": "Compositional data, where observations represent proportions that sum to a constant, are ubiquitous in ecology, yet many analysts fall back on problematic approaches like separate binomial models, beta regression on ratios, or worse, standard linear regression on raw proportions. These methods ignore the fundamental constraint that proportions must sum to unity and fail to model the inherent dependencies between components. Aitchison’s landmark work established the mathematical foundation for proper compositional analysis, while van den Boogaart & Tolosana-Delgado provide comprehensive coverage of modern compositional data analysis methods. Here I demonstrate how Dirichlet regression with Gaussian process smooths provides a principled, flexible framework for modeling plant community composition across environmental gradients. I’ll use Riutort-Mayol et al’s approximate Hilbert space Gaussian processes, which make these models computationally tractable even for moderately large datasets. Overview of this post Compositional data appears everywhere in scientific research: microbiome relative abundances in biology, market share distributions in economics, geological mineral compositions in earth sciences, time allocation in behavioral studies, and survey response proportions in social research. Yet despite this ubiquity, many analysts resort to problematic approaches that ignore the fundamental constraint that components must sum to a constant (typically 1 or 100%). This post addresses two critical challenges data scientists face with compositional data. Methodologically, I demonstrate why standard approaches like separate Binomial models or Beta regression on ratios fail to capture the inherent dependencies between components, leading to impossible predictions and inefficient inference. If you’ve worked with GAMs for time series analysis like I have, you’ll appreciate how Gaussian processes provide similar flexibility for capturing nonlinear relationships while respecting compositional constraints. Computationally, I show how approximate Hilbert space Gaussian processes make sophisticated nonlinear modeling feasible for realistic dataset sizes, overcoming the traditional scalability limitations of GP methods. This builds on the same computational advances that make complex hierarchical models practical for everyday use. I begin with the mathematical foundation of the Dirichlet distribution and its regression parameterization, emphasizing how brms enables separate linear predictors for each component. Next, I simulate realistic plant community data to demonstrate complex ecological relationships. I then fit Dirichlet regression models with bivariate Gaussian process smooths, extract and visualize predictions across environmental gradients, and interpret the results. Throughout, I emphasize practical implementation details and computational considerations that make this approach accessible for real-world applications. By the end, you’ll understand when and how to apply Dirichlet regression to your own compositional data, regardless of scientific domain. Plus, you’ll never again have to explain to a collaborator why your separate logistic regressions predict that 130% of survey respondents chose option A. The Dirichlet distribution and compositional constraints For a \\({\\color{#FDE725}{K}}\\)-component composition \\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, {\\color{#440154}{y_2}}, \\ldots, {\\color{#440154}{y_K}})\\) where \\(\\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}} = 1\\) and \\({\\color{#440154}{y_k}} > 0\\), the Dirichlet distribution provides a natural model: $${\\color{#440154}{\\boldsymbol{y}}} \\sim \\text{Dirichlet}({\\color{#31688E}{\\boldsymbol{\\alpha}}})$$ where \\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, {\\color{#31688E}{\\alpha_2}}, \\ldots, {\\color{#31688E}{\\alpha_K}})\\) are positive concentration parameters. The probability density is: $$f({\\color{#440154}{\\boldsymbol{y}}}|{\\color{#31688E}{\\boldsymbol{\\alpha}}}) = \\frac{\\Gamma({\\color{#31688E}{\\alpha_0}})}{\\prod_{k=1}^{\\color{#FDE725}{K}} \\Gamma({\\color{#31688E}{\\alpha_k}})} \\prod_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}}^{{\\color{#31688E}{\\alpha_k}} - 1}$$ with \\({\\color{#31688E}{\\alpha_0}} = \\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#31688E}{\\alpha_k}}\\) and \\(\\Gamma(\\cdot)\\) the gamma function. The expected proportion for component \\(k\\) is \\(\\mathbb{E}[{\\color{#440154}{y_k}}] = {\\color{#31688E}{\\alpha_k}} / {\\color{#31688E}{\\alpha_0}}\\), while the precision (inverse variance) increases with \\({\\color{#31688E}{\\alpha_0}}\\). In regression contexts, we model how \\({\\color{#31688E}{\\boldsymbol{\\alpha}}}\\) depends on predictors. The brms package uses a multivariate logit parameterization where the expected proportions \\({\\color{#35B779}{\\boldsymbol{\\mu}}} = \\mathbb{E}[{\\color{#440154}{\\boldsymbol{y}}}]\\) are linked to linear predictors via: $${\\color{#35B779}{\\mu_j}} = \\frac{\\exp({\\color{#21918C}{\\eta_j}})}{\\sum_{k=1}^{\\color{#FDE725}{K}} \\exp({\\color{#21918C}{\\eta_k}})}$$ where \\({\\color{#21918C}{\\eta_j}}\\) is the linear predictor for category \\(j\\). For identifiability, one category (typically the last) serves as reference with \\({\\color{#21918C}{\\eta_{\\text{ref}}}} = 0\\). This means we estimate separate linear predictors for \\({\\color{#FDE725}{K}}-1\\) categories: $${\\color{#21918C}{\\eta_j}} = \\boldsymbol{x}^T \\boldsymbol{\\beta}_j + f_j(\\boldsymbol{x}), \\quad j = 1, \\ldots, {\\color{#FDE725}{K}}-1$$ where \\(f_j(\\cdot)\\) represents smooth functions (like our Gaussian processes). This approach naturally ensures \\(\\sum_{k=1}^K \\mu_k = 1\\) while allowing each functional group to have its own flexible, nonlinear response to environmental gradients. Parameter guide for Dirichlet regression Let me break down what each parameter means in our ecological context, using the same color scheme as above: Observed composition \\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, ..., {\\color{#440154}{y_K}})\\): The actual proportions we observe at each site. In our case, this is a 5-element vector containing the relative abundances of grass, forb, shrub, tree, and lichen. These must sum to 1 and all be positive. Concentration parameters \\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, ..., {\\color{#31688E}{\\alpha_K}})\\): These control both the expected proportions and the precision of the distribution. Higher \\({\\color{#31688E}{\\alpha_k}}\\) means functional group \\(k\\) has higher expected proportion. The sum \\({\\color{#31688E}{\\alpha_0}} = \\sum_k {\\color{#31688E}{\\alpha_k}}\\) determines overall precision. Larger values mean less variance around expected proportions. Expected proportions \\({\\color{#35B779}{\\boldsymbol{\\mu}}} = ({\\color{#35B779}{\\mu_1}}, ..., {\\color{#35B779}{\\mu_K}})\\): The mean of the Dirichlet distribution, representing expected composition at any given environmental combination. This is what we’re ultimately interested in predicting, how community composition changes across environmental gradients. Linear predictors \\({\\color{#21918C}{\\eta_j}}\\) for \\(j = 1, ..., {\\color{#FDE725}{K}}-1\\): The unconstrained predictions before applying the softmax transformation. This is where we place our Gaussian process smooths of elevation and temperature. Note we only model \\({\\color{#FDE725}{K}}-1\\) predictors, with the last category serving as reference. Number of categories \\({\\color{#FDE725}{K}}\\): The dimensionality of our compositional data. For plant communities, \\({\\color{#FDE725}{K}}=5\\) functional groups. This could be any number of categories in other applications like market shares, time allocation, or mineral compositions. The key insight is that the linear predictors \\(\\eta_j\\) are where we incorporate environmental effects through Gaussian process smooths, allowing each functional group to have its own flexible, nonlinear response to environmental gradients while ensuring all predictions respect compositional constraints. Environment setup This tutorial relies on the following packages: library(brms) # Bayesian modeling with Stan library(tidyverse) # Data manipulation and visualization library(viridis) # Color palettes library(patchwork) # Plot composition library(waffle) # Waffle plots for compositional visualization library(cowplot) # Extract and manipulate plot components A custom ggplot2 theme; feel free to ignore if you have your own plot preferences # Set consistent ggplot theme for all visualizations theme_set( theme_classic( base_size = 15, base_family = 'serif' ) + theme( axis.line.x.bottom = element_line( colour = \"black\", size = 1 ), axis.line.y.left = element_line( colour = \"black\", size = 1 ) ) ) Simulating plant community data I simulate realistic plant community composition data across elevation and temperature gradients, where five functional groups (grasses, forbs, shrubs, trees, lichens) respond differently to environmental conditions. This simulation captures the ecological reality that different plant types show varying tolerance ranges and optimal growing conditions along environmental gradients—a pattern we’ll later model using Dirichlet regression. simulate_plant_community",
      "og_image": "https://ecogambler.netlify.app/blog/plant-community-dirichlet/index_files/figure-html/unnamed-chunk-6-1.png",
      "og_title": "Compositional modeling of plant communities with Dirichlet regression | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 27,
      "sitemap_lastmod": null,
      "twitter_description": "Compositional data, where observations represent proportions that sum to a constant, are ubiquitous in ecology, yet many analysts fall back on problematic approaches like separate binomial models, beta regression on ratios, or worse, standard linear regression on raw proportions. These methods ignore the fundamental constraint that proportions must sum to unity and fail to model the inherent dependencies between components. Aitchison’s landmark work established the mathematical foundation for proper compositional analysis, while van den Boogaart & Tolosana-Delgado provide comprehensive coverage of modern compositional data analysis methods. Here I demonstrate how Dirichlet regression with Gaussian process smooths provides a principled, flexible framework for modeling plant community composition across environmental gradients. I’ll use Riutort-Mayol et al’s approximate Hilbert space Gaussian processes, which make these models computationally tractable even for moderately large datasets. Overview of this post Compositional data appears everywhere in scientific research: microbiome relative abundances in biology, market share distributions in economics, geological mineral compositions in earth sciences, time allocation in behavioral studies, and survey response proportions in social research. Yet despite this ubiquity, many analysts resort to problematic approaches that ignore the fundamental constraint that components must sum to a constant (typically 1 or 100%). This post addresses two critical challenges data scientists face with compositional data. Methodologically, I demonstrate why standard approaches like separate Binomial models or Beta regression on ratios fail to capture the inherent dependencies between components, leading to impossible predictions and inefficient inference. If you’ve worked with GAMs for time series analysis like I have, you’ll appreciate how Gaussian processes provide similar flexibility for capturing nonlinear relationships while respecting compositional constraints. Computationally, I show how approximate Hilbert space Gaussian processes make sophisticated nonlinear modeling feasible for realistic dataset sizes, overcoming the traditional scalability limitations of GP methods. This builds on the same computational advances that make complex hierarchical models practical for everyday use. I begin with the mathematical foundation of the Dirichlet distribution and its regression parameterization, emphasizing how brms enables separate linear predictors for each component. Next, I simulate realistic plant community data to demonstrate complex ecological relationships. I then fit Dirichlet regression models with bivariate Gaussian process smooths, extract and visualize predictions across environmental gradients, and interpret the results. Throughout, I emphasize practical implementation details and computational considerations that make this approach accessible for real-world applications. By the end, you’ll understand when and how to apply Dirichlet regression to your own compositional data, regardless of scientific domain. Plus, you’ll never again have to explain to a collaborator why your separate logistic regressions predict that 130% of survey respondents chose option A. The Dirichlet distribution and compositional constraints For a \\({\\color{#FDE725}{K}}\\)-component composition \\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, {\\color{#440154}{y_2}}, \\ldots, {\\color{#440154}{y_K}})\\) where \\(\\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}} = 1\\) and \\({\\color{#440154}{y_k}} > 0\\), the Dirichlet distribution provides a natural model: $${\\color{#440154}{\\boldsymbol{y}}} \\sim \\text{Dirichlet}({\\color{#31688E}{\\boldsymbol{\\alpha}}})$$ where \\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, {\\color{#31688E}{\\alpha_2}}, \\ldots, {\\color{#31688E}{\\alpha_K}})\\) are positive concentration parameters. The probability density is: $$f({\\color{#440154}{\\boldsymbol{y}}}|{\\color{#31688E}{\\boldsymbol{\\alpha}}}) = \\frac{\\Gamma({\\color{#31688E}{\\alpha_0}})}{\\prod_{k=1}^{\\color{#FDE725}{K}} \\Gamma({\\color{#31688E}{\\alpha_k}})} \\prod_{k=1}^{\\color{#FDE725}{K}} {\\color{#440154}{y_k}}^{{\\color{#31688E}{\\alpha_k}} - 1}$$ with \\({\\color{#31688E}{\\alpha_0}} = \\sum_{k=1}^{\\color{#FDE725}{K}} {\\color{#31688E}{\\alpha_k}}\\) and \\(\\Gamma(\\cdot)\\) the gamma function. The expected proportion for component \\(k\\) is \\(\\mathbb{E}[{\\color{#440154}{y_k}}] = {\\color{#31688E}{\\alpha_k}} / {\\color{#31688E}{\\alpha_0}}\\), while the precision (inverse variance) increases with \\({\\color{#31688E}{\\alpha_0}}\\). In regression contexts, we model how \\({\\color{#31688E}{\\boldsymbol{\\alpha}}}\\) depends on predictors. The brms package uses a multivariate logit parameterization where the expected proportions \\({\\color{#35B779}{\\boldsymbol{\\mu}}} = \\mathbb{E}[{\\color{#440154}{\\boldsymbol{y}}}]\\) are linked to linear predictors via: $${\\color{#35B779}{\\mu_j}} = \\frac{\\exp({\\color{#21918C}{\\eta_j}})}{\\sum_{k=1}^{\\color{#FDE725}{K}} \\exp({\\color{#21918C}{\\eta_k}})}$$ where \\({\\color{#21918C}{\\eta_j}}\\) is the linear predictor for category \\(j\\). For identifiability, one category (typically the last) serves as reference with \\({\\color{#21918C}{\\eta_{\\text{ref}}}} = 0\\). This means we estimate separate linear predictors for \\({\\color{#FDE725}{K}}-1\\) categories: $${\\color{#21918C}{\\eta_j}} = \\boldsymbol{x}^T \\boldsymbol{\\beta}_j + f_j(\\boldsymbol{x}), \\quad j = 1, \\ldots, {\\color{#FDE725}{K}}-1$$ where \\(f_j(\\cdot)\\) represents smooth functions (like our Gaussian processes). This approach naturally ensures \\(\\sum_{k=1}^K \\mu_k = 1\\) while allowing each functional group to have its own flexible, nonlinear response to environmental gradients. Parameter guide for Dirichlet regression Let me break down what each parameter means in our ecological context, using the same color scheme as above: Observed composition \\({\\color{#440154}{\\boldsymbol{y}}} = ({\\color{#440154}{y_1}}, ..., {\\color{#440154}{y_K}})\\): The actual proportions we observe at each site. In our case, this is a 5-element vector containing the relative abundances of grass, forb, shrub, tree, and lichen. These must sum to 1 and all be positive. Concentration parameters \\({\\color{#31688E}{\\boldsymbol{\\alpha}}} = ({\\color{#31688E}{\\alpha_1}}, ..., {\\color{#31688E}{\\alpha_K}})\\): These control both the expected proportions and the precision of the distribution. Higher \\({\\color{#31688E}{\\alpha_k}}\\) means functional group \\(k\\) has higher expected proportion. The sum \\({\\color{#31688E}{\\alpha_0}} = \\sum_k {\\color{#31688E}{\\alpha_k}}\\) determines overall precision. Larger values mean less variance around expected proportions. Expected proportions \\({\\color{#35B779}{\\boldsymbol{\\mu}}} = ({\\color{#35B779}{\\mu_1}}, ..., {\\color{#35B779}{\\mu_K}})\\): The mean of the Dirichlet distribution, representing expected composition at any given environmental combination. This is what we’re ultimately interested in predicting, how community composition changes across environmental gradients. Linear predictors \\({\\color{#21918C}{\\eta_j}}\\) for \\(j = 1, ..., {\\color{#FDE725}{K}}-1\\): The unconstrained predictions before applying the softmax transformation. This is where we place our Gaussian process smooths of elevation and temperature. Note we only model \\({\\color{#FDE725}{K}}-1\\) predictors, with the last category serving as reference. Number of categories \\({\\color{#FDE725}{K}}\\): The dimensionality of our compositional data. For plant communities, \\({\\color{#FDE725}{K}}=5\\) functional groups. This could be any number of categories in other applications like market shares, time allocation, or mineral compositions. The key insight is that the linear predictors \\(\\eta_j\\) are where we incorporate environmental effects through Gaussian process smooths, allowing each functional group to have its own flexible, nonlinear response to environmental gradients while ensuring all predictions respect compositional constraints. Environment setup This tutorial relies on the following packages: library(brms) # Bayesian modeling with Stan library(tidyverse) # Data manipulation and visualization library(viridis) # Color palettes library(patchwork) # Plot composition library(waffle) # Waffle plots for compositional visualization library(cowplot) # Extract and manipulate plot components A custom ggplot2 theme; feel free to ignore if you have your own plot preferences # Set consistent ggplot theme for all visualizations theme_set( theme_classic( base_size = 15, base_family = 'serif' ) + theme( axis.line.x.bottom = element_line( colour = \"black\", size = 1 ), axis.line.y.left = element_line( colour = \"black\", size = 1 ) ) ) Simulating plant community data I simulate realistic plant community composition data across elevation and temperature gradients, where five functional groups (grasses, forbs, shrubs, trees, lichens) respond differently to environmental conditions. This simulation captures the ecological reality that different plant types show varying tolerance ranges and optimal growing conditions along environmental gradients—a pattern we’ll later model using Dirichlet regression. simulate_plant_community",
      "twitter_title": "Compositional modeling of plant communities with Dirichlet regression | R-bloggers",
      "url": "https://www.r-bloggers.com/2025/10/compositional-modeling-of-plant-communities-with-dirichlet-regression/",
      "word_count": 5396
    }
  }
}