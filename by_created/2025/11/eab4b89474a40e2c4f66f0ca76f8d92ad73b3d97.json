{
  "id": "eab4b89474a40e2c4f66f0ca76f8d92ad73b3d97",
  "url": "https://www.r-bloggers.com/2009/11/my-implementation-of-berry-and-berrys-hierarchical-bayes-algorithm-for-adverse-events/",
  "created_at_utc": "2025-11-17T20:39:56Z",
  "data": null,
  "raw_original": {
    "uuid": "2c906b7e-bec7-4aa8-8588-e44556eb5166",
    "created_at": "2025-11-17 20:39:56",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2009/11/my-implementation-of-berry-and-berrys-hierarchical-bayes-algorithm-for-adverse-events/",
      "crawled_at": "2025-11-17T10:16:07.839954",
      "external_links": [
        {
          "href": "https://realizationsinbiostatistics.blogspot.com/2009/11/my-implementation-of-berry-and-berrys.html",
          "text": "Realizations in Biostatistics"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://realizationsinbiostatistics.blogspot.com/2009/11/working-on-drug-safety-project.html",
          "text": "here"
        },
        {
          "href": "https://realizationsinbiostatistics.blogspot.com/2009/11/my-implementation-of-berry-and-berrys.html",
          "text": "Realizations in Biostatistics"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "My implementation of Berry and Berry’s hierarchical Bayes algorithm for adverse events | R-bloggers",
      "images": [],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/john-johnson/",
          "text": "John Johnson"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-59512 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">My implementation of Berry and Berry’s hierarchical Bayes algorithm for adverse events</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">November 20, 2009</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/john-johnson/\">John Johnson</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<p class=\"syndicated-attribution\"><!-- \r\n<div style=\"min-height: 30px;\">\r\n[social4i size=\"small\" align=\"align-left\"]\r\n</div>\r\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\r\n[This article was first published on  <strong><a href=\"https://realizationsinbiostatistics.blogspot.com/2009/11/my-implementation-of-berry-and-berrys.html\"> Realizations in Biostatistics</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</div></p>\n\n<!-- Share buttons by mashshare.net - Version: 3.8.0-->I’ve been working on this for quite some time (see <a href=\"https://realizationsinbiostatistics.blogspot.com/2009/11/working-on-drug-safety-project.html\" rel=\"nofollow\" target=\"_blank\">here</a> for a little background), so I’m pleased that it looks close to done at least as far as the core algorithm. It uses global variables for now, and I’m sure there are a couple of other bugs lurking, but here it is, after the jump.<br/><br/><br/><a name=\"more\"></a><br/><pre>const.sqrt2pi &lt;- sqrt(2*3.14159265358979)\nlogit &lt;- function(x) return(x/(1-x))\nthetacond.log &lt;- function(b,j,thet=theta[b,j]) {\n    res &lt;- y[b,j]*(thet+gamm[b,j])-nt*log(1+exp(thet+gamm[b,j]))+\n        log(pi[b]*(thet==0) +(1-pi[b])/\n            (const.sqrt2pi*sigma.theta[b])*exp(-0.5*(thet-mu.theta[b])^2/sigma.theta[b]^2))\n    return(res)\n}\nthetabj.update &lt;- function() {\n    # this is a mixture MH step, as described in Berry and Berry (2004)\n    for (b in 1:nbodysys) {\n        for (j in 1:nae[b]) {\n                                        # simulate new candidate - point mass at 0 and normal mixture\n            if (runif(1)&lt;0.5) {\n                thetabj.cand &lt;- 0\n            } else {\n                thetabj.cand &lt;- rnorm(1,mean=theta[b,j],sd=sigma.mh.theta)\n            }\n            #cat(\"b=\",b,\", j=\",j,sep=\"\")\n            ccond.ratio &lt;- exp(thetacond.log(b,j,thet=thetabj.cand)-thetacond.log(b,j))\n            if (theta[b,j]==0 &amp;&amp; thetabj.cand==0 &amp;&amp; runif(1)\n                theta[b,j]&lt;&lt;-thetabj.cand\n                #cat(\"cond=1, acceptance probability=\",ccond.ratio,'\\n',sep=\"\")\n            }\n            else if (thetabj.cand==0 &amp;&amp; theta[b,j]!=0 &amp;&amp; runif(1)&lt;\n                     ccond.ratio*exp(-0.5*theta[b,j]^2/sigma.mh.theta^2)/sigma.mh.theta/const.sqrt2pi)\n            {\n                theta[b,j]&lt;&lt;-thetabj.cand\n                #cat(\"cond=2, acc prob=\",ccond.ratio*exp(-0.5*theta[b,j]^2/sigma.mh.theta^2)/sigma.mh.theta/const.sqrt2pi,'\\n',sep=\"\")\n            }\n            else if (thetabj.cand!=0 &amp;&amp; theta[b,j]==0 &amp;&amp;\n                     runif(1)\n            {\n                theta[b,j]&lt;&lt;-thetabj.cand\n                #cat(\"cond=3, acc prob=\",ccond.ratio/exp(-0.5*theta[b,j]^2/sigma.mh.theta^2)*sigma.mh.theta*const.sqrt2pi,'\\n',sep=\"\")\n            }\n            else if (thetabj.cand!=0 &amp;&amp; theta[b,j]!=0 &amp;&amp; runif(1)\n            {\n                theta[b,j]&lt;&lt;-thetabj.cand\n                #cat(\"cond=4, acceptance probability=\",ccond.ratio,'\\n',sep=\"\")\n            }\n            #else cat('\\n')\n        }\n    }\n}\ngammabj.cond.log &lt;- function(b,j,g=gamm[b,j]) {\n    tmp1 &lt;- exp(theta[b,j]+g)\n    tmp2 &lt;- exp(g)\n    return(y[b,j]*(theta[b,j]+g)-nt*log(1+tmp1)+x[b,j]*g-nc*log(1+tmp2)\n           -0.5/sigma.gamma^2*(g-mu.gamma[b])^2)\n}\ngammabj.update &lt;- function() {\n    for (b in 1:nbodysys) {\n        for (j in 1:nae[b]) {\n            cand &lt;- rnorm(1,mean=gamm[b,j],sd=sigma.mh.gamma)\n            acc.prob &lt;- exp(gammabj.cond.log(b,j,g=cand)-gammabj.cond.log(b,j))\n                                        #if (acc.prob&gt;1) then acc.prob&lt;-1 # not sure we need this for program\n            if (runif(1)&lt;&lt;-cand\n        }\n    }\n}\npib.update &lt;- function() {\n    for (b in 1:nbodysys) {\n        pi[b] &lt;&lt;- rbeta(1,alpha.pi+sum(theta[b,1:nae[b]]==0,na.rm=T),beta.pi+nae[b]-sum(theta[b,1:nae[b]]==0,na.rm=T))\n    }\n}\nsigma.theta.update &lt;- function() {\n    for (b in 1:nbodysys) {\n        sigma2.rand &lt;- rgamma(1,nae[b]/2+alpha.theta,\n                              scale=1/beta.theta+0.5*sum((theta[b,1:nae[b]]-mu.theta[b])^2,na.rm=T)) # fixed\n        sigma.theta[b] &lt;&lt;- 1/sqrt(sigma2.rand)\n    }\n}\nsigma.gamma.update &lt;- function()\n{\n    tmp&lt;-0\n    for (b in 1:nbodysys) {\n        tmp &lt;- tmp+sum((gamm[b,1:nae[b]]-mu.gamma[b])^2,na.rm=T)\n    }\n    sigma2.rand &lt;- rgamma(1,0.5*sum(nae)+alpha.sigma.gamma,scale=1/beta.sigma.gamma+\n                          0.5*tmp) #fixed\n    sigma.gamma &lt;&lt;- 1/sqrt(sigma.gamma)\n}\ntau.gamma0.update &lt;- function()\n{\n    tau2.gamma0 &lt;- rgamma(1,0.5*nbodysys+alpha.tau.gamma,scale=1/beta.tau.gamma+0.5*\n                          sum((mu.gamma-mu.gamma0)^2)) #fixed\n    tau.gamma0 &lt;&lt;- 1/sqrt(tau2.gamma0)\n}\ntau.theta0.update &lt;- function()\n{\n    tau2.theta0 &lt;- rgamma(1,0.5*nbodysys+alpha.tau.theta,scale=1/beta.tau.theta+0.5*\n                          sum((mu.theta-mu.theta0)^2)) #fixed\n    tau.theta0 &lt;&lt;- 1/sqrt(tau2.theta0)\n}\nmu.gamma.update &lt;- function() {\n    for (b in 1:nbodysys) {\n        gibbs.mu &lt;- (tau.gamma0^2*sum(gamm[b,1:nae[b]],na.rm=T)+sigma.gamma^2*mu.gamma0)/\n            (tau.gamma0^2*nae[b]+sigma.gamma^2)\n        gibbs.sigma2 &lt;- tau.gamma0^2*sigma.gamma^2/(tau.gamma0^2*nae[b]+sigma.gamma^2)\n        mu.gamma[b] &lt;&lt;- rnorm(1,mean=gibbs.mu,sd=sqrt(gibbs.sigma2))\n    }\n}\nmu.theta.update &lt;- function() {\n    for (b in 1:nbodysys) {\n        gibbs.mu &lt;- (tau.theta0^2*sum(theta[b,1:nae[b]],na.rm=T)+sigma.theta^2*mu.theta0)/\n            (tau.theta0^2*nae[b]+sigma.theta^2)\n        gibbs.sigma2 &lt;- tau.theta0^2*sigma.theta^2/(tau.theta0^2*nae[b]+sigma.theta^2)\n        mu.theta[b] &lt;&lt;- rnorm(1,mean=gibbs.mu,sd=sqrt(gibbs.sigma2))\n    }\n}\nmu.gamma0.update &lt;- function()\n{\n    gibbs.mu &lt;- (tau.gamma00^2*sum(mu.gamma)+tau.gamma0^2*mu.gamma00) /\n        (tau.gamma00^2*nbodysys+tau.gamma0^2)\n    gibbs.sigma2 &lt;- tau.gamma00^2*tau.gamma0^2/(tau.gamma00^2*nbodysys +\n                                                tau.gamma0^2)\n    mu.gamma0 &lt;&lt;- rnorm(1,mean=gibbs.mu,sd=sqrt(gibbs.sigma2))\n}\nmu.theta0.update &lt;- function()\n{\n    gibbs.mu &lt;- (tau.theta00^2*sum(mu.theta)+tau.theta0^2*mu.theta00) /\n        (tau.theta00^2*nbodysys+tau.theta0^2)\n    gibbs.sigma2 &lt;- tau.theta00^2*tau.theta0^2/(tau.theta00^2*nbodysys +\n                                                tau.theta0^2)\n    mu.theta0 &lt;&lt;- rnorm(1,mean=gibbs.mu,sd=sqrt(gibbs.sigma2))\n}\nalpha.pi.logcond &lt;- function(alpha=alpha.pi) {\n    if (alpha&lt;=1) return(-Inf)\n    else {\n        return(nbodysys*(lgamma(alpha+beta.pi)-lgamma(alpha))+\n               (alpha+1)*sum(log(pi))-alpha*lambda.alpha)\n    }\n}\nalpha.pi.update &lt;- function() {\n    cand &lt;- rnorm(1,mean=alpha.pi,sd=sigma.mh.theta)\n    acc.prob &lt;- exp(alpha.pi.logcond(alpha=cand)-alpha.pi.logcond())\n    if (runif(1)&lt;&lt;-cand\n}\nbeta.pi.logcond &lt;- function(beta=beta.pi) {\n    if (beta&lt;=1) return(-Inf)\n    else {\n        return(nbodysys*(lgamma(beta+alpha.pi)-lgamma(beta))+\n               (beta+1)*sum(log(1-pi))-beta*lambda.beta)\n    }\n}\nbeta.pi.update &lt;- function() {\n    cand &lt;- rnorm(1,mean=beta.pi,sd=sigma.mh.theta)\n    acc.prob &lt;- exp(beta.pi.logcond(beta=cand)-beta.pi.logcond())\n    if (runif(1)&lt;&lt;-cand\n}\n                                        # set up constants as in sec 4\nmu.theta00&lt;-0\ntau.theta00 &lt;- sqrt(10)\nmu.gamma00 &lt;- 0\ntau.gamma00 &lt;- sqrt(10)\nalpha.theta &lt;- 3\nbeta.theta &lt;- 1\nalpha.theta0 &lt;- 3\nbeta.theta0 &lt;- 1\nalpha.tau.gamma&lt;-3\nbeta.tau.gamma &lt;- 1\nalpha.tau.theta &lt;- 3\nbeta.tau.theta &lt;- 1\nalpha.sigma.gamma&lt;-3\nbeta.sigma.gamma &lt;- 1\nlambda.alpha&lt;-1\nlambda.beta &lt;- 1\n                                        # parms for the example in berry and berry\nae.dat &lt;- read.table(file=\"ae.dat\",header=T)\nae.dat$bodysysf &lt;- factor(ae.dat$bodysys)\nnt &lt;- 148\nnc &lt;- 132\nnae &lt;- tapply(ae.dat$aenum,ae.dat$bodysysf,length)\nnbodysys &lt;- length(levels(ae.dat$bodysysf))\ny &lt;- matrix(NA,nrow=nbodysys,ncol=max(nae))\nx &lt;- matrix(NA,nrow=nbodysys,ncol=max(nae))\nfor (i in 1:nbodysys) {\ny[i,1:nae[i]] &lt;- ae.dat$trtct[ae.dat$bodysysf==as.numeric(levels(ae.dat$bodysysf)[i])]\nx[i,1:nae[i]] &lt;- ae.dat$contct[ae.dat$bodysysf==as.numeric(levels(ae.dat$bodysysf)[i])]\n}\nsigma.mh.theta &lt;- 2\nsigma.mh.gamma &lt;- 2\n                                        # set up containers\ntheta &lt;- matrix(NA,nrow=nbodysys,ncol=max(nae))\ngamm &lt;- matrix(NA,nrow=nbodysys,ncol=max(nae))\npi &lt;- rep(NA,length=nbodysys)\nsigma.theta &lt;- rep(NA,length=nbodysys)\nsigma.gamma &lt;- NA\ntau.gamma0 &lt;- NA\ntau.theta0 &lt;- NA\nmu.gamma &lt;- rep(NA,length=nbodysys)\nmu.theta &lt;- rep(NA,length=nbodysys)\nmu.gamma0 &lt;- NA\nmu.theta0 &lt;- NA\nalpha.pi &lt;- NA\nbeta.pi &lt;- NA\n\n\n                                        # initial values\ngamm &lt;- logit(x/nc)\ntheta &lt;- logit(y/nt)-gamm\npi &lt;- rep(.5,length=nbodysys)\nsigma.theta &lt;- rep(1,length=nbodysys)\nsigma.gamma &lt;- 1\ntau.gamma0 &lt;- 1\ntau.theta0 &lt;- 1\nmu.gamma &lt;- rep(0,length=nbodysys)\nmu.theta &lt;- rep(0,length=nbodysys)\nmu.gamma0 &lt;- 0\nmu.theta0 &lt;- 1\nalpha.pi &lt;- 1.5\nbeta.pi &lt;- 1.5\n                                        # chains\nn.iter &lt;- 11000\nn.burnin &lt;- 1000\ntheta.chain &lt;- array(NA,dim=c(nbodysys,max(nae),n.iter))\ngammabj.chain &lt;- array(NA,dim=c(nbodysys,max(nae),n.iter))\nfor (i in 1:n.iter)\n{\n    thetabj.update()\n    theta.chain[,,i] &lt;- theta\n    gammabj.update()\n    gammabj.chain[,,i] &lt;- gamm\n    pib.update()\n    sigma.theta.update()\n    sigma.gamma.update()\n    tau.gamma0.update()\n    tau.theta0.update()\n    mu.gamma.update()\n    mu.theta.update()\n    mu.gamma0.update()\n    mu.theta0.update()\n    alpha.pi.update()\n    beta.pi.update()\n}\nfor (b in 1:nbodysys)\n{\n    for (j in 1:nae[b])\n    {\n        if (b==1 &amp;&amp; j==1) {\n            cat(sprintf(\"%5s%5s%10s%10s\\n\",\"b\",\"j\",\"P(th=0)\",\"P(th&gt;0)\"))\n            cat(sprintf(\"%5s%5s%10s%10s\\n\",\"---\",\"---\",\"------\",\"------\"))\n        }\n        cat(sprintf(\"%5s%5d%10.3f%10.3f\\n\",names(nae)[b],j,sum(theta.chain[b,j,(n.burnin+1):n.iter]==0)/sum(!is.na(theta.chain[b,j,(n.burnin+1):n.iter])),sum(theta.chain[b,j,(n.burnin+1):n.iter]&gt;0)/sum(!is.na(theta.chain[b,j,(n.burnin+1):n.iter]))))\n    }\n}\n#mean(theta.chain[1,1,(n.burnin+1):n.iter],na.rm=T)\nplot(theta.chain[1,1,(n.burnin+1):n.iter],type='b',pch=0)\nplot(theta.chain[2,4,(n.burnin+1):n.iter],type='b')\nplot(theta.chain[2,4,1:n.iter],type='b')\nsum(theta.chain[2,4,])/n.iter\ngammabj.chain[1,1,(n.burnin+1):n.iter]\nplot(theta.chain[6,2,(n.burnin+1):n.iter],type='b')\nhist(theta.chain[1,1,(n.burnin+1):n.iter])\n#acceptance rate\nfoo &lt;- theta.chain[1,1,(n.burnin+1):n.iter]\nsum(foo[2:(n.iter-n.burnin)]!=foo[1:(n.iter-n.burnin-1)])/(n.iter-n.burnin+1)\n</pre><div><br/></div>The datafile ae.dat copies the vaccine data from the article and looks like the following:<br/><br/><pre># data for Berry and Berry AE model\nbodysys aenum ae trtct contct\n1 1 astenia/fatigue 57 40\n1 2 fever 34 26\n1 3 infection/fungal 2 0\n1 4 infection/viral 3 1\n1 5 malaise 27 20\n3 1 anorexia 7 2\n3 2 cendisiasis/oral 2 0\n3 3 constipation 2 0\n3 4 diarrhea 24 10\n3 5 castroenteritis 3 1\n3 6 nausea 2 7\n3 7 vomiting 19 19\n5 1 lymphadenopathy 3 2\n6 1 dehydration 0 2\n8 1 crying 2 0\n8 2 insomnia 2 2\n8 3 irritability  75 43\n9 1 bronchitis 4 1\n9 2 congestion/nasal 4 2\n9 3 congestion/respiratory 1 2\n9 4 cough 13 8\n9 5 infection/upper_respiratory 28 20\n9 6 laryngotracheobronchitis 2 1\n9 7 pharyngitis 13 8\n9 8 rhinorrhea 15 14\n9 9 sinusitis 3 1\n9 10 tonsillitis 2 1\n9 11 wheezing 3 1\n10 1 bite/sting 4 0\n10 2 eczema 2 0\n10 3 pruritis 2 1\n10 4 rash 13 3\n10 5 rash/diaper 6 2\n10 6 rash/measles/rubella-like 8 1\n10 7 rash/varicella-like 4 2\n10 8 urticaria 0 2\n10 9 viral/exanthema 1 2\n11 1 conjunctivitis 0 2\n11 2 otitis/media 18 14\n11 3 otorrhea 2 1\n</pre><br/>I make no claims to the correctness of this code, but I have gotten results that are close to the Berry and Berry article.\r\n\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 3.8.0-->\n<p class=\"syndicated-attribution\"><div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://realizationsinbiostatistics.blogspot.com/2009/11/my-implementation-of-berry-and-berrys.html\"> Realizations in Biostatistics</a></strong>.</div>\n<hr>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\r\n\r\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\r\n</hr></div></p> </div>\n</article>",
      "main_text": "My implementation of Berry and Berry’s hierarchical Bayes algorithm for adverse events\nPosted on\nNovember 20, 2009\nby\nJohn Johnson\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nRealizations in Biostatistics\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nI’ve been working on this for quite some time (see\nhere\nfor a little background), so I’m pleased that it looks close to done at least as far as the core algorithm. It uses global variables for now, and I’m sure there are a couple of other bugs lurking, but here it is, after the jump.\nconst.sqrt2pi <- sqrt(2*3.14159265358979)\nlogit <- function(x) return(x/(1-x))\nthetacond.log <- function(b,j,thet=theta[b,j]) {\n    res <- y[b,j]*(thet+gamm[b,j])-nt*log(1+exp(thet+gamm[b,j]))+\n        log(pi[b]*(thet==0) +(1-pi[b])/\n            (const.sqrt2pi*sigma.theta[b])*exp(-0.5*(thet-mu.theta[b])^2/sigma.theta[b]^2))\n    return(res)\n}\nthetabj.update <- function() {\n    # this is a mixture MH step, as described in Berry and Berry (2004)\n    for (b in 1:nbodysys) {\n        for (j in 1:nae[b]) {\n                                        # simulate new candidate - point mass at 0 and normal mixture\n            if (runif(1)<0.5) {\n                thetabj.cand <- 0\n            } else {\n                thetabj.cand <- rnorm(1,mean=theta[b,j],sd=sigma.mh.theta)\n            }\n            #cat(\"b=\",b,\", j=\",j,sep=\"\")\n            ccond.ratio <- exp(thetacond.log(b,j,thet=thetabj.cand)-thetacond.log(b,j))\n            if (theta[b,j]==0 && thetabj.cand==0 && runif(1)\n                theta[b,j]<<-thetabj.cand\n                #cat(\"cond=1, acceptance probability=\",ccond.ratio,'\\n',sep=\"\")\n            }\n            else if (thetabj.cand==0 && theta[b,j]!=0 && runif(1)<\n                     ccond.ratio*exp(-0.5*theta[b,j]^2/sigma.mh.theta^2)/sigma.mh.theta/const.sqrt2pi)\n            {\n                theta[b,j]<<-thetabj.cand\n                #cat(\"cond=2, acc prob=\",ccond.ratio*exp(-0.5*theta[b,j]^2/sigma.mh.theta^2)/sigma.mh.theta/const.sqrt2pi,'\\n',sep=\"\")\n            }\n            else if (thetabj.cand!=0 && theta[b,j]==0 &&\n                     runif(1)\n            {\n                theta[b,j]<<-thetabj.cand\n                #cat(\"cond=3, acc prob=\",ccond.ratio/exp(-0.5*theta[b,j]^2/sigma.mh.theta^2)*sigma.mh.theta*const.sqrt2pi,'\\n',sep=\"\")\n            }\n            else if (thetabj.cand!=0 && theta[b,j]!=0 && runif(1)\n            {\n                theta[b,j]<<-thetabj.cand\n                #cat(\"cond=4, acceptance probability=\",ccond.ratio,'\\n',sep=\"\")\n            }\n            #else cat('\\n')\n        }\n    }\n}\ngammabj.cond.log <- function(b,j,g=gamm[b,j]) {\n    tmp1 <- exp(theta[b,j]+g)\n    tmp2 <- exp(g)\n    return(y[b,j]*(theta[b,j]+g)-nt*log(1+tmp1)+x[b,j]*g-nc*log(1+tmp2)\n           -0.5/sigma.gamma^2*(g-mu.gamma[b])^2)\n}\ngammabj.update <- function() {\n    for (b in 1:nbodysys) {\n        for (j in 1:nae[b]) {\n            cand <- rnorm(1,mean=gamm[b,j],sd=sigma.mh.gamma)\n            acc.prob <- exp(gammabj.cond.log(b,j,g=cand)-gammabj.cond.log(b,j))\n                                        #if (acc.prob>1) then acc.prob<-1 # not sure we need this for program\n            if (runif(1)<<-cand\n        }\n    }\n}\npib.update <- function() {\n    for (b in 1:nbodysys) {\n        pi[b] <<- rbeta(1,alpha.pi+sum(theta[b,1:nae[b]]==0,na.rm=T),beta.pi+nae[b]-sum(theta[b,1:nae[b]]==0,na.rm=T))\n    }\n}\nsigma.theta.update <- function() {\n    for (b in 1:nbodysys) {\n        sigma2.rand <- rgamma(1,nae[b]/2+alpha.theta,\n                              scale=1/beta.theta+0.5*sum((theta[b,1:nae[b]]-mu.theta[b])^2,na.rm=T)) # fixed\n        sigma.theta[b] <<- 1/sqrt(sigma2.rand)\n    }\n}\nsigma.gamma.update <- function()\n{\n    tmp<-0\n    for (b in 1:nbodysys) {\n        tmp <- tmp+sum((gamm[b,1:nae[b]]-mu.gamma[b])^2,na.rm=T)\n    }\n    sigma2.rand <- rgamma(1,0.5*sum(nae)+alpha.sigma.gamma,scale=1/beta.sigma.gamma+\n                          0.5*tmp) #fixed\n    sigma.gamma <<- 1/sqrt(sigma.gamma)\n}\ntau.gamma0.update <- function()\n{\n    tau2.gamma0 <- rgamma(1,0.5*nbodysys+alpha.tau.gamma,scale=1/beta.tau.gamma+0.5*\n                          sum((mu.gamma-mu.gamma0)^2)) #fixed\n    tau.gamma0 <<- 1/sqrt(tau2.gamma0)\n}\ntau.theta0.update <- function()\n{\n    tau2.theta0 <- rgamma(1,0.5*nbodysys+alpha.tau.theta,scale=1/beta.tau.theta+0.5*\n                          sum((mu.theta-mu.theta0)^2)) #fixed\n    tau.theta0 <<- 1/sqrt(tau2.theta0)\n}\nmu.gamma.update <- function() {\n    for (b in 1:nbodysys) {\n        gibbs.mu <- (tau.gamma0^2*sum(gamm[b,1:nae[b]],na.rm=T)+sigma.gamma^2*mu.gamma0)/\n            (tau.gamma0^2*nae[b]+sigma.gamma^2)\n        gibbs.sigma2 <- tau.gamma0^2*sigma.gamma^2/(tau.gamma0^2*nae[b]+sigma.gamma^2)\n        mu.gamma[b] <<- rnorm(1,mean=gibbs.mu,sd=sqrt(gibbs.sigma2))\n    }\n}\nmu.theta.update <- function() {\n    for (b in 1:nbodysys) {\n        gibbs.mu <- (tau.theta0^2*sum(theta[b,1:nae[b]],na.rm=T)+sigma.theta^2*mu.theta0)/\n            (tau.theta0^2*nae[b]+sigma.theta^2)\n        gibbs.sigma2 <- tau.theta0^2*sigma.theta^2/(tau.theta0^2*nae[b]+sigma.theta^2)\n        mu.theta[b] <<- rnorm(1,mean=gibbs.mu,sd=sqrt(gibbs.sigma2))\n    }\n}\nmu.gamma0.update <- function()\n{\n    gibbs.mu <- (tau.gamma00^2*sum(mu.gamma)+tau.gamma0^2*mu.gamma00) /\n        (tau.gamma00^2*nbodysys+tau.gamma0^2)\n    gibbs.sigma2 <- tau.gamma00^2*tau.gamma0^2/(tau.gamma00^2*nbodysys +\n                                                tau.gamma0^2)\n    mu.gamma0 <<- rnorm(1,mean=gibbs.mu,sd=sqrt(gibbs.sigma2))\n}\nmu.theta0.update <- function()\n{\n    gibbs.mu <- (tau.theta00^2*sum(mu.theta)+tau.theta0^2*mu.theta00) /\n        (tau.theta00^2*nbodysys+tau.theta0^2)\n    gibbs.sigma2 <- tau.theta00^2*tau.theta0^2/(tau.theta00^2*nbodysys +\n                                                tau.theta0^2)\n    mu.theta0 <<- rnorm(1,mean=gibbs.mu,sd=sqrt(gibbs.sigma2))\n}\nalpha.pi.logcond <- function(alpha=alpha.pi) {\n    if (alpha<=1) return(-Inf)\n    else {\n        return(nbodysys*(lgamma(alpha+beta.pi)-lgamma(alpha))+\n               (alpha+1)*sum(log(pi))-alpha*lambda.alpha)\n    }\n}\nalpha.pi.update <- function() {\n    cand <- rnorm(1,mean=alpha.pi,sd=sigma.mh.theta)\n    acc.prob <- exp(alpha.pi.logcond(alpha=cand)-alpha.pi.logcond())\n    if (runif(1)<<-cand\n}\nbeta.pi.logcond <- function(beta=beta.pi) {\n    if (beta<=1) return(-Inf)\n    else {\n        return(nbodysys*(lgamma(beta+alpha.pi)-lgamma(beta))+\n               (beta+1)*sum(log(1-pi))-beta*lambda.beta)\n    }\n}\nbeta.pi.update <- function() {\n    cand <- rnorm(1,mean=beta.pi,sd=sigma.mh.theta)\n    acc.prob <- exp(beta.pi.logcond(beta=cand)-beta.pi.logcond())\n    if (runif(1)<<-cand\n}\n                                        # set up constants as in sec 4\nmu.theta00<-0\ntau.theta00 <- sqrt(10)\nmu.gamma00 <- 0\ntau.gamma00 <- sqrt(10)\nalpha.theta <- 3\nbeta.theta <- 1\nalpha.theta0 <- 3\nbeta.theta0 <- 1\nalpha.tau.gamma<-3\nbeta.tau.gamma <- 1\nalpha.tau.theta <- 3\nbeta.tau.theta <- 1\nalpha.sigma.gamma<-3\nbeta.sigma.gamma <- 1\nlambda.alpha<-1\nlambda.beta <- 1\n                                        # parms for the example in berry and berry\nae.dat <- read.table(file=\"ae.dat\",header=T)\nae.dat$bodysysf <- factor(ae.dat$bodysys)\nnt <- 148\nnc <- 132\nnae <- tapply(ae.dat$aenum,ae.dat$bodysysf,length)\nnbodysys <- length(levels(ae.dat$bodysysf))\ny <- matrix(NA,nrow=nbodysys,ncol=max(nae))\nx <- matrix(NA,nrow=nbodysys,ncol=max(nae))\nfor (i in 1:nbodysys) {\ny[i,1:nae[i]] <- ae.dat$trtct[ae.dat$bodysysf==as.numeric(levels(ae.dat$bodysysf)[i])]\nx[i,1:nae[i]] <- ae.dat$contct[ae.dat$bodysysf==as.numeric(levels(ae.dat$bodysysf)[i])]\n}\nsigma.mh.theta <- 2\nsigma.mh.gamma <- 2\n                                        # set up containers\ntheta <- matrix(NA,nrow=nbodysys,ncol=max(nae))\ngamm <- matrix(NA,nrow=nbodysys,ncol=max(nae))\npi <- rep(NA,length=nbodysys)\nsigma.theta <- rep(NA,length=nbodysys)\nsigma.gamma <- NA\ntau.gamma0 <- NA\ntau.theta0 <- NA\nmu.gamma <- rep(NA,length=nbodysys)\nmu.theta <- rep(NA,length=nbodysys)\nmu.gamma0 <- NA\nmu.theta0 <- NA\nalpha.pi <- NA\nbeta.pi <- NA\n\n                                        # initial values\ngamm <- logit(x/nc)\ntheta <- logit(y/nt)-gamm\npi <- rep(.5,length=nbodysys)\nsigma.theta <- rep(1,length=nbodysys)\nsigma.gamma <- 1\ntau.gamma0 <- 1\ntau.theta0 <- 1\nmu.gamma <- rep(0,length=nbodysys)\nmu.theta <- rep(0,length=nbodysys)\nmu.gamma0 <- 0\nmu.theta0 <- 1\nalpha.pi <- 1.5\nbeta.pi <- 1.5\n                                        # chains\nn.iter <- 11000\nn.burnin <- 1000\ntheta.chain <- array(NA,dim=c(nbodysys,max(nae),n.iter))\ngammabj.chain <- array(NA,dim=c(nbodysys,max(nae),n.iter))\nfor (i in 1:n.iter)\n{\n    thetabj.update()\n    theta.chain[,,i] <- theta\n    gammabj.update()\n    gammabj.chain[,,i] <- gamm\n    pib.update()\n    sigma.theta.update()\n    sigma.gamma.update()\n    tau.gamma0.update()\n    tau.theta0.update()\n    mu.gamma.update()\n    mu.theta.update()\n    mu.gamma0.update()\n    mu.theta0.update()\n    alpha.pi.update()\n    beta.pi.update()\n}\nfor (b in 1:nbodysys)\n{\n    for (j in 1:nae[b])\n    {\n        if (b==1 && j==1) {\n            cat(sprintf(\"%5s%5s%10s%10s\\n\",\"b\",\"j\",\"P(th=0)\",\"P(th>0)\"))\n            cat(sprintf(\"%5s%5s%10s%10s\\n\",\"---\",\"---\",\"------\",\"------\"))\n        }\n        cat(sprintf(\"%5s%5d%10.3f%10.3f\\n\",names(nae)[b],j,sum(theta.chain[b,j,(n.burnin+1):n.iter]==0)/sum(!is.na(theta.chain[b,j,(n.burnin+1):n.iter])),sum(theta.chain[b,j,(n.burnin+1):n.iter]>0)/sum(!is.na(theta.chain[b,j,(n.burnin+1):n.iter]))))\n    }\n}\n#mean(theta.chain[1,1,(n.burnin+1):n.iter],na.rm=T)\nplot(theta.chain[1,1,(n.burnin+1):n.iter],type='b',pch=0)\nplot(theta.chain[2,4,(n.burnin+1):n.iter],type='b')\nplot(theta.chain[2,4,1:n.iter],type='b')\nsum(theta.chain[2,4,])/n.iter\ngammabj.chain[1,1,(n.burnin+1):n.iter]\nplot(theta.chain[6,2,(n.burnin+1):n.iter],type='b')\nhist(theta.chain[1,1,(n.burnin+1):n.iter])\n#acceptance rate\nfoo <- theta.chain[1,1,(n.burnin+1):n.iter]\nsum(foo[2:(n.iter-n.burnin)]!=foo[1:(n.iter-n.burnin-1)])/(n.iter-n.burnin+1)\nThe datafile ae.dat copies the vaccine data from the article and looks like the following:\n# data for Berry and Berry AE model\nbodysys aenum ae trtct contct\n1 1 astenia/fatigue 57 40\n1 2 fever 34 26\n1 3 infection/fungal 2 0\n1 4 infection/viral 3 1\n1 5 malaise 27 20\n3 1 anorexia 7 2\n3 2 cendisiasis/oral 2 0\n3 3 constipation 2 0\n3 4 diarrhea 24 10\n3 5 castroenteritis 3 1\n3 6 nausea 2 7\n3 7 vomiting 19 19\n5 1 lymphadenopathy 3 2\n6 1 dehydration 0 2\n8 1 crying 2 0\n8 2 insomnia 2 2\n8 3 irritability  75 43\n9 1 bronchitis 4 1\n9 2 congestion/nasal 4 2\n9 3 congestion/respiratory 1 2\n9 4 cough 13 8\n9 5 infection/upper_respiratory 28 20\n9 6 laryngotracheobronchitis 2 1\n9 7 pharyngitis 13 8\n9 8 rhinorrhea 15 14\n9 9 sinusitis 3 1\n9 10 tonsillitis 2 1\n9 11 wheezing 3 1\n10 1 bite/sting 4 0\n10 2 eczema 2 0\n10 3 pruritis 2 1\n10 4 rash 13 3\n10 5 rash/diaper 6 2\n10 6 rash/measles/rubella-like 8 1\n10 7 rash/varicella-like 4 2\n10 8 urticaria 0 2\n10 9 viral/exanthema 1 2\n11 1 conjunctivitis 0 2\n11 2 otitis/media 18 14\n11 3 otorrhea 2 1\nI make no claims to the correctness of this code, but I have gotten results that are close to the Berry and Berry article.\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nRealizations in Biostatistics\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "I've been working on this for quite some time (see here for a little background), so I'm pleased that it looks close to done at least as far as the core algorithm. It uses global variables for now, and I'm sure there are a couple of other bugs lurking, but here it is, after the jump.const.sqrt2pi",
      "meta_keywords": null,
      "og_description": "I've been working on this for quite some time (see here for a little background), so I'm pleased that it looks close to done at least as far as the core algorithm. It uses global variables for now, and I'm sure there are a couple of other bugs lurking, but here it is, after the jump.const.sqrt2pi",
      "og_image": "https://www.r-bloggers.com/wp-content/uploads/2016/04/R_02_2016-05-01.png",
      "og_title": "My implementation of Berry and Berry’s hierarchical Bayes algorithm for adverse events | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 10.1,
      "sitemap_lastmod": "2009-11-20T22:48:37+00:00",
      "twitter_description": "I've been working on this for quite some time (see here for a little background), so I'm pleased that it looks close to done at least as far as the core algorithm. It uses global variables for now, and I'm sure there are a couple of other bugs lurking, but here it is, after the jump.const.sqrt2pi",
      "twitter_title": "My implementation of Berry and Berry’s hierarchical Bayes algorithm for adverse events | R-bloggers",
      "url": "https://www.r-bloggers.com/2009/11/my-implementation-of-berry-and-berrys-hierarchical-bayes-algorithm-for-adverse-events/",
      "word_count": 2012
    }
  }
}