{
  "id": "d4d7c7e8c6ed6c27b149a3c478c33782b199c243",
  "url": "https://www.r-bloggers.com/2024/12/using-stan-from-r/",
  "created_at_utc": "2025-11-22T19:59:33Z",
  "data": null,
  "raw_original": {
    "uuid": "4a7eddb5-45a5-40a8-a72d-1fdf19ef1249",
    "created_at": "2025-11-22 19:59:33",
    "raw_json": {
      "article_author": null,
      "article_headline": null,
      "article_modified": null,
      "article_published": null,
      "article_section": null,
      "article_tags": null,
      "canonical_url": "https://www.r-bloggers.com/2024/12/using-stan-from-r/",
      "crawled_at": "2025-11-22T10:56:18.227635",
      "external_links": [
        {
          "href": "https://cbowdon.github.io/posts/using-stan-from-r/",
          "text": "Chris Bowdon"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        },
        {
          "href": "https://trac.macports.org/ticket/71068",
          "text": "locate the R and R-group files on my system and edit them"
        },
        {
          "href": "https://cbowdon.github.io/posts/f1-stan/",
          "text": "F1 project"
        },
        {
          "href": "https://cbowdon.github.io/posts/using-stan-from-r/",
          "text": "Chris Bowdon"
        },
        {
          "href": "https://feedburner.google.com/fb/a/mailverify?uri=RBloggers",
          "text": "daily e-mail updates"
        },
        {
          "href": "https://www.r-project.org/",
          "text": "R"
        },
        {
          "href": "https://www.r-users.com/",
          "text": "Click here if you're looking to post or find an R/data-science job"
        },
        {
          "href": "http://r-posts.com/",
          "text": "here"
        }
      ],
      "h1_title": "R-bloggers",
      "html_title": "Using Stan from R | R-bloggers",
      "images": [],
      "internal_links": [
        {
          "href": "https://www.r-bloggers.com/author/chris-bowdon/",
          "text": "Chris Bowdon"
        },
        {
          "href": "https://www.r-bloggers.com/category/r-bloggers/",
          "text": "R bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers"
        },
        {
          "href": "https://www.r-bloggers.com/contact-us/",
          "text": "here"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        },
        {
          "href": "https://www.r-bloggers.com/",
          "text": "R-bloggers.com"
        },
        {
          "href": "https://www.r-bloggers.com/how-to-learn-r-2/",
          "text": "learning R"
        },
        {
          "href": "https://www.r-bloggers.com/add-your-blog/",
          "text": "click here"
        }
      ],
      "lang": "en-US",
      "main_html": "<article class=\"post-393272 post type-post status-publish format-standard hentry category-r-bloggers\">\n<header class=\"post-header\">\n<h1 class=\"entry-title\">Using Stan from R</h1>\n<p class=\"meta post-meta\">Posted on <span class=\"updated\">December 25, 2024</span>  by <span class=\"vcard author\"><a class=\"fn\" href=\"https://www.r-bloggers.com/author/chris-bowdon/\">Chris Bowdon</a></span>  in <a href=\"https://www.r-bloggers.com/category/r-bloggers/\" rel=\"category tag\">R bloggers</a> | 0 Comments</p>\n</header>\n<div class=\"entry clearfix\">\n<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://cbowdon.github.io/posts/using-stan-from-r/\"> Chris Bowdon</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<p>I’ve been trying to get the hang of Bayesian models with Stan. One of the hurdles has been using Stan from R, so in this post I’m jotting down what I’ve learned (mostly the hard way).</p>\n<section class=\"level1\" id=\"rstan-or-cmdstanr\">\n<h1>RStan or CmdStanR?</h1>\n<p>On the whole I had a much better time using <code>CmdStanR</code> than <code>RStan</code>. When I made a mistake that led to a runtime exception, RStan would simply die with this kind of error:</p>\n<pre>Error in `unserialize()`:\n! error reading from connection\n     ▆\n  1. └─rstan::stan(...)\n  2.   ├─rstan::sampling(...)\n  3.   └─rstan::sampling(...)\n  4.     └─rstan (local) .local(object, ...)\n  5.       └─parallel::parLapplyLB(cl, X = 1:chains, fun = callFun)\n  6.         ├─base::do.call(...)\n  7.         └─parallel::clusterApplyLB(...)\n  8.           └─parallel:::dynamicClusterApply(cl, fun, length(x), argfun)\n  9.             └─parallel:::recvOneResult(cl)\n 10.               ├─parallel::recvOneData(cl)\n 11.               └─parallel:::recvOneData.SOCKcluster(cl)\n 12.                 └─base::unserialize(socklist[[n]])</pre>\n<p>CmdStanR on the other hand would print something useful. Other aspects of the development experience were also nicer:</p>\n<ul>\n<li>better status updates (e.g. showing when compiling)</li>\n<li>editor support for stan files e.g. linting</li>\n</ul>\n<p>I found installing CmdStanR, Stan and the rest of the toolchain from Macports to be very easy. However your mileage may vary when it comes to getting an R installation from Macports, due to some esoteric g95 and xcode compiler errors. I ended up having to <a href=\"https://trac.macports.org/ticket/71068\" rel=\"nofollow\" target=\"_blank\">locate the R and R-group files on my system and edit them</a>. Hopefully the Macports team will resolve this, because I really appreciate being able to install R from there.</p>\n</section>\n<section class=\"level1\" id=\"ensure-show_messages-is-true\">\n<h1>Ensure <code>show_messages</code> is <code>TRUE</code></h1>\n<p>For obvious reasons.</p>\n</section>\n<section class=\"level1\" id=\"rejecting-initial-value-errors\">\n<h1>“Rejecting initial value” errors</h1>\n<p>I got “Rejecting initial value” a lot:</p>\n<blockquote class=\"blockquote\">\n<p>log probability evaluates to log(0), i.e. negative infinity</p>\n</blockquote>\n<p>This is trying to tell you that the default initial value chosen by Stan has a probability of zero in your prior. You need to set constraints in the parameters block that match the prior distribution you choose. For example if you chose a uniform(1, 10) prior, you should add the constraint <code>&lt;lower=1, upper=10&gt;</code> to your parameter declaration.</p>\n</section>\n<section class=\"level1\" id=\"dont-forget-to-set-parallel_chains\">\n<h1>Don’t forget to set <code>parallel_chains</code></h1>\n<p>On my system <code>getOption(\"mc.cores\")</code> was unset and Stan defaulted to running all four chains on a single core. Oops. You can also have within-chain parallelism, but I’ve read varying accounts on the usefulness of this (presumably there’s more communication required, which is usually the death of parallelism gains).</p>\n<p>Other software can apparently use GPUs for calculations by the way (e.g. the TensorFlow-based software) so if you have massive calculations to do those may be worth investigating.</p>\n</section>\n<section class=\"level1\" id=\"maximum-tree-depth-warnings\">\n<h1>Maximum tree-depth warnings</h1>\n<p>Hitting maximum tree-depth for the majority of samples was because of an <em>identifiability</em> problem in my model.</p>\n<p>The linked advice within the warning is fairly clear: https://mc-stan.org/misc/warnings#maximum-treedepth. If you’re wondering whether your Rhat and ESS values are good, read higher up that page.</p>\n</section>\n<section class=\"level1\" id=\"resolving-unidentified-or-weakly-identified-models\">\n<h1>Resolving unidentified or weakly-identified models</h1>\n<p>I don’t have a comprehensive understanding of this, but the general idea is that your problem doesn’t have a unique solution, or more precisely there are multiple parameter values that would give the same distribution of observed data. Here’s a dumb example: imagine you are modelling your data as draws from a Normal distribution where the mean is the sum of two parameters, i.e. <code>observations ~ normal(a + b, 1)</code>. If <code>a</code> and <code>b</code> don’t correspond to real phenomena captured in your observations, the values could be all over the place and the model will struggle. You need to constrain the parameters.</p>\n<p>A simple way to do this is to transform your parameters with the inverse logistic function, which has a range (output) between 0 and 1. You could also pin one of your parameters to a constant, though I found that harder to follow and more difficult to make work.</p>\n<p>Here’s an example from my <a href=\"https://cbowdon.github.io/posts/f1-stan/\" rel=\"nofollow\" target=\"_blank\">F1 project</a>, simplified slightly.</p>\n<pre>#| label: stan-constraints-example\ndata {\n  int&lt;lower=1&gt; n_ctrs;\n  int&lt;lower=1&gt; n_drvs;\n  int&lt;lower=1&gt; n_obs;\n  array[n_obs] int&lt;lower=1, upper=20&gt; positions;\n  array[n_obs, 2] int position_indices;\n}\nparameters {\n  // Raw will be sampled from prior distribution\n  vector[n_ctrs] lambda_ctrs_raw;\n  vector[n_drvs] lambda_drvs_raw;\n}\ntransformed parameters {\n  // Transformed will be used as the parameter\n  vector[n_ctrs] lambda_ctrs;\n  vector[n_drvs] lambda_drvs;\n  \n  // The transformed params can only be between 1 and 10\n  // because the inv_logit function has range [0, 1]\n  lambda_ctrs = 1 + 9 * inv_logit(lambda_ctrs_raw);\n  lambda_drvs = 1 + 9 * inv_logit(lambda_drvs_raw);\n}\nmodel {\n  lambda_ctrs_raw ~ std_normal();\n  lambda_drvs_raw ~ std_normal();\n  \n  for (k in 1 : n_obs) {\n    int i = position_indices[k, 1];\n    int j = position_indices[k, 2];\n    positions[k] ~ poisson(exp(lambda_ctrs[i] + lambda_drvs[j]));\n  }</pre>\n</section>\n<div class=\"jp-relatedposts\" id=\"jp-relatedposts\">\n<h3 class=\"jp-relatedposts-headline\"><em>Related</em></h3>\n</div>\n<!-- Share buttons by mashshare.net - Version: 4.0.47-->\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://cbowdon.github.io/posts/using-stan-from-r/\"> Chris Bowdon</a></strong>.</div>\n<hr/>\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a href=\"https://www.r-project.org/\" rel=\"nofollow\" title=\"The R Project for Statistical Computing\">R</a> news and tutorials about <a href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\" title=\"R tutorials\">learning R</a> and many other topics. <a href=\"https://www.r-users.com/\" rel=\"nofollow\" title=\"Data science jobs\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr/>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div> </div>\n</article>",
      "main_text": "Using Stan from R\nPosted on\nDecember 25, 2024\nby\nChris Bowdon\nin\nR bloggers\n| 0 Comments\n[This article was first published on\nChris Bowdon\n, and kindly contributed to\nR-bloggers\n].  (You can report issue about the content on this page\nhere\n)\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.\nI’ve been trying to get the hang of Bayesian models with Stan. One of the hurdles has been using Stan from R, so in this post I’m jotting down what I’ve learned (mostly the hard way).\nRStan or CmdStanR?\nOn the whole I had a much better time using\nCmdStanR\nthan\nRStan\n. When I made a mistake that led to a runtime exception, RStan would simply die with this kind of error:\nError in `unserialize()`:\n! error reading from connection\n     ▆\n  1. └─rstan::stan(...)\n  2.   ├─rstan::sampling(...)\n  3.   └─rstan::sampling(...)\n  4.     └─rstan (local) .local(object, ...)\n  5.       └─parallel::parLapplyLB(cl, X = 1:chains, fun = callFun)\n  6.         ├─base::do.call(...)\n  7.         └─parallel::clusterApplyLB(...)\n  8.           └─parallel:::dynamicClusterApply(cl, fun, length(x), argfun)\n  9.             └─parallel:::recvOneResult(cl)\n 10.               ├─parallel::recvOneData(cl)\n 11.               └─parallel:::recvOneData.SOCKcluster(cl)\n 12.                 └─base::unserialize(socklist[[n]])\nCmdStanR on the other hand would print something useful. Other aspects of the development experience were also nicer:\nbetter status updates (e.g. showing when compiling)\neditor support for stan files e.g. linting\nI found installing CmdStanR, Stan and the rest of the toolchain from Macports to be very easy. However your mileage may vary when it comes to getting an R installation from Macports, due to some esoteric g95 and xcode compiler errors. I ended up having to\nlocate the R and R-group files on my system and edit them\n. Hopefully the Macports team will resolve this, because I really appreciate being able to install R from there.\nEnsure\nshow_messages\nis\nTRUE\nFor obvious reasons.\n“Rejecting initial value” errors\nI got “Rejecting initial value” a lot:\nlog probability evaluates to log(0), i.e. negative infinity\nThis is trying to tell you that the default initial value chosen by Stan has a probability of zero in your prior. You need to set constraints in the parameters block that match the prior distribution you choose. For example if you chose a uniform(1, 10) prior, you should add the constraint\n<lower=1, upper=10>\nto your parameter declaration.\nDon’t forget to set\nparallel_chains\nOn my system\ngetOption(\"mc.cores\")\nwas unset and Stan defaulted to running all four chains on a single core. Oops. You can also have within-chain parallelism, but I’ve read varying accounts on the usefulness of this (presumably there’s more communication required, which is usually the death of parallelism gains).\nOther software can apparently use GPUs for calculations by the way (e.g. the TensorFlow-based software) so if you have massive calculations to do those may be worth investigating.\nMaximum tree-depth warnings\nHitting maximum tree-depth for the majority of samples was because of an\nidentifiability\nproblem in my model.\nThe linked advice within the warning is fairly clear: https://mc-stan.org/misc/warnings#maximum-treedepth. If you’re wondering whether your Rhat and ESS values are good, read higher up that page.\nResolving unidentified or weakly-identified models\nI don’t have a comprehensive understanding of this, but the general idea is that your problem doesn’t have a unique solution, or more precisely there are multiple parameter values that would give the same distribution of observed data. Here’s a dumb example: imagine you are modelling your data as draws from a Normal distribution where the mean is the sum of two parameters, i.e.\nobservations ~ normal(a + b, 1)\n. If\na\nand\nb\ndon’t correspond to real phenomena captured in your observations, the values could be all over the place and the model will struggle. You need to constrain the parameters.\nA simple way to do this is to transform your parameters with the inverse logistic function, which has a range (output) between 0 and 1. You could also pin one of your parameters to a constant, though I found that harder to follow and more difficult to make work.\nHere’s an example from my\nF1 project\n, simplified slightly.\n#| label: stan-constraints-example\ndata {\n  int<lower=1> n_ctrs;\n  int<lower=1> n_drvs;\n  int<lower=1> n_obs;\n  array[n_obs] int<lower=1, upper=20> positions;\n  array[n_obs, 2] int position_indices;\n}\nparameters {\n  // Raw will be sampled from prior distribution\n  vector[n_ctrs] lambda_ctrs_raw;\n  vector[n_drvs] lambda_drvs_raw;\n}\ntransformed parameters {\n  // Transformed will be used as the parameter\n  vector[n_ctrs] lambda_ctrs;\n  vector[n_drvs] lambda_drvs;\n  \n  // The transformed params can only be between 1 and 10\n  // because the inv_logit function has range [0, 1]\n  lambda_ctrs = 1 + 9 * inv_logit(lambda_ctrs_raw);\n  lambda_drvs = 1 + 9 * inv_logit(lambda_drvs_raw);\n}\nmodel {\n  lambda_ctrs_raw ~ std_normal();\n  lambda_drvs_raw ~ std_normal();\n  \n  for (k in 1 : n_obs) {\n    int i = position_indices[k, 1];\n    int j = position_indices[k, 2];\n    positions[k] ~ poisson(exp(lambda_ctrs[i] + lambda_drvs[j]));\n  }\nRelated\nTo\nleave a comment\nfor the author, please follow the link and comment on their blog:\nChris Bowdon\n.\nR-bloggers.com\noffers\ndaily e-mail updates\nabout\nR\nnews and tutorials about\nlearning R\nand many other topics.\nClick here if you're looking to post or find an R/data-science job\n.\nWant to share your content on R-bloggers?\nclick here\nif you have a blog, or\nhere\nif you don't.",
      "meta_description": "I’ve been trying to get the hang of Bayesian models with Stan. One of the hurdles has been using Stan from R, so in this post I’m jotting down what I’ve learned (mostly the hard way). RStan or CmdStanR? On the whole I had a much better time usi...",
      "meta_keywords": null,
      "og_description": "I’ve been trying to get the hang of Bayesian models with Stan. One of the hurdles has been using Stan from R, so in this post I’m jotting down what I’ve learned (mostly the hard way). RStan or CmdStanR? On the whole I had a much better time usi...",
      "og_image": "https://www.r-bloggers.com/wp-content/uploads/2016/04/R_02_2016-05-01.png",
      "og_title": "Using Stan from R | R-bloggers",
      "raw_jsonld_article": null,
      "reading_time_min": 4.5,
      "sitemap_lastmod": null,
      "twitter_description": "I’ve been trying to get the hang of Bayesian models with Stan. One of the hurdles has been using Stan from R, so in this post I’m jotting down what I’ve learned (mostly the hard way). RStan or CmdStanR? On the whole I had a much better time usi...",
      "twitter_title": "Using Stan from R | R-bloggers",
      "url": "https://www.r-bloggers.com/2024/12/using-stan-from-r/",
      "word_count": 907
    }
  }
}