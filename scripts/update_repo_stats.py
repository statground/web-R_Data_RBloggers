import os
import json
from datetime import datetime
from pathlib import Path

# í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜(scripts/)ì˜ ìƒìœ„ í´ë”(ë£¨íŠ¸)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²½ë¡œ ì„¤ì •
CURRENT_DIR = Path(__file__).resolve().parent
ROOT_DIR = CURRENT_DIR.parent

DATA_DIR = ROOT_DIR / 'by_created'
COUNTS_FILE = ROOT_DIR / 'RBLOGGERS_COUNTS.json'
STATS_FILE = ROOT_DIR / 'RBLOGGERS_REPO_STATS.md'
ACTION_RESULT_FILE = ROOT_DIR / '.action_result.json'

def scan_repository():
    """
    by_created ë””ë ‰í† ë¦¬ ì „ì²´ë¥¼ ìŠ¤ìº”í•˜ì—¬ ì—°/ì›”ë³„ í†µê³„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    (ê¸°ì¡´ ê°’ì„ ë¯¿ì§€ ì•Šê³  ë§¤ë²ˆ ìƒˆë¡œ ì…‰ë‹ˆë‹¤ -> ì˜¤ë¥˜ ê°€ëŠ¥ì„± 0%)
    """
    stats = {}
    total_files = 0
    total_bytes = 0
    
    if not DATA_DIR.exists():
        print(f"Warning: {DATA_DIR} does not exist.")
        return stats, 0, 0

    # ì—°ë„(YYYY) ë””ë ‰í† ë¦¬ ìˆœíšŒ
    for year_path in sorted(DATA_DIR.iterdir()):
        if not year_path.is_dir() or not year_path.name.isdigit():
            continue
        
        year = year_path.name
        
        # ì›”(MM) ë””ë ‰í† ë¦¬ ìˆœíšŒ
        for month_path in sorted(year_path.iterdir()):
            if not month_path.is_dir() or not month_path.name.isdigit():
                continue
                
            month = month_path.name
            key = f"{year}-{month}"
            
            # í•´ë‹¹ ì›”ì˜ .json íŒŒì¼ ì „ìˆ˜ ì¡°ì‚¬
            files = list(month_path.glob("*.json"))
            count = len(files)
            size = sum(f.stat().st_size for f in files)
            
            if count > 0:
                stats[key] = {"files": count, "bytes": size}
                total_files += count
                total_bytes += size

    return stats, total_files, total_bytes

def load_last_run_info():
    """í¬ë¡¤ëŸ¬(crawl_rbloggers.py)ê°€ ìƒì„±í•œ ì„ì‹œ ê²°ê³¼ íŒŒì¼ì—ì„œ ìµœê·¼ ì‹¤í–‰ ì •ë³´ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤."""
    info = {"status": "Unknown", "new_count": 0}
    if ACTION_RESULT_FILE.exists():
        try:
            with open(ACTION_RESULT_FILE, 'r', encoding='utf-8') as f:
                data = json.load(f)
                info["status"] = data.get("status", "Unknown")
                # í¬ë¡¤ëŸ¬ê°€ ê¸°ë¡í•œ new_countë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜, ì—†ìœ¼ë©´ 0
                info["new_count"] = data.get("new_count", 0) 
        except Exception as e:
            print(f"Error reading action result: {e}")
    return info

def update_stats_files(monthly_stats, total_files, total_bytes, last_run_info):
    """JSON ë° MD íŒŒì¼ì„ ê°±ì‹ í•©ë‹ˆë‹¤."""
    
    # 1. RBLOGGERS_COUNTS.json ì—…ë°ì´íŠ¸
    sorted_keys = sorted(monthly_stats.keys(), reverse=True) # ìµœì‹  ì›”ì´ ìœ„ë¡œ
    sorted_stats = {k: monthly_stats[k] for k in sorted_keys}
    
    output_json = {
        "meta": {
            "total_posts": total_files,
            "total_bytes": total_bytes,
            "last_updated": datetime.now().strftime("%Y-%m-%d %H:%M:%S KST"),
            "last_crawl_status": last_run_info["status"],
            "last_crawl_new_files": last_run_info["new_count"]
        },
        "monthly_counts": sorted_stats
    }
    
    with open(COUNTS_FILE, 'w', encoding='utf-8') as f:
        json.dump(output_json, f, indent=2)
    print(f"âœ… Updated {COUNTS_FILE}")

    # 2. RBLOGGERS_REPO_STATS.md ì—…ë°ì´íŠ¸
    mb_size = total_bytes / (1024 * 1024)
    
    md_content = [
        "# R-bloggers Data Repository Statistics",
        "",
        "## ğŸ“Š Repository Status",
        f"- **Total Archived Posts:** {total_files:,}",
        f"- **Total Data Size:** {mb_size:.2f} MB",
        f"- **Last Updated:** {output_json['meta']['last_updated']}",
        "",
        "## ğŸ”„ Last Crawl Info",
        f"- **Status:** {last_run_info['status']}",
        f"- **New Posts Added:** {last_run_info['new_count']}",
        "",
        "## ğŸ“… Monthly Archive History",
        "| Month | Posts | Size (KB) |",
        "| :--- | :---: | :---: |"
    ]
    
    for key in sorted_keys:
        data = monthly_stats[key]
        kb_size = data['bytes'] / 1024
        md_content.append(f"| **{key}** | {data['files']:,} | {kb_size:,.1f} KB |")
    
    md_content.append("")
    md_content.append("---")
    md_content.append(f"\n*This report is automatically generated by Statground Platform.*")

    with open(STATS_FILE, 'w', encoding='utf-8') as f:
        f.write("\n".join(md_content))
    print(f"âœ… Updated {STATS_FILE}")

if __name__ == "__main__":
    print("--- Starting Repository Stats Update (Full Scan) ---")
    monthly_stats, total_files, total_bytes = scan_repository()
    last_run = load_last_run_info()
    update_stats_files(monthly_stats, total_files, total_bytes, last_run)
    print("--- Update Finished ---")