name: Crawl R-Bloggers (hourly)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: rbloggers-crawl-main
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  crawl-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f scripts/requirements.txt ]; then
            pip install -r scripts/requirements.txt
          else
            pip install requests beautifulsoup4 lxml
          fi

      - name: Crawl R-Bloggers
        run: |
          python scripts/crawl_rbloggers.py

      - name: Update Repository Stats
        run: |
          python scripts/update_repo_stats.py

      # ✅ 여기서 "push 이후 HEAD sha"를 outputs로 뽑아둠
      - name: Commit and Push changes
        id: commit_push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add by_created/
          git add RBLOGGERS_COUNTS.json RBLOGGERS_REPO_STATS.md
          git add .action_result.json

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto Update: R-Bloggers Data & Stats ($(date +'%Y-%m-%d %H:%M'))"
            git push
          fi

          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "ref=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "repo=${GITHUB_REPOSITORY}" >> "$GITHUB_OUTPUT"

      - name: Trigger Web-R Sync
        if: always()
        env:
          WEBR_SYNC_URL: ${{ secrets.WEBR_SYNC_URL }}
          WEBR_SYNC_TOKEN: ${{ secrets.WEBR_SYNC_TOKEN }}

          # ✅ github.sha 대신 "push 이후 HEAD"
          GH_SHA: ${{ steps.commit_push.outputs.sha }}
          GH_REF_NAME: ${{ steps.commit_push.outputs.ref }}
          GH_REPO: ${{ steps.commit_push.outputs.repo }}
        run: |
          if [ -z "${WEBR_SYNC_URL:-}" ] || [ -z "${WEBR_SYNC_TOKEN:-}" ]; then
            echo "WEBR_SYNC_URL or WEBR_SYNC_TOKEN not set. Skipping sync."
            exit 0
          fi

          if [ -f ".action_result.json" ]; then
            FILES_JSON="$(python -c 'import json; d=json.load(open(".action_result.json","r",encoding="utf-8")); k = "new_files_relpaths" if "new_files_relpaths" in d else "files"; print(json.dumps(d.get(k, []), ensure_ascii=False))')"
          else
            FILES_JSON="[]"
          fi

          export FILES_JSON

          python -c "
          import json, os
          payload = {
            'repo': os.environ.get('GH_REPO',''),
            'sha': os.environ.get('GH_SHA',''),
            'ref': os.environ.get('GH_REF_NAME',''),
            'files': json.loads(os.environ.get('FILES_JSON','[]'))
          }
          with open('payload.json','w',encoding='utf-8') as f:
            json.dump(payload, f, ensure_ascii=False)
          print('payload:', payload)
          "

          echo "Sending webhook to $WEBR_SYNC_URL..."
          curl --fail-with-body -sS -X POST \
               -H "Content-Type: application/json" \
               -H "Authorization: Bearer $WEBR_SYNC_TOKEN" \
               -d @payload.json \
               "$WEBR_SYNC_URL"
