name: Crawl R-Bloggers (hourly)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: rbloggers-crawl-main
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  crawl-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f scripts/requirements.txt ]; then
            pip install -r scripts/requirements.txt
          else
            pip install requests beautifulsoup4 lxml
          fi

      - name: Crawl R-Bloggers
        run: |
          python scripts/crawl_rbloggers.py

      - name: Update Repository Stats
        run: |
          python scripts/update_repo_stats.py

      # ✅ BEFORE/AFTER sha + by_created diff 파일 목록을 outputs로 생성
      - name: Commit and Push changes
        id: commit_push
        env:
          BEFORE_SHA: ${{ github.sha }}
        run: |
          set -e

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add by_created/
          git add RBLOGGERS_COUNTS.json RBLOGGERS_REPO_STATS.md
          git add .action_result.json || true

          COMMITTED="0"
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto Update: R-Bloggers Data & Stats ($(date +'%Y-%m-%d %H:%M'))"
            git push
            COMMITTED="1"
          fi

          AFTER_SHA="$(git rev-parse HEAD)"
          echo "committed=${COMMITTED}" >> "$GITHUB_OUTPUT"
          echo "sha=${AFTER_SHA}" >> "$GITHUB_OUTPUT"
          echo "ref=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "repo=${GITHUB_REPOSITORY}" >> "$GITHUB_OUTPUT"

          # by_created 하위 json 변경 목록 추출(이번 실행에서 커밋이 없으면 빈 목록)
          if [ "${COMMITTED}" = "1" ]; then
            git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" -- 'by_created/**/*.json' > /tmp/changed_files.txt || true
          else
            : > /tmp/changed_files.txt
          fi

          python - <<'PY'
          import json
          files=[]
          with open('/tmp/changed_files.txt','r',encoding='utf-8') as f:
            for line in f:
              p=line.strip()
              if p:
                files.append(p)
          print("changed by_created json files:", len(files))
          with open('/tmp/changed_files.json','w',encoding='utf-8') as f:
            json.dump(files, f, ensure_ascii=False)
          PY

          echo "files_json=$(cat /tmp/changed_files.json)" >> "$GITHUB_OUTPUT"

      # ✅ by_created 변경이 있을 때만 webhook 호출 (없으면 서버 부하/504 방지)
      - name: Trigger Web-R Sync
        if: always()
        env:
          WEBR_SYNC_URL: ${{ secrets.WEBR_SYNC_URL }}
          WEBR_SYNC_TOKEN: ${{ secrets.WEBR_SYNC_TOKEN }}

          GH_SHA: ${{ steps.commit_push.outputs.sha }}
          GH_REF_NAME: ${{ steps.commit_push.outputs.ref }}
          GH_REPO: ${{ steps.commit_push.outputs.repo }}
          FILES_JSON: ${{ steps.commit_push.outputs.files_json }}
        run: |
          if [ -z "${WEBR_SYNC_URL:-}" ] || [ -z "${WEBR_SYNC_TOKEN:-}" ]; then
            echo "WEBR_SYNC_URL or WEBR_SYNC_TOKEN not set. Skipping sync."
            exit 0
          fi

          python - <<'PY'
          import json, os
          files = []
          try:
            files = json.loads(os.environ.get("FILES_JSON","[]"))
          except Exception:
            files = []
          payload = {
            "repo": os.environ.get("GH_REPO",""),
            "sha": os.environ.get("GH_SHA",""),
            "ref": os.environ.get("GH_REF_NAME",""),
            "files": files
          }
          with open("payload.json","w",encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False)
          print("payload:", payload)
          print("files_count:", len(files))
          PY

          # by_created 변경이 없으면 webhook 자체를 호출하지 않음
          FILES_COUNT="$(python -c "import json;print(len(json.load(open('payload.json','r',encoding='utf-8'))['files']))")"
          if [ "${FILES_COUNT}" = "0" ]; then
            echo "No by_created json changes. Skip webhook."
            exit 0
          fi

          echo
